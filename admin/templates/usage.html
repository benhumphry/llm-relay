{% extends "base.html" %} {% block title %}Usage{% endblock %} {% block content
%}
<div x-data="usagePage()" x-init="init()">
    <!-- Header with date range selector -->
    <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4"
    >
        <div>
            <h1 class="text-2xl font-bold">Usage & Stats</h1>
            <p class="text-base-content/60">Monitor proxy usage and costs</p>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
            <!-- Date Range -->
            <div class="join">
                <button
                    @click="setDatePreset('today')"
                    :class="{'btn-active': dateMode === 'today'}"
                    class="btn btn-sm join-item"
                >
                    Today
                </button>
                <button
                    @click="setDatePreset(7)"
                    :class="{'btn-active': dateMode === 7}"
                    class="btn btn-sm join-item"
                >
                    7d
                </button>
                <button
                    @click="setDatePreset(30)"
                    :class="{'btn-active': dateMode === 30}"
                    class="btn btn-sm join-item"
                >
                    30d
                </button>
                <button
                    @click="setDatePreset(90)"
                    :class="{'btn-active': dateMode === 90}"
                    class="btn btn-sm join-item"
                >
                    90d
                </button>
                <button
                    @click="toggleCustomDate()"
                    :class="{'btn-active': dateMode === 'custom'}"
                    class="btn btn-sm join-item"
                >
                    Custom
                </button>
            </div>
            <button @click="loadData()" class="btn btn-sm btn-outline">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                    />
                </svg>
                Refresh
            </button>
        </div>
    </div>

    <!-- Custom Date Range Picker -->
    <div
        x-show="dateMode === 'custom'"
        x-transition
        class="mb-4 flex flex-wrap gap-2 items-center"
    >
        <label class="text-sm text-base-content/60">From:</label>
        <input
            type="date"
            x-model="customStartDate"
            @change="loadData()"
            class="input input-bordered input-sm"
        />
        <label class="text-sm text-base-content/60">To:</label>
        <input
            type="date"
            x-model="customEndDate"
            @change="loadData()"
            class="input input-bordered input-sm"
        />
    </div>

    <!-- Filter Bar -->
    <div class="mb-4">
        <!-- Filter Buttons -->
        <div class="flex flex-wrap gap-2 items-center">
            <!-- Tag Filter Button -->
            <button
                @click="expandedFilter = expandedFilter === 'tags' ? null : 'tags'"
                class="btn btn-sm gap-1"
                :class="expandedFilter === 'tags' ? 'btn-primary' : 'btn-outline'"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                    />
                </svg>
                Tags
                <span
                    x-show="filters.tags.length > 0"
                    class="badge badge-primary badge-xs"
                    x-text="filters.tags.length"
                ></span>
            </button>

            <!-- Provider Filter Button -->
            <button
                @click="expandedFilter = expandedFilter === 'providers' ? null : 'providers'"
                class="btn btn-sm gap-1"
                :class="expandedFilter === 'providers' ? 'btn-info' : 'btn-outline'"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"
                    />
                </svg>
                Providers
                <span
                    x-show="filters.providers.length > 0"
                    class="badge badge-info badge-xs"
                    x-text="filters.providers.length"
                ></span>
            </button>

            <!-- Model Filter Button -->
            <button
                @click="expandedFilter = expandedFilter === 'models' ? null : 'models'"
                class="btn btn-sm gap-1"
                :class="expandedFilter === 'models' ? 'btn-secondary' : 'btn-outline'"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                    />
                </svg>
                Models
                <span
                    x-show="filters.models.length > 0"
                    class="badge badge-secondary badge-xs"
                    x-text="filters.models.length"
                ></span>
            </button>

            <!-- Client Filter Button -->
            <button
                @click="expandedFilter = expandedFilter === 'clients' ? null : 'clients'"
                class="btn btn-sm gap-1"
                :class="expandedFilter === 'clients' ? 'btn-warning' : 'btn-outline'"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                    />
                </svg>
                Clients
                <span
                    x-show="filters.clients.length > 0"
                    class="badge badge-warning badge-xs"
                    x-text="filters.clients.length"
                ></span>
            </button>

            <!-- Alias Filter Button -->
            <button
                @click="expandedFilter = expandedFilter === 'aliases' ? null : 'aliases'"
                class="btn btn-sm gap-1"
                :class="expandedFilter === 'aliases' ? 'btn-accent' : 'btn-outline'"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                    />
                </svg>
                Aliases
                <span
                    x-show="filters.aliases.length > 0"
                    class="badge badge-accent badge-xs"
                    x-text="filters.aliases.length"
                ></span>
            </button>

            <!-- Clear Filters -->
            <button
                x-show="hasActiveFilters()"
                @click="clearFilters(); expandedFilter = null"
                class="btn btn-sm btn-ghost text-error"
            >
                Clear All
            </button>
        </div>

        <!-- Expanded Filter Panel -->
        <div
            x-show="expandedFilter"
            x-transition
            class="mt-3 p-3 bg-base-200 rounded-lg"
        >
            <!-- Tags Panel -->
            <div x-show="expandedFilter === 'tags'">
                <div class="flex flex-wrap gap-2">
                    <template x-for="tag in filterOptions.tags" :key="tag">
                        <label class="cursor-pointer">
                            <input
                                type="checkbox"
                                :checked="filters.tags.includes(tag)"
                                @change="toggleFilter('tags', tag)"
                                class="hidden peer"
                            />
                            <span
                                class="badge badge-lg peer-checked:badge-primary peer-checked:text-primary-content hover:opacity-80 transition-opacity"
                                x-text="tag"
                            ></span>
                        </label>
                    </template>
                    <span
                        x-show="filterOptions.tags.length === 0"
                        class="text-sm text-base-content/60"
                        >No tags available</span
                    >
                </div>
            </div>

            <!-- Providers Panel -->
            <div x-show="expandedFilter === 'providers'">
                <div class="flex flex-wrap gap-2">
                    <template
                        x-for="provider in filterOptions.providers"
                        :key="provider"
                    >
                        <label class="cursor-pointer">
                            <input
                                type="checkbox"
                                :checked="filters.providers.includes(provider)"
                                @change="toggleFilter('providers', provider)"
                                class="hidden peer"
                            />
                            <span
                                class="badge badge-lg peer-checked:badge-info peer-checked:text-info-content hover:opacity-80 transition-opacity"
                                x-text="provider"
                            ></span>
                        </label>
                    </template>
                    <span
                        x-show="filterOptions.providers.length === 0"
                        class="text-sm text-base-content/60"
                        >No providers available</span
                    >
                </div>
            </div>

            <!-- Models Panel -->
            <div x-show="expandedFilter === 'models'">
                <div class="flex flex-wrap gap-2">
                    <template
                        x-for="model in getFilteredModels()"
                        :key="model.provider + '/' + model.model"
                    >
                        <label class="cursor-pointer">
                            <input
                                type="checkbox"
                                :checked="filters.models.includes(model.model)"
                                @change="toggleFilter('models', model.model)"
                                class="hidden peer"
                            />
                            <span
                                class="badge badge-lg peer-checked:badge-secondary peer-checked:text-secondary-content hover:opacity-80 transition-opacity"
                            >
                                <span
                                    class="opacity-60"
                                    x-text="model.provider + '/'"
                                ></span
                                ><span x-text="model.model"></span>
                            </span>
                        </label>
                    </template>
                    <span
                        x-show="getFilteredModels().length === 0"
                        class="text-sm text-base-content/60"
                        >No models available</span
                    >
                </div>
            </div>

            <!-- Clients Panel -->
            <div x-show="expandedFilter === 'clients'">
                <div class="flex flex-wrap gap-2">
                    <template
                        x-for="client in filterOptions.clients"
                        :key="client"
                    >
                        <label class="cursor-pointer">
                            <input
                                type="checkbox"
                                :checked="filters.clients.includes(client)"
                                @change="toggleFilter('clients', client)"
                                class="hidden peer"
                            />
                            <span
                                class="badge badge-lg peer-checked:badge-warning peer-checked:text-warning-content hover:opacity-80 transition-opacity"
                                x-text="client"
                            ></span>
                        </label>
                    </template>
                    <span
                        x-show="filterOptions.clients.length === 0"
                        class="text-sm text-base-content/60"
                        >No clients available</span
                    >
                </div>
            </div>

            <!-- Aliases Panel -->
            <div x-show="expandedFilter === 'aliases'">
                <div class="flex flex-wrap gap-2">
                    <template
                        x-for="alias in filterOptions.aliases"
                        :key="alias"
                    >
                        <label class="cursor-pointer">
                            <input
                                type="checkbox"
                                :checked="filters.aliases.includes(alias)"
                                @change="toggleFilter('aliases', alias)"
                                class="hidden peer"
                            />
                            <span
                                class="badge badge-lg peer-checked:badge-accent peer-checked:text-accent-content hover:opacity-80 transition-opacity"
                                x-text="alias"
                            ></span>
                        </label>
                    </template>
                    <span
                        x-show="filterOptions.aliases.length === 0"
                        class="text-sm text-base-content/60"
                        >No aliases available</span
                    >
                </div>
            </div>
        </div>

        <!-- Active Filters Display -->
        <div x-show="hasActiveFilters()" class="flex flex-wrap gap-2 mt-3">
            <span class="text-sm text-base-content/60 self-center"
                >Active:</span
            >
            <template x-for="tag in filters.tags" :key="'tag-' + tag">
                <span class="badge badge-primary gap-1">
                    <span x-text="tag"></span>
                    <button
                        @click="removeFilter('tags', tag)"
                        class="hover:text-error"
                    >
                        ×
                    </button>
                </span>
            </template>
            <template
                x-for="provider in filters.providers"
                :key="'provider-' + provider"
            >
                <span class="badge badge-info gap-1">
                    <span x-text="provider"></span>
                    <button
                        @click="removeFilter('providers', provider)"
                        class="hover:text-error"
                    >
                        ×
                    </button>
                </span>
            </template>
            <template x-for="model in filters.models" :key="'model-' + model">
                <span class="badge badge-secondary gap-1">
                    <span x-text="model"></span>
                    <button
                        @click="removeFilter('models', model)"
                        class="hover:text-error"
                    >
                        ×
                    </button>
                </span>
            </template>
            <template
                x-for="client in filters.clients"
                :key="'client-' + client"
            >
                <span class="badge badge-warning gap-1">
                    <span x-text="client"></span>
                    <button
                        @click="removeFilter('clients', client)"
                        class="hover:text-error"
                    >
                        ×
                    </button>
                </span>
            </template>
            <template x-for="alias in filters.aliases" :key="'alias-' + alias">
                <span class="badge badge-accent gap-1">
                    <span x-text="alias"></span>
                    <button
                        @click="removeFilter('aliases', alias)"
                        class="hover:text-error"
                    >
                        ×
                    </button>
                </span>
            </template>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Total Requests -->
        <div class="card bg-base-100 shadow">
            <div class="card-body py-4">
                <div class="flex items-center justify-between">
                    <p class="text-sm text-base-content/60">Total Requests</p>
                    <div class="badge badge-primary badge-outline">
                        <span x-text="dateRange + 'd'"></span>
                    </div>
                </div>
                <p
                    class="text-2xl font-bold"
                    x-text="formatNumber(summary.total_requests)"
                >
                    -
                </p>
                <div class="text-xs text-base-content/60">
                    <span
                        class="text-success"
                        x-text="formatNumber(summary.success_count) + ' success'"
                    ></span>
                    <span
                        x-show="summary.error_count > 0"
                        class="text-error"
                        x-text="' / ' + formatNumber(summary.error_count) + ' errors'"
                    ></span>
                </div>
            </div>
        </div>
        <!-- Input Tokens -->
        <div class="card bg-base-100 shadow">
            <div class="card-body py-4">
                <p class="text-sm text-base-content/60">Input Tokens</p>
                <p
                    class="text-2xl font-bold"
                    x-text="formatTokens(summary.total_input_tokens)"
                >
                    -
                </p>
            </div>
        </div>
        <!-- Output Tokens -->
        <div class="card bg-base-100 shadow">
            <div class="card-body py-4">
                <p class="text-sm text-base-content/60">Output Tokens</p>
                <p
                    class="text-2xl font-bold"
                    x-text="formatTokens(summary.total_output_tokens)"
                >
                    -
                </p>
            </div>
        </div>
        <!-- Estimated Cost -->
        <div class="card bg-base-100 shadow">
            <div class="card-body py-4">
                <p class="text-sm text-base-content/60">Estimated Cost</p>
                <p
                    class="text-2xl font-bold text-warning"
                    x-text="'$' + summary.estimated_cost.toFixed(2)"
                >
                    -
                </p>
            </div>
        </div>
    </div>

    <!-- Time Series Chart -->
    <div class="card bg-base-100 shadow mb-6">
        <div class="card-body">
            <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4"
            >
                <h2 class="card-title">Usage Over Time</h2>
                <div class="join">
                    <button
                        @click="chartMetric = 'requests'; renderChart(); renderBreakdownCharts()"
                        :class="{'btn-active': chartMetric === 'requests'}"
                        class="btn btn-sm join-item"
                    >
                        Requests
                    </button>
                    <button
                        @click="chartMetric = 'tokens'; renderChart(); renderBreakdownCharts()"
                        :class="{'btn-active': chartMetric === 'tokens'}"
                        class="btn btn-sm join-item"
                    >
                        Tokens
                    </button>
                    <button
                        @click="chartMetric = 'cost'; renderChart(); renderBreakdownCharts()"
                        :class="{'btn-active': chartMetric === 'cost'}"
                        class="btn btn-sm join-item"
                    >
                        Cost
                    </button>
                </div>
            </div>
            <div id="usage-chart" style="height: 300px">
                <div
                    x-show="timeseries.length === 0"
                    class="flex items-center justify-center h-full text-base-content/60"
                >
                    No data available for the selected period
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs for breakdown tables -->
    <div class="tabs tabs-boxed mb-4 bg-base-100 p-1">
        <a
            @click="switchTab('tags')"
            :class="{'tab-active': activeTab === 'tags'}"
            class="tab"
            >By Tag</a
        >
        <a
            @click="switchTab('providers')"
            :class="{'tab-active': activeTab === 'providers'}"
            class="tab"
            >By Provider</a
        >
        <a
            @click="switchTab('models')"
            :class="{'tab-active': activeTab === 'models'}"
            class="tab"
            >By Model</a
        >
        <a
            @click="switchTab('clients')"
            :class="{'tab-active': activeTab === 'clients'}"
            class="tab"
            >By Client</a
        >
        <a
            @click="switchTab('aliases')"
            :class="{'tab-active': activeTab === 'aliases'}"
            class="tab"
            >By Alias</a
        >
    </div>

    <!-- By Tag Table -->
    <div x-show="activeTab === 'tags'" class="card bg-base-100 shadow">
        <div class="card-body">
            <h3 class="card-title">Usage by Tag</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- Breakdown Chart -->
                <div id="tag-chart" style="height: 300px">
                    <div
                        x-show="byTag.length === 0"
                        class="flex items-center justify-center h-full text-base-content/60"
                    >
                        No data available
                    </div>
                </div>
                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr>
                                <th
                                    @click="setSortColumn('tag', 'tag')"
                                    class="cursor-pointer hover:bg-base-200"
                                >
                                    Tag
                                    <span
                                        x-show="sortColumn === 'tag'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('tag', 'requests')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Requests
                                    <span
                                        x-show="sortColumn === 'requests'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('tag', 'total_tokens')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Tokens
                                    <span
                                        x-show="sortColumn === 'total_tokens'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('tag', 'cost')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Cost
                                    <span
                                        x-show="sortColumn === 'cost'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template
                                x-for="row in getSortedData(byTag, 'tag')"
                                :key="row.tag"
                            >
                                <tr
                                    @click="drillDown('tags', row.tag)"
                                    class="cursor-pointer hover:bg-primary/10"
                                >
                                    <td>
                                        <span
                                            class="badge badge-outline"
                                            x-text="row.tag"
                                        ></span>
                                    </td>
                                    <td
                                        class="text-right"
                                        x-text="formatNumber(row.requests)"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="formatTokens(row.total_tokens)"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="'$' + row.cost.toFixed(4)"
                                    ></td>
                                </tr>
                            </template>
                            <tr x-show="byTag.length === 0">
                                <td
                                    colspan="4"
                                    class="text-center text-base-content/60"
                                >
                                    No data available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- By Provider Table -->
    <div x-show="activeTab === 'providers'" class="card bg-base-100 shadow">
        <div class="card-body">
            <h3 class="card-title">Usage by Provider</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- Breakdown Chart -->
                <div id="provider-chart" style="height: 300px">
                    <div
                        x-show="byProvider.length === 0"
                        class="flex items-center justify-center h-full text-base-content/60"
                    >
                        No data available
                    </div>
                </div>
                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr>
                                <th
                                    @click="setSortColumn('provider', 'provider_id')"
                                    class="cursor-pointer hover:bg-base-200"
                                >
                                    Provider
                                    <span
                                        x-show="sortColumn === 'provider_id'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('provider', 'requests')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Requests
                                    <span
                                        x-show="sortColumn === 'requests'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th class="text-right">%</th>
                                <th
                                    @click="setSortColumn('provider', 'total_tokens')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Tokens
                                    <span
                                        x-show="sortColumn === 'total_tokens'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('provider', 'cost')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Cost
                                    <span
                                        x-show="sortColumn === 'cost'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template
                                x-for="row in getSortedData(byProvider, 'provider_id')"
                                :key="row.provider_id"
                            >
                                <tr
                                    @click="drillDown('providers', row.provider_id)"
                                    class="cursor-pointer hover:bg-info/10"
                                >
                                    <td>
                                        <span
                                            class="badge badge-info badge-outline"
                                            x-text="row.provider_id"
                                        ></span>
                                    </td>
                                    <td
                                        class="text-right"
                                        x-text="formatNumber(row.requests)"
                                    ></td>
                                    <td
                                        class="text-right text-base-content/60"
                                        x-text="getPercentage(row.requests, getTotalRequests(byProvider)) + '%'"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="formatTokens(row.total_tokens)"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="'$' + row.cost.toFixed(4)"
                                    ></td>
                                </tr>
                            </template>
                            <tr x-show="byProvider.length === 0">
                                <td
                                    colspan="5"
                                    class="text-center text-base-content/60"
                                >
                                    No data available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- By Model Table -->
    <div x-show="activeTab === 'models'" class="card bg-base-100 shadow">
        <div class="card-body">
            <h3 class="card-title">Usage by Model</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- Breakdown Chart -->
                <div id="model-chart" style="height: 300px">
                    <div
                        x-show="byModel.length === 0"
                        class="flex items-center justify-center h-full text-base-content/60"
                    >
                        No data available
                    </div>
                </div>
                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr>
                                <th
                                    @click="setSortColumn('model', 'provider_id')"
                                    class="cursor-pointer hover:bg-base-200"
                                >
                                    Provider
                                    <span
                                        x-show="sortColumn === 'provider_id'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('model', 'model_id')"
                                    class="cursor-pointer hover:bg-base-200"
                                >
                                    Model
                                    <span
                                        x-show="sortColumn === 'model_id'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('model', 'requests')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Requests
                                    <span
                                        x-show="sortColumn === 'requests'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th class="text-right">%</th>
                                <th
                                    @click="setSortColumn('model', 'total_tokens')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Tokens
                                    <span
                                        x-show="sortColumn === 'total_tokens'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('model', 'cost')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Cost
                                    <span
                                        x-show="sortColumn === 'cost'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template
                                x-for="row in getSortedData(byModel, 'model_id')"
                                :key="row.provider_id + '/' + row.model_id"
                            >
                                <tr
                                    @click="drillDown('models', row.model_id)"
                                    class="cursor-pointer hover:bg-secondary/10"
                                >
                                    <td>
                                        <span
                                            class="badge badge-info badge-outline badge-sm"
                                            x-text="row.provider_id"
                                        ></span>
                                    </td>
                                    <td
                                        class="font-mono text-sm max-w-40 truncate"
                                        x-text="row.model_id"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="formatNumber(row.requests)"
                                    ></td>
                                    <td
                                        class="text-right text-base-content/60"
                                        x-text="getPercentage(row.requests, getTotalRequests(byModel)) + '%'"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="formatTokens(row.total_tokens)"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="'$' + row.cost.toFixed(4)"
                                    ></td>
                                </tr>
                            </template>
                            <tr x-show="byModel.length === 0">
                                <td
                                    colspan="6"
                                    class="text-center text-base-content/60"
                                >
                                    No data available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- By Client Table -->
    <div x-show="activeTab === 'clients'" class="card bg-base-100 shadow">
        <div class="card-body">
            <h3 class="card-title">Usage by Client</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- Breakdown Chart -->
                <div id="client-chart" style="height: 300px">
                    <div
                        x-show="byClient.length === 0"
                        class="flex items-center justify-center h-full text-base-content/60"
                    >
                        No data available
                    </div>
                </div>
                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr>
                                <th
                                    @click="setSortColumn('client', 'client')"
                                    class="cursor-pointer hover:bg-base-200"
                                >
                                    Client
                                    <span
                                        x-show="sortColumn === 'client'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('client', 'requests')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Requests
                                    <span
                                        x-show="sortColumn === 'requests'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th class="text-right">%</th>
                                <th
                                    @click="setSortColumn('client', 'total_tokens')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Tokens
                                    <span
                                        x-show="sortColumn === 'total_tokens'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('client', 'cost')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Cost
                                    <span
                                        x-show="sortColumn === 'cost'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template
                                x-for="row in getSortedData(byClient, 'client')"
                                :key="row.client"
                            >
                                <tr
                                    @click="drillDown('clients', row.client)"
                                    class="cursor-pointer hover:bg-warning/10"
                                >
                                    <td>
                                        <span
                                            class="badge badge-warning badge-outline text-xs"
                                            x-text="row.client"
                                        ></span>
                                    </td>
                                    <td
                                        class="text-right"
                                        x-text="formatNumber(row.requests)"
                                    ></td>
                                    <td
                                        class="text-right text-base-content/60"
                                        x-text="getPercentage(row.requests, getTotalRequests(byClient)) + '%'"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="formatTokens(row.total_tokens)"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="'$' + row.cost.toFixed(4)"
                                    ></td>
                                </tr>
                            </template>
                            <tr x-show="byClient.length === 0">
                                <td
                                    colspan="5"
                                    class="text-center text-base-content/60"
                                >
                                    No data available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- By Alias Table -->
    <div x-show="activeTab === 'aliases'" class="card bg-base-100 shadow">
        <div class="card-body">
            <h3 class="card-title">Usage by Alias</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- Breakdown Chart -->
                <div id="alias-chart" style="height: 300px">
                    <div
                        x-show="byAlias.length === 0"
                        class="flex items-center justify-center h-full text-base-content/60"
                    >
                        No data available
                    </div>
                </div>
                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr>
                                <th
                                    @click="setSortColumn('alias', 'alias')"
                                    class="cursor-pointer hover:bg-base-200"
                                >
                                    Alias
                                    <span
                                        x-show="sortColumn === 'alias'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('alias', 'requests')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Requests
                                    <span
                                        x-show="sortColumn === 'requests'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th class="text-right">%</th>
                                <th
                                    @click="setSortColumn('alias', 'total_tokens')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Tokens
                                    <span
                                        x-show="sortColumn === 'total_tokens'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                                <th
                                    @click="setSortColumn('alias', 'cost')"
                                    class="text-right cursor-pointer hover:bg-base-200"
                                >
                                    Cost
                                    <span
                                        x-show="sortColumn === 'cost'"
                                        x-text="sortDirection === 'asc' ? ' ▲' : ' ▼'"
                                    ></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template
                                x-for="row in getSortedData(byAlias, 'alias')"
                                :key="row.alias"
                            >
                                <tr
                                    @click="drillDown('aliases', row.alias)"
                                    class="cursor-pointer hover:bg-accent/10"
                                >
                                    <td>
                                        <span
                                            class="badge badge-accent badge-outline"
                                            x-text="row.alias"
                                        ></span>
                                    </td>
                                    <td
                                        class="text-right"
                                        x-text="formatNumber(row.requests)"
                                    ></td>
                                    <td
                                        class="text-right text-base-content/60"
                                        x-text="getPercentage(row.requests, getTotalRequests(byAlias)) + '%'"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="formatTokens(row.total_tokens)"
                                    ></td>
                                    <td
                                        class="text-right"
                                        x-text="'$' + row.cost.toFixed(4)"
                                    ></td>
                                </tr>
                            </template>
                            <tr x-show="byAlias.length === 0">
                                <td
                                    colspan="5"
                                    class="text-center text-base-content/60"
                                >
                                    No data available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-transition class="toast toast-end" x-cloak>
        <div :class="'alert alert-' + toast.type">
            <span x-text="toast.message"></span>
        </div>
    </div>
</div>

<script>
    function usagePage() {
        return {
            // Date range state
            dateMode: 30, // 'today', 7, 30, 90, or 'custom'
            dateRange: 30,
            customStartDate: "",
            customEndDate: "",

            // Filter state
            filters: {
                tags: [],
                providers: [],
                models: [],
                clients: [],
                aliases: [],
            },
            filterOptions: {
                tags: [],
                providers: [],
                models: [],
                clients: [],
                aliases: [],
            },
            expandedFilter: null, // 'tags', 'providers', 'models', 'clients', or null

            // Sorting state
            sortColumn: "requests",
            sortDirection: "desc",
            sortTable: null,

            // Data
            summary: {
                total_requests: 0,
                total_input_tokens: 0,
                total_output_tokens: 0,
                estimated_cost: 0,
                success_count: 0,
                error_count: 0,
            },
            timeseries: [],
            byTag: [],
            byProvider: [],
            byModel: [],
            byClient: [],
            byAlias: [],

            // UI state
            activeTab: "tags",
            chartMetric: "requests",
            chart: null,
            tagChart: null,
            providerChart: null,
            modelChart: null,
            aliasChart: null,
            toast: { show: false, message: "", type: "info" },

            async init() {
                // Set default custom dates
                const today = new Date();
                const thirtyDaysAgo = new Date(
                    today - 30 * 24 * 60 * 60 * 1000,
                );
                this.customEndDate = today.toISOString().split("T")[0];
                this.customStartDate = thirtyDaysAgo
                    .toISOString()
                    .split("T")[0];

                await this.loadFilterOptions();
                await this.loadData();
            },

            // Date range methods
            setDatePreset(preset) {
                this.dateMode = preset;
                if (preset === "today") {
                    this.dateRange = 1;
                } else if (typeof preset === "number") {
                    this.dateRange = preset;
                }
                this.loadData();
            },

            toggleCustomDate() {
                this.dateMode = "custom";
            },

            buildQueryParams() {
                const params = new URLSearchParams();

                // Date params
                if (this.dateMode === "custom") {
                    if (this.customStartDate)
                        params.set("start", this.customStartDate);
                    if (this.customEndDate)
                        params.set("end", this.customEndDate);
                } else {
                    params.set("days", this.dateRange);
                }

                // Filter params
                if (this.filters.tags.length > 0) {
                    params.set("tags", this.filters.tags.join(","));
                }
                if (this.filters.providers.length > 0) {
                    params.set("providers", this.filters.providers.join(","));
                }
                if (this.filters.models.length > 0) {
                    params.set("models", this.filters.models.join(","));
                }
                if (this.filters.clients.length > 0) {
                    params.set("clients", this.filters.clients.join(","));
                }
                if (this.filters.aliases.length > 0) {
                    params.set("aliases", this.filters.aliases.join(","));
                }

                return params.toString();
            },

            // Tab switching with chart re-render
            switchTab(tab) {
                this.activeTab = tab;
                // Re-render charts after tab switch (needed for ECharts to size correctly)
                this.$nextTick(() => {
                    this.renderBreakdownCharts();
                });
            },

            // Filter methods
            async loadFilterOptions() {
                try {
                    const res = await fetch("/api/usage/filters");
                    if (res.ok) {
                        this.filterOptions = await res.json();
                    }
                } catch (e) {
                    console.error("Error loading filter options:", e);
                }
            },

            toggleFilter(type, value) {
                const idx = this.filters[type].indexOf(value);
                if (idx === -1) {
                    this.filters[type].push(value);
                } else {
                    this.filters[type].splice(idx, 1);
                }
                this.loadData();
            },

            removeFilter(type, value) {
                const idx = this.filters[type].indexOf(value);
                if (idx !== -1) {
                    this.filters[type].splice(idx, 1);
                    this.loadData();
                }
            },

            clearFilters() {
                this.filters.tags = [];
                this.filters.providers = [];
                this.filters.models = [];
                this.filters.clients = [];
                this.filters.aliases = [];
                this.loadData();
            },

            hasActiveFilters() {
                return (
                    this.filters.tags.length > 0 ||
                    this.filters.providers.length > 0 ||
                    this.filters.models.length > 0 ||
                    this.filters.clients.length > 0 ||
                    this.filters.aliases.length > 0
                );
            },

            getFilteredModels() {
                // If providers are selected, only show models from those providers
                if (this.filters.providers.length > 0) {
                    return this.filterOptions.models.filter((m) =>
                        this.filters.providers.includes(m.provider),
                    );
                }
                return this.filterOptions.models;
            },

            // Drill-down
            drillDown(type, value) {
                if (!this.filters[type].includes(value)) {
                    this.filters[type].push(value);
                    this.loadData();
                }
            },

            // Sorting methods
            setSortColumn(table, column) {
                if (this.sortTable === table && this.sortColumn === column) {
                    this.sortDirection =
                        this.sortDirection === "asc" ? "desc" : "asc";
                } else {
                    this.sortTable = table;
                    this.sortColumn = column;
                    this.sortDirection = "desc";
                }
            },

            getSortedData(data, defaultKey) {
                if (!data || data.length === 0) return [];
                const sorted = [...data].sort((a, b) => {
                    let aVal = a[this.sortColumn] ?? a[defaultKey];
                    let bVal = b[this.sortColumn] ?? b[defaultKey];
                    if (typeof aVal === "string") {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    if (aVal < bVal)
                        return this.sortDirection === "asc" ? -1 : 1;
                    if (aVal > bVal)
                        return this.sortDirection === "asc" ? 1 : -1;
                    return 0;
                });
                return sorted;
            },

            // Helper methods
            getTotalRequests(data) {
                return data.reduce((sum, row) => sum + (row.requests || 0), 0);
            },

            getPercentage(value, total) {
                if (!total || total === 0) return 0;
                return ((value / total) * 100).toFixed(1);
            },

            async loadData() {
                await Promise.all([
                    this.loadSummary(),
                    this.loadTimeseries(),
                    this.loadByTag(),
                    this.loadByProvider(),
                    this.loadByModel(),
                    this.loadByClient(),
                    this.loadByAlias(),
                ]);
                this.renderChart();
                this.renderBreakdownCharts();
            },

            async loadSummary() {
                try {
                    const res = await fetch(
                        `/api/usage/summary?${this.buildQueryParams()}`,
                    );
                    if (res.ok) this.summary = await res.json();
                } catch (e) {
                    console.error("Error loading summary:", e);
                }
            },

            async loadTimeseries() {
                try {
                    const res = await fetch(
                        `/api/usage/timeseries?${this.buildQueryParams()}`,
                    );
                    if (res.ok) this.timeseries = await res.json();
                } catch (e) {
                    console.error("Error loading timeseries:", e);
                }
            },

            async loadByTag() {
                try {
                    const res = await fetch(
                        `/api/usage/by-tag?${this.buildQueryParams()}`,
                    );
                    if (res.ok) this.byTag = await res.json();
                } catch (e) {
                    console.error("Error loading by-tag:", e);
                }
            },

            async loadByProvider() {
                try {
                    const res = await fetch(
                        `/api/usage/by-provider?${this.buildQueryParams()}`,
                    );
                    if (res.ok) this.byProvider = await res.json();
                } catch (e) {
                    console.error("Error loading by-provider:", e);
                }
            },

            async loadByModel() {
                try {
                    const res = await fetch(
                        `/api/usage/by-model?${this.buildQueryParams()}`,
                    );
                    if (res.ok) this.byModel = await res.json();
                } catch (e) {
                    console.error("Error loading by-model:", e);
                }
            },

            async loadByClient() {
                try {
                    const res = await fetch(
                        `/api/usage/by-client?${this.buildQueryParams()}`,
                    );
                    if (res.ok) this.byClient = await res.json();
                } catch (e) {
                    console.error("Error loading by-client:", e);
                }
            },

            async loadByAlias() {
                try {
                    const res = await fetch(
                        `/api/usage/by-alias?${this.buildQueryParams()}`,
                    );
                    if (res.ok) this.byAlias = await res.json();
                } catch (e) {
                    console.error("Error loading by-alias:", e);
                }
            },

            renderChart() {
                if (this.timeseries.length === 0) return;

                const chartDom = document.getElementById("usage-chart");
                const theme = this.getEChartsTheme();
                if (!this.chart) {
                    this.chart = echarts.init(chartDom, theme);
                } else if (this.chart._theme !== theme) {
                    // Theme changed, recreate chart
                    this.chart.dispose();
                    this.chart = echarts.init(chartDom, theme);
                }

                const metricLabels = {
                    requests: "Requests",
                    tokens: "Tokens",
                    cost: "Cost ($)",
                };
                const data = this.timeseries.map((d) => ({
                    date: d.date,
                    value:
                        this.chartMetric === "cost"
                            ? d.cost
                            : d[this.chartMetric],
                }));

                const option = {
                    backgroundColor: "transparent",
                    tooltip: {
                        trigger: "axis",
                        formatter: (params) => {
                            const d = params[0];
                            let val = d.value;
                            if (this.chartMetric === "cost")
                                val = "$" + val.toFixed(4);
                            else if (this.chartMetric === "tokens")
                                val = this.formatTokens(val);
                            else val = this.formatNumber(val);
                            return `${d.name}<br/>${metricLabels[this.chartMetric]}: ${val}`;
                        },
                    },
                    grid: {
                        left: "3%",
                        right: "4%",
                        bottom: "3%",
                        containLabel: true,
                    },
                    xAxis: {
                        type: "category",
                        data: data.map((d) => d.date),
                    },
                    yAxis: {
                        type: "value",
                        axisLabel: {
                            formatter: (val) => {
                                if (this.chartMetric === "cost")
                                    return "$" + val.toFixed(2);
                                if (
                                    this.chartMetric === "tokens" &&
                                    val >= 1000000
                                )
                                    return (val / 1000000).toFixed(1) + "M";
                                if (val >= 1000)
                                    return (val / 1000).toFixed(0) + "K";
                                return val;
                            },
                        },
                    },
                    series: [
                        {
                            data: data.map((d) => d.value),
                            type: "bar",
                            itemStyle: {
                                color:
                                    this.chartMetric === "cost"
                                        ? "#f59e0b"
                                        : this.chartMetric === "tokens"
                                          ? "#3b82f6"
                                          : "#22c55e",
                            },
                        },
                    ],
                };
                this.chart.setOption(option);
            },

            renderBreakdownCharts() {
                // Map chartMetric to data field
                const metricField =
                    this.chartMetric === "tokens"
                        ? "total_tokens"
                        : this.chartMetric === "cost"
                          ? "cost"
                          : "requests";
                const metricColor =
                    this.chartMetric === "cost"
                        ? "#f59e0b"
                        : this.chartMetric === "tokens"
                          ? "#3b82f6"
                          : "#22c55e";

                // Only render charts for visible tabs to ensure proper sizing
                if (this.activeTab === "tags") {
                    this.renderBreakdownChart(
                        "tag-chart",
                        this.byTag,
                        "tag",
                        metricField,
                        metricColor,
                        false,
                    );
                }
                if (this.activeTab === "providers") {
                    this.renderBreakdownChart(
                        "provider-chart",
                        this.byProvider,
                        "provider_id",
                        metricField,
                        metricColor,
                        true,
                    );
                }
                if (this.activeTab === "models") {
                    this.renderBreakdownChart(
                        "model-chart",
                        this.byModel,
                        "model_id",
                        metricField,
                        metricColor,
                        true,
                    );
                }
                if (this.activeTab === "clients") {
                    this.renderBreakdownChart(
                        "client-chart",
                        this.byClient,
                        "client",
                        metricField,
                        metricColor,
                        true,
                    );
                }
                if (this.activeTab === "aliases") {
                    this.renderBreakdownChart(
                        "alias-chart",
                        this.byAlias,
                        "alias",
                        metricField,
                        metricColor,
                        true,
                    );
                }
            },

            renderBreakdownChart(
                containerId,
                data,
                labelKey,
                valueKey,
                color,
                showPercentage = true,
            ) {
                if (!data || data.length === 0) return;

                const chartDom = document.getElementById(containerId);
                if (!chartDom) return;

                const theme = this.getEChartsTheme();
                let chart = echarts.getInstanceByDom(chartDom);
                if (!chart) {
                    chart = echarts.init(chartDom, theme);
                } else if (chart._theme !== theme) {
                    // Theme changed, recreate chart
                    chart.dispose();
                    chart = echarts.init(chartDom, theme);
                }

                // Take top 10 and aggregate rest as "Other"
                const sorted = [...data].sort(
                    (a, b) => (b[valueKey] || 0) - (a[valueKey] || 0),
                );
                const top10 = sorted.slice(0, 10);
                const other = sorted.slice(10);
                const otherSum = other.reduce(
                    (sum, item) => sum + (item[valueKey] || 0),
                    0,
                );

                // Build data for horizontal bar chart (reversed for top-to-bottom display)
                const labels = top10.map((item) => item[labelKey]).reverse();
                const values = top10
                    .map((item) => item[valueKey] || 0)
                    .reverse();
                if (otherSum > 0) {
                    labels.unshift("Other");
                    values.unshift(otherSum);
                }

                const total = values.reduce((sum, v) => sum + v, 0);

                // Determine metric label and formatter
                const metricLabels = {
                    requests: "Requests",
                    total_tokens: "Tokens",
                    cost: "Cost",
                };
                const metricLabel = metricLabels[valueKey] || "Value";
                const isCost = valueKey === "cost";
                const isTokens = valueKey === "total_tokens";

                const formatValue = (val) => {
                    if (isCost) return "$" + val.toFixed(4);
                    if (val >= 1000000) return (val / 1000000).toFixed(1) + "M";
                    if (val >= 1000) return (val / 1000).toFixed(1) + "K";
                    return this.formatNumber(val);
                };

                const option = {
                    backgroundColor: "transparent",
                    tooltip: {
                        trigger: "axis",
                        axisPointer: { type: "shadow" },
                        formatter: (params) => {
                            const d = params[0];
                            const pct =
                                total > 0
                                    ? ((d.value / total) * 100).toFixed(1)
                                    : 0;
                            return `${d.name}<br/>${metricLabel}: ${formatValue(d.value)} (${pct}%)`;
                        },
                    },
                    grid: {
                        left: "3%",
                        right: "15%",
                        top: "3%",
                        bottom: "3%",
                        containLabel: true,
                    },
                    xAxis: {
                        type: "value",
                        axisLabel: {
                            formatter: (val) => {
                                if (isCost) return "$" + val.toFixed(2);
                                if (val >= 1000000)
                                    return (val / 1000000).toFixed(1) + "M";
                                if (val >= 1000)
                                    return (val / 1000).toFixed(0) + "K";
                                return val;
                            },
                        },
                    },
                    yAxis: {
                        type: "category",
                        data: labels,
                        axisLabel: {
                            width: 100,
                            overflow: "truncate",
                            ellipsis: "...",
                        },
                    },
                    series: [
                        {
                            type: "bar",
                            data: values,
                            itemStyle: {
                                color: color,
                                borderRadius: [0, 4, 4, 0],
                            },
                            label: {
                                show: showPercentage,
                                position: "right",
                                formatter: (params) => {
                                    const pct =
                                        total > 0
                                            ? (
                                                  (params.value / total) *
                                                  100
                                              ).toFixed(1)
                                            : 0;
                                    return `${pct}%`;
                                },
                            },
                        },
                    ],
                };

                chart.setOption(option, true);
            },

            // Get current theme for ECharts (null for light, 'dark' for dark)
            getEChartsTheme() {
                const dataTheme =
                    document.documentElement.getAttribute("data-theme");
                return dataTheme === "dark" ? "dark" : null;
            },

            formatNumber(n) {
                if (n === undefined || n === null) return "-";
                return n.toLocaleString();
            },

            formatTokens(n) {
                if (n === undefined || n === null) return "-";
                if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
                if (n >= 1000) return (n / 1000).toFixed(1) + "K";
                return n.toString();
            },

            formatTime(iso) {
                if (!iso) return "-";
                const d = new Date(iso);
                return d.toLocaleString();
            },

            // Check if a log entry has extended token data
            hasExtendedTokens(log) {
                return (
                    log.reasoning_tokens ||
                    log.cached_input_tokens ||
                    log.cache_creation_tokens ||
                    log.cache_read_tokens
                );
            },

            // Format tooltip showing token breakdown
            formatTokenTooltip(log) {
                let parts = [
                    `In: ${log.input_tokens}`,
                    `Out: ${log.output_tokens}`,
                ];

                // OpenAI reasoning tokens (o1/o3 models)
                if (log.reasoning_tokens) {
                    parts.push(`Reasoning: ${log.reasoning_tokens}`);
                }

                // OpenAI cached input tokens
                if (log.cached_input_tokens) {
                    parts.push(`Cached: ${log.cached_input_tokens}`);
                }

                // Anthropic cache creation tokens
                if (log.cache_creation_tokens) {
                    parts.push(`Cache Write: ${log.cache_creation_tokens}`);
                }

                // Anthropic cache read tokens
                if (log.cache_read_tokens) {
                    parts.push(`Cache Read: ${log.cache_read_tokens}`);
                }

                return parts.join(" | ");
            },

            showToast(message, type = "info") {
                this.toast = { show: true, message, type };
                setTimeout(() => {
                    this.toast.show = false;
                }, 3000);
            },
        };
    }
</script>
{% endblock %}
