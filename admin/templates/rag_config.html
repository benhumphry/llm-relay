{% extends "base.html" %} {% block title %}RAG Configuration{% endblock %} {%
block content %}
<div x-data="ragConfigPage()" x-init="loadSettings()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold">RAG Configuration</h1>
        <p class="text-base-content/60">
            Configure embeddings, reranking, and document vision for RAG
            pipelines
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Embedding Settings -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Embeddings</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Vector embeddings for document stores and semantic search
                </p>

                <div class="space-y-4">
                    <!-- Embedding Provider -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Embedding Provider</span>
                            <template
                                x-if="settings.embedding_provider === 'local'"
                            >
                                <span
                                    class="badge badge-sm"
                                    :class="settings.gpu_available ? 'badge-success' : 'badge-warning'"
                                    x-text="settings.gpu_available ? 'GPU: ' + settings.gpu_name : 'CPU'"
                                ></span>
                            </template>
                        </label>
                        <select
                            x-model="settings.embedding_provider"
                            @change="onEmbeddingProviderChange()"
                            class="select select-bordered"
                        >
                            <option value="local">
                                Local (BAAI/bge-small-en-v1.5)
                            </option>
                            <option
                                x-show="embeddingModels.ollama?.available"
                                value="ollama"
                            >
                                Ollama
                            </option>
                            <template
                                x-for="provider in embeddingModels.providers || []"
                                :key="provider.name"
                            >
                                <option
                                    :value="provider.name"
                                    x-text="provider.name"
                                ></option>
                            </template>
                        </select>
                    </div>

                    <!-- Ollama Instance & Model -->
                    <template
                        x-if="settings.embedding_provider === 'ollama' && embeddingModels.ollama?.available"
                    >
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Ollama Instance</span
                                    >
                                </label>
                                <select
                                    x-model="settings.embedding_ollama_instance"
                                    @change="onEmbeddingOllamaInstanceChange()"
                                    class="select select-bordered"
                                >
                                    <template
                                        x-for="instance in embeddingModels.ollama.instances"
                                        :key="instance.name"
                                    >
                                        <option
                                            :value="instance.name"
                                            x-text="instance.name + ' (' + instance.url + ')'"
                                        ></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Embedding Model</span
                                    >
                                </label>
                                <select
                                    x-model="settings.embedding_model"
                                    class="select select-bordered"
                                >
                                    <template
                                        x-for="model in currentOllamaEmbeddingModels"
                                        :key="model"
                                    >
                                        <option
                                            :value="model"
                                            x-text="model"
                                        ></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                    </template>

                    <!-- Provider Embedding Model -->
                    <template
                        x-if="settings.embedding_provider !== 'local' && settings.embedding_provider !== 'ollama'"
                    >
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Embedding Model</span>
                            </label>
                            <select
                                x-model="settings.embedding_model"
                                class="select select-bordered"
                            >
                                <template
                                    x-for="model in currentProviderEmbeddingModels"
                                    :key="model"
                                >
                                    <option
                                        :value="model"
                                        x-text="model"
                                    ></option>
                                </template>
                            </select>
                        </div>
                    </template>

                    <!-- Local Embedding Info -->
                    <template x-if="settings.embedding_provider === 'local'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Uses bundled BAAI/bge-small-en-v1.5 model (~130MB).
                            No external dependencies required.
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Reranking Settings -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Reranking</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Rerank retrieved documents for better relevance
                </p>

                <div class="space-y-4">
                    <!-- Rerank Provider -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Rerank Provider</span>
                            <template
                                x-if="settings.rerank_provider === 'local'"
                            >
                                <span
                                    class="badge badge-sm"
                                    :class="settings.gpu_available ? 'badge-success' : 'badge-warning'"
                                    x-text="settings.gpu_available ? 'GPU: ' + settings.gpu_name : 'CPU'"
                                ></span>
                            </template>
                        </label>
                        <select
                            x-model="settings.rerank_provider"
                            class="select select-bordered"
                        >
                            <option value="local">Local (cross-encoder)</option>
                            <option value="jina">
                                Jina Reranker (requires API key)
                            </option>
                        </select>
                    </div>

                    <!-- Jina Warning -->
                    <template
                        x-if="settings.rerank_provider === 'jina' && !settings.jina_api_configured"
                    >
                        <div class="alert alert-warning py-2">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                                />
                            </svg>
                            <span class="text-sm"
                                >Jina reranker requires JINA_API_KEY to be
                                set</span
                            >
                        </div>
                    </template>

                    <!-- Local Rerank Model -->
                    <template x-if="settings.rerank_provider === 'local'">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Rerank Model</span>
                            </label>
                            <select
                                x-model="settings.rerank_model"
                                class="select select-bordered"
                            >
                                <option
                                    value="cross-encoder/ms-marco-MiniLM-L-6-v2"
                                >
                                    ms-marco-MiniLM-L-6-v2 (fast)
                                </option>
                                <option
                                    value="cross-encoder/ms-marco-TinyBERT-L-2-v2"
                                >
                                    ms-marco-TinyBERT-L-2-v2 (fastest)
                                </option>
                                <option value="BAAI/bge-reranker-base">
                                    bge-reranker-base (accurate)
                                </option>
                            </select>
                        </div>
                    </template>

                    <!-- Local Rerank Info -->
                    <template x-if="settings.rerank_provider === 'local'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Cross-encoder models run locally. GPU recommended
                            for large document sets.
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Vision Settings -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Document Vision</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Vision provider for parsing PDFs and images in documents
                </p>

                <div class="space-y-4">
                    <!-- Vision Provider -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Vision Provider</span>
                            <template
                                x-if="settings.vision_provider === 'local'"
                            >
                                <span
                                    class="badge badge-sm"
                                    :class="settings.gpu_available ? 'badge-success' : 'badge-warning'"
                                    x-text="settings.gpu_available ? 'GPU: ' + settings.gpu_name : 'CPU'"
                                ></span>
                            </template>
                        </label>
                        <select
                            x-model="settings.vision_provider"
                            @change="onVisionProviderChange()"
                            class="select select-bordered"
                        >
                            <option value="local">
                                Local (Docling default)
                            </option>
                            <option
                                x-show="visionModels.ollama?.available"
                                value="ollama"
                            >
                                Ollama
                            </option>
                            <template
                                x-for="provider in visionModels.providers || []"
                                :key="provider.name"
                            >
                                <option
                                    :value="provider.name"
                                    x-text="provider.name"
                                ></option>
                            </template>
                        </select>
                    </div>

                    <!-- Ollama Vision Instance & Model -->
                    <template
                        x-if="settings.vision_provider === 'ollama' && visionModels.ollama?.available"
                    >
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Ollama Instance</span
                                    >
                                </label>
                                <select
                                    x-model="settings.vision_ollama_instance"
                                    @change="onVisionOllamaInstanceChange()"
                                    class="select select-bordered"
                                >
                                    <template
                                        x-for="instance in visionModels.ollama.instances"
                                        :key="instance.name"
                                    >
                                        <option
                                            :value="instance.name"
                                            x-text="instance.name + ' (' + instance.url + ')'"
                                        ></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Vision Model</span>
                                </label>
                                <select
                                    x-model="settings.vision_model"
                                    class="select select-bordered"
                                >
                                    <template
                                        x-for="model in currentOllamaVisionModels"
                                        :key="model.id || model"
                                    >
                                        <option
                                            :value="model.id || model"
                                            x-text="model.name || model"
                                        ></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                    </template>

                    <!-- Provider Vision Model -->
                    <template
                        x-if="settings.vision_provider !== 'local' && settings.vision_provider !== 'ollama'"
                    >
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Vision Model</span>
                            </label>
                            <select
                                x-model="settings.vision_model"
                                class="select select-bordered"
                            >
                                <template
                                    x-for="model in currentProviderVisionModels"
                                    :key="model.id || model"
                                >
                                    <option
                                        :value="model.id || model"
                                        x-text="model.name || model"
                                    ></option>
                                </template>
                            </select>
                        </div>
                    </template>

                    <!-- Local Vision Info -->
                    <template x-if="settings.vision_provider === 'local'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Uses bundled Docling models for document parsing.
                            Runs on CPU/GPU.
                        </div>
                    </template>

                    <!-- RAG PDF Parser -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">RAG PDF Parser</span>
                        </label>
                        <select
                            x-model="settings.rag_pdf_parser"
                            class="select select-bordered"
                        >
                            <option value="docling">
                                Docling (with Vision model)
                            </option>
                            <option value="pypdf">
                                PyPDF (fast, text-only)
                            </option>
                        </select>
                        <label class="label">
                            <span class="label-text-alt text-base-content/60">
                                <template
                                    x-if="settings.rag_pdf_parser === 'docling'"
                                >
                                    <span
                                        >Uses Vision model above. Best for
                                        scanned docs.</span
                                    >
                                </template>
                                <template
                                    x-if="settings.rag_pdf_parser === 'pypdf'"
                                >
                                    <span
                                        >Fast text extraction. Won't work on
                                        scanned documents.</span
                                    >
                                </template>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Store Intelligence -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Document Intelligence</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Auto-generate themes and summaries for document stores after
                    indexing
                </p>

                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Intelligence Model</span>
                        </label>
                        <select
                            x-model="settings.docstore_intelligence_model"
                            class="select select-bordered"
                        >
                            <option value="">
                                Disabled (no auto-intelligence)
                            </option>
                            <template
                                x-for="model in availableModels"
                                :key="model.id"
                            >
                                <option
                                    :value="model.id"
                                    x-text="model.id"
                                ></option>
                            </template>
                        </select>
                        <label class="label">
                            <span class="label-text-alt text-base-content/60">
                                Model used to analyze indexed content and
                                generate themes
                            </span>
                        </label>
                    </div>

                    <div
                        class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                    >
                        When enabled, after indexing completes, the system
                        samples document chunks and generates:<br />
                        <span class="font-medium">Themes</span> - Main topics
                        covered<br />
                        <span class="font-medium">Best For</span> - Ideal
                        question types<br />
                        <span class="font-medium">Summary</span> - Content
                        overview<br />
                        <br />
                        This helps Smart Aliases choose the right document
                        stores for queries.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="mt-6">
        <button
            @click="saveSettings()"
            class="btn btn-primary"
            :class="{ 'loading': saving }"
            :disabled="saving"
        >
            Save Settings
        </button>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-transition class="toast toast-end" x-cloak>
        <div :class="'alert alert-' + toast.type">
            <span x-text="toast.message"></span>
        </div>
    </div>
</div>

<script>
    function ragConfigPage() {
        return {
            settings: {
                gpu_available: false,
                gpu_name: "",
                jina_api_configured: false,
                embedding_provider: "local",
                embedding_model: "",
                embedding_ollama_instance: "",
                rerank_provider: "local",
                rerank_model: "cross-encoder/ms-marco-MiniLM-L-6-v2",
                vision_provider: "local",
                vision_model: "",
                vision_ollama_instance: "",
                rag_pdf_parser: "docling",
                docstore_intelligence_model: "",
            },
            embeddingModels: {},
            visionModels: {},
            availableModels: [],
            currentOllamaEmbeddingModels: [],
            currentProviderEmbeddingModels: [],
            currentOllamaVisionModels: [],
            currentProviderVisionModels: [],
            saving: false,
            toast: { show: false, message: "", type: "info" },

            async loadSettings() {
                try {
                    // Load web settings (contains RAG config)
                    const webRes = await fetch("/api/settings/web");
                    if (webRes.ok) {
                        const webData = await webRes.json();
                        this.settings.jina_api_configured =
                            webData.jina_api_configured || false;
                        this.settings.gpu_available =
                            webData.gpu_available || false;
                        this.settings.gpu_name = webData.gpu_name || "";
                        this.settings.embedding_provider =
                            webData.embedding_provider || "local";
                        this.settings.embedding_model =
                            webData.embedding_model || "";
                        this.settings.embedding_ollama_instance =
                            webData.embedding_ollama_instance || "";
                        this.settings.rerank_provider =
                            webData.rerank_provider || "local";
                        this.settings.rerank_model =
                            webData.rerank_model ||
                            "cross-encoder/ms-marco-MiniLM-L-6-v2";
                        this.settings.vision_provider =
                            webData.vision_provider || "local";
                        this.settings.rag_pdf_parser =
                            webData.rag_pdf_parser || "docling";
                        // Handle corrupted data where vision_model might be an object
                        const vm = webData.vision_model;
                        this.settings.vision_model =
                            typeof vm === "object" && vm !== null
                                ? vm.id || vm.name || ""
                                : vm || "";
                        // Store URLs temporarily - will map to instance names after loading models
                        this._vision_ollama_url =
                            webData.vision_ollama_url || "";
                        this._embedding_ollama_url =
                            webData.embedding_ollama_url || "";
                        this.settings.docstore_intelligence_model =
                            webData.docstore_intelligence_model || "";
                    }

                    // Load available models for intelligence
                    const savedIntelligenceModel =
                        this.settings.docstore_intelligence_model;
                    const modelsRes = await fetch("/api/models");
                    if (modelsRes.ok) {
                        const modelsData = await modelsRes.json();
                        // API returns array with {id, provider_id, ...} - transform to {id: "provider/model"} format
                        this.availableModels = (
                            Array.isArray(modelsData) ? modelsData : []
                        )
                            .filter((m) => m.enabled !== false)
                            .map((m) => ({
                                id: `${m.provider_id}/${m.id}`,
                            }));
                    }
                    // Load embedding models
                    const embedRes = await fetch(
                        "/api/settings/embedding-models",
                    );
                    if (embedRes.ok) {
                        this.embeddingModels = await embedRes.json();
                        // Map URL to instance name
                        if (this._embedding_ollama_url) {
                            const instance =
                                this.embeddingModels.ollama?.instances?.find(
                                    (i) => i.url === this._embedding_ollama_url,
                                );
                            this.settings.embedding_ollama_instance =
                                instance?.name || "";
                        }
                        this.updateEmbeddingModelLists();
                    }

                    // Load vision models
                    const visionRes = await fetch(
                        "/api/settings/vision-models",
                    );
                    if (visionRes.ok) {
                        this.visionModels = await visionRes.json();
                        // Map URL to instance name
                        if (this._vision_ollama_url) {
                            const instance =
                                this.visionModels.ollama?.instances?.find(
                                    (i) => i.url === this._vision_ollama_url,
                                );
                            this.settings.vision_ollama_instance =
                                instance?.name || "";
                        }
                        this.updateVisionModelLists();
                    }

                    // Restore saved intelligence model after all data is loaded
                    // Must wait for Alpine to render template options, then set via DOM
                    this.$nextTick(() => {
                        if (savedIntelligenceModel) {
                            const select = document.querySelector(
                                'select[x-model="settings.docstore_intelligence_model"]',
                            );
                            if (select) {
                                select.value = savedIntelligenceModel;
                                select.dispatchEvent(new Event("change"));
                            }
                        }
                    });
                } catch (error) {
                    console.error("Error loading settings:", error);
                    this.showToast("Failed to load settings", "error");
                }
            },

            updateEmbeddingModelLists() {
                // Update Ollama embedding models
                if (
                    this.embeddingModels.ollama?.available &&
                    this.settings.embedding_ollama_instance
                ) {
                    const instance = this.embeddingModels.ollama.instances.find(
                        (i) =>
                            i.name === this.settings.embedding_ollama_instance,
                    );
                    this.currentOllamaEmbeddingModels =
                        instance?.embedding_models || [];
                }
                // Update provider embedding models
                if (
                    this.settings.embedding_provider &&
                    this.settings.embedding_provider !== "local" &&
                    this.settings.embedding_provider !== "ollama"
                ) {
                    const provider = this.embeddingModels.providers?.find(
                        (p) => p.name === this.settings.embedding_provider,
                    );
                    this.currentProviderEmbeddingModels =
                        provider?.models || [];
                }
            },

            updateVisionModelLists() {
                // Update Ollama vision models
                if (
                    this.visionModels.ollama?.available &&
                    this.settings.vision_ollama_instance
                ) {
                    const instance = this.visionModels.ollama.instances.find(
                        (i) => i.name === this.settings.vision_ollama_instance,
                    );
                    this.currentOllamaVisionModels =
                        instance?.vision_models || [];
                }
                // Update provider vision models
                if (
                    this.settings.vision_provider &&
                    this.settings.vision_provider !== "local" &&
                    this.settings.vision_provider !== "ollama"
                ) {
                    const provider = this.visionModels.providers?.find(
                        (p) => p.name === this.settings.vision_provider,
                    );
                    this.currentProviderVisionModels = provider?.models || [];
                }
            },

            onEmbeddingProviderChange() {
                this.settings.embedding_model = "";
                this.settings.embedding_ollama_instance = "";
                if (
                    this.settings.embedding_provider === "ollama" &&
                    this.embeddingModels.ollama?.instances?.length > 0
                ) {
                    this.settings.embedding_ollama_instance =
                        this.embeddingModels.ollama.instances[0].name;
                    this.onEmbeddingOllamaInstanceChange();
                }
                this.updateEmbeddingModelLists();
            },

            onEmbeddingOllamaInstanceChange() {
                this.updateEmbeddingModelLists();
                if (this.currentOllamaEmbeddingModels.length > 0) {
                    const model = this.currentOllamaEmbeddingModels[0];
                    this.settings.embedding_model = model.id || model;
                }
            },

            onVisionProviderChange() {
                this.settings.vision_model = "";
                this.settings.vision_ollama_instance = "";
                if (
                    this.settings.vision_provider === "ollama" &&
                    this.visionModels.ollama?.instances?.length > 0
                ) {
                    this.settings.vision_ollama_instance =
                        this.visionModels.ollama.instances[0].name;
                    this.onVisionOllamaInstanceChange();
                }
                this.updateVisionModelLists();
            },

            onVisionOllamaInstanceChange() {
                this.updateVisionModelLists();
                if (this.currentOllamaVisionModels.length > 0) {
                    const model = this.currentOllamaVisionModels[0];
                    this.settings.vision_model = model.id || model;
                }
            },

            async saveSettings() {
                this.saving = true;
                try {
                    // Extract model IDs if they're objects (safeguard)
                    const getModelId = (model) =>
                        typeof model === "object" && model !== null
                            ? model.id || model.name || ""
                            : model || "";

                    // Convert instance names to URLs for backend
                    const getOllamaUrl = (instanceName, modelList) => {
                        if (!instanceName || !modelList?.ollama?.instances)
                            return "";
                        const instance = modelList.ollama.instances.find(
                            (i) => i.name === instanceName,
                        );
                        return instance?.url || "";
                    };

                    const response = await fetch("/api/settings/web", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            embedding_provider:
                                this.settings.embedding_provider,
                            embedding_model: getModelId(
                                this.settings.embedding_model,
                            ),
                            embedding_ollama_url: getOllamaUrl(
                                this.settings.embedding_ollama_instance,
                                this.embeddingModels,
                            ),
                            rerank_provider: this.settings.rerank_provider,
                            rerank_model: this.settings.rerank_model,
                            vision_provider: this.settings.vision_provider,
                            vision_model: getModelId(
                                this.settings.vision_model,
                            ),
                            vision_ollama_url: getOllamaUrl(
                                this.settings.vision_ollama_instance,
                                this.visionModels,
                            ),
                            rag_pdf_parser: this.settings.rag_pdf_parser,
                            docstore_intelligence_model:
                                this.settings.docstore_intelligence_model ||
                                null,
                        }),
                    });

                    if (response.ok) {
                        this.showToast(
                            "Settings saved successfully",
                            "success",
                        );
                    } else {
                        const data = await response.json();
                        this.showToast(
                            data.error || "Failed to save settings",
                            "error",
                        );
                    }
                } catch (error) {
                    console.error("Error saving settings:", error);
                    this.showToast("Failed to save settings", "error");
                }
                this.saving = false;
            },

            showToast(message, type = "info") {
                this.toast = { show: true, message, type };
                setTimeout(() => {
                    this.toast.show = false;
                }, 3000);
            },
        };
    }
</script>
{% endblock %}
