{% extends "base.html" %} {% block title %}Settings{% endblock %} {% block
content %}
<div x-data="settingsPage()" x-init="loadSettings()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold">Settings</h1>
        <p class="text-base-content/60">
            Configure proxy settings and defaults
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Default Model -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Default Model</h2>
                <p class="text-sm text-base-content/60 mb-2">
                    Fallback model used when an unknown model is requested
                </p>

                <!-- Current default display -->
                <div
                    x-show="settings.default_provider && settings.default_model"
                    class="alert alert-info mb-4 py-2"
                >
                    <span class="text-sm">
                        Current default:
                        <strong
                            x-text="settings.default_provider + '/' + settings.default_model"
                        ></strong>
                    </span>
                </div>
                <div
                    x-show="!settings.default_provider || !settings.default_model"
                    class="alert mb-4 py-2"
                >
                    <span class="text-sm text-base-content/60"
                        >No default model configured</span
                    >
                </div>

                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Provider</span>
                        </label>
                        <select
                            x-model="settings.default_provider"
                            @change="loadProviderModels()"
                            class="select select-bordered"
                        >
                            <option value="">Select provider</option>
                            <template x-for="p in providers" :key="p.id">
                                <option :value="p.id" x-text="p.id"></option>
                            </template>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Model</span>
                        </label>
                        <select
                            x-model="settings.default_model"
                            class="select select-bordered"
                        >
                            <option value="">Select model</option>
                            <template x-for="m in providerModels" :key="m.id">
                                <option :value="m.id" x-text="m.id"></option>
                            </template>
                        </select>
                    </div>

                    <button
                        @click="saveSettings()"
                        class="btn btn-primary"
                        :class="{ 'loading': saving }"
                    >
                        Save Default
                    </button>
                </div>
            </div>
        </div>

        <!-- Change Password -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Admin Password</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Change the admin dashboard password
                </p>

                <form @submit.prevent="changePassword()" class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">New Password</span>
                        </label>
                        <input
                            type="password"
                            x-model="newPassword"
                            class="input input-bordered"
                            placeholder="Enter new password"
                            minlength="8"
                            required
                        />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Confirm Password</span>
                        </label>
                        <input
                            type="password"
                            x-model="confirmPassword"
                            class="input input-bordered"
                            placeholder="Confirm new password"
                            required
                        />
                    </div>

                    <button
                        type="submit"
                        class="btn btn-primary"
                        :class="{ 'loading': changingPassword }"
                    >
                        Change Password
                    </button>
                </form>
            </div>
        </div>

        <!-- Configuration Reload -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Configuration</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Reload configuration to pick up database changes
                </p>

                <button
                    @click="reloadConfig()"
                    class="btn btn-outline"
                    :class="{ 'loading': reloading }"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 mr-1"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        />
                    </svg>
                    Reload Config
                </button>
            </div>
        </div>

        <!-- Backup & Restore -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Backup & Restore</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Export your configuration for backup or import to a new
                    instance
                </p>

                <div class="space-y-4">
                    <!-- Export -->
                    <div>
                        <p class="text-sm mb-2">
                            Export custom models, aliases, providers, overrides,
                            and settings.
                        </p>
                        <a
                            href="/api/config/export"
                            class="btn btn-outline btn-sm"
                            download
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4 mr-1"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                                />
                            </svg>
                            Export Configuration
                        </a>
                    </div>

                    <!-- Import -->
                    <div class="border-t border-base-300 pt-4">
                        <p class="text-sm mb-2">
                            Import configuration from a previously exported JSON
                            file. Existing entries will be updated.
                        </p>
                        <input
                            type="file"
                            id="importFile"
                            accept=".json"
                            class="hidden"
                            @change="handleImportFile($event)"
                        />
                        <button
                            @click="$refs.importFile.click()"
                            class="btn btn-outline btn-sm"
                            :class="{ 'loading': importing }"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4 mr-1"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                                />
                            </svg>
                            Import Configuration
                        </button>
                        <input
                            type="file"
                            x-ref="importFile"
                            accept=".json"
                            class="hidden"
                            @change="handleImportFile($event)"
                        />
                    </div>
                </div>
            </div>
        </div>

        <!-- Theme -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Theme</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Choose your preferred color scheme
                </p>

                <div class="flex flex-wrap gap-2">
                    <button
                        @click="setTheme('system')"
                        class="btn btn-sm"
                        :class="currentTheme === 'system' ? 'btn-primary' : 'btn-outline'"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 mr-1"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                            />
                        </svg>
                        System
                    </button>
                    <button
                        @click="setTheme('light')"
                        class="btn btn-sm"
                        :class="currentTheme === 'light' ? 'btn-primary' : 'btn-outline'"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 mr-1"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                            />
                        </svg>
                        Light
                    </button>
                    <button
                        @click="setTheme('dark')"
                        class="btn btn-sm"
                        :class="currentTheme === 'dark' ? 'btn-primary' : 'btn-outline'"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 mr-1"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                            />
                        </svg>
                        Dark
                    </button>
                </div>
            </div>
        </div>

        <!-- Model Sync -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Model Sync</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Sync models and pricing from LiteLLM's community-maintained
                    database
                </p>

                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Provider (optional)</span>
                        </label>
                        <select
                            x-model="syncProvider"
                            class="select select-bordered select-sm"
                        >
                            <option value="">All providers</option>
                            <template x-for="p in syncProviders" :key="p">
                                <option :value="p" x-text="p"></option>
                            </template>
                        </select>
                    </div>

                    <button
                        @click="checkSync()"
                        class="btn btn-outline btn-sm"
                        :class="{ 'loading': checkingSync }"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 mr-1"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                            />
                        </svg>
                        Check for Updates
                    </button>

                    <!-- Results -->
                    <template x-if="syncResults">
                        <div class="space-y-2">
                            <div class="text-sm">
                                <span class="text-base-content/60"
                                    >Remote models:</span
                                >
                                <span
                                    x-text="syncResults.total_remote_models"
                                ></span>
                            </div>
                            <div class="text-sm">
                                <span class="text-base-content/60"
                                    >Price updates:</span
                                >
                                <span
                                    x-text="syncResults.price_update_count || 0"
                                    :class="syncResults.price_update_count > 0 ? 'text-warning font-semibold' : 'text-success'"
                                ></span>
                            </div>
                            <div class="text-sm">
                                <span class="text-base-content/60"
                                    >New models:</span
                                >
                                <span
                                    x-text="syncResults.new_model_count || 0"
                                    :class="syncResults.new_model_count > 0 ? 'text-info font-semibold' : 'text-success'"
                                ></span>
                            </div>

                            <template x-if="syncResults.differences_found > 0">
                                <div class="mt-4">
                                    <button
                                        @click="showSyncDiffs = !showSyncDiffs"
                                        class="btn btn-xs btn-ghost"
                                    >
                                        <span
                                            x-text="showSyncDiffs ? 'Hide details' : 'Show details'"
                                        ></span>
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4 ml-1 transition-transform"
                                            :class="showSyncDiffs ? 'rotate-180' : ''"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 9l-7 7-7-7"
                                            />
                                        </svg>
                                    </button>

                                    <template x-if="showSyncDiffs">
                                        <div
                                            class="mt-2 max-h-64 overflow-y-auto text-xs font-mono bg-base-200 rounded p-2"
                                        >
                                            <template
                                                x-for="diff in syncResults.diffs"
                                                :key="diff.model_id + diff.field"
                                            >
                                                <div
                                                    class="py-1 border-b border-base-300 last:border-0"
                                                >
                                                    <span
                                                        class="text-primary"
                                                        x-text="diff.provider + '/'"
                                                    ></span>
                                                    <span
                                                        x-text="diff.model_id"
                                                    ></span>
                                                    <span
                                                        class="text-base-content/50"
                                                        >.</span
                                                    >
                                                    <span
                                                        class="text-secondary"
                                                        x-text="diff.field"
                                                    ></span>
                                                    <template
                                                        x-if="diff.change_type === 'changed'"
                                                    >
                                                        <span>
                                                            <span
                                                                class="text-error"
                                                                x-text="diff.local_value"
                                                            ></span>
                                                            <span
                                                                class="text-base-content/50"
                                                            >
                                                                ->
                                                            </span>
                                                            <span
                                                                class="text-success"
                                                                x-text="diff.remote_value"
                                                            ></span>
                                                        </span>
                                                    </template>
                                                    <template
                                                        x-if="diff.change_type === 'added'"
                                                    >
                                                        <span
                                                            class="text-success"
                                                            x-text="'+ ' + diff.remote_value"
                                                        ></span>
                                                    </template>
                                                    <template
                                                        x-if="diff.change_type === 'info'"
                                                    >
                                                        <span
                                                            class="text-info"
                                                            x-text="'(info) ' + diff.remote_value"
                                                        ></span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <!-- Action Buttons -->
                                    <div class="mt-4 space-y-3">
                                        <!-- Update Existing Models -->
                                        <template
                                            x-if="syncResults.price_update_count > 0 && !syncResults.updates_applied"
                                        >
                                            <div
                                                class="flex items-center gap-2"
                                            >
                                                <button
                                                    @click="applyModelSync('update_existing')"
                                                    class="btn btn-primary btn-sm"
                                                    :class="{ 'loading': applyingSync }"
                                                    :disabled="applyingSync"
                                                >
                                                    Update Existing
                                                </button>
                                                <span
                                                    class="text-xs text-base-content/60"
                                                >
                                                    Update prices for
                                                    <span
                                                        x-text="syncResults.price_update_count"
                                                    ></span>
                                                    existing models
                                                </span>
                                            </div>
                                        </template>

                                        <!-- Add New Models -->
                                        <template
                                            x-if="syncResults.new_model_count > 0 && !syncResults.new_models_applied"
                                        >
                                            <div
                                                class="flex items-center gap-2"
                                            >
                                                <button
                                                    @click="applyModelSync('add_new')"
                                                    class="btn btn-secondary btn-sm"
                                                    :class="{ 'loading': applyingSync }"
                                                    :disabled="applyingSync"
                                                >
                                                    Add New Models
                                                </button>
                                                <span
                                                    class="text-xs text-base-content/60"
                                                >
                                                    Add
                                                    <span
                                                        x-text="syncResults.new_model_count"
                                                    ></span>
                                                    new models as custom models
                                                </span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Applied confirmation -->
                            <template
                                x-if="syncResults.updates_applied || syncResults.new_models_applied"
                            >
                                <div class="alert alert-success mt-4">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="stroke-current shrink-0 h-6 w-6"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                        />
                                    </svg>
                                    <div class="flex flex-col">
                                        <template
                                            x-if="syncResults.updates_applied"
                                        >
                                            <span>
                                                Prices updated:
                                                <span
                                                    x-text="syncResults.overrides_created || 0"
                                                ></span>
                                                created,
                                                <span
                                                    x-text="syncResults.overrides_updated || 0"
                                                ></span>
                                                updated
                                            </span>
                                        </template>
                                        <template
                                            x-if="syncResults.new_models_applied"
                                        >
                                            <span>
                                                New models added:
                                                <span
                                                    x-text="syncResults.new_models_added || 0"
                                                ></span>
                                            </span>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">System Information</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Current proxy status
                </p>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Version:</span>
                        <span class="font-mono">2.1.0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Providers:</span>
                        <span x-text="stats.providers?.total || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Models:</span>
                        <span x-text="stats.models?.total || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Aliases:</span>
                        <span x-text="stats.aliases?.total || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60"
                            >Configured Providers:</span
                        >
                        <span
                            x-text="stats.providers?.configured || '-'"
                        ></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div class="toast toast-end">
        <template x-for="toast in toasts" :key="toast.id">
            <div
                class="alert"
                :class="toast.type === 'error' ? 'alert-error' : 'alert-success'"
            >
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>
</div>

<script>
    function settingsPage() {
        return {
            settings: {
                default_provider: "",
                default_model: "",
            },
            providers: [],
            providerModels: [],
            stats: {},
            saving: false,
            newPassword: "",
            confirmPassword: "",
            changingPassword: false,
            reloading: false,
            importing: false,
            toasts: [],
            currentTheme: localStorage.getItem("theme") || "system",
            syncProviders: [],
            syncProvider: "",
            checkingSync: false,
            applyingSync: false,
            syncResults: null,
            showSyncDiffs: false,

            setTheme(theme) {
                this.currentTheme = theme;
                localStorage.setItem("theme", theme);
                this.applyTheme(theme);
                this.showToast(`Theme set to ${theme}`);
            },

            applyTheme(theme) {
                if (theme === "system") {
                    const prefersDark = window.matchMedia(
                        "(prefers-color-scheme: dark)",
                    ).matches;
                    document.documentElement.setAttribute(
                        "data-theme",
                        prefersDark ? "dark" : "light",
                    );
                } else {
                    document.documentElement.setAttribute("data-theme", theme);
                }
            },

            async loadSettings() {
                try {
                    const [
                        settingsRes,
                        providersRes,
                        statsRes,
                        syncProvidersRes,
                    ] = await Promise.all([
                        fetch("/api/settings"),
                        fetch("/api/providers"),
                        fetch("/api/stats"),
                        fetch("/api/models/sync/providers"),
                    ]);

                    if (providersRes.ok) {
                        this.providers = await providersRes.json();
                    }
                    if (statsRes.ok) {
                        this.stats = await statsRes.json();
                    }
                    if (syncProvidersRes.ok) {
                        const data = await syncProvidersRes.json();
                        this.syncProviders = data.providers || [];
                    }

                    // Load settings and merge with defaults
                    if (settingsRes.ok) {
                        const loaded = await settingsRes.json();
                        this.settings = { ...this.settings, ...loaded };
                    }

                    // Load models for default provider (need to wait for Alpine to render options)
                    if (this.settings.default_provider) {
                        await this.loadProviderModels();
                    }
                } catch (err) {
                    this.showToast("Failed to load settings", "error");
                }
            },

            async loadProviderModels() {
                if (!this.settings.default_provider) {
                    this.providerModels = [];
                    return;
                }

                // Save current model selection before loading new options
                const savedModel = this.settings.default_model;

                try {
                    const res = await fetch(
                        `/api/models?provider=${this.settings.default_provider}`,
                    );
                    if (res.ok) {
                        this.providerModels = await res.json();

                        // Restore model selection after options are rendered
                        if (savedModel) {
                            this.$nextTick(() => {
                                this.settings.default_model = savedModel;
                            });
                        }
                    }
                } catch (err) {
                    console.error("Failed to load models", err);
                }
            },

            async saveSettings() {
                this.saving = true;
                try {
                    const res = await fetch("/api/settings", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(this.settings),
                    });

                    if (res.ok) {
                        this.showToast("Settings saved");
                    } else {
                        this.showToast("Failed to save settings", "error");
                    }
                } catch (err) {
                    this.showToast("Failed to save settings", "error");
                } finally {
                    this.saving = false;
                }
            },

            async changePassword() {
                if (this.newPassword !== this.confirmPassword) {
                    this.showToast("Passwords do not match", "error");
                    return;
                }

                if (this.newPassword.length < 8) {
                    this.showToast(
                        "Password must be at least 8 characters",
                        "error",
                    );
                    return;
                }

                this.changingPassword = true;
                try {
                    const res = await fetch("/api/settings/password", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            new_password: this.newPassword,
                        }),
                    });

                    if (res.ok) {
                        this.showToast("Password changed successfully");
                        this.newPassword = "";
                        this.confirmPassword = "";
                    } else {
                        const data = await res.json();
                        this.showToast(
                            data.error || "Failed to change password",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast("Failed to change password", "error");
                } finally {
                    this.changingPassword = false;
                }
            },

            async reloadConfig() {
                this.reloading = true;
                try {
                    const res = await fetch("/api/config/reload", {
                        method: "POST",
                    });

                    if (res.ok) {
                        this.showToast("Configuration reloaded");
                    } else {
                        this.showToast(
                            "Failed to reload configuration",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast("Failed to reload configuration", "error");
                } finally {
                    this.reloading = false;
                }
            },

            async handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.importing = true;
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    const res = await fetch("/api/config/import", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });

                    if (res.ok) {
                        const result = await res.json();
                        const stats = result.stats;
                        const total = Object.values(stats).reduce(
                            (a, b) => a + b,
                            0,
                        );
                        this.showToast(`Imported ${total} items successfully`);
                        await this.loadSettings();
                    } else {
                        const error = await res.json();
                        this.showToast(
                            error.error || "Failed to import configuration",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast(
                        "Failed to parse import file: " + err.message,
                        "error",
                    );
                } finally {
                    this.importing = false;
                    // Reset the file input
                    event.target.value = "";
                }
            },

            async checkSync() {
                this.checkingSync = true;
                this.syncResults = null;
                this.showSyncDiffs = false;

                try {
                    const body = {};
                    if (this.syncProvider) {
                        body.provider = this.syncProvider;
                    }

                    const res = await fetch("/api/models/sync", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });

                    if (res.ok) {
                        this.syncResults = await res.json();
                        if (this.syncResults.differences_found === 0) {
                            this.showToast("Models are up to date");
                        } else {
                            const updates =
                                this.syncResults.price_update_count || 0;
                            const newModels =
                                this.syncResults.new_model_count || 0;
                            this.showToast(
                                `Found ${updates} price updates, ${newModels} new models`,
                                "warning",
                            );
                        }
                    } else {
                        const error = await res.json();
                        this.showToast(
                            error.error || "Failed to check models",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast(
                        "Failed to check models: " + err.message,
                        "error",
                    );
                } finally {
                    this.checkingSync = false;
                }
            },

            async applyModelSync(action) {
                this.applyingSync = true;

                try {
                    const body = {};
                    if (this.syncProvider) {
                        body.provider = this.syncProvider;
                    }

                    if (action === "update_existing") {
                        body.update_existing = true;
                    } else if (action === "add_new") {
                        body.add_new = true;
                    }

                    const res = await fetch("/api/models/sync", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });

                    if (res.ok) {
                        const result = await res.json();

                        if (action === "update_existing") {
                            this.syncResults.updates_applied = true;
                            this.syncResults.overrides_created =
                                result.overrides_created || 0;
                            this.syncResults.overrides_updated =
                                result.overrides_updated || 0;
                            const total =
                                (result.overrides_created || 0) +
                                (result.overrides_updated || 0);
                            this.showToast(`Updated ${total} model prices`);
                        } else if (action === "add_new") {
                            this.syncResults.new_models_applied = true;
                            this.syncResults.new_models_added =
                                result.new_models_added || 0;
                            this.showToast(
                                `Added ${result.new_models_added || 0} new models`,
                            );
                        }
                    } else {
                        const error = await res.json();
                        this.showToast(
                            error.error || "Failed to apply changes",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast(
                        "Failed to apply changes: " + err.message,
                        "error",
                    );
                } finally {
                    this.applyingSync = false;
                }
            },

            showToast(message, type = "success") {
                const id = Date.now();
                this.toasts.push({ id, message, type });
                setTimeout(() => {
                    this.toasts = this.toasts.filter((t) => t.id !== id);
                }, 3000);
            },
        };
    }
</script>
{% endblock %}
