{% extends "base.html" %} {% block title %}Settings{% endblock %} {% block
content %}
<div x-data="settingsPage()" x-init="loadSettings()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold">Settings</h1>
        <p class="text-base-content/60">
            Configure proxy settings and defaults
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Default Model -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Default Model</h2>
                <p class="text-sm text-base-content/60 mb-2">
                    Fallback model used when an unknown model is requested
                </p>

                <!-- Current default display -->
                <div
                    x-show="settings.default_provider && settings.default_model"
                    class="alert alert-info mb-4 py-2"
                >
                    <span class="text-sm">
                        Current default:
                        <strong
                            x-text="settings.default_provider + '/' + settings.default_model"
                        ></strong>
                    </span>
                </div>
                <div
                    x-show="!settings.default_provider || !settings.default_model"
                    class="alert mb-4 py-2"
                >
                    <span class="text-sm text-base-content/60"
                        >No default model configured</span
                    >
                </div>

                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Provider</span>
                        </label>
                        <select
                            x-model="settings.default_provider"
                            @change="loadProviderModels()"
                            class="select select-bordered"
                        >
                            <option value="">Select provider</option>
                            <template x-for="p in providers" :key="p.id">
                                <option :value="p.id" x-text="p.id"></option>
                            </template>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Model</span>
                        </label>
                        <select
                            x-model="settings.default_model"
                            class="select select-bordered"
                        >
                            <option value="">Select model</option>
                            <template x-for="m in providerModels" :key="m.id">
                                <option :value="m.id" x-text="m.id"></option>
                            </template>
                        </select>
                    </div>

                    <button
                        @click="saveSettings()"
                        class="btn btn-primary"
                        :class="{ 'loading': saving }"
                    >
                        Save Default
                    </button>
                </div>
            </div>
        </div>

        <!-- Change Password -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Admin Password</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Change the admin dashboard password
                </p>

                <form @submit.prevent="changePassword()" class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">New Password</span>
                        </label>
                        <input
                            type="password"
                            x-model="newPassword"
                            class="input input-bordered"
                            placeholder="Enter new password"
                            minlength="8"
                            required
                        />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Confirm Password</span>
                        </label>
                        <input
                            type="password"
                            x-model="confirmPassword"
                            class="input input-bordered"
                            placeholder="Confirm new password"
                            required
                        />
                    </div>

                    <button
                        type="submit"
                        class="btn btn-primary"
                        :class="{ 'loading': changingPassword }"
                    >
                        Change Password
                    </button>
                </form>
            </div>
        </div>

        <!-- Backup & Restore -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Backup & Restore</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Export your configuration for backup or import to a new
                    instance
                </p>

                <div class="space-y-4">
                    <!-- Export -->
                    <div>
                        <p class="text-sm mb-2">
                            Export models, providers, aliases, smart routers,
                            and settings.
                        </p>
                        <a
                            href="/api/config/export"
                            class="btn btn-outline btn-sm"
                            download
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4 mr-1"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                                />
                            </svg>
                            Export Configuration
                        </a>
                    </div>

                    <!-- Import -->
                    <div class="border-t border-base-300 pt-4">
                        <p class="text-sm mb-2">
                            Import configuration from a previously exported JSON
                            file. Existing entries will be updated.
                        </p>
                        <input
                            type="file"
                            id="importFile"
                            accept=".json"
                            class="hidden"
                            @change="handleImportFile($event)"
                        />
                        <button
                            @click="$refs.importFile.click()"
                            class="btn btn-outline btn-sm"
                            :class="{ 'loading': importing }"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4 mr-1"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                                />
                            </svg>
                            Import Configuration
                        </button>
                        <input
                            type="file"
                            x-ref="importFile"
                            accept=".json"
                            class="hidden"
                            @change="handleImportFile($event)"
                        />
                    </div>
                </div>
            </div>
        </div>

        <!-- Theme -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Theme</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Choose your preferred color scheme
                </p>

                <div class="flex flex-wrap gap-2">
                    <button
                        @click="setTheme('system')"
                        class="btn btn-sm"
                        :class="currentTheme === 'system' ? 'btn-primary' : 'btn-outline'"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 mr-1"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                            />
                        </svg>
                        System
                    </button>
                    <button
                        @click="setTheme('light')"
                        class="btn btn-sm"
                        :class="currentTheme === 'light' ? 'btn-primary' : 'btn-outline'"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 mr-1"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                            />
                        </svg>
                        Light
                    </button>
                    <button
                        @click="setTheme('dark')"
                        class="btn btn-sm"
                        :class="currentTheme === 'dark' ? 'btn-primary' : 'btn-outline'"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 mr-1"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                            />
                        </svg>
                        Dark
                    </button>
                </div>
            </div>
        </div>

        <!-- Model Sync -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Model Sync</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Sync models and pricing from LiteLLM's community-maintained
                    database
                </p>

                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Provider (optional)</span>
                        </label>
                        <select
                            x-model="syncProvider"
                            class="select select-bordered select-sm"
                        >
                            <option value="">All providers</option>
                            <template x-for="p in syncProviders" :key="p">
                                <option :value="p" x-text="p"></option>
                            </template>
                        </select>
                    </div>

                    <button
                        @click="checkSync()"
                        class="btn btn-outline btn-sm"
                        :class="{ 'loading': checkingSync }"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 mr-1"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                            />
                        </svg>
                        Check for Updates
                    </button>

                    <!-- Results -->
                    <template x-if="syncResults">
                        <div class="space-y-2">
                            <div class="text-sm">
                                <span class="text-base-content/60"
                                    >Remote models:</span
                                >
                                <span
                                    x-text="syncResults.total_remote_models"
                                ></span>
                            </div>
                            <div class="text-sm">
                                <span class="text-base-content/60"
                                    >Price updates:</span
                                >
                                <span
                                    x-text="syncResults.price_update_count || 0"
                                    :class="syncResults.price_update_count > 0 ? 'text-warning font-semibold' : 'text-success'"
                                ></span>
                            </div>
                            <div class="text-sm">
                                <span class="text-base-content/60"
                                    >New models:</span
                                >
                                <span
                                    x-text="syncResults.new_model_count || 0"
                                    :class="syncResults.new_model_count > 0 ? 'text-info font-semibold' : 'text-success'"
                                ></span>
                            </div>
                            <div class="text-sm">
                                <span class="text-base-content/60"
                                    >Deprecated models:</span
                                >
                                <span
                                    x-text="syncResults.deprecated_model_count || 0"
                                    :class="syncResults.deprecated_model_count > 0 ? 'text-warning font-semibold' : 'text-success'"
                                ></span>
                            </div>

                            <template x-if="syncResults.differences_found > 0">
                                <div class="mt-4">
                                    <button
                                        @click="showSyncDiffs = !showSyncDiffs"
                                        class="btn btn-xs btn-ghost"
                                    >
                                        <span
                                            x-text="showSyncDiffs ? 'Hide details' : 'Show details'"
                                        ></span>
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4 ml-1 transition-transform"
                                            :class="showSyncDiffs ? 'rotate-180' : ''"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 9l-7 7-7-7"
                                            />
                                        </svg>
                                    </button>

                                    <template x-if="showSyncDiffs">
                                        <div
                                            class="mt-2 max-h-64 overflow-y-auto text-xs font-mono bg-base-200 rounded p-2"
                                        >
                                            <template
                                                x-for="diff in syncResults.diffs"
                                                :key="diff.model_id + diff.field"
                                            >
                                                <div
                                                    class="py-1 border-b border-base-300 last:border-0"
                                                >
                                                    <span
                                                        class="text-primary"
                                                        x-text="diff.provider + '/'"
                                                    ></span>
                                                    <span
                                                        x-text="diff.model_id"
                                                    ></span>
                                                    <span
                                                        class="text-base-content/50"
                                                        >.</span
                                                    >
                                                    <span
                                                        class="text-secondary"
                                                        x-text="diff.field"
                                                    ></span>
                                                    <template
                                                        x-if="diff.change_type === 'changed'"
                                                    >
                                                        <span>
                                                            <span
                                                                class="text-error"
                                                                x-text="diff.local_value"
                                                            ></span>
                                                            <span
                                                                class="text-base-content/50"
                                                            >
                                                                ->
                                                            </span>
                                                            <span
                                                                class="text-success"
                                                                x-text="diff.remote_value"
                                                            ></span>
                                                        </span>
                                                    </template>
                                                    <template
                                                        x-if="diff.change_type === 'added'"
                                                    >
                                                        <span
                                                            class="text-success"
                                                            x-text="'+ ' + diff.remote_value"
                                                        ></span>
                                                    </template>
                                                    <template
                                                        x-if="diff.change_type === 'info'"
                                                    >
                                                        <span
                                                            class="text-info"
                                                            x-text="'(info) ' + diff.remote_value"
                                                        ></span>
                                                    </template>
                                                    <template
                                                        x-if="diff.change_type === 'removed'"
                                                    >
                                                        <span
                                                            class="text-warning"
                                                            x-text="'(deprecated) ' + diff.local_value"
                                                        ></span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <!-- Action Buttons -->
                                    <div class="mt-4 space-y-3">
                                        <!-- Update Existing Models -->
                                        <template
                                            x-if="syncResults.price_update_count > 0 && !syncResults.updates_applied"
                                        >
                                            <div class="space-y-2">
                                                <div
                                                    class="flex items-center gap-2"
                                                >
                                                    <button
                                                        @click="showPriceUpdateSelection = !showPriceUpdateSelection"
                                                        class="btn btn-primary btn-sm"
                                                    >
                                                        <span
                                                            x-text="showPriceUpdateSelection ? 'Hide Selection' : 'Select Price Updates'"
                                                        ></span>
                                                        <span
                                                            class="badge badge-sm ml-1"
                                                            x-text="syncResults.price_update_count"
                                                        ></span>
                                                    </button>
                                                    <span
                                                        class="text-xs text-base-content/60"
                                                    >
                                                        Choose which prices to
                                                        update
                                                    </span>
                                                </div>

                                                <!-- Price update selection list -->
                                                <template
                                                    x-if="showPriceUpdateSelection"
                                                >
                                                    <div
                                                        class="bg-base-200 rounded p-3 space-y-2"
                                                    >
                                                        <!-- Select all / none -->
                                                        <div
                                                            class="flex gap-2 mb-2 pb-2 border-b border-base-300"
                                                        >
                                                            <button
                                                                @click="selectAllPriceUpdates()"
                                                                class="btn btn-xs btn-ghost"
                                                            >
                                                                Select All
                                                            </button>
                                                            <button
                                                                @click="selectNoPriceUpdates()"
                                                                class="btn btn-xs btn-ghost"
                                                            >
                                                                Select None
                                                            </button>
                                                            <span
                                                                class="text-xs text-base-content/60 ml-auto"
                                                            >
                                                                <span
                                                                    x-text="selectedPriceUpdates.length"
                                                                ></span>
                                                                selected
                                                            </span>
                                                        </div>

                                                        <!-- Model checkboxes -->
                                                        <div
                                                            class="max-h-48 overflow-y-auto space-y-1"
                                                        >
                                                            <template
                                                                x-for="diff in getPriceUpdateDiffs()"
                                                                :key="diff.provider + '/' + diff.model_id"
                                                            >
                                                                <label
                                                                    class="flex items-center gap-2 cursor-pointer hover:bg-base-300 rounded px-2 py-1"
                                                                >
                                                                    <input
                                                                        type="checkbox"
                                                                        class="checkbox checkbox-sm checkbox-primary"
                                                                        :value="diff.provider + '/' + diff.model_id"
                                                                        x-model="selectedPriceUpdates"
                                                                    />
                                                                    <span
                                                                        class="text-xs font-mono flex-1"
                                                                    >
                                                                        <span
                                                                            class="text-primary"
                                                                            x-text="diff.provider + '/'"
                                                                        ></span>
                                                                        <span
                                                                            x-text="diff.model_id"
                                                                        ></span>
                                                                    </span>
                                                                    <span
                                                                        class="text-xs text-base-content/60"
                                                                        x-text="diff.changesSummary"
                                                                    ></span>
                                                                </label>
                                                            </template>
                                                        </div>

                                                        <!-- Apply button -->
                                                        <div
                                                            class="pt-2 border-t border-base-300"
                                                        >
                                                            <button
                                                                @click="applySelectedPriceUpdates()"
                                                                class="btn btn-primary btn-sm"
                                                                :class="{ 'loading': applyingSync }"
                                                                :disabled="applyingSync || selectedPriceUpdates.length === 0"
                                                            >
                                                                Update Selected
                                                                Prices
                                                                <span
                                                                    class="badge badge-sm ml-1"
                                                                    x-text="selectedPriceUpdates.length"
                                                                ></span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>

                                        <!-- Add New Models -->
                                        <template
                                            x-if="syncResults.new_model_count > 0 && !syncResults.new_models_applied"
                                        >
                                            <div class="space-y-2">
                                                <div
                                                    class="flex items-center gap-2"
                                                >
                                                    <button
                                                        @click="showNewModelSelection = !showNewModelSelection"
                                                        class="btn btn-secondary btn-sm"
                                                    >
                                                        <span
                                                            x-text="showNewModelSelection ? 'Hide Selection' : 'Select New Models'"
                                                        ></span>
                                                        <span
                                                            class="badge badge-sm ml-1"
                                                            x-text="syncResults.new_model_count"
                                                        ></span>
                                                    </button>
                                                    <span
                                                        class="text-xs text-base-content/60"
                                                    >
                                                        Choose which models to
                                                        add
                                                    </span>
                                                </div>

                                                <!-- Model selection list -->
                                                <template
                                                    x-if="showNewModelSelection"
                                                >
                                                    <div
                                                        class="bg-base-200 rounded p-3 space-y-2"
                                                    >
                                                        <!-- Select all / none -->
                                                        <div
                                                            class="flex gap-2 mb-2 pb-2 border-b border-base-300"
                                                        >
                                                            <button
                                                                @click="selectAllNewModels()"
                                                                class="btn btn-xs btn-ghost"
                                                            >
                                                                Select All
                                                            </button>
                                                            <button
                                                                @click="selectNoNewModels()"
                                                                class="btn btn-xs btn-ghost"
                                                            >
                                                                Select None
                                                            </button>
                                                            <span
                                                                class="text-xs text-base-content/60 ml-auto"
                                                            >
                                                                <span
                                                                    x-text="selectedNewModels.length"
                                                                ></span>
                                                                selected
                                                            </span>
                                                        </div>

                                                        <!-- Model checkboxes -->
                                                        <div
                                                            class="max-h-48 overflow-y-auto space-y-1"
                                                        >
                                                            <template
                                                                x-for="diff in getNewModelDiffs()"
                                                                :key="diff.provider + '/' + diff.model_id"
                                                            >
                                                                <label
                                                                    class="flex items-center gap-2 cursor-pointer hover:bg-base-300 rounded px-2 py-1"
                                                                >
                                                                    <input
                                                                        type="checkbox"
                                                                        class="checkbox checkbox-sm checkbox-primary"
                                                                        :value="diff.provider + '/' + diff.model_id"
                                                                        x-model="selectedNewModels"
                                                                    />
                                                                    <span
                                                                        class="text-xs font-mono flex-1"
                                                                    >
                                                                        <span
                                                                            class="text-primary"
                                                                            x-text="diff.provider + '/'"
                                                                        ></span>
                                                                        <span
                                                                            x-text="diff.model_id"
                                                                        ></span>
                                                                    </span>
                                                                    <span
                                                                        class="text-xs text-base-content/60"
                                                                        x-text="diff.remote_value"
                                                                    ></span>
                                                                </label>
                                                            </template>
                                                        </div>

                                                        <!-- Add selected button -->
                                                        <div
                                                            class="pt-2 border-t border-base-300"
                                                        >
                                                            <button
                                                                @click="applySelectedNewModels()"
                                                                class="btn btn-primary btn-sm"
                                                                :class="{ 'loading': applyingSync }"
                                                                :disabled="applyingSync || selectedNewModels.length === 0"
                                                            >
                                                                Add Selected
                                                                Models
                                                                <span
                                                                    class="badge badge-sm ml-1"
                                                                    x-text="selectedNewModels.length"
                                                                ></span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>

                                        <!-- Disable Deprecated Models -->
                                        <template
                                            x-if="syncResults.deprecated_model_count > 0 && !syncResults.deprecated_applied"
                                        >
                                            <div class="space-y-2">
                                                <div
                                                    class="flex items-center gap-2"
                                                >
                                                    <button
                                                        @click="showDeprecatedSelection = !showDeprecatedSelection"
                                                        class="btn btn-warning btn-sm"
                                                    >
                                                        <span
                                                            x-text="showDeprecatedSelection ? 'Hide Selection' : 'Select Deprecated Models'"
                                                        ></span>
                                                        <span
                                                            class="badge badge-sm ml-1"
                                                            x-text="syncResults.deprecated_model_count"
                                                        ></span>
                                                    </button>
                                                    <span
                                                        class="text-xs text-base-content/60"
                                                    >
                                                        Choose which models to
                                                        disable
                                                    </span>
                                                </div>

                                                <!-- Deprecated model selection list -->
                                                <template
                                                    x-if="showDeprecatedSelection"
                                                >
                                                    <div
                                                        class="bg-base-200 rounded p-3 space-y-2"
                                                    >
                                                        <!-- Select all / none -->
                                                        <div
                                                            class="flex gap-2 mb-2 pb-2 border-b border-base-300"
                                                        >
                                                            <button
                                                                @click="selectAllDeprecated()"
                                                                class="btn btn-xs btn-ghost"
                                                            >
                                                                Select All
                                                            </button>
                                                            <button
                                                                @click="selectNoDeprecated()"
                                                                class="btn btn-xs btn-ghost"
                                                            >
                                                                Select None
                                                            </button>
                                                            <span
                                                                class="text-xs text-base-content/60 ml-auto"
                                                            >
                                                                <span
                                                                    x-text="selectedDeprecated.length"
                                                                ></span>
                                                                selected
                                                            </span>
                                                        </div>

                                                        <!-- Model checkboxes -->
                                                        <div
                                                            class="max-h-48 overflow-y-auto space-y-1"
                                                        >
                                                            <template
                                                                x-for="diff in getDeprecatedDiffs()"
                                                                :key="diff.provider + '/' + diff.model_id"
                                                            >
                                                                <label
                                                                    class="flex items-center gap-2 cursor-pointer hover:bg-base-300 rounded px-2 py-1"
                                                                >
                                                                    <input
                                                                        type="checkbox"
                                                                        class="checkbox checkbox-sm checkbox-warning"
                                                                        :value="diff.provider + '/' + diff.model_id"
                                                                        x-model="selectedDeprecated"
                                                                    />
                                                                    <span
                                                                        class="text-xs font-mono flex-1"
                                                                    >
                                                                        <span
                                                                            class="text-primary"
                                                                            x-text="diff.provider + '/'"
                                                                        ></span>
                                                                        <span
                                                                            x-text="diff.model_id"
                                                                        ></span>
                                                                    </span>
                                                                    <span
                                                                        class="text-xs text-warning"
                                                                        x-text="diff.local_value"
                                                                    ></span>
                                                                </label>
                                                            </template>
                                                        </div>

                                                        <!-- Disable button -->
                                                        <div
                                                            class="pt-2 border-t border-base-300"
                                                        >
                                                            <button
                                                                @click="applySelectedDeprecated()"
                                                                class="btn btn-warning btn-sm"
                                                                :class="{ 'loading': applyingSync }"
                                                                :disabled="applyingSync || selectedDeprecated.length === 0"
                                                            >
                                                                Disable Selected
                                                                Models
                                                                <span
                                                                    class="badge badge-sm ml-1"
                                                                    x-text="selectedDeprecated.length"
                                                                ></span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Applied confirmation -->
                            <template
                                x-if="syncResults.updates_applied || syncResults.new_models_applied || syncResults.deprecated_applied"
                            >
                                <div class="alert alert-success mt-4">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="stroke-current shrink-0 h-6 w-6"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                        />
                                    </svg>
                                    <div class="flex flex-col">
                                        <template
                                            x-if="syncResults.updates_applied"
                                        >
                                            <span>
                                                Prices updated:
                                                <span
                                                    x-text="syncResults.overrides_created || 0"
                                                ></span>
                                                created,
                                                <span
                                                    x-text="syncResults.overrides_updated || 0"
                                                ></span>
                                                updated
                                            </span>
                                        </template>
                                        <template
                                            x-if="syncResults.new_models_applied"
                                        >
                                            <span>
                                                New models added:
                                                <span
                                                    x-text="syncResults.new_models_added || 0"
                                                ></span>
                                            </span>
                                        </template>
                                        <template
                                            x-if="syncResults.deprecated_applied"
                                        >
                                            <span>
                                                Models disabled:
                                                <span
                                                    x-text="syncResults.models_disabled || 0"
                                                ></span>
                                            </span>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">System Information</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Current proxy status
                </p>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Version:</span>
                        <span class="font-mono">1.0.0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Providers:</span>
                        <span x-text="stats.providers?.total || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Models:</span>
                        <span x-text="stats.models?.total || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60"
                            >Configured Providers:</span
                        >
                        <span
                            x-text="stats.providers?.configured || '-'"
                        ></span>
                    </div>
                </div>

                <div class="divider my-3"></div>

                <a
                    href="https://github.com/benhumphry/llm-relay"
                    target="_blank"
                    class="btn btn-ghost btn-sm gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                    >
                        <path
                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                        />
                    </svg>
                    View on GitHub
                </a>
            </div>
        </div>

        <!-- Usage Tracking -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Usage Tracking</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Configure request logging and analytics
                </p>

                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input
                                type="checkbox"
                                x-model="trackingSettings.tracking_enabled"
                                class="toggle toggle-primary"
                            />
                            <div>
                                <span class="label-text"
                                    >Enable Usage Tracking</span
                                >
                                <p class="text-xs text-base-content/60">
                                    Log all proxy requests for usage analysis
                                </p>
                            </div>
                        </label>
                    </div>

                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input
                                type="checkbox"
                                x-model="trackingSettings.dns_resolution_enabled"
                                class="toggle toggle-primary"
                            />
                            <div>
                                <span class="label-text"
                                    >Enable DNS Resolution</span
                                >
                                <p class="text-xs text-base-content/60">
                                    Resolve client IP to hostname (cached)
                                </p>
                            </div>
                        </label>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Data Retention (days)</span
                            >
                        </label>
                        <input
                            type="number"
                            x-model="trackingSettings.retention_days"
                            class="input input-bordered input-sm w-24"
                            min="1"
                            max="365"
                        />
                        <p class="text-xs text-base-content/60 mt-1">
                            How long to keep detailed request logs
                        </p>
                    </div>

                    <button
                        @click="saveTrackingSettings()"
                        class="btn btn-primary btn-sm"
                        :class="{ 'loading': savingTracking }"
                    >
                        Save Tracking Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Log Viewer (full width) -->
    <div class="mt-6">
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="card-title text-lg">Debug Logs</h2>
                        <p class="text-sm text-base-content/60">
                            Real-time debug log stream from the proxy
                        </p>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Connection status -->
                        <div class="flex items-center gap-1 text-sm">
                            <div
                                class="w-2 h-2 rounded-full"
                                :class="debugStreamConnected ? 'bg-success' : 'bg-error'"
                            ></div>
                            <span
                                class="text-base-content/60"
                                x-text="debugStreamConnected ? 'Connected' : 'Disconnected'"
                            ></span>
                        </div>
                        <!-- Log count -->
                        <span
                            class="badge badge-ghost"
                            x-text="debugLogs.length + ' logs'"
                        ></span>
                        <!-- Clear button -->
                        <button
                            @click="clearDebugLogs()"
                            class="btn btn-ghost btn-sm"
                            title="Clear logs"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                />
                            </svg>
                        </button>
                        <!-- Toggle button -->
                        <button
                            @click="toggleDebugLogs()"
                            class="btn btn-sm"
                            :class="debugLogsEnabled ? 'btn-error' : 'btn-success'"
                        >
                            <span
                                x-text="debugLogsEnabled ? 'Stop Capture' : 'Start Capture'"
                            ></span>
                        </button>
                    </div>
                </div>

                <!-- Filter controls -->
                <div class="flex gap-2 mb-3">
                    <select
                        x-model="debugLogFilter"
                        class="select select-bordered select-sm"
                    >
                        <option value="all">All Levels</option>
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO">INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                    <input
                        type="text"
                        x-model="debugLogSearch"
                        placeholder="Search logs..."
                        class="input input-bordered input-sm flex-1"
                    />
                    <label class="label cursor-pointer gap-2">
                        <span class="label-text text-sm">Auto-scroll</span>
                        <input
                            type="checkbox"
                            x-model="debugAutoScroll"
                            class="checkbox checkbox-sm"
                        />
                    </label>
                </div>

                <!-- Log viewer -->
                <div
                    x-ref="debugLogContainer"
                    class="bg-base-200 rounded-lg p-3 h-96 overflow-y-auto font-mono text-xs"
                >
                    <template x-if="filteredDebugLogs.length === 0">
                        <div class="text-base-content/50 text-center py-8">
                            <template x-if="!debugLogsEnabled">
                                <span
                                    >Click "Start Capture" to begin capturing
                                    logs</span
                                >
                            </template>
                            <template
                                x-if="debugLogsEnabled && debugLogs.length === 0"
                            >
                                <span>Waiting for logs...</span>
                            </template>
                            <template
                                x-if="debugLogsEnabled && debugLogs.length > 0"
                            >
                                <span>No logs match your filter</span>
                            </template>
                        </div>
                    </template>
                    <template
                        x-for="(log, index) in filteredDebugLogs"
                        :key="index"
                    >
                        <div
                            class="py-0.5 border-b border-base-300 last:border-0 hover:bg-base-300/50"
                            :class="{
                                'text-error': log.level === 'ERROR',
                                'text-warning': log.level === 'WARNING',
                                'text-info': log.level === 'DEBUG',
                            }"
                        >
                            <span
                                class="text-base-content/50"
                                x-text="log.timestamp.split('T')[1]?.substring(0, 12) || ''"
                            ></span>
                            <span
                                class="inline-block w-16 font-semibold"
                                :class="{
                                    'text-error': log.level === 'ERROR',
                                    'text-warning': log.level === 'WARNING',
                                    'text-info': log.level === 'DEBUG',
                                    'text-success': log.level === 'INFO',
                                }"
                                x-text="log.level"
                            ></span>
                            <span
                                class="text-primary"
                                x-text="log.logger"
                            ></span>
                            <span class="text-base-content/50">-</span>
                            <span x-text="log.message"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div class="toast toast-end">
        <template x-for="toast in toasts" :key="toast.id">
            <div
                class="alert"
                :class="toast.type === 'error' ? 'alert-error' : 'alert-success'"
            >
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>
</div>

<script>
    function settingsPage() {
        return {
            settings: {
                default_provider: "",
                default_model: "",
            },
            providers: [],
            providerModels: [],
            stats: {},
            saving: false,
            newPassword: "",
            confirmPassword: "",
            changingPassword: false,
            importing: false,
            toasts: [],
            currentTheme: localStorage.getItem("theme") || "system",
            syncProviders: [],
            syncProvider: "",
            checkingSync: false,
            applyingSync: false,
            syncResults: null,
            showSyncDiffs: false,
            showNewModelSelection: false,
            selectedNewModels: [],
            showPriceUpdateSelection: false,
            selectedPriceUpdates: [],
            showDeprecatedSelection: false,
            selectedDeprecated: [],
            // Usage tracking settings
            trackingSettings: {
                tracking_enabled: true,
                dns_resolution_enabled: true,
                retention_days: 90,
            },
            savingTracking: false,

            // Debug log viewer
            debugLogs: [],
            debugLogsEnabled: false,
            debugStreamConnected: false,
            debugEventSource: null,
            debugLogFilter: "all",
            debugLogSearch: "",
            debugAutoScroll: true,

            // Computed property for filtered logs
            get filteredDebugLogs() {
                return this.debugLogs.filter((log) => {
                    // Filter by level
                    if (
                        this.debugLogFilter !== "all" &&
                        log.level !== this.debugLogFilter
                    ) {
                        return false;
                    }
                    // Filter by search text
                    if (this.debugLogSearch) {
                        const searchLower = this.debugLogSearch.toLowerCase();
                        return (
                            log.message.toLowerCase().includes(searchLower) ||
                            log.logger.toLowerCase().includes(searchLower)
                        );
                    }
                    return true;
                });
            },

            // Helper to get diffs by change type
            getNewModelDiffs() {
                if (!this.syncResults || !this.syncResults.diffs) return [];
                return this.syncResults.diffs.filter(
                    (d) => d.change_type === "added",
                );
            },

            getPriceUpdateDiffs() {
                if (!this.syncResults || !this.syncResults.diffs) return [];
                // Get unique models with price changes (dedupe by provider/model_id)
                const changedDiffs = this.syncResults.diffs.filter(
                    (d) => d.change_type === "changed",
                );
                const seen = new Set();
                const uniqueModels = [];
                for (const d of changedDiffs) {
                    const key = d.provider + "/" + d.model_id;
                    if (!seen.has(key)) {
                        seen.add(key);
                        // Collect all changes for this model
                        const modelChanges = changedDiffs.filter(
                            (x) =>
                                x.provider === d.provider &&
                                x.model_id === d.model_id,
                        );
                        uniqueModels.push({
                            ...d,
                            changes: modelChanges,
                            changesSummary: modelChanges
                                .map((x) => x.field)
                                .join(", "),
                        });
                    }
                }
                return uniqueModels;
            },

            getDeprecatedDiffs() {
                if (!this.syncResults || !this.syncResults.diffs) return [];
                return this.syncResults.diffs.filter(
                    (d) => d.change_type === "removed",
                );
            },

            // Selection helpers for new models
            selectAllNewModels() {
                this.selectedNewModels = this.getNewModelDiffs().map(
                    (d) => d.provider + "/" + d.model_id,
                );
            },

            selectNoNewModels() {
                this.selectedNewModels = [];
            },

            // Selection helpers for price updates
            selectAllPriceUpdates() {
                this.selectedPriceUpdates = this.getPriceUpdateDiffs().map(
                    (d) => d.provider + "/" + d.model_id,
                );
            },

            selectNoPriceUpdates() {
                this.selectedPriceUpdates = [];
            },

            // Selection helpers for deprecated models
            selectAllDeprecated() {
                this.selectedDeprecated = this.getDeprecatedDiffs().map(
                    (d) => d.provider + "/" + d.model_id,
                );
            },

            selectNoDeprecated() {
                this.selectedDeprecated = [];
            },

            // Apply selected new models
            async applySelectedNewModels() {
                if (this.selectedNewModels.length === 0) return;
                await this.applyModelSyncWithSelection(
                    "add_new",
                    this.selectedNewModels,
                );
            },

            // Apply selected price updates
            async applySelectedPriceUpdates() {
                if (this.selectedPriceUpdates.length === 0) return;
                await this.applyModelSyncWithSelection(
                    "update_existing",
                    this.selectedPriceUpdates,
                );
            },

            // Apply selected deprecated (disable them)
            async applySelectedDeprecated() {
                if (this.selectedDeprecated.length === 0) return;
                await this.applyModelSyncWithSelection(
                    "disable_deprecated",
                    this.selectedDeprecated,
                );
            },

            // Unified method to apply sync with selection
            async applyModelSyncWithSelection(action, selectedModels) {
                this.applyingSync = true;

                try {
                    const body = {
                        selected_models: selectedModels,
                    };
                    if (this.syncProvider) {
                        body.provider = this.syncProvider;
                    }

                    if (action === "update_existing") {
                        body.update_existing = true;
                    } else if (action === "add_new") {
                        body.add_new = true;
                    } else if (action === "disable_deprecated") {
                        body.disable_deprecated = true;
                    }

                    const res = await fetch("/api/models/sync", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });

                    if (res.ok) {
                        const result = await res.json();

                        if (action === "update_existing") {
                            this.syncResults.updates_applied = true;
                            this.syncResults.overrides_created =
                                result.overrides_created || 0;
                            this.syncResults.overrides_updated =
                                result.overrides_updated || 0;
                            const total =
                                (result.overrides_created || 0) +
                                (result.overrides_updated || 0);
                            this.showToast(`Updated ${total} model prices`);
                            this.showPriceUpdateSelection = false;
                            this.selectedPriceUpdates = [];
                        } else if (action === "add_new") {
                            this.syncResults.new_models_applied = true;
                            this.syncResults.new_models_added =
                                result.new_models_added || 0;
                            this.showToast(
                                `Added ${result.new_models_added || 0} new models`,
                            );
                            this.showNewModelSelection = false;
                            this.selectedNewModels = [];
                        } else if (action === "disable_deprecated") {
                            this.syncResults.deprecated_applied = true;
                            this.syncResults.models_disabled =
                                result.models_disabled || 0;
                            this.showToast(
                                `Disabled ${result.models_disabled || 0} deprecated models`,
                            );
                            this.showDeprecatedSelection = false;
                            this.selectedDeprecated = [];
                        }
                    } else {
                        const error = await res.json();
                        this.showToast(
                            error.error || "Failed to apply changes",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast(
                        "Failed to apply changes: " + err.message,
                        "error",
                    );
                } finally {
                    this.applyingSync = false;
                }
            },

            setTheme(theme) {
                this.currentTheme = theme;
                localStorage.setItem("theme", theme);
                this.applyTheme(theme);
                this.showToast(`Theme set to ${theme}`);
            },

            applyTheme(theme) {
                if (theme === "system") {
                    const prefersDark = window.matchMedia(
                        "(prefers-color-scheme: dark)",
                    ).matches;
                    document.documentElement.setAttribute(
                        "data-theme",
                        prefersDark ? "dark" : "light",
                    );
                } else {
                    document.documentElement.setAttribute("data-theme", theme);
                }
            },

            async loadSettings() {
                try {
                    const [
                        settingsRes,
                        providersRes,
                        statsRes,
                        syncProvidersRes,
                        trackingRes,
                    ] = await Promise.all([
                        fetch("/api/settings"),
                        fetch("/api/providers"),
                        fetch("/api/stats"),
                        fetch("/api/models/sync/providers"),
                        fetch("/api/usage/settings"),
                    ]);

                    if (providersRes.ok) {
                        this.providers = await providersRes.json();
                    }
                    if (statsRes.ok) {
                        this.stats = await statsRes.json();
                    }
                    if (syncProvidersRes.ok) {
                        const data = await syncProvidersRes.json();
                        this.syncProviders = data.providers || [];
                    }
                    if (trackingRes.ok) {
                        const loaded = await trackingRes.json();
                        this.trackingSettings = {
                            ...this.trackingSettings,
                            ...loaded,
                        };
                    }

                    // Load settings and merge with defaults
                    if (settingsRes.ok) {
                        const loaded = await settingsRes.json();
                        this.settings = { ...this.settings, ...loaded };
                    }

                    // Load models for default provider (need to wait for Alpine to render options)
                    if (this.settings.default_provider) {
                        await this.loadProviderModels();
                    }

                    // Initialize debug log viewer
                    await this.initDebugLogs();
                } catch (err) {
                    this.showToast("Failed to load settings", "error");
                }
            },

            async loadProviderModels() {
                if (!this.settings.default_provider) {
                    this.providerModels = [];
                    return;
                }

                // Save current model selection before loading new options
                const savedModel = this.settings.default_model;

                try {
                    const res = await fetch(
                        `/api/models?provider=${this.settings.default_provider}`,
                    );
                    if (res.ok) {
                        this.providerModels = await res.json();

                        // Restore model selection after options are rendered
                        if (savedModel) {
                            this.$nextTick(() => {
                                this.settings.default_model = savedModel;
                            });
                        }
                    }
                } catch (err) {
                    console.error("Failed to load models", err);
                }
            },

            async saveSettings() {
                this.saving = true;
                try {
                    const res = await fetch("/api/settings", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(this.settings),
                    });

                    if (res.ok) {
                        this.showToast("Settings saved");
                    } else {
                        this.showToast("Failed to save settings", "error");
                    }
                } catch (err) {
                    this.showToast("Failed to save settings", "error");
                } finally {
                    this.saving = false;
                }
            },

            async saveTrackingSettings() {
                this.savingTracking = true;
                try {
                    const res = await fetch("/api/usage/settings", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(this.trackingSettings),
                    });

                    if (res.ok) {
                        this.showToast("Tracking settings saved");
                    } else {
                        this.showToast(
                            "Failed to save tracking settings",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast("Failed to save tracking settings", "error");
                } finally {
                    this.savingTracking = false;
                }
            },

            async changePassword() {
                if (this.newPassword !== this.confirmPassword) {
                    this.showToast("Passwords do not match", "error");
                    return;
                }

                if (this.newPassword.length < 8) {
                    this.showToast(
                        "Password must be at least 8 characters",
                        "error",
                    );
                    return;
                }

                this.changingPassword = true;
                try {
                    const res = await fetch("/api/settings/password", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            new_password: this.newPassword,
                        }),
                    });

                    if (res.ok) {
                        this.showToast("Password changed successfully");
                        this.newPassword = "";
                        this.confirmPassword = "";
                    } else {
                        const data = await res.json();
                        this.showToast(
                            data.error || "Failed to change password",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast("Failed to change password", "error");
                } finally {
                    this.changingPassword = false;
                }
            },

            async handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.importing = true;
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    const res = await fetch("/api/config/import", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });

                    if (res.ok) {
                        const result = await res.json();
                        const stats = result.stats;
                        const total = Object.values(stats).reduce(
                            (a, b) => a + b,
                            0,
                        );
                        this.showToast(`Imported ${total} items successfully`);
                        await this.loadSettings();
                    } else {
                        const error = await res.json();
                        this.showToast(
                            error.error || "Failed to import configuration",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast(
                        "Failed to parse import file: " + err.message,
                        "error",
                    );
                } finally {
                    this.importing = false;
                    // Reset the file input
                    event.target.value = "";
                }
            },

            async checkSync() {
                this.checkingSync = true;
                this.syncResults = null;
                this.showSyncDiffs = false;

                try {
                    const body = {};
                    if (this.syncProvider) {
                        body.provider = this.syncProvider;
                    }

                    const res = await fetch("/api/models/sync", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });

                    if (res.ok) {
                        this.syncResults = await res.json();
                        if (this.syncResults.differences_found === 0) {
                            this.showToast("Models are up to date");
                        } else {
                            const updates =
                                this.syncResults.price_update_count || 0;
                            const newModels =
                                this.syncResults.new_model_count || 0;
                            this.showToast(
                                `Found ${updates} price updates, ${newModels} new models`,
                                "warning",
                            );
                        }
                    } else {
                        const error = await res.json();
                        this.showToast(
                            error.error || "Failed to check models",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast(
                        "Failed to check models: " + err.message,
                        "error",
                    );
                } finally {
                    this.checkingSync = false;
                }
            },

            async applyModelSync(action) {
                this.applyingSync = true;

                try {
                    const body = {};
                    if (this.syncProvider) {
                        body.provider = this.syncProvider;
                    }

                    if (action === "update_existing") {
                        body.update_existing = true;
                    } else if (action === "add_new") {
                        body.add_new = true;
                    }

                    const res = await fetch("/api/models/sync", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });

                    if (res.ok) {
                        const result = await res.json();

                        if (action === "update_existing") {
                            this.syncResults.updates_applied = true;
                            this.syncResults.overrides_created =
                                result.overrides_created || 0;
                            this.syncResults.overrides_updated =
                                result.overrides_updated || 0;
                            const total =
                                (result.overrides_created || 0) +
                                (result.overrides_updated || 0);
                            this.showToast(`Updated ${total} model prices`);
                        } else if (action === "add_new") {
                            this.syncResults.new_models_applied = true;
                            this.syncResults.new_models_added =
                                result.new_models_added || 0;
                            this.showToast(
                                `Added ${result.new_models_added || 0} new models`,
                            );
                        }
                    } else {
                        const error = await res.json();
                        this.showToast(
                            error.error || "Failed to apply changes",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast(
                        "Failed to apply changes: " + err.message,
                        "error",
                    );
                } finally {
                    this.applyingSync = false;
                }
            },

            showToast(message, type = "success") {
                const id = Date.now();
                this.toasts.push({ id, message, type });
                setTimeout(() => {
                    this.toasts = this.toasts.filter((t) => t.id !== id);
                }, 3000);
            },

            // Debug log methods
            async initDebugLogs() {
                // Check current state
                try {
                    const res = await fetch("/api/debug/logs");
                    if (res.ok) {
                        const data = await res.json();
                        this.debugLogsEnabled = data.enabled;
                        this.debugLogs = data.logs || [];

                        // If enabled, start streaming
                        if (this.debugLogsEnabled) {
                            this.startDebugStream();
                        }
                    }
                } catch (err) {
                    console.error("Failed to init debug logs:", err);
                }
            },

            async toggleDebugLogs() {
                const endpoint = this.debugLogsEnabled
                    ? "/api/debug/logs/disable"
                    : "/api/debug/logs/enable";

                try {
                    const res = await fetch(endpoint, { method: "POST" });
                    if (res.ok) {
                        const data = await res.json();
                        this.debugLogsEnabled = data.enabled;

                        if (this.debugLogsEnabled) {
                            this.startDebugStream();
                            this.showToast("Debug log capture started");
                        } else {
                            this.stopDebugStream();
                            this.showToast("Debug log capture stopped");
                        }
                    }
                } catch (err) {
                    this.showToast("Failed to toggle debug logs", "error");
                }
            },

            startDebugStream() {
                // Close existing connection if any
                this.stopDebugStream();

                // Create new EventSource for SSE
                this.debugEventSource = new EventSource(
                    "/api/debug/logs/stream",
                );

                this.debugEventSource.onopen = () => {
                    this.debugStreamConnected = true;
                };

                this.debugEventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === "connected") {
                            this.debugStreamConnected = true;
                        } else if (data.type === "log") {
                            this.debugLogs.push(data.entry);
                            // Limit buffer size
                            if (this.debugLogs.length > 2000) {
                                this.debugLogs = this.debugLogs.slice(-1500);
                            }
                            // Auto-scroll
                            if (this.debugAutoScroll) {
                                this.$nextTick(() => {
                                    const container =
                                        this.$refs.debugLogContainer;
                                    if (container) {
                                        container.scrollTop =
                                            container.scrollHeight;
                                    }
                                });
                            }
                        }
                    } catch (err) {
                        console.error("Failed to parse debug log:", err);
                    }
                };

                this.debugEventSource.onerror = () => {
                    this.debugStreamConnected = false;
                    // Attempt to reconnect after a delay
                    setTimeout(() => {
                        if (
                            this.debugLogsEnabled &&
                            !this.debugStreamConnected
                        ) {
                            this.startDebugStream();
                        }
                    }, 3000);
                };
            },

            stopDebugStream() {
                if (this.debugEventSource) {
                    this.debugEventSource.close();
                    this.debugEventSource = null;
                }
                this.debugStreamConnected = false;
            },

            async clearDebugLogs() {
                try {
                    await fetch("/api/debug/logs/clear", { method: "POST" });
                    this.debugLogs = [];
                    this.showToast("Debug logs cleared");
                } catch (err) {
                    this.showToast("Failed to clear logs", "error");
                }
            },
        };
    }
</script>
{% endblock %}
