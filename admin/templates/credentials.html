{% extends "base.html" %}
{% block title %}Credentials{% endblock %}
{% block content %}
<div x-data="credentialsPage()" x-init="init()">
    <!-- Header -->
    <div class="flex justify-between items-start mb-6">
        <div>
            <h1 class="text-2xl font-bold">Credentials</h1>
            <p class="text-base-content/60">Manage API keys and OAuth accounts</p>
        </div>
        <div class="flex gap-2">
            <button @click="refreshAll()" class="btn btn-ghost btn-sm" :disabled="loading">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Refresh
            </button>
        </div>
    </div>

    <!-- Loading state -->
    <template x-if="loading">
        <div class="flex justify-center py-12">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    </template>

    <template x-if="!loading">
        <div class="space-y-8">
            <!-- OAuth Accounts Section -->
            <div class="card bg-base-100 shadow-sm">
                <div class="card-body">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                            </svg>
                            OAuth Accounts
                        </h2>
                        <div class="dropdown dropdown-end">
                            <label tabindex="0" class="btn btn-primary btn-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Connect Account
                            </label>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                                <li class="menu-title"><span>Google</span></li>
                                <li><a @click="connectOAuth('google', 'workspace')">Google Workspace (All)</a></li>
                                <li><a @click="connectOAuth('google', 'gmail')">Gmail Only</a></li>
                                <li><a @click="connectOAuth('google', 'calendar')">Calendar Only</a></li>
                                <li><a @click="connectOAuth('google', 'drive')">Drive Only</a></li>
                                <li class="menu-title mt-2"><span>Microsoft</span></li>
                                <li><a @click="connectOAuth('microsoft', 'all')">Microsoft 365 (All)</a></li>
                                <li><a @click="connectOAuth('microsoft', 'outlook')">Outlook Only</a></li>
                                <li><a @click="connectOAuth('microsoft', 'onedrive')">OneDrive Only</a></li>
                                <li class="menu-title mt-2"><span>Other</span></li>
                                <li><a @click="connectOAuth('slack', 'bot')">Slack</a></li>
                                <li><a @click="connectOAuth('oura', 'all')">Oura Ring</a></li>
                                <li><a @click="connectOAuth('withings', 'all')">Withings</a></li>
                            </ul>
                        </div>
                    </div>

                    <!-- OAuth accounts list -->
                    <template x-if="oauthAccounts.length === 0">
                        <div class="text-center py-8 text-base-content/60">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            <p>No OAuth accounts connected</p>
                            <p class="text-sm">Connect an account to enable integrations</p>
                        </div>
                    </template>

                    <template x-if="oauthAccounts.length > 0">
                        <div class="overflow-x-auto">
                            <table class="table table-zebra">
                                <thead>
                                    <tr>
                                        <th>Provider</th>
                                        <th>Account</th>
                                        <th>Scopes</th>
                                        <th>Status</th>
                                        <th>Last Used</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="account in oauthAccounts" :key="account.id">
                                        <tr>
                                            <td>
                                                <div class="flex items-center gap-2">
                                                    <span x-text="getProviderIcon(account.provider)" class="text-lg"></span>
                                                    <span class="font-medium capitalize" x-text="account.provider"></span>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <div class="font-medium" x-text="account.account_email || 'Unknown'"></div>
                                                    <div class="text-xs text-base-content/60" x-text="account.account_name || ''"></div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex flex-wrap gap-1 max-w-xs">
                                                    <template x-for="scope in getScopeNames(account.scopes)" :key="scope">
                                                        <span class="badge badge-ghost badge-sm" x-text="scope"></span>
                                                    </template>
                                                </div>
                                            </td>
                                            <td>
                                                <span x-show="account.is_valid" class="badge badge-success badge-sm">Valid</span>
                                                <span x-show="!account.is_valid" class="badge badge-error badge-sm">Invalid</span>
                                            </td>
                                            <td>
                                                <span class="text-sm" x-text="formatDate(account.last_used)"></span>
                                            </td>
                                            <td>
                                                <div class="flex gap-1">
                                                    <button @click="reconnectOAuth(account)" class="btn btn-ghost btn-xs" title="Reconnect">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                        </svg>
                                                    </button>
                                                    <button @click="deleteOAuthAccount(account)" class="btn btn-ghost btn-xs text-error" title="Disconnect">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </template>
                </div>
            </div>

            <!-- API Keys Section -->
            <div class="card bg-base-100 shadow-sm">
                <div class="card-body">
                    <h2 class="card-title mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                        API Keys
                        <span class="badge badge-ghost" x-text="apiKeys.filter(k => k.is_set).length + '/' + apiKeys.length + ' configured'"></span>
                    </h2>

                    <p class="text-sm text-base-content/60 mb-4">
                        API keys are set via environment variables for security. Restart the container after changing environment variables.
                    </p>

                    <!-- LLM Providers -->
                    <div class="mb-6">
                        <h3 class="font-semibold mb-2 text-sm uppercase text-base-content/60">LLM Providers</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <template x-for="key in apiKeys.filter(k => k.category === 'llm')" :key="key.env_var">
                                <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <span x-text="key.icon" class="text-lg"></span>
                                        <div>
                                            <div class="font-medium text-sm" x-text="key.name"></div>
                                            <div class="text-xs text-base-content/60 font-mono" x-text="key.env_var"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <span x-show="key.is_set" class="badge badge-success badge-sm">
                                            <span x-text="key.redacted"></span>
                                        </span>
                                        <span x-show="!key.is_set" class="badge badge-ghost badge-sm">Not set</span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Data & Search Providers -->
                    <div class="mb-6">
                        <h3 class="font-semibold mb-2 text-sm uppercase text-base-content/60">Data & Search</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <template x-for="key in apiKeys.filter(k => k.category === 'data')" :key="key.env_var">
                                <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <span x-text="key.icon" class="text-lg"></span>
                                        <div>
                                            <div class="font-medium text-sm" x-text="key.name"></div>
                                            <div class="text-xs text-base-content/60 font-mono" x-text="key.env_var"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <span x-show="key.is_set" class="badge badge-success badge-sm">
                                            <span x-text="key.redacted"></span>
                                        </span>
                                        <span x-show="!key.is_set" class="badge badge-ghost badge-sm">Not set</span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- OAuth Client Credentials -->
                    <div>
                        <h3 class="font-semibold mb-2 text-sm uppercase text-base-content/60">OAuth Client Credentials</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <template x-for="key in apiKeys.filter(k => k.category === 'oauth')" :key="key.env_var">
                                <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <span x-text="key.icon" class="text-lg"></span>
                                        <div>
                                            <div class="font-medium text-sm" x-text="key.name"></div>
                                            <div class="text-xs text-base-content/60 font-mono" x-text="key.env_var"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <span x-show="key.is_set" class="badge badge-success badge-sm">
                                            <span x-text="key.redacted"></span>
                                        </span>
                                        <span x-show="!key.is_set" class="badge badge-ghost badge-sm">Not set</span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Credentials Section -->
            <div class="card bg-base-100 shadow-sm">
                <div class="card-body">
                    <h2 class="card-title mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                        </svg>
                        Service Credentials
                    </h2>

                    <p class="text-sm text-base-content/60 mb-4">
                        Credentials for external services (Paperless, Nextcloud, Notion, etc.)
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <template x-for="key in apiKeys.filter(k => k.category === 'service')" :key="key.env_var">
                            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <span x-text="key.icon" class="text-lg"></span>
                                    <div>
                                        <div class="font-medium text-sm" x-text="key.name"></div>
                                        <div class="text-xs text-base-content/60 font-mono" x-text="key.env_var"></div>
                                    </div>
                                </div>
                                <div>
                                    <span x-show="key.is_set" class="badge badge-success badge-sm">
                                        <span x-text="key.redacted"></span>
                                    </span>
                                    <span x-show="!key.is_set" class="badge badge-ghost badge-sm">Not set</span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
function credentialsPage() {
    return {
        loading: false,
        oauthAccounts: [],
        apiKeys: [],

        async init() {
            await this.refreshAll();

            // Listen for OAuth popup success
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'oauth_success') {
                    this.loadOAuthAccounts();
                }
            });
        },

        async refreshAll() {
            this.loading = true;
            await Promise.all([
                this.loadOAuthAccounts(),
                this.loadApiKeys()
            ]);
            this.loading = false;
        },

        async loadOAuthAccounts() {
            try {
                const response = await fetch('/api/oauth/tokens');
                if (response.ok) {
                    this.oauthAccounts = await response.json();
                }
            } catch (error) {
                console.error('Failed to load OAuth accounts:', error);
            }
        },

        async loadApiKeys() {
            try {
                const response = await fetch('/api/credentials/api-keys');
                if (response.ok) {
                    this.apiKeys = await response.json();
                }
            } catch (error) {
                console.error('Failed to load API keys:', error);
            }
        },

        connectOAuth(provider, scope) {
            const width = 600;
            const height = 700;
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;

            let url;
            if (provider === 'google') {
                url = `/api/oauth/google/start?scope=${scope}&popup=true`;
            } else if (provider === 'microsoft') {
                url = `/api/oauth/microsoft/start?scope=${scope}&popup=true`;
            } else if (provider === 'slack') {
                url = `/api/oauth/slack/start?popup=true`;
            } else if (provider === 'oura') {
                url = `/api/oauth/oura/start?popup=true`;
            } else if (provider === 'withings') {
                url = `/api/oauth/withings/start?popup=true`;
            } else {
                console.error('Unknown OAuth provider:', provider);
                return;
            }

            window.open(
                url,
                'oauth_popup',
                `width=${width},height=${height},left=${left},top=${top}`
            );
        },

        async reconnectOAuth(account) {
            // Reconnect using the same provider
            let scope = 'all';
            if (account.scopes) {
                // Try to determine scope from existing scopes
                const scopeStr = JSON.stringify(account.scopes).toLowerCase();
                if (scopeStr.includes('gmail') && !scopeStr.includes('drive') && !scopeStr.includes('calendar')) {
                    scope = 'gmail';
                } else if (scopeStr.includes('calendar') && !scopeStr.includes('gmail') && !scopeStr.includes('drive')) {
                    scope = 'calendar';
                } else if (scopeStr.includes('drive') && !scopeStr.includes('gmail') && !scopeStr.includes('calendar')) {
                    scope = 'drive';
                } else {
                    scope = 'workspace';
                }
            }
            this.connectOAuth(account.provider, scope);
        },

        async deleteOAuthAccount(account) {
            if (!confirm(`Disconnect ${account.account_email}?\n\nThis will remove access to all integrations using this account.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/oauth/tokens/${account.id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await this.loadOAuthAccounts();
                } else {
                    const error = await response.json();
                    alert('Failed to disconnect: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to disconnect: ' + error.message);
            }
        },

        getProviderIcon(provider) {
            const icons = {
                'google': 'ðŸ”µ',
                'microsoft': 'ðŸŸ¦',
                'slack': 'ðŸ’¬',
                'oura': 'ðŸ’',
                'withings': 'âš–ï¸',
                'github': 'ðŸ™'
            };
            return icons[provider] || 'ðŸ”‘';
        },

        getScopeNames(scopes) {
            if (!scopes) return [];
            // Parse scope URLs to friendly names
            const scopeList = Array.isArray(scopes) ? scopes : JSON.parse(scopes || '[]');
            return scopeList.map(scope => {
                // Extract the last part of the scope URL
                const parts = scope.split('/');
                const name = parts[parts.length - 1];
                // Clean up common suffixes
                return name.replace('.readonly', ' (R)')
                          .replace('.modify', ' (RW)')
                          .replace('https://www.googleapis.com/auth/', '')
                          .replace('https://graph.microsoft.com/', '');
            }).slice(0, 5); // Limit to 5 scopes shown
        },

        formatDate(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';

            return date.toLocaleDateString();
        }
    };
}
</script>
{% endblock %}
