{% extends "base.html" %} {% block title %}Document Stores{% endblock %} {%
block content %}
<div x-data="documentStoresPage()" x-init="init()">
    <!-- Header -->
    <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6"
    >
        <div>
            <h1 class="text-2xl font-bold">Document Stores</h1>
            <p class="text-base-content/60">
                Configure and index document sources for Smart RAGs
            </p>
        </div>
        <button @click="openAddModal()" class="btn btn-primary btn-sm">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 mr-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                />
            </svg>
            Add Store
        </button>
    </div>

    <!-- Filter Tabs (content-based categories) -->
    <div class="tabs tabs-boxed bg-base-200 mb-4 inline-flex">
        <button
            @click="setFilter('all')"
            class="tab"
            :class="{ 'tab-active': filterMode === 'all' }"
        >
            All
            <span class="badge badge-sm ml-1" x-text="tabCounts.all"></span>
        </button>
        <button
            @click="setFilter('files')"
            class="tab"
            :class="{ 'tab-active': filterMode === 'files' }"
            x-show="tabCounts.files > 0"
        >
            Files
            <span class="badge badge-sm ml-1" x-text="tabCounts.files"></span>
        </button>
        <button
            @click="setFilter('emails')"
            class="tab"
            :class="{ 'tab-active': filterMode === 'emails' }"
            x-show="tabCounts.emails > 0"
        >
            Emails
            <span class="badge badge-sm ml-1" x-text="tabCounts.emails"></span>
        </button>
        <button
            @click="setFilter('calendars')"
            class="tab"
            :class="{ 'tab-active': filterMode === 'calendars' }"
            x-show="tabCounts.calendars > 0"
        >
            Calendars
            <span
                class="badge badge-sm ml-1"
                x-text="tabCounts.calendars"
            ></span>
        </button>
        <button
            @click="setFilter('tasks')"
            class="tab"
            :class="{ 'tab-active': filterMode === 'tasks' }"
            x-show="tabCounts.tasks > 0"
        >
            Tasks
            <span class="badge badge-sm ml-1" x-text="tabCounts.tasks"></span>
        </button>
        <button
            @click="setFilter('notes')"
            class="tab"
            :class="{ 'tab-active': filterMode === 'notes' }"
            x-show="tabCounts.notes > 0"
        >
            Notes
            <span class="badge badge-sm ml-1" x-text="tabCounts.notes"></span>
        </button>
        <button
            @click="setFilter('websites')"
            class="tab"
            :class="{ 'tab-active': filterMode === 'websites' }"
            x-show="tabCounts.websites > 0"
        >
            Websites
            <span
                class="badge badge-sm ml-1"
                x-text="tabCounts.websites"
            ></span>
        </button>
        <button
            @click="setFilter('messages')"
            class="tab"
            :class="{ 'tab-active': filterMode === 'messages' }"
            x-show="tabCounts.messages > 0"
        >
            Messages
            <span
                class="badge badge-sm ml-1"
                x-text="tabCounts.messages"
            ></span>
        </button>
        <button
            @click="setFilter('other')"
            class="tab"
            :class="{ 'tab-active': filterMode === 'other' }"
            x-show="tabCounts.other > 0"
        >
            Other
            <span class="badge badge-sm ml-1" x-text="tabCounts.other"></span>
        </button>
    </div>

    <!-- Loading State -->
    <template x-if="loading">
        <div class="flex justify-center py-12">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    </template>

    <!-- No Stores Configured -->
    <template x-if="!loading && filteredStores.length === 0">
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center py-12">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-16 w-16 mx-auto text-base-content/30"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"
                    />
                </svg>
                <h3 class="mt-4 text-lg font-medium">
                    <span x-show="filterMode === 'all'"
                        >No Document Stores Configured</span
                    >
                    <span
                        x-show="filterMode !== 'all'"
                        x-text="'No ' + filterLabel + ' stores'"
                    ></span>
                </h3>
                <p class="mt-2 text-base-content/60 max-w-md mx-auto">
                    Document stores index documents from local folders, cloud
                    services, or websites. They can be shared across multiple
                    Smart RAGs for multi-source search.
                </p>
                <button @click="openAddModal()" class="btn btn-primary mt-4">
                    Create Your First Store
                </button>
            </div>
        </div>
    </template>

    <!-- Store Table -->
    <template x-if="!loading && filteredStores.length > 0">
        <div class="card bg-base-100 shadow-lg">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="w-8"></th>
                            <th>Store</th>
                            <th>Index</th>
                            <th class="text-right">Docs</th>
                            <th class="text-right">Chunks</th>
                            <th>Status</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <template x-for="store in filteredStores" :key="store.id">
                        <tbody>
                            <!-- Main Row -->
                            <tr
                                @click="toggleExpand(store.id)"
                                class="cursor-pointer hover:bg-base-200 transition-colors duration-500"
                                :data-store-id="store.id"
                            >
                                <td class="w-8">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 transition-transform"
                                        :class="{'rotate-90': expandedRows.includes(store.id)}"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 5l7 7-7 7"
                                        />
                                    </svg>
                                </td>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <span
                                            class="text-xl"
                                            x-text="store.unified_source?.icon || getSourceIcon(store)"
                                        ></span>
                                        <div>
                                            <div
                                                class="flex items-center gap-1.5"
                                            >
                                                <span
                                                    class="font-medium"
                                                    x-text="getStoreDisplayName(store)"
                                                ></span>
                                                <span
                                                    x-show="store.unified_source?.supports_live"
                                                    class="text-warning text-xs"
                                                    title="Live data enabled"
                                                    >âš¡</span
                                                >
                                            </div>
                                            <div
                                                class="text-xs text-base-content/50"
                                                x-text="getSourceDetailShort(store) || getSourceBadgeText(store)"
                                            ></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="badge badge-sm"
                                            :class="{
                                                'badge-success': store.index_status === 'ready',
                                                'badge-warning': store.index_status === 'indexing',
                                                'badge-error': store.index_status === 'error',
                                                'badge-ghost': store.index_status === 'pending'
                                            }"
                                            x-text="store.index_status"
                                        ></span>
                                        <span
                                            x-show="store.index_status === 'indexing'"
                                            class="loading loading-spinner loading-xs"
                                        ></span>
                                    </div>
                                </td>
                                <td class="text-right">
                                    <span
                                        class="font-mono text-sm"
                                        x-text="store.document_count || 0"
                                    ></span>
                                </td>
                                <td class="text-right">
                                    <span
                                        class="font-mono text-sm"
                                        x-text="store.chunk_count || 0"
                                    ></span>
                                </td>
                                <td>
                                    <span
                                        class="badge badge-sm"
                                        :class="store.enabled ? 'badge-success' : 'badge-ghost'"
                                        x-text="store.enabled ? 'Enabled' : 'Disabled'"
                                    ></span>
                                </td>
                                <td class="text-right" @click.stop>
                                    <div class="flex justify-end gap-1">
                                        <!-- Index Now button (hidden when indexing) -->
                                        <button
                                            x-show="store.index_status !== 'indexing'"
                                            @click="indexNow(store)"
                                            class="btn btn-ghost btn-sm"
                                            :class="{ 'loading': indexingStores.includes(store.id) }"
                                            :disabled="indexingStores.includes(store.id)"
                                            title="Index now"
                                        >
                                            <svg
                                                x-show="!indexingStores.includes(store.id)"
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                                />
                                            </svg>
                                        </button>
                                        <!-- Cancel Index button (shown when indexing) -->
                                        <button
                                            x-show="store.index_status === 'indexing'"
                                            @click="cancelIndex(store)"
                                            class="btn btn-ghost btn-sm text-warning"
                                            :class="{ 'loading': cancellingStores.includes(store.id) }"
                                            :disabled="cancellingStores.includes(store.id)"
                                            title="Cancel indexing"
                                        >
                                            <svg
                                                x-show="!cancellingStores.includes(store.id)"
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M6 18L18 6M6 6l12 12"
                                                />
                                            </svg>
                                        </button>
                                        <!-- Preview button (shown when has content) -->
                                        <button
                                            x-show="store.chunk_count > 0"
                                            @click="openPreviewModal(store)"
                                            class="btn btn-ghost btn-sm text-info"
                                            title="Preview content"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                                />
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                                />
                                            </svg>
                                        </button>
                                        <!-- Test Unified button (shown for unified sources) -->
                                        <button
                                            x-show="store.unified_source"
                                            @click="testUnified(store)"
                                            class="btn btn-ghost btn-sm text-accent"
                                            :class="{ 'loading': testingUnifiedStores.includes(store.id) }"
                                            :disabled="testingUnifiedStores.includes(store.id)"
                                            :title="'Test ' + (store.unified_source?.supports_live ? 'RAG + Live' : 'RAG') + ' connection'"
                                        >
                                            <svg
                                                x-show="!testingUnifiedStores.includes(store.id)"
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                                />
                                            </svg>
                                        </button>
                                        <!-- Clear Contents button (shown when has content) -->
                                        <button
                                            x-show="store.chunk_count > 0 && store.index_status !== 'indexing'"
                                            @click="clearContents(store)"
                                            class="btn btn-ghost btn-sm text-warning"
                                            :class="{ 'loading': clearingStores.includes(store.id) }"
                                            :disabled="clearingStores.includes(store.id)"
                                            title="Clear indexed content"
                                        >
                                            <svg
                                                x-show="!clearingStores.includes(store.id)"
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                />
                                            </svg>
                                        </button>
                                        <button
                                            @click="openEditModal(store)"
                                            class="btn btn-ghost btn-sm"
                                            title="Edit store"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                                />
                                            </svg>
                                        </button>
                                        <button
                                            @click="confirmDelete(store)"
                                            class="btn btn-ghost btn-sm text-error"
                                            :disabled="store.rag_count > 0"
                                            :title="store.rag_count > 0 ? 'Cannot delete - used by RAGs' : 'Delete store'"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Expanded Details Row -->
                            <tr
                                x-show="expandedRows.includes(store.id)"
                                x-transition
                            >
                                <td colspan="9" class="bg-base-200 p-0">
                                    <div
                                        class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"
                                    >
                                        <!-- Description -->
                                        <div
                                            x-show="store.description"
                                            class="md:col-span-2"
                                        >
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Description
                                            </div>
                                            <div
                                                class="text-sm"
                                                x-text="store.description"
                                            ></div>
                                        </div>
                                        <!-- Source Path (full) -->
                                        <div
                                            x-show="getSourceDetail(store)"
                                            class="md:col-span-2"
                                        >
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Source Path
                                            </div>
                                            <div
                                                class="font-mono text-xs break-all"
                                                x-text="getSourceDetail(store)"
                                            ></div>
                                        </div>
                                        <!-- Embedding Provider -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Embedding
                                            </div>
                                            <div class="font-mono text-xs">
                                                <span
                                                    x-text="store.embedding_provider"
                                                ></span>
                                                <span
                                                    x-show="store.embedding_model"
                                                    x-text="' / ' + store.embedding_model"
                                                ></span>
                                            </div>
                                        </div>
                                        <!-- Vision Provider -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Vision
                                            </div>
                                            <div class="font-mono text-xs">
                                                <span
                                                    x-text="store.vision_provider"
                                                ></span>
                                                <span
                                                    x-show="store.vision_model"
                                                    x-text="' / ' + store.vision_model"
                                                ></span>
                                            </div>
                                        </div>
                                        <!-- Index Schedule -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Schedule
                                            </div>
                                            <div
                                                class="text-xs"
                                                x-text="store.index_schedule || 'Manual only'"
                                            ></div>
                                        </div>
                                        <!-- Last Indexed -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Last Indexed
                                            </div>
                                            <div
                                                class="text-xs"
                                                x-text="store.last_indexed ? new Date(store.last_indexed).toLocaleString() : 'Never'"
                                            ></div>
                                        </div>
                                        <!-- Chunking -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Chunking
                                            </div>
                                            <div class="text-xs">
                                                Size:
                                                <span
                                                    class="font-mono"
                                                    x-text="store.chunk_size"
                                                ></span
                                                >, Overlap:
                                                <span
                                                    class="font-mono"
                                                    x-text="store.chunk_overlap"
                                                ></span>
                                            </div>
                                        </div>
                                        <!-- Collection Name -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Collection
                                            </div>
                                            <div
                                                class="font-mono text-xs"
                                                x-text="store.collection_name || 'Not created'"
                                            ></div>
                                        </div>
                                        <!-- Error (if any) -->
                                        <div
                                            x-show="store.index_error"
                                            class="md:col-span-2"
                                        >
                                            <div
                                                class="text-xs text-error uppercase mb-1"
                                            >
                                                Index Error
                                            </div>
                                            <div
                                                class="text-xs text-error"
                                                x-text="store.index_error"
                                            ></div>
                                        </div>
                                    </div>

                                    <!-- Intelligence Section -->
                                    <div
                                        x-show="store.themes?.length || store.best_for || store.content_summary"
                                        class="border-t border-base-300 p-4"
                                    >
                                        <div
                                            class="flex items-center justify-between mb-3"
                                        >
                                            <div
                                                class="text-xs text-base-content/50 uppercase font-medium"
                                            >
                                                Document Intelligence
                                            </div>
                                            <div
                                                class="flex items-center gap-2"
                                            >
                                                <span
                                                    x-show="store.intelligence_updated_at"
                                                    class="text-xs text-base-content/40"
                                                    x-text="'Updated: ' + new Date(store.intelligence_updated_at).toLocaleDateString()"
                                                ></span>
                                                <button
                                                    @click="refreshIntelligence(store)"
                                                    class="btn btn-ghost btn-xs"
                                                    :class="{ 'loading': refreshingIntelligence === store.id }"
                                                    :disabled="refreshingIntelligence === store.id"
                                                    title="Regenerate intelligence"
                                                >
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        class="h-3 w-3"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <div
                                            class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm"
                                        >
                                            <!-- Themes -->
                                            <div x-show="store.themes?.length">
                                                <div
                                                    class="text-xs text-base-content/50 mb-1"
                                                >
                                                    Themes
                                                </div>
                                                <div
                                                    class="flex flex-wrap gap-1"
                                                >
                                                    <template
                                                        x-for="theme in store.themes"
                                                        :key="theme"
                                                    >
                                                        <span
                                                            class="badge badge-sm badge-outline"
                                                            x-text="theme"
                                                        ></span>
                                                    </template>
                                                </div>
                                            </div>
                                            <!-- Best For -->
                                            <div x-show="store.best_for">
                                                <div
                                                    class="text-xs text-base-content/50 mb-1"
                                                >
                                                    Best For
                                                </div>
                                                <div
                                                    class="text-xs"
                                                    x-text="store.best_for"
                                                ></div>
                                            </div>
                                            <!-- Summary -->
                                            <div x-show="store.content_summary">
                                                <div
                                                    class="text-xs text-base-content/50 mb-1"
                                                >
                                                    Summary
                                                </div>
                                                <div
                                                    class="text-xs"
                                                    x-text="store.content_summary"
                                                ></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- No Intelligence - offer to generate -->
                                    <div
                                        x-show="!store.themes?.length && !store.best_for && !store.content_summary && store.index_status === 'ready' && store.chunk_count > 0"
                                        class="border-t border-base-300 p-4"
                                    >
                                        <div
                                            class="flex items-center justify-between"
                                        >
                                            <span
                                                class="text-xs text-base-content/50"
                                                >No intelligence generated</span
                                            >
                                            <button
                                                @click="refreshIntelligence(store)"
                                                class="btn btn-ghost btn-xs"
                                                :class="{ 'loading': refreshingIntelligence === store.id }"
                                                :disabled="refreshingIntelligence === store.id"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-3 w-3 mr-1"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M13 10V3L4 14h7v7l9-11h-7z"
                                                    />
                                                </svg>
                                                Generate Intelligence
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </template>
                </table>
            </div>
        </div>
    </template>

    <!-- Add/Edit Modal -->
    <div class="modal" :class="{ 'modal-open': showModal }">
        <div class="modal-box max-w-2xl">
            <h3
                class="font-bold text-lg"
                x-text="editingStore ? 'Edit Document Store' : 'Add Document Store'"
            ></h3>
            <form @submit.prevent="saveStore()">
                <!-- Name -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Store Name</span>
                    </label>
                    <input
                        type="text"
                        x-model="form.name"
                        class="input input-bordered"
                        :class="{ 'input-error': formErrors.name }"
                        placeholder="e.g., work-gmail, personal-calendar"
                        required
                        :disabled="editingStore"
                    />
                    <label class="label">
                        <span class="label-text-alt" x-show="!formErrors.name"
                            >Unique identifier (lowercase, no spaces)</span
                        >
                        <span
                            class="label-text-alt text-error"
                            x-show="formErrors.name"
                            x-text="formErrors.name"
                        ></span>
                    </label>
                </div>

                <!-- Display Name (for actionable sources) -->
                <div
                    class="form-control mt-4"
                    x-show="isActionableSource(form.source_type)"
                >
                    <label class="label">
                        <span class="label-text">Display Name</span>
                        <span class="label-text-alt text-base-content/60"
                            >Used by LLM to identify this account</span
                        >
                    </label>
                    <input
                        type="text"
                        x-model="form.display_name"
                        class="input input-bordered"
                        placeholder="e.g., Work Email, Personal Calendar, Home Tasks"
                    />
                    <label class="label">
                        <span class="label-text-alt"
                            >Friendly name for LLM instructions (e.g., "send
                            from Work Email")</span
                        >
                    </label>
                </div>

                <!-- Source Type -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Document Source</span>
                    </label>
                    <select
                        x-model="form.source_type"
                        @change="onSourceTypeChange()"
                        class="select select-bordered"
                    >
                        <option value="local">Local Filesystem</option>
                        <optgroup label="Google">
                            <option value="mcp:gdrive">Google Drive</option>
                            <option value="mcp:gmail">Gmail</option>
                            <option value="mcp:gcalendar">
                                Google Calendar
                            </option>
                            <option value="mcp:gtasks">Google Tasks</option>
                            <option value="mcp:gcontacts">
                                Google Contacts
                            </option>
                            <!-- Google Keep disabled - requires domain-wide delegation, not standard OAuth
                            <option value="mcp:gkeep">
                                Google Keep (Workspace)
                            </option>
                            -->
                        </optgroup>
                        <optgroup label="Microsoft">
                            <option value="mcp:onedrive">OneDrive</option>
                            <option value="mcp:outlook">Outlook Mail</option>
                            <option value="mcp:onenote">OneNote</option>
                            <option value="mcp:teams">Teams</option>
                        </optgroup>
                        <optgroup label="Document Management">
                            <option
                                value="paperless"
                                x-show="documentSources.paperless?.configured"
                            >
                                Paperless-ngx
                            </option>
                            <option
                                value="notion"
                                x-show="documentSources.notion?.configured"
                            >
                                Notion
                            </option>
                            <option
                                value="nextcloud"
                                x-show="documentSources.nextcloud?.configured"
                            >
                                Nextcloud
                            </option>
                        </optgroup>
                        <optgroup label="Web">
                            <option value="website">Website (crawled)</option>
                            <option value="websearch">
                                Web Search (scheduled)
                            </option>
                        </optgroup>
                        <optgroup label="Other Integrations">
                            <option
                                value="mcp:github"
                                x-show="documentSources.github?.configured"
                            >
                                GitHub
                            </option>
                            <option
                                value="slack"
                                x-show="documentSources.slack?.configured"
                            >
                                Slack
                            </option>
                            <option
                                value="todoist"
                                x-show="documentSources.todoist?.configured"
                            >
                                Todoist
                            </option>
                        </optgroup>
                    </select>
                    <label
                        class="label"
                        x-show="!mcpStatus.google?.available && !mcpStatus.notion?.available && !mcpStatus.github?.available && !mcpStatus.slack?.available"
                    >
                        <span class="label-text-alt text-base-content/60">
                            Set environment variables to enable MCP integrations
                            (e.g., NOTION_API_KEY, GITHUB_TOKEN)
                        </span>
                    </label>
                </div>

                <!-- Source Path (for local source) -->
                <div
                    class="form-control mt-4"
                    x-show="form.source_type === 'local'"
                >
                    <label class="label">
                        <span class="label-text">Source Path</span>
                    </label>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            x-model="form.source_path"
                            class="input input-bordered font-mono flex-1"
                            :class="{ 'input-error': formErrors.source_path }"
                            placeholder="e.g., /data/documents"
                            :required="form.source_type === 'local'"
                        />
                        <button
                            type="button"
                            @click="toggleLocalFolderBrowser()"
                            class="btn btn-outline btn-square"
                            title="Browse folders"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                />
                            </svg>
                        </button>
                    </div>

                    <!-- Local folder browser -->
                    <div
                        x-show="showLocalFolderBrowser"
                        x-transition
                        class="mt-2 border rounded-lg p-3 bg-base-200"
                    >
                        <!-- Breadcrumb navigation -->
                        <div
                            class="text-sm flex items-center gap-1 mb-2 flex-wrap"
                        >
                            <a
                                href="#"
                                @click.prevent="navigateLocalFolder('/')"
                                class="link link-hover"
                            >
                                /
                            </a>
                            <template
                                x-for="(crumb, index) in localFolderBreadcrumbs"
                                :key="crumb.path"
                            >
                                <span class="flex items-center gap-1">
                                    <span class="text-base-content/50"
                                        >&gt;</span
                                    >
                                    <a
                                        href="#"
                                        @click.prevent="navigateLocalFolder(crumb.path)"
                                        class="link link-hover"
                                        x-text="crumb.name"
                                    ></a>
                                </span>
                            </template>
                        </div>

                        <!-- Folder list -->
                        <div
                            class="border rounded-lg max-h-48 overflow-y-auto bg-base-100"
                        >
                            <div
                                x-show="loadingLocalFolders"
                                class="flex justify-center py-4"
                            >
                                <span
                                    class="loading loading-spinner loading-sm"
                                ></span>
                            </div>
                            <ul
                                x-show="!loadingLocalFolders"
                                class="menu menu-sm p-1"
                            >
                                <!-- "Select this folder" option -->
                                <li>
                                    <a
                                        href="#"
                                        @click.prevent="selectLocalFolder(currentLocalPath)"
                                        class="text-primary font-medium"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M5 13l4 4L19 7"
                                            />
                                        </svg>
                                        Select this folder
                                    </a>
                                </li>
                                <!-- Subfolders -->
                                <template
                                    x-for="folder in localFolders"
                                    :key="folder.path"
                                >
                                    <li>
                                        <a
                                            href="#"
                                            @click.prevent="navigateLocalFolder(folder.path)"
                                            class="font-mono text-sm"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                                />
                                            </svg>
                                            <span x-text="folder.name"></span>
                                        </a>
                                    </li>
                                </template>
                                <!-- No subfolders message -->
                                <li
                                    x-show="localFolders.length === 0 && !loadingLocalFolders"
                                >
                                    <span class="text-base-content/50 italic"
                                        >No subfolders</span
                                    >
                                </li>
                            </ul>
                        </div>
                    </div>

                    <label class="label">
                        <span class="label-text-alt"
                            >Docker-mounted folder containing documents to
                            index</span
                        >
                    </label>
                </div>

                <!-- Paperless Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'paperless'"
                    x-effect="if (form.source_type === 'paperless' && paperlessTags.length === 0 && !loadingPaperlessTags) loadPaperlessTags()"
                >
                    <!-- Tag Filter -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Filter by Tag (optional)</span
                            >
                        </label>
                        <select
                            x-model="form.paperless_tag_id"
                            @change="onPaperlessTagChange()"
                            class="select select-bordered w-full"
                        >
                            <option value="">
                                <span x-show="loadingPaperlessTags"
                                    >Loading tags...</span
                                >
                                <span x-show="!loadingPaperlessTags"
                                    >All documents (no filter)</span
                                >
                            </option>
                            <template
                                x-for="(tag, index) in paperlessTags"
                                :key="index"
                            >
                                <option :value="tag.id">
                                    <span
                                        x-text="tag.name + (tag.document_count ? ' (' + tag.document_count + ')' : '')"
                                    ></span>
                                </option>
                            </template>
                        </select>
                        <label class="label">
                            <span class="label-text-alt">
                                Only index documents with a specific tag, or
                                leave empty for all documents
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Nextcloud Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'nextcloud'"
                >
                    <!-- Folder Path with Browser -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Folder Path (optional)</span
                            >
                        </label>
                        <div class="join w-full">
                            <input
                                type="text"
                                x-model="form.nextcloud_folder"
                                class="input input-bordered join-item flex-1 font-mono"
                                placeholder="/ (all files)"
                            />
                            <button
                                type="button"
                                @click="toggleNextcloudFolderBrowser()"
                                class="btn btn-outline btn-square join-item"
                                title="Browse folders"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                    />
                                </svg>
                            </button>
                        </div>

                        <!-- Nextcloud folder browser -->
                        <div
                            x-show="showNextcloudFolderBrowser"
                            x-transition
                            class="mt-2 border rounded-lg p-3 bg-base-200"
                        >
                            <!-- Breadcrumb navigation -->
                            <div
                                class="text-sm flex items-center gap-1 mb-2 flex-wrap"
                            >
                                <a
                                    href="#"
                                    @click.prevent="navigateNextcloudFolder('/')"
                                    class="link link-hover"
                                >
                                    /
                                </a>
                                <template
                                    x-for="(crumb, index) in nextcloudFolderBreadcrumbs"
                                    :key="crumb.path"
                                >
                                    <span class="flex items-center gap-1">
                                        <span class="text-base-content/50"
                                            >&gt;</span
                                        >
                                        <a
                                            href="#"
                                            @click.prevent="navigateNextcloudFolder(crumb.path)"
                                            class="link link-hover"
                                            x-text="crumb.name"
                                        ></a>
                                    </span>
                                </template>
                            </div>

                            <!-- Folder list -->
                            <div
                                class="border rounded-lg max-h-48 overflow-y-auto bg-base-100"
                            >
                                <div
                                    x-show="loadingNextcloudFolders"
                                    class="flex justify-center py-4"
                                >
                                    <span
                                        class="loading loading-spinner loading-sm"
                                    ></span>
                                </div>
                                <ul
                                    x-show="!loadingNextcloudFolders"
                                    class="menu menu-sm p-1"
                                >
                                    <!-- "Select this folder" option -->
                                    <li>
                                        <a
                                            href="#"
                                            @click.prevent="selectNextcloudFolder(currentNextcloudPath)"
                                            class="text-primary font-medium"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M5 13l4 4L19 7"
                                                />
                                            </svg>
                                            Select this folder
                                        </a>
                                    </li>
                                    <!-- Subfolders -->
                                    <template
                                        x-for="folder in nextcloudFolders"
                                        :key="folder.path"
                                    >
                                        <li>
                                            <a
                                                href="#"
                                                @click.prevent="navigateNextcloudFolder(folder.path)"
                                                class="font-mono text-sm"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-4 w-4"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                                    />
                                                </svg>
                                                <span
                                                    x-text="folder.name"
                                                ></span>
                                            </a>
                                        </li>
                                    </template>
                                    <!-- Empty state -->
                                    <li
                                        x-show="nextcloudFolders.length === 0 && !loadingNextcloudFolders"
                                    >
                                        <span
                                            class="text-base-content/50 italic"
                                            >No subfolders</span
                                        >
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <label class="label">
                            <span class="label-text-alt">
                                Leave empty to index all files, or select a
                                folder to restrict indexing
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Notion Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'notion'"
                    x-effect="if (form.source_type === 'notion' && notionDatabases.length === 0 && !loadingNotionDatabases) loadNotionDatabases()"
                >
                    <!-- Database Selection -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Database (optional)</span>
                        </label>
                        <div class="flex gap-2">
                            <select
                                x-model="form.notion_database_id"
                                class="select select-bordered flex-1"
                                :disabled="loadingNotionDatabases"
                            >
                                <option value="">
                                    All accessible pages (no filter)
                                </option>
                                <template
                                    x-for="db in notionDatabases"
                                    :key="db.id"
                                >
                                    <option
                                        :value="db.id"
                                        x-text="db.title"
                                    ></option>
                                </template>
                            </select>
                            <button
                                type="button"
                                @click="loadNotionDatabases()"
                                class="btn btn-ghost btn-sm"
                                :class="{ 'loading': loadingNotionDatabases }"
                                :disabled="loadingNotionDatabases"
                                title="Refresh databases"
                            >
                                <svg
                                    x-show="!loadingNotionDatabases"
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                    />
                                </svg>
                            </button>
                        </div>
                        <label class="label" x-show="notionError">
                            <span
                                class="label-text-alt text-error"
                                x-text="notionError"
                            ></span>
                        </label>
                        <label class="label" x-show="!notionError">
                            <span class="label-text-alt"
                                >Index all pages from a specific Notion
                                database</span
                            >
                        </label>
                    </div>

                    <!-- Manual Page ID (alternative to database) -->
                    <div class="form-control" x-show="!form.notion_database_id">
                        <label class="label">
                            <span class="label-text"
                                >Or enter Page ID manually (optional)</span
                            >
                        </label>
                        <input
                            type="text"
                            x-model="form.notion_page_id"
                            class="input input-bordered font-mono"
                            placeholder="e.g., 1234abcd-5678-efgh-ijkl-9012mnop3456"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Index a specific page and its children (find ID
                                in Notion URL)</span
                            >
                        </label>
                    </div>

                    <div
                        class="text-sm text-base-content/60"
                        x-show="!form.notion_database_id && !form.notion_page_id"
                    >
                        Leave both empty to search all accessible pages.
                    </div>

                    <!-- Task Database Option -->
                    <div class="form-control" x-show="form.notion_database_id">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input
                                type="checkbox"
                                x-model="form.notion_is_task_database"
                                class="checkbox checkbox-primary"
                            />
                            <span class="label-text"
                                >This is a task database</span
                            >
                        </label>
                        <label class="label pt-0">
                            <span class="label-text-alt"
                                >Enable to use this database with Smart Actions
                                for task management (create, complete, update
                                tasks)</span
                            >
                        </label>
                    </div>
                </div>

                <!-- GitHub Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'mcp:github'"
                >
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Repository</span>
                        </label>
                        <input
                            type="text"
                            x-model="form.github_repo"
                            class="input input-bordered font-mono"
                            placeholder="owner/repo (e.g., anthropics/claude-code)"
                            :required="form.source_type === 'mcp:github'"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Format: owner/repository-name</span
                            >
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Branch (optional)</span>
                        </label>
                        <input
                            type="text"
                            x-model="form.github_branch"
                            class="input input-bordered font-mono"
                            placeholder="main (defaults to repository default branch)"
                        />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Path Filter (optional)</span
                            >
                        </label>
                        <input
                            type="text"
                            x-model="form.github_path"
                            class="input input-bordered font-mono"
                            placeholder="e.g., docs/ or src/**/*.md"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Only index files matching this path
                                pattern</span
                            >
                        </label>
                    </div>
                    <div class="alert alert-info">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="stroke-current shrink-0 h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        <div class="text-sm">
                            Authentication via
                            <code class="font-mono">GITHUB_TOKEN</code>
                            environment variable.
                        </div>
                    </div>
                </div>

                <!-- Website Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'website'"
                >
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Website URL</span>
                        </label>
                        <input
                            type="url"
                            x-model="form.website_url"
                            class="input input-bordered font-mono"
                            placeholder="https://docs.example.com"
                            :required="form.source_type === 'website'"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Starting URL for the crawler</span
                            >
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Crawl Depth</span>
                            </label>
                            <input
                                type="number"
                                x-model.number="form.website_crawl_depth"
                                class="input input-bordered"
                                min="0"
                                max="5"
                            />
                            <label class="label">
                                <span class="label-text-alt"
                                    >0 = start page only, 1 = follow links
                                    once</span
                                >
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Max Pages</span>
                            </label>
                            <input
                                type="number"
                                x-model.number="form.website_max_pages"
                                class="input input-bordered"
                                min="1"
                                max="500"
                            />
                            <label class="label">
                                <span class="label-text-alt"
                                    >Maximum pages to crawl</span
                                >
                            </label>
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Include Pattern (optional)</span
                            >
                        </label>
                        <input
                            type="text"
                            x-model="form.website_include_pattern"
                            class="input input-bordered font-mono"
                            placeholder="e.g., /docs/.*"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Regex pattern - only crawl URLs matching
                                this</span
                            >
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Exclude Pattern (optional)</span
                            >
                        </label>
                        <input
                            type="text"
                            x-model="form.website_exclude_pattern"
                            class="input input-bordered font-mono"
                            placeholder="e.g., /blog/.*|/archive/.*"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Regex pattern - skip URLs matching this</span
                            >
                        </label>
                    </div>
                    <div class="alert alert-info">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="stroke-current shrink-0 h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        <div class="text-sm">
                            Crawls the website using trafilatura for content
                            extraction. Only follows links within the same
                            domain.
                        </div>
                    </div>
                </div>

                <!-- Web Search Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'websearch'"
                >
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Search Query</span>
                        </label>
                        <input
                            type="text"
                            x-model="form.websearch_query"
                            class="input input-bordered"
                            placeholder="e.g., uk latest news"
                            :required="form.source_type === 'websearch'"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >The search query to run on each index</span
                            >
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text"
                                    >Max Search Results</span
                                >
                            </label>
                            <input
                                type="number"
                                x-model.number="form.websearch_max_results"
                                class="input input-bordered"
                                min="1"
                                max="50"
                            />
                            <label class="label">
                                <span class="label-text-alt"
                                    >Number of search results to fetch</span
                                >
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Pages to Scrape</span>
                            </label>
                            <input
                                type="number"
                                x-model.number="form.websearch_pages_to_scrape"
                                class="input input-bordered"
                                min="1"
                                max="20"
                            />
                            <label class="label">
                                <span class="label-text-alt"
                                    >How many results to actually scrape</span
                                >
                            </label>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text"
                                    >Time Range (optional)</span
                                >
                            </label>
                            <select
                                x-model="form.websearch_time_range"
                                class="select select-bordered"
                            >
                                <option value="">Any time</option>
                                <option value="day">Past day</option>
                                <option value="week">Past week</option>
                                <option value="month">Past month</option>
                                <option value="year">Past year</option>
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text"
                                    >Category (optional)</span
                                >
                            </label>
                            <select
                                x-model="form.websearch_category"
                                class="select select-bordered"
                            >
                                <option value="">General</option>
                                <option value="news">News</option>
                                <option value="images">Images</option>
                                <option value="videos">Videos</option>
                            </select>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="stroke-current shrink-0 h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        <div class="text-sm">
                            Runs a web search, scrapes the top results, and
                            indexes the content. Set an Index Schedule to keep
                            results fresh. Use Max Documents to limit storage.
                        </div>
                    </div>
                </div>

                <!-- Slack Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'slack'"
                >
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Channel (optional)</span>
                        </label>
                        <div class="flex gap-2">
                            <select
                                x-model="form.slack_channel_id"
                                class="select select-bordered flex-1"
                                @focus="loadSlackChannels()"
                            >
                                <option value="">
                                    All accessible channels
                                </option>
                                <template
                                    x-for="channel in slackChannels"
                                    :key="channel.id"
                                >
                                    <option
                                        :value="channel.id"
                                        x-text="'#' + channel.name"
                                    ></option>
                                </template>
                            </select>
                            <button
                                type="button"
                                class="btn btn-square btn-outline"
                                @click="loadSlackChannels()"
                                :class="{ 'loading': loadingSlackChannels }"
                                title="Refresh channels"
                            >
                                <svg
                                    x-show="!loadingSlackChannels"
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                    />
                                </svg>
                            </button>
                        </div>
                        <label class="label">
                            <span class="label-text-alt"
                                >Leave empty to index all channels the bot can
                                access</span
                            >
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Channel Types</span>
                        </label>
                        <div class="flex gap-4">
                            <label class="label cursor-pointer gap-2">
                                <input
                                    type="checkbox"
                                    class="checkbox checkbox-sm"
                                    :checked="form.slack_channel_types.includes('public_channel')"
                                    @change="toggleSlackChannelType('public_channel')"
                                />
                                <span class="label-text">Public channels</span>
                            </label>
                            <label class="label cursor-pointer gap-2">
                                <input
                                    type="checkbox"
                                    class="checkbox checkbox-sm"
                                    :checked="form.slack_channel_types.includes('private_channel')"
                                    @change="toggleSlackChannelType('private_channel')"
                                />
                                <span class="label-text">Private channels</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Days of History</span>
                        </label>
                        <input
                            type="number"
                            x-model.number="form.slack_days_back"
                            class="input input-bordered w-32"
                            min="1"
                            max="90"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Max 90 days on Slack free plan</span
                            >
                        </label>
                    </div>
                    <div class="alert alert-info">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="stroke-current shrink-0 h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        <div class="text-sm">
                            Authentication via
                            <code class="font-mono">SLACK_BOT_TOKEN</code>
                            environment variable. Create a Slack app at
                            <a
                                href="https://api.slack.com/apps"
                                target="_blank"
                                class="link"
                                >api.slack.com/apps</a
                            >
                            with scopes: channels:history, channels:read,
                            users:read.
                        </div>
                    </div>
                </div>

                <!-- Todoist Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'todoist'"
                    x-effect="if (form.source_type === 'todoist' && todoistProjects.length === 0 && !loadingTodoistProjects) loadTodoistProjects()"
                >
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Project (optional)</span>
                        </label>
                        <div class="flex gap-2">
                            <select
                                x-model="form.todoist_project_id"
                                @change="onTodoistProjectChange()"
                                class="select select-bordered flex-1"
                                :disabled="loadingTodoistProjects"
                            >
                                <option value="">All projects</option>
                                <template
                                    x-for="project in todoistProjects"
                                    :key="project.id"
                                >
                                    <option
                                        :value="project.id"
                                        x-text="project.name"
                                    ></option>
                                </template>
                            </select>
                            <button
                                type="button"
                                class="btn btn-square btn-outline"
                                @click="loadTodoistProjects()"
                                :class="{ 'loading': loadingTodoistProjects }"
                                title="Refresh projects"
                            >
                                <svg
                                    x-show="!loadingTodoistProjects"
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                    />
                                </svg>
                            </button>
                        </div>
                        <label class="label">
                            <span class="label-text-alt"
                                >Leave empty to index tasks from all
                                projects</span
                            >
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Filter (optional)</span>
                        </label>
                        <input
                            type="text"
                            x-model="form.todoist_filter"
                            class="input input-bordered font-mono"
                            placeholder="e.g., today | overdue | #Work"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Todoist filter expression (see
                                <a
                                    href="https://todoist.com/help/articles/introduction-to-filters-V98wIH"
                                    target="_blank"
                                    class="link"
                                    >filter documentation</a
                                >)</span
                            >
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input
                                type="checkbox"
                                x-model="form.todoist_include_completed"
                                class="checkbox checkbox-sm"
                            />
                            <span class="label-text"
                                >Include completed tasks</span
                            >
                        </label>
                        <label class="label">
                            <span class="label-text-alt"
                                >When enabled, indexes completed tasks as well
                                (requires Todoist Pro)</span
                            >
                        </label>
                    </div>
                    <div class="alert alert-info">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="stroke-current shrink-0 h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        <div class="text-sm">
                            Authentication via
                            <code class="font-mono">TODOIST_API_TOKEN</code>
                            environment variable. Get your API token from
                            <a
                                href="https://todoist.com/prefs/integrations"
                                target="_blank"
                                class="link"
                                >Todoist Settings &gt; Integrations &gt;
                                Developer</a
                            >.
                        </div>
                    </div>
                </div>

                <!-- Google OAuth Configuration (for mcp:gdrive, mcp:gmail, mcp:gcalendar, mcp:gtasks, mcp:gcontacts, mcp:gkeep) -->
                <div
                    x-show="['mcp:gdrive', 'mcp:gmail', 'mcp:gcalendar', 'mcp:gtasks', 'mcp:gcontacts', 'mcp:gkeep'].includes(form.source_type)"
                    class="mt-4"
                >
                    <!-- No OAuth configured -->
                    <template x-if="!googleOAuth.configured">
                        <div class="alert alert-warning">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="stroke-current shrink-0 h-6 w-6"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                                />
                            </svg>
                            <div>
                                <h3 class="font-bold">
                                    Google OAuth Not Configured
                                </h3>
                                <div class="text-sm">
                                    Set GOOGLE_CLIENT_ID and
                                    GOOGLE_CLIENT_SECRET environment variables.
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- OAuth configured but no accounts connected -->
                    <template
                        x-if="googleOAuth.configured && googleOAuth.accounts.length === 0"
                    >
                        <div class="alert alert-info">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="stroke-current shrink-0 h-6 w-6"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                />
                            </svg>
                            <div>
                                <h3 class="font-bold">
                                    Connect Google Account
                                </h3>
                                <div class="text-sm">
                                    Authorize access to Google Drive to index
                                    documents.
                                </div>
                            </div>
                            <button
                                type="button"
                                @click="startGoogleOAuth()"
                                class="btn btn-sm btn-primary"
                            >
                                Connect Google Account
                            </button>
                        </div>
                    </template>

                    <!-- OAuth configured with accounts - show selector -->
                    <template
                        x-if="googleOAuth.configured && googleOAuth.accounts.length > 0"
                    >
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Google Account</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.google_account_id"
                                        @change="onGoogleAccountChange()"
                                        class="select select-bordered flex-1"
                                        :required="['mcp:gdrive', 'mcp:gmail', 'mcp:gcalendar', 'mcp:gtasks', 'mcp:gcontacts', 'mcp:gkeep'].includes(form.source_type)"
                                    >
                                        <option value="">
                                            Select an account...
                                        </option>
                                        <template
                                            x-for="account in googleOAuth.accounts"
                                            :key="account.id"
                                        >
                                            <option
                                                :value="account.id"
                                                x-text="account.account_email + (account.account_name ? ' (' + account.account_name + ')' : '')"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="startGoogleOAuth()"
                                        class="btn btn-ghost btn-sm"
                                        title="Connect another account"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M12 4v16m8-8H4"
                                            />
                                        </svg>
                                    </button>
                                    <button
                                        type="button"
                                        @click="deleteGoogleAccount()"
                                        class="btn btn-ghost btn-sm text-error"
                                        title="Delete selected account"
                                        :disabled="!form.google_account_id"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                            />
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Folder Selection (Google Drive only) -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:gdrive' && form.google_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Folder (optional)</span
                                    >
                                </label>

                                <!-- Selected folder display -->
                                <div
                                    class="flex items-center gap-2 mb-2"
                                    x-show="form.gdrive_folder_id"
                                >
                                    <span class="badge badge-primary gap-1">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                            />
                                        </svg>
                                        <span
                                            x-text="form.gdrive_folder_name || 'Selected folder'"
                                        ></span>
                                    </span>
                                    <button
                                        type="button"
                                        @click="clearFolderSelection()"
                                        class="btn btn-ghost btn-xs"
                                        title="Clear selection"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12"
                                            />
                                        </svg>
                                    </button>
                                </div>

                                <!-- Breadcrumb navigation -->
                                <div
                                    class="text-sm flex items-center gap-1 mb-2 flex-wrap"
                                    x-show="folderBreadcrumbs.length > 0"
                                >
                                    <a
                                        href="#"
                                        @click.prevent="navigateToFolder('', 'My Drive')"
                                        class="link link-hover"
                                    >
                                        My Drive
                                    </a>
                                    <template
                                        x-for="(crumb, index) in folderBreadcrumbs"
                                        :key="crumb.id"
                                    >
                                        <span class="flex items-center gap-1">
                                            <span class="text-base-content/50"
                                                >&gt;</span
                                            >
                                            <a
                                                href="#"
                                                @click.prevent="navigateToBreadcrumb(index)"
                                                class="link link-hover"
                                                x-text="crumb.name"
                                            ></a>
                                        </span>
                                    </template>
                                </div>

                                <!-- Folder list -->
                                <div
                                    class="border rounded-lg max-h-48 overflow-y-auto bg-base-200"
                                >
                                    <div
                                        x-show="loadingFolders"
                                        class="flex justify-center py-4"
                                    >
                                        <span
                                            class="loading loading-spinner loading-sm"
                                        ></span>
                                    </div>
                                    <ul
                                        x-show="!loadingFolders"
                                        class="menu menu-sm p-1"
                                    >
                                        <!-- "Select this folder" option when inside a subfolder -->
                                        <li
                                            x-show="folderBreadcrumbs.length > 0"
                                        >
                                            <a
                                                href="#"
                                                @click.prevent="selectCurrentFolder()"
                                                class="text-primary font-medium"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-4 w-4"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M5 13l4 4L19 7"
                                                    />
                                                </svg>
                                                Select this folder
                                            </a>
                                        </li>
                                        <!-- "All files" option at root level -->
                                        <li
                                            x-show="folderBreadcrumbs.length === 0"
                                        >
                                            <a
                                                href="#"
                                                @click.prevent="selectFolder('', 'All files (no filter)')"
                                                class="text-base-content/70"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-4 w-4"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 6h16M4 10h16M4 14h16M4 18h16"
                                                    />
                                                </svg>
                                                All files (no folder filter)
                                            </a>
                                        </li>
                                        <!-- Folder items -->
                                        <template
                                            x-for="folder in gdriveFolders"
                                            :key="folder.id"
                                        >
                                            <li>
                                                <a
                                                    href="#"
                                                    @click.prevent="navigateToFolder(folder.id, folder.name)"
                                                    class="flex justify-between"
                                                >
                                                    <span
                                                        class="flex items-center gap-2"
                                                    >
                                                        <svg
                                                            xmlns="http://www.w3.org/2000/svg"
                                                            class="h-4 w-4 text-warning"
                                                            fill="none"
                                                            viewBox="0 0 24 24"
                                                            stroke="currentColor"
                                                        >
                                                            <path
                                                                stroke-linecap="round"
                                                                stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                                            />
                                                        </svg>
                                                        <span
                                                            x-text="folder.name"
                                                        ></span>
                                                    </span>
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        class="h-4 w-4 text-base-content/50"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M9 5l7 7-7 7"
                                                        />
                                                    </svg>
                                                </a>
                                            </li>
                                        </template>
                                        <!-- No folders message -->
                                        <li
                                            x-show="gdriveFolders.length === 0 && !loadingFolders"
                                        >
                                            <span
                                                class="text-base-content/50 italic"
                                                >No subfolders</span
                                            >
                                        </li>
                                    </ul>
                                </div>

                                <label class="label">
                                    <span class="label-text-alt"
                                        >Navigate to select a folder, or leave
                                        empty for all files</span
                                    >
                                </label>
                            </div>

                            <!-- Gmail Label Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:gmail' && form.google_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Label (optional)</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.gmail_label_id"
                                        @change="onLabelChange()"
                                        class="select select-bordered flex-1"
                                        :disabled="loadingLabels"
                                    >
                                        <option value="">
                                            All emails (no label filter)
                                        </option>
                                        <template
                                            x-for="label in gmailLabels"
                                            :key="label.id"
                                        >
                                            <option
                                                :value="label.id"
                                                x-text="label.name"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="loadGmailLabels()"
                                        class="btn btn-ghost btn-sm"
                                        :class="{ 'loading': loadingLabels }"
                                        :disabled="loadingLabels || !form.google_account_id"
                                        title="Refresh labels"
                                    >
                                        <svg
                                            x-show="!loadingLabels"
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Limit indexing to emails with this
                                        label (e.g., INBOX, SENT, or custom
                                        labels)</span
                                    >
                                </label>
                            </div>

                            <!-- Google Calendar Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:gcalendar' && form.google_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Calendar (optional)</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.gcalendar_calendar_id"
                                        @change="onCalendarChange()"
                                        class="select select-bordered flex-1"
                                        :disabled="loadingCalendars"
                                    >
                                        <option value="">
                                            Primary calendar only
                                        </option>
                                        <template
                                            x-for="cal in googleCalendars"
                                            :key="cal.id"
                                        >
                                            <option
                                                :value="cal.id"
                                                x-text="cal.name"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="loadGoogleCalendars()"
                                        class="btn btn-ghost btn-sm"
                                        :class="{ 'loading': loadingCalendars }"
                                        :disabled="loadingCalendars || !form.google_account_id"
                                        title="Refresh calendars"
                                    >
                                        <svg
                                            x-show="!loadingCalendars"
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Select a specific calendar to index, or
                                        leave empty for primary calendar</span
                                    >
                                </label>
                            </div>

                            <!-- Google Tasks Task List Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:gtasks' && form.google_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Task List (optional)</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.gtasks_tasklist_id"
                                        @change="onTaskListChange()"
                                        class="select select-bordered flex-1"
                                        :disabled="loadingTaskLists"
                                    >
                                        <option value="">All task lists</option>
                                        <template
                                            x-for="list in googleTaskLists"
                                            :key="list.id"
                                        >
                                            <option
                                                :value="list.id"
                                                x-text="list.name"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="loadGoogleTaskLists()"
                                        class="btn btn-ghost btn-sm"
                                        :class="{ 'loading': loadingTaskLists }"
                                        :disabled="loadingTaskLists || !form.google_account_id"
                                        title="Refresh task lists"
                                    >
                                        <svg
                                            x-show="!loadingTaskLists"
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Select a specific task list to index,
                                        or leave empty for all task lists</span
                                    >
                                </label>
                            </div>

                            <!-- Google Contacts Label Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:gcontacts' && form.google_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Label (optional)</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.gcontacts_group_id"
                                        @change="onContactGroupChange()"
                                        class="select select-bordered flex-1"
                                        :disabled="loadingContactGroups"
                                    >
                                        <option value="">All contacts</option>
                                        <template
                                            x-for="group in googleContactGroups"
                                            :key="group.id"
                                        >
                                            <option
                                                :value="group.id"
                                                x-text="group.name + (group.memberCount ? ' (' + group.memberCount + ')' : '')"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="loadGoogleContactGroups()"
                                        class="btn btn-ghost btn-sm"
                                        :class="{ 'loading': loadingContactGroups }"
                                        :disabled="loadingContactGroups || !form.google_account_id"
                                        title="Refresh labels"
                                    >
                                        <svg
                                            x-show="!loadingContactGroups"
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Select a label to filter contacts, or
                                        leave empty for all contacts</span
                                    >
                                </label>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Microsoft OAuth Configuration (for mcp:onedrive, mcp:outlook, mcp:onenote, mcp:teams) -->
                <div
                    x-show="['mcp:onedrive', 'mcp:outlook', 'mcp:onenote', 'mcp:teams'].includes(form.source_type)"
                    class="mt-4"
                >
                    <!-- No OAuth configured -->
                    <template x-if="!microsoftOAuth.configured">
                        <div class="alert alert-warning">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="stroke-current shrink-0 h-6 w-6"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                                />
                            </svg>
                            <div>
                                <h3 class="font-bold">
                                    Microsoft OAuth Not Configured
                                </h3>
                                <div class="text-sm">
                                    Set MICROSOFT_CLIENT_ID and
                                    MICROSOFT_CLIENT_SECRET environment
                                    variables.
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- OAuth configured but no accounts connected -->
                    <template
                        x-if="microsoftOAuth.configured && microsoftOAuth.accounts.length === 0"
                    >
                        <div class="alert alert-info">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="stroke-current shrink-0 h-6 w-6"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                />
                            </svg>
                            <div>
                                <h3 class="font-bold">
                                    Connect Microsoft Account
                                </h3>
                                <div class="text-sm">
                                    Authorize access to Microsoft services to
                                    index documents.
                                </div>
                            </div>
                            <button
                                type="button"
                                @click="startMicrosoftOAuth()"
                                class="btn btn-sm btn-primary"
                            >
                                Connect Microsoft Account
                            </button>
                        </div>
                    </template>

                    <!-- OAuth configured with accounts - show selector -->
                    <template
                        x-if="microsoftOAuth.configured && microsoftOAuth.accounts.length > 0"
                    >
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Microsoft Account</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.microsoft_account_id"
                                        @change="onMicrosoftAccountChange()"
                                        class="select select-bordered flex-1"
                                        :required="['mcp:onedrive', 'mcp:outlook', 'mcp:onenote', 'mcp:teams'].includes(form.source_type)"
                                    >
                                        <option value="">
                                            Select an account...
                                        </option>
                                        <template
                                            x-for="account in microsoftOAuth.accounts"
                                            :key="account.id"
                                        >
                                            <option
                                                :value="account.id"
                                                x-text="account.account_email + (account.account_name ? ' (' + account.account_name + ')' : '')"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="startMicrosoftOAuth()"
                                        class="btn btn-ghost btn-sm"
                                        title="Connect another account"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M12 4v16m8-8H4"
                                            />
                                        </svg>
                                    </button>
                                    <button
                                        type="button"
                                        @click="deleteMicrosoftAccount()"
                                        class="btn btn-ghost btn-sm text-error"
                                        title="Delete selected account"
                                        :disabled="!form.microsoft_account_id"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                            />
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- OneDrive Folder Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:onedrive' && form.microsoft_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Folder (optional)</span
                                    >
                                </label>

                                <!-- Selected folder display -->
                                <div
                                    class="flex items-center gap-2 mb-2"
                                    x-show="form.onedrive_folder_id"
                                >
                                    <span class="badge badge-primary gap-1">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                            />
                                        </svg>
                                        <span
                                            x-text="form.onedrive_folder_name || 'Selected folder'"
                                        ></span>
                                    </span>
                                    <button
                                        type="button"
                                        @click="clearOneDriveFolderSelection()"
                                        class="btn btn-ghost btn-xs"
                                        title="Clear selection"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12"
                                            />
                                        </svg>
                                    </button>
                                </div>

                                <!-- Breadcrumb navigation -->
                                <div
                                    class="text-sm flex items-center gap-1 mb-2 flex-wrap"
                                    x-show="onedriveFolderBreadcrumbs.length > 0"
                                >
                                    <a
                                        href="#"
                                        @click.prevent="navigateToOneDriveFolder('', 'OneDrive')"
                                        class="link link-hover"
                                    >
                                        OneDrive
                                    </a>
                                    <template
                                        x-for="(crumb, index) in onedriveFolderBreadcrumbs"
                                        :key="crumb.id"
                                    >
                                        <span class="flex items-center gap-1">
                                            <span class="text-base-content/50"
                                                >&gt;</span
                                            >
                                            <a
                                                href="#"
                                                @click.prevent="navigateToOneDriveBreadcrumb(index)"
                                                class="link link-hover"
                                                x-text="crumb.name"
                                            ></a>
                                        </span>
                                    </template>
                                </div>

                                <!-- Folder list -->
                                <div
                                    class="border rounded-lg max-h-48 overflow-y-auto bg-base-200"
                                >
                                    <div
                                        x-show="loadingOneDriveFolders"
                                        class="flex justify-center py-4"
                                    >
                                        <span
                                            class="loading loading-spinner loading-sm"
                                        ></span>
                                    </div>
                                    <ul
                                        x-show="!loadingOneDriveFolders"
                                        class="menu menu-sm p-1"
                                    >
                                        <!-- "Select this folder" option when inside a subfolder -->
                                        <li
                                            x-show="onedriveFolderBreadcrumbs.length > 0"
                                        >
                                            <a
                                                href="#"
                                                @click.prevent="selectCurrentOneDriveFolder()"
                                                class="text-primary font-medium"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-4 w-4"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M5 13l4 4L19 7"
                                                    />
                                                </svg>
                                                Select this folder
                                            </a>
                                        </li>
                                        <!-- "All files" option at root level -->
                                        <li
                                            x-show="onedriveFolderBreadcrumbs.length === 0"
                                        >
                                            <a
                                                href="#"
                                                @click.prevent="selectOneDriveFolder('', 'All files (no filter)')"
                                                class="text-base-content/70"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-4 w-4"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 6h16M4 10h16M4 14h16M4 18h16"
                                                    />
                                                </svg>
                                                All files (no folder filter)
                                            </a>
                                        </li>
                                        <!-- Folder items -->
                                        <template
                                            x-for="folder in onedriveFolders"
                                            :key="folder.id"
                                        >
                                            <li>
                                                <a
                                                    href="#"
                                                    @click.prevent="navigateToOneDriveFolder(folder.id, folder.name)"
                                                    class="flex justify-between"
                                                >
                                                    <span
                                                        class="flex items-center gap-2"
                                                    >
                                                        <svg
                                                            xmlns="http://www.w3.org/2000/svg"
                                                            class="h-4 w-4 text-info"
                                                            fill="none"
                                                            viewBox="0 0 24 24"
                                                            stroke="currentColor"
                                                        >
                                                            <path
                                                                stroke-linecap="round"
                                                                stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                                            />
                                                        </svg>
                                                        <span
                                                            x-text="folder.name"
                                                        ></span>
                                                    </span>
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        class="h-4 w-4 text-base-content/50"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M9 5l7 7-7 7"
                                                        />
                                                    </svg>
                                                </a>
                                            </li>
                                        </template>
                                        <!-- No folders message -->
                                        <li
                                            x-show="onedriveFolders.length === 0 && !loadingOneDriveFolders"
                                        >
                                            <span
                                                class="text-base-content/50 italic"
                                                >No subfolders</span
                                            >
                                        </li>
                                    </ul>
                                </div>

                                <label class="label">
                                    <span class="label-text-alt"
                                        >Navigate to select a folder, or leave
                                        empty for all files</span
                                    >
                                </label>
                            </div>

                            <!-- Outlook Folder Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:outlook' && form.microsoft_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Folder (optional)</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.outlook_folder_id"
                                        @change="onOutlookFolderChange()"
                                        class="select select-bordered flex-1"
                                        :disabled="loadingOutlookFolders"
                                    >
                                        <option value="">
                                            All emails (Inbox)
                                        </option>
                                        <template
                                            x-for="folder in outlookFolders"
                                            :key="folder.id"
                                        >
                                            <option
                                                :value="folder.id"
                                                x-text="folder.name"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="loadOutlookFolders()"
                                        class="btn btn-ghost btn-sm"
                                        :class="{ 'loading': loadingOutlookFolders }"
                                        :disabled="loadingOutlookFolders || !form.microsoft_account_id"
                                        title="Refresh folders"
                                    >
                                        <svg
                                            x-show="!loadingOutlookFolders"
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Limit indexing to emails from this
                                        folder</span
                                    >
                                </label>
                            </div>

                            <!-- Outlook Days Back -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:outlook' && form.microsoft_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Days of History</span
                                    >
                                </label>
                                <input
                                    type="number"
                                    x-model.number="form.outlook_days_back"
                                    class="input input-bordered w-32"
                                    min="1"
                                    max="365"
                                />
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Number of days of email history to
                                        index</span
                                    >
                                </label>
                            </div>

                            <!-- OneNote Notebook Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:onenote' && form.microsoft_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Notebook (optional)</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.onenote_notebook_id"
                                        @change="onOneNoteNotebookChange()"
                                        class="select select-bordered flex-1"
                                        :disabled="loadingOneNoteNotebooks"
                                    >
                                        <option value="">All notebooks</option>
                                        <template
                                            x-for="notebook in onenoteNotebooks"
                                            :key="notebook.id"
                                        >
                                            <option
                                                :value="notebook.id"
                                                x-text="notebook.name"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="loadOneNoteNotebooks()"
                                        class="btn btn-ghost btn-sm"
                                        :class="{ 'loading': loadingOneNoteNotebooks }"
                                        :disabled="loadingOneNoteNotebooks || !form.microsoft_account_id"
                                        title="Refresh notebooks"
                                    >
                                        <svg
                                            x-show="!loadingOneNoteNotebooks"
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Select a specific notebook to index, or
                                        leave empty for all notebooks</span
                                    >
                                </label>
                            </div>

                            <!-- Teams Team Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:teams' && form.microsoft_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Team (optional)</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.teams_team_id"
                                        @change="onTeamsTeamChange()"
                                        class="select select-bordered flex-1"
                                        :disabled="loadingTeams"
                                    >
                                        <option value="">All teams</option>
                                        <template
                                            x-for="team in teamsTeams"
                                            :key="team.id"
                                        >
                                            <option
                                                :value="team.id"
                                                x-text="team.name"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="loadTeams()"
                                        class="btn btn-ghost btn-sm"
                                        :class="{ 'loading': loadingTeams }"
                                        :disabled="loadingTeams || !form.microsoft_account_id"
                                        title="Refresh teams"
                                    >
                                        <svg
                                            x-show="!loadingTeams"
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Select a specific team to index, or
                                        leave empty for all teams</span
                                    >
                                </label>
                            </div>

                            <!-- Teams Channel Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:teams' && form.microsoft_account_id && form.teams_team_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Channel (optional)</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.teams_channel_id"
                                        @change="onTeamsChannelChange()"
                                        class="select select-bordered flex-1"
                                        :disabled="loadingTeamsChannels"
                                    >
                                        <option value="">All channels</option>
                                        <template
                                            x-for="channel in teamsChannels"
                                            :key="channel.id"
                                        >
                                            <option
                                                :value="channel.id"
                                                x-text="channel.name"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="loadTeamsChannels()"
                                        class="btn btn-ghost btn-sm"
                                        :class="{ 'loading': loadingTeamsChannels }"
                                        :disabled="loadingTeamsChannels || !form.teams_team_id"
                                        title="Refresh channels"
                                    >
                                        <svg
                                            x-show="!loadingTeamsChannels"
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Select a specific channel to index, or
                                        leave empty for all channels in the
                                        team</span
                                    >
                                </label>
                            </div>

                            <!-- Teams Days Back -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:teams' && form.microsoft_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Days of history</span
                                    >
                                </label>
                                <input
                                    type="number"
                                    x-model.number="form.teams_days_back"
                                    class="input input-bordered"
                                    min="1"
                                    max="365"
                                />
                                <label class="label">
                                    <span class="label-text-alt"
                                        >How many days of message history to
                                        index (default: 90)</span
                                    >
                                </label>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- MCP Server Configuration (for mcp sources) -->
                <div
                    x-show="form.source_type.startsWith('mcp:') && !['mcp:gdrive', 'mcp:gmail', 'mcp:gcalendar', 'mcp:gtasks', 'mcp:gcontacts', 'mcp:gkeep', 'mcp:onedrive', 'mcp:outlook', 'mcp:onenote', 'mcp:teams'].includes(form.source_type)"
                    class="mt-4 space-y-4"
                >
                    <!-- Custom MCP Server fields (only shown for mcp:custom) -->
                    <template x-if="form.source_type === 'mcp:custom'">
                        <div class="space-y-4">
                            <!-- MCP Server Name -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Server Name</span>
                                </label>
                                <input
                                    type="text"
                                    x-model="form.mcp_name"
                                    class="input input-bordered"
                                    placeholder="e.g., my-mcp-server"
                                    required
                                />
                            </div>

                            <!-- MCP Transport Type -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Transport</span>
                                </label>
                                <select
                                    x-model="form.mcp_transport"
                                    class="select select-bordered"
                                >
                                    <option value="stdio">
                                        Stdio (subprocess)
                                    </option>
                                    <option value="http">HTTP</option>
                                </select>
                            </div>

                            <!-- Stdio Configuration -->
                            <template x-if="form.mcp_transport === 'stdio'">
                                <div class="space-y-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text"
                                                >Command</span
                                            >
                                        </label>
                                        <input
                                            type="text"
                                            x-model="form.mcp_command"
                                            class="input input-bordered font-mono"
                                            placeholder="e.g., npx, uvx, python"
                                        />
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text"
                                                >Arguments</span
                                            >
                                        </label>
                                        <input
                                            type="text"
                                            x-model="form.mcp_args"
                                            class="input input-bordered font-mono"
                                            placeholder="e.g., -y @modelcontextprotocol/server-gdrive"
                                        />
                                        <label class="label">
                                            <span class="label-text-alt"
                                                >Space-separated arguments</span
                                            >
                                        </label>
                                    </div>
                                </div>
                            </template>

                            <!-- HTTP Configuration -->
                            <template x-if="form.mcp_transport === 'http'">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text"
                                            >MCP Server URL</span
                                        >
                                    </label>
                                    <input
                                        type="text"
                                        x-model="form.mcp_url"
                                        class="input input-bordered font-mono"
                                        placeholder="e.g., http://localhost:8000/mcp"
                                    />
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- URI Patterns (optional - shown for all MCP sources) -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >URI Patterns (optional)</span
                            >
                        </label>
                        <input
                            type="text"
                            x-model="form.mcp_uri_patterns"
                            class="input input-bordered font-mono"
                            placeholder="e.g., file://**/*.pdf, gdrive://**/*"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Comma-separated glob patterns to filter
                                resources</span
                            >
                        </label>
                    </div>
                </div>

                <!-- Embedding & Vision Settings Note -->
                <div
                    class="mt-4 text-sm text-base-content/60 bg-base-200 rounded-lg p-3"
                >
                    <span class="font-medium">Embedding & Vision Models:</span>
                    Embedding provider and vision model for document parsing are
                    configured in
                    <a href="/settings" class="link link-primary"
                        >Global Settings</a
                    >.
                </div>

                <!-- Index Schedule -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Index Schedule</span>
                    </label>
                    <select
                        x-model="form.index_schedule"
                        class="select select-bordered"
                    >
                        <option value="">Manual only</option>
                        <option value="0 * * * *">Every hour</option>
                        <option value="0 */6 * * *">Every 6 hours</option>
                        <option value="0 2 * * *">Daily at 2 AM</option>
                        <option value="0 2 * * 0">
                            Weekly on Sunday at 2 AM
                        </option>
                        <option value="custom">Custom cron...</option>
                    </select>
                </div>
                <div
                    class="form-control mt-2"
                    x-show="form.index_schedule === 'custom'"
                >
                    <input
                        type="text"
                        x-model="form.custom_schedule"
                        class="input input-bordered font-mono"
                        placeholder="0 2 * * * (minute hour day month day_of_week)"
                    />
                </div>

                <!-- Description -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Description</span>
                    </label>
                    <textarea
                        x-model="form.description"
                        class="textarea textarea-bordered"
                        rows="2"
                        placeholder="Optional description of this document store"
                    ></textarea>
                </div>

                <!-- Advanced Settings (collapsed) -->
                <div class="collapse collapse-arrow bg-base-200 mt-4">
                    <input type="checkbox" />
                    <div class="collapse-title text-sm font-medium">
                        Advanced Settings
                    </div>
                    <div class="collapse-content">
                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Chunk Size</span>
                                </label>
                                <input
                                    type="number"
                                    x-model="form.chunk_size"
                                    class="input input-bordered input-sm"
                                    min="100"
                                    max="2000"
                                />
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Tokens per chunk (default: 512)</span
                                    >
                                </label>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Chunk Overlap</span
                                    >
                                </label>
                                <input
                                    type="number"
                                    x-model="form.chunk_overlap"
                                    class="input input-bordered input-sm"
                                    min="0"
                                    max="500"
                                />
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Overlap between chunks (default:
                                        50)</span
                                    >
                                </label>
                            </div>
                            <!-- Max Documents (hidden for website sources - use max_pages instead) -->
                            <div
                                class="form-control"
                                x-show="form.source_type !== 'website'"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Max Documents</span
                                    >
                                </label>
                                <input
                                    type="number"
                                    x-model="form.max_documents"
                                    class="input input-bordered input-sm"
                                    min="0"
                                    placeholder="No limit"
                                />
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Maximum documents to index (0 or empty
                                        = no limit)</span
                                    >
                                </label>
                            </div>
                        </div>
                        <!-- Crawler Override (website sources only) -->
                        <div
                            class="form-control mt-4"
                            x-show="form.source_type === 'website'"
                        >
                            <label class="label">
                                <span class="label-text">Crawler</span>
                            </label>
                            <select
                                x-model="form.website_crawler_override"
                                class="select select-bordered select-sm"
                            >
                                <option value="">Use global default</option>
                                <option value="builtin">
                                    Builtin (trafilatura)
                                </option>
                                <option value="jina">Jina Reader API</option>
                            </select>
                            <label class="label">
                                <span class="label-text-alt"
                                    >Override the global crawler setting for
                                    this store</span
                                >
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Enabled Toggle -->
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input
                            type="checkbox"
                            x-model="form.enabled"
                            class="toggle toggle-primary"
                        />
                        <span class="label-text">Enabled</span>
                    </label>
                </div>

                <!-- Form Actions -->
                <div class="modal-action">
                    <button
                        type="button"
                        @click="closeModal()"
                        class="btn btn-ghost"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        class="btn btn-primary"
                        :class="{ 'loading': saving }"
                        :disabled="saving"
                    >
                        <span
                            x-text="editingStore ? 'Save Changes' : 'Create Store'"
                        ></span>
                    </button>
                </div>
            </form>
        </div>
        <div class="modal-backdrop" @click="closeModal()"></div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" :class="{ 'modal-open': showDeleteModal }">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Delete Document Store</h3>
            <p class="py-4">
                Are you sure you want to delete
                <span
                    class="font-mono font-bold"
                    x-text="deleteTarget?.name"
                ></span
                >? This will also delete the ChromaDB collection with all
                indexed chunks.
            </p>
            <div class="modal-action">
                <button @click="showDeleteModal = false" class="btn btn-ghost">
                    Cancel
                </button>
                <button
                    @click="deleteStore()"
                    class="btn btn-error"
                    :class="{ 'loading': deleting }"
                    :disabled="deleting"
                >
                    Delete
                </button>
            </div>
        </div>
        <div class="modal-backdrop" @click="showDeleteModal = false"></div>
    </div>

    <!-- Preview Modal -->
    <div class="modal" :class="{ 'modal-open': showPreviewModal }">
        <div class="modal-box max-w-4xl max-h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">
                    Preview:
                    <span class="font-mono" x-text="previewStore?.name"></span>
                </h3>
                <button
                    @click="showPreviewModal = false"
                    class="btn btn-ghost btn-sm btn-circle"
                >
                    âœ•
                </button>
            </div>

            <!-- Stats -->
            <div class="stats stats-horizontal shadow mb-4 w-full">
                <div class="stat py-2">
                    <div class="stat-title text-xs">Documents</div>
                    <div
                        class="stat-value text-lg"
                        x-text="previewData?.total_documents || 0"
                    ></div>
                </div>
                <div class="stat py-2">
                    <div class="stat-title text-xs">Chunks</div>
                    <div
                        class="stat-value text-lg"
                        x-text="previewData?.total_chunks || 0"
                    ></div>
                </div>
                <div class="stat py-2">
                    <div class="stat-title text-xs">Showing</div>
                    <div
                        class="stat-value text-lg"
                        x-text="previewData?.showing || 0"
                    ></div>
                </div>
            </div>

            <!-- Loading -->
            <div x-show="previewLoading" class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>

            <!-- Error -->
            <div x-show="previewError" class="alert alert-error mb-4">
                <span x-text="previewError"></span>
            </div>

            <!-- Content -->
            <div
                x-show="!previewLoading && !previewError"
                class="overflow-y-auto max-h-[50vh]"
            >
                <div class="space-y-3">
                    <template
                        x-for="doc in (previewData?.documents || [])"
                        :key="doc.id"
                    >
                        <div class="card bg-base-200 shadow-sm">
                            <div class="card-body p-3">
                                <div
                                    class="flex justify-between items-start gap-2"
                                >
                                    <div
                                        class="text-xs text-base-content/60 font-mono truncate flex-1"
                                        x-text="doc.source_name || doc.source_uri"
                                    ></div>
                                    <div
                                        class="badge badge-ghost badge-sm"
                                        x-text="'Chunk ' + doc.chunk_index"
                                    ></div>
                                </div>
                                <p
                                    class="text-sm whitespace-pre-wrap break-words mt-1"
                                    x-text="doc.content"
                                ></p>
                                <div
                                    class="flex justify-between items-center mt-2 text-xs text-base-content/50"
                                >
                                    <span
                                        x-text="doc.full_length + ' chars'"
                                    ></span>
                                    <span
                                        x-show="doc.timestamp"
                                        x-text="doc.timestamp"
                                    ></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Load More -->
                <div
                    x-show="previewData && previewData.showing < previewData.total_chunks"
                    class="mt-4 text-center"
                >
                    <button
                        @click="loadMorePreview()"
                        class="btn btn-outline btn-sm"
                        :class="{ 'loading': previewLoadingMore }"
                        :disabled="previewLoadingMore"
                    >
                        Load More
                    </button>
                </div>
            </div>

            <div class="modal-action">
                <button @click="showPreviewModal = false" class="btn">
                    Close
                </button>
            </div>
        </div>
        <div class="modal-backdrop" @click="showPreviewModal = false"></div>
    </div>
</div>

<script>
    function documentStoresPage() {
        return {
            loading: true,
            stores: [],
            allStores: [], // Unfiltered stores
            filterMode:
                new URLSearchParams(window.location.search).get("filter") ||
                "all",
            expandedRows: [],

            // Content category mapping for source types
            // Matches LEGACY_SOURCE_TYPE_CATEGORIES in plugin_base/common.py
            contentCategories: {
                // Files (documents, notes, etc.)
                local: "files",
                "mcp:gdrive": "files",
                "mcp:onedrive": "files",
                paperless: "files",
                nextcloud: "files",
                "mcp:github": "files",
                // Emails
                "mcp:gmail": "emails",
                "mcp:outlook": "emails",
                // Calendars
                "mcp:gcalendar": "calendars",
                "mcp:ocalendar": "calendars",
                // Tasks
                "mcp:gtasks": "tasks",
                todoist: "tasks",
                // Websites
                website: "websites",
                websearch: "websites",
                // Contacts (grouped with Other for now)
                "mcp:gcontacts": "contacts",
                // Notes
                // "mcp:gkeep": "notes",  // Disabled - requires domain-wide delegation
                "mcp:onenote": "notes",
                notion: "notes",
                // Messages
                slack: "messages",
                "mcp:teams": "messages",
            },

            // Get content category for a source type (or store object)
            getContentCategory(sourceTypeOrStore) {
                // If passed a store object, check for special cases
                if (
                    typeof sourceTypeOrStore === "object" &&
                    sourceTypeOrStore !== null
                ) {
                    const store = sourceTypeOrStore;
                    // Notion task databases should be categorized as tasks
                    if (
                        store.source_type === "notion" &&
                        store.notion_is_task_database
                    ) {
                        return "tasks";
                    }
                    return this.contentCategories[store.source_type] || "other";
                }
                // Otherwise treat as source_type string
                return this.contentCategories[sourceTypeOrStore] || "other";
            },

            // Check if source type is "actionable" (email, calendar, tasks)
            // These source types can be used by action handlers
            // Accepts either a store object or a source_type string
            isActionableSource(storeOrSourceType) {
                // If it's a string (source_type from form), check form.notion_is_task_database
                if (typeof storeOrSourceType === "string") {
                    if (
                        storeOrSourceType === "notion" &&
                        this.form?.notion_is_task_database
                    ) {
                        return true;
                    }
                    const category = this.getContentCategory(storeOrSourceType);
                    return ["emails", "calendars", "tasks"].includes(category);
                }
                const category = this.getContentCategory(storeOrSourceType);
                return ["emails", "calendars", "tasks"].includes(category);
            },

            // Computed: tab counts (content-based)
            get tabCounts() {
                const counts = {
                    all: this.allStores.length,
                    files: 0,
                    emails: 0,
                    calendars: 0,
                    tasks: 0,
                    notes: 0,
                    websites: 0,
                    messages: 0,
                    other: 0,
                };
                for (const store of this.allStores) {
                    const category = this.getContentCategory(store);
                    if (category === "contacts") {
                        counts.other++; // Group contacts with other for now
                    } else if (counts.hasOwnProperty(category)) {
                        counts[category]++;
                    } else {
                        counts.other++;
                    }
                }
                return counts;
            },

            // Computed: filtered stores based on current tab (content-based)
            get filteredStores() {
                if (this.filterMode === "all") return this.allStores;

                // Map filter mode to content categories
                const categoryMap = {
                    files: ["files"],
                    emails: ["emails"],
                    calendars: ["calendars"],
                    tasks: ["tasks"],
                    notes: ["notes"],
                    websites: ["websites"],
                    messages: ["messages"],
                    other: ["contacts", "other"], // Include contacts in other
                };

                const categories = categoryMap[this.filterMode];
                if (!categories) return this.allStores;

                return this.allStores.filter((s) => {
                    const category = this.getContentCategory(s);
                    return categories.includes(category);
                });
            },

            // Computed: label for current filter
            get filterLabel() {
                const labels = {
                    all: "All",
                    files: "Files",
                    emails: "Email",
                    calendars: "Calendar",
                    tasks: "Tasks",
                    notes: "Notes",
                    websites: "Website",
                    messages: "Messages",
                    other: "Other",
                };
                return labels[this.filterMode] || "All";
            },
            showModal: false,
            showDeleteModal: false,
            showPreviewModal: false,
            editingStore: null,
            deleteTarget: null,
            previewStore: null,
            previewData: null,
            previewLoading: false,
            previewLoadingMore: false,
            previewError: null,
            saving: false,
            deleting: false,
            indexingStores: [],
            cancellingStores: [],
            clearingStores: [],
            testingUnifiedStores: [],
            refreshingIntelligence: null,
            formErrors: {},

            // MCP integration availability status
            documentSources: {},
            mcpStatus: {
                google: { available: false },
                notion: { available: false },
                github: { available: false },
                slack: { available: false },
                postgres: { available: true },
                custom: { available: true },
            },

            // Google OAuth status
            googleOAuth: {
                configured: false,
                accounts: [],
            },

            // Microsoft OAuth status
            microsoftOAuth: {
                configured: false,
                accounts: [],
            },

            // OneDrive folders
            onedriveFolders: [],
            loadingOneDriveFolders: false,
            onedriveFolderBreadcrumbs: [],
            currentOneDriveFolderId: "",

            // Outlook folders
            outlookFolders: [],
            loadingOutlookFolders: false,

            // OneNote notebooks
            onenoteNotebooks: [],
            loadingOneNoteNotebooks: false,

            // Teams
            teamsTeams: [],
            loadingTeams: false,
            teamsChannels: [],
            loadingTeamsChannels: false,

            // Google Drive folders
            gdriveFolders: [],
            loadingFolders: false,
            folderBreadcrumbs: [], // [{id, name}, ...] for navigation path
            currentFolderId: "", // Current folder being browsed

            // Gmail labels
            gmailLabels: [],
            loadingLabels: false,

            // Google calendars
            googleCalendars: [],
            loadingCalendars: false,

            // Google task lists
            googleTaskLists: [],
            loadingTaskLists: false,

            // Google contact groups
            googleContactGroups: [],
            loadingContactGroups: false,

            // Notion databases
            notionDatabases: [],
            loadingNotionDatabases: false,
            notionError: null,

            // Local folder browser
            showLocalFolderBrowser: false,
            localFolders: [],
            loadingLocalFolders: false,
            localFolderBreadcrumbs: [],
            currentLocalPath: "/",

            // Nextcloud folder browser
            showNextcloudFolderBrowser: false,
            nextcloudFolders: [],
            loadingNextcloudFolders: false,
            nextcloudFolderBreadcrumbs: [],
            currentNextcloudPath: "/",

            // Paperless tags
            paperlessTags: [],
            loadingPaperlessTags: false,

            // Slack channels
            slackChannels: [],
            loadingSlackChannels: false,

            // Todoist projects
            todoistProjects: [],
            loadingTodoistProjects: false,

            form: {
                name: "",
                source_type: "local",
                source_path: "",
                paperless_url: "",
                paperless_token: "",
                paperless_tag_id: "",
                paperless_tag_name: "",
                github_repo: "",
                github_branch: "",
                github_path: "",
                notion_database_id: "",
                notion_page_id: "",
                notion_is_task_database: false,
                nextcloud_folder: "",
                website_url: "",
                website_crawl_depth: 1,
                website_max_pages: 50,
                website_include_pattern: "",
                website_exclude_pattern: "",
                website_crawler_override: "",
                slack_channel_id: "",
                slack_channel_types: "public_channel",
                slack_days_back: 90,
                todoist_project_id: "",
                todoist_project_name: "",
                todoist_filter: "",
                todoist_include_completed: false,
                websearch_query: "",
                websearch_max_results: 10,
                websearch_pages_to_scrape: 5,
                websearch_time_range: "",
                websearch_category: "",
                mcp_name: "",
                mcp_transport: "stdio",
                mcp_command: "",
                mcp_args: "",
                mcp_url: "",
                mcp_uri_patterns: "",
                google_account_id: "",
                gdrive_folder_id: "",
                gdrive_folder_name: "",
                gmail_label_id: "",
                gmail_label_name: "",
                gcalendar_calendar_id: "",
                gcalendar_calendar_name: "",
                gtasks_tasklist_id: "",
                gtasks_tasklist_name: "",
                gcontacts_group_id: "",
                gcontacts_group_name: "",
                microsoft_account_id: "",
                onedrive_folder_id: "",
                onedrive_folder_name: "",
                outlook_folder_id: "",
                outlook_folder_name: "",
                outlook_days_back: 90,
                onenote_notebook_id: "",
                onenote_notebook_name: "",
                teams_team_id: "",
                teams_team_name: "",
                teams_channel_id: "",
                teams_channel_name: "",
                teams_days_back: 90,
                index_schedule: "",
                custom_schedule: "",
                chunk_size: 512,
                chunk_overlap: 50,
                max_documents: null,
                description: "",
                enabled: true,
            },

            // MCP presets
            mcpPresets: {
                gdrive: {
                    name: "gdrive",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-gdrive",
                },
                gmail: {
                    name: "gmail",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-gsuite",
                },
                gcalendar: {
                    name: "gcalendar",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-gsuite",
                },
                notion: {
                    name: "notion",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @notionhq/notion-mcp-server",
                    discovery_tool: "API-post-search",
                    discovery_args: {
                        filter: { property: "object", value: "page" },
                    },
                    content_tool: "API-get-block-children",
                    content_id_field: "block_id",
                },
                github: {
                    name: "github",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-github",
                },
                slack: {
                    name: "slack",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-slack",
                },
                postgres: {
                    name: "postgres",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-postgres",
                },
            },

            async init() {
                await Promise.all([
                    this.loadStores(),
                    this.loadMcpStatus(),
                    this.loadGoogleOAuthStatus(),
                    this.loadMicrosoftOAuthStatus(),
                    this.loadDocumentSources(),
                ]);

                // Check for saved form state (from OAuth redirect)
                const savedState = sessionStorage.getItem(
                    "docstore_form_state",
                );
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        this.form = state.form;
                        this.editingStore = state.editingStore;
                        this.showModal = state.showModal;
                        sessionStorage.removeItem("docstore_form_state");

                        // If we have a Google source type, load the account options
                        if (
                            [
                                "mcp:gdrive",
                                "mcp:gmail",
                                "mcp:gcalendar",
                                "mcp:gtasks",
                                "mcp:gcontacts",
                                "mcp:gkeep",
                            ].includes(this.form.source_type)
                        ) {
                            // Trigger folder/label/list loading if account is set
                            if (this.form.google_account_id) {
                                await this.onGoogleAccountChange();
                            }
                        }

                        // If we have a Microsoft source type, load the account options
                        if (
                            [
                                "mcp:onedrive",
                                "mcp:outlook",
                                "mcp:onenote",
                            ].includes(this.form.source_type)
                        ) {
                            // Trigger folder/notebook loading if account is set
                            if (this.form.microsoft_account_id) {
                                await this.onMicrosoftAccountChange();
                            }
                        }
                    } catch (e) {
                        console.error("Failed to restore form state:", e);
                        sessionStorage.removeItem("docstore_form_state");
                    }
                } else {
                    // Handle deeplink - expand and scroll to specific store
                    const params = new URLSearchParams(window.location.search);
                    const expandId = params.get("expand");
                    const expandName = params.get("name");

                    if (expandId) {
                        const storeId = parseInt(expandId);
                        if (!this.expandedRows.includes(storeId)) {
                            this.expandedRows.push(storeId);
                        }
                        // Scroll to the store after a short delay for DOM update
                        this.$nextTick(() => {
                            const row = document.querySelector(
                                `[data-store-id="${storeId}"]`,
                            );
                            if (row) {
                                row.scrollIntoView({
                                    behavior: "smooth",
                                    block: "center",
                                });
                                row.classList.add("bg-primary/10");
                                setTimeout(
                                    () => row.classList.remove("bg-primary/10"),
                                    2000,
                                );
                            }
                        });
                    } else if (expandName) {
                        // Find store by name
                        const store = this.stores.find(
                            (s) =>
                                s.name.toLowerCase() ===
                                expandName.toLowerCase(),
                        );
                        if (store) {
                            if (!this.expandedRows.includes(store.id)) {
                                this.expandedRows.push(store.id);
                            }
                            this.$nextTick(() => {
                                const row = document.querySelector(
                                    `[data-store-id="${store.id}"]`,
                                );
                                if (row) {
                                    row.scrollIntoView({
                                        behavior: "smooth",
                                        block: "center",
                                    });
                                    row.classList.add("bg-primary/10");
                                    setTimeout(
                                        () =>
                                            row.classList.remove(
                                                "bg-primary/10",
                                            ),
                                        2000,
                                    );
                                }
                            });
                        }
                    }
                }

                // Poll for status updates
                setInterval(() => this.loadStores(), 5000);
            },

            async loadGoogleOAuthStatus() {
                try {
                    const response = await fetch("/api/oauth/google/status");
                    if (response.ok) {
                        this.googleOAuth = await response.json();
                    }
                } catch (error) {
                    console.error("Failed to load Google OAuth status:", error);
                }
            },

            async loadMicrosoftOAuthStatus() {
                try {
                    const response = await fetch("/api/oauth/microsoft/status");
                    if (response.ok) {
                        this.microsoftOAuth = await response.json();
                    }
                } catch (error) {
                    console.error(
                        "Failed to load Microsoft OAuth status:",
                        error,
                    );
                }
            },

            async startMicrosoftOAuth() {
                try {
                    // Save form state before OAuth redirect
                    sessionStorage.setItem(
                        "docstore_form_state",
                        JSON.stringify({
                            form: this.form,
                            editingStore: this.editingStore,
                            showModal: true,
                        }),
                    );

                    // Map source type to OAuth scope
                    const scopeMap = {
                        "mcp:onedrive": "onedrive",
                        "mcp:outlook": "outlook",
                        "mcp:onenote": "onenote",
                    };
                    const scope = scopeMap[this.form.source_type] || "full";
                    const response = await fetch(
                        `/api/oauth/microsoft/start?scope=${scope}&redirect_uri=/document-stores`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        window.location.href = data.auth_url;
                    } else {
                        const error = await response.json();
                        alert(error.error || "Failed to start OAuth");
                    }
                } catch (error) {
                    console.error("Failed to start Microsoft OAuth:", error);
                    alert("Failed to start Microsoft OAuth");
                }
            },

            async deleteMicrosoftAccount() {
                if (!this.form.microsoft_account_id) return;

                const account = this.microsoftOAuth.accounts.find(
                    (a) => a.id == this.form.microsoft_account_id,
                );
                const accountName = account
                    ? account.account_email
                    : "this account";

                if (
                    !confirm(
                        `Are you sure you want to delete ${accountName}? Any document stores using this account will need to be reconfigured.`,
                    )
                ) {
                    return;
                }

                try {
                    const response = await fetch(
                        `/api/oauth/accounts/${this.form.microsoft_account_id}`,
                        { method: "DELETE" },
                    );
                    if (response.ok) {
                        // Refresh accounts list
                        await this.loadMicrosoftOAuthStatus();
                        this.form.microsoft_account_id = "";
                        this.onedriveFolders = [];
                        this.form.onedrive_folder_id = "";
                        this.form.onedrive_folder_name = "";
                        this.outlookFolders = [];
                        this.form.outlook_folder_id = "";
                        this.form.outlook_folder_name = "";
                        this.onenoteNotebooks = [];
                        this.form.onenote_notebook_id = "";
                        this.form.onenote_notebook_name = "";
                    } else {
                        const error = await response.json();
                        alert(error.error || "Failed to delete account");
                    }
                } catch (error) {
                    console.error("Failed to delete account:", error);
                    alert("Failed to delete account");
                }
            },

            async onMicrosoftAccountChange() {
                // Clear folder/notebook/teams selection when account changes
                this.form.onedrive_folder_id = "";
                this.form.onedrive_folder_name = "";
                this.onedriveFolders = [];
                this.onedriveFolderBreadcrumbs = [];
                this.currentOneDriveFolderId = "";
                this.form.outlook_folder_id = "";
                this.form.outlook_folder_name = "";
                this.outlookFolders = [];
                this.form.onenote_notebook_id = "";
                this.form.onenote_notebook_name = "";
                this.onenoteNotebooks = [];
                this.form.teams_team_id = "";
                this.form.teams_team_name = "";
                this.form.teams_channel_id = "";
                this.form.teams_channel_name = "";
                this.teamsTeams = [];
                this.teamsChannels = [];

                // Auto-load folders for OneDrive
                if (
                    this.form.source_type === "mcp:onedrive" &&
                    this.form.microsoft_account_id
                ) {
                    await this.loadOneDriveFolders();
                }

                // Auto-load folders for Outlook
                if (
                    this.form.source_type === "mcp:outlook" &&
                    this.form.microsoft_account_id
                ) {
                    await this.loadOutlookFolders();
                }

                // Auto-load notebooks for OneNote
                if (
                    this.form.source_type === "mcp:onenote" &&
                    this.form.microsoft_account_id
                ) {
                    await this.loadOneNoteNotebooks();
                }

                // Auto-load teams for Teams
                if (
                    this.form.source_type === "mcp:teams" &&
                    this.form.microsoft_account_id
                ) {
                    await this.loadTeams();
                }
            },

            async loadOneDriveFolders(parentId = "") {
                if (!this.form.microsoft_account_id) return;

                this.loadingOneDriveFolders = true;
                this.currentOneDriveFolderId = parentId;
                try {
                    let url = `/api/oauth/microsoft/${this.form.microsoft_account_id}/folders`;
                    if (parentId) {
                        url += `?parent=${encodeURIComponent(parentId)}`;
                    }
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        this.onedriveFolders = data.folders || [];
                    } else {
                        const error = await response.json();
                        console.error(
                            "Failed to load OneDrive folders:",
                            error,
                        );
                    }
                } catch (error) {
                    console.error("Failed to load OneDrive folders:", error);
                } finally {
                    this.loadingOneDriveFolders = false;
                }
            },

            navigateToOneDriveFolder(folderId, folderName) {
                // If going to root, clear breadcrumbs
                if (!folderId) {
                    this.onedriveFolderBreadcrumbs = [];
                } else {
                    // Add to breadcrumbs
                    this.onedriveFolderBreadcrumbs.push({
                        id: folderId,
                        name: folderName,
                    });
                }
                // Load subfolders
                this.loadOneDriveFolders(folderId);
            },

            navigateToOneDriveBreadcrumb(index) {
                // Navigate to a specific breadcrumb level
                const crumb = this.onedriveFolderBreadcrumbs[index];
                // Truncate breadcrumbs to this level
                this.onedriveFolderBreadcrumbs =
                    this.onedriveFolderBreadcrumbs.slice(0, index + 1);
                // Load that folder's contents
                this.loadOneDriveFolders(crumb.id);
            },

            selectOneDriveFolder(folderId, folderName) {
                this.form.onedrive_folder_id = folderId;
                this.form.onedrive_folder_name = folderName;
            },

            selectCurrentOneDriveFolder() {
                // Select the current folder we're browsing (last breadcrumb)
                if (this.onedriveFolderBreadcrumbs.length > 0) {
                    const current =
                        this.onedriveFolderBreadcrumbs[
                            this.onedriveFolderBreadcrumbs.length - 1
                        ];
                    this.form.onedrive_folder_id = current.id;
                    this.form.onedrive_folder_name = current.name;
                }
            },

            clearOneDriveFolderSelection() {
                this.form.onedrive_folder_id = "";
                this.form.onedrive_folder_name = "";
            },

            async loadOutlookFolders() {
                if (!this.form.microsoft_account_id) return;

                this.loadingOutlookFolders = true;
                try {
                    const response = await fetch(
                        `/api/oauth/microsoft/${this.form.microsoft_account_id}/mail-folders`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.outlookFolders = data.folders || [];
                    }
                } catch (error) {
                    console.error("Failed to load Outlook folders:", error);
                } finally {
                    this.loadingOutlookFolders = false;
                }
            },

            onOutlookFolderChange() {
                // Update folder name when folder is selected
                const folder = this.outlookFolders.find(
                    (f) => f.id === this.form.outlook_folder_id,
                );
                this.form.outlook_folder_name = folder ? folder.name : "";
            },

            async loadOneNoteNotebooks() {
                if (!this.form.microsoft_account_id) return;

                this.loadingOneNoteNotebooks = true;
                try {
                    const response = await fetch(
                        `/api/oauth/microsoft/${this.form.microsoft_account_id}/notebooks`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.onenoteNotebooks = data.notebooks || [];
                    }
                } catch (error) {
                    console.error("Failed to load OneNote notebooks:", error);
                } finally {
                    this.loadingOneNoteNotebooks = false;
                }
            },

            onOneNoteNotebookChange() {
                // Update notebook name when notebook is selected
                const notebook = this.onenoteNotebooks.find(
                    (n) => n.id === this.form.onenote_notebook_id,
                );
                this.form.onenote_notebook_name = notebook ? notebook.name : "";
            },

            async loadTeams() {
                if (!this.form.microsoft_account_id) return;

                this.loadingTeams = true;
                try {
                    const response = await fetch(
                        `/api/oauth/microsoft/${this.form.microsoft_account_id}/teams`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.teamsTeams = data.teams || [];
                    }
                } catch (error) {
                    console.error("Failed to load Teams:", error);
                } finally {
                    this.loadingTeams = false;
                }
            },

            async loadTeamsChannels() {
                if (!this.form.microsoft_account_id || !this.form.teams_team_id)
                    return;

                this.loadingTeamsChannels = true;
                try {
                    const response = await fetch(
                        `/api/oauth/microsoft/${this.form.microsoft_account_id}/teams/${this.form.teams_team_id}/channels`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.teamsChannels = data.channels || [];
                    }
                } catch (error) {
                    console.error("Failed to load Teams channels:", error);
                } finally {
                    this.loadingTeamsChannels = false;
                }
            },

            onTeamsTeamChange() {
                // Update team name when team is selected
                const team = this.teamsTeams.find(
                    (t) => t.id === this.form.teams_team_id,
                );
                this.form.teams_team_name = team ? team.name : "";
                // Clear channel selection when team changes
                this.form.teams_channel_id = "";
                this.form.teams_channel_name = "";
                this.teamsChannels = [];
                // Load channels for the selected team
                if (this.form.teams_team_id) {
                    this.loadTeamsChannels();
                }
            },

            onTeamsChannelChange() {
                // Update channel name when channel is selected
                const channel = this.teamsChannels.find(
                    (c) => c.id === this.form.teams_channel_id,
                );
                this.form.teams_channel_name = channel ? channel.name : "";
            },

            async startGoogleOAuth() {
                try {
                    // Save form state before OAuth redirect
                    sessionStorage.setItem(
                        "docstore_form_state",
                        JSON.stringify({
                            form: this.form,
                            editingStore: this.editingStore,
                            showModal: true,
                        }),
                    );

                    // Map source type to OAuth scope
                    const scopeMap = {
                        "mcp:gdrive": "drive",
                        "mcp:gmail": "gmail",
                        "mcp:gcalendar": "calendar",
                        "mcp:gtasks": "tasks",
                        "mcp:gcontacts": "contacts",
                        "mcp:gkeep": "keep",
                    };
                    const scope = scopeMap[this.form.source_type] || "drive";
                    const response = await fetch(
                        `/api/oauth/google/start?scope=${scope}&redirect_uri=/document-stores`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        window.location.href = data.auth_url;
                    } else {
                        const error = await response.json();
                        alert(error.error || "Failed to start OAuth");
                    }
                } catch (error) {
                    console.error("Failed to start Google OAuth:", error);
                    alert("Failed to start Google OAuth");
                }
            },

            async deleteGoogleAccount() {
                if (!this.form.google_account_id) return;

                const account = this.googleOAuth.accounts.find(
                    (a) => a.id == this.form.google_account_id,
                );
                const accountName = account
                    ? account.account_email
                    : "this account";

                if (
                    !confirm(
                        `Are you sure you want to delete ${accountName}? Any document stores using this account will need to be reconfigured.`,
                    )
                ) {
                    return;
                }

                try {
                    const response = await fetch(
                        `/api/oauth/accounts/${this.form.google_account_id}`,
                        { method: "DELETE" },
                    );
                    if (response.ok) {
                        // Refresh accounts list
                        await this.loadGoogleOAuthStatus();
                        this.form.google_account_id = "";
                        this.gdriveFolders = [];
                        this.form.gdrive_folder_id = "";
                        this.form.gdrive_folder_name = "";
                    } else {
                        const error = await response.json();
                        alert(error.error || "Failed to delete account");
                    }
                } catch (error) {
                    console.error("Failed to delete account:", error);
                    alert("Failed to delete account");
                }
            },

            async onGoogleAccountChange() {
                // Clear folder/label selection when account changes
                this.form.gdrive_folder_id = "";
                this.form.gdrive_folder_name = "";
                this.gdriveFolders = [];
                this.folderBreadcrumbs = [];
                this.currentFolderId = "";
                this.form.gmail_label_id = "";
                this.form.gmail_label_name = "";
                this.gmailLabels = [];
                this.form.gcalendar_calendar_id = "";
                this.form.gcalendar_calendar_name = "";
                this.googleCalendars = [];
                this.form.gtasks_tasklist_id = "";
                this.form.gtasks_tasklist_name = "";
                this.googleTaskLists = [];
                this.form.gcontacts_group_id = "";
                this.form.gcontacts_group_name = "";
                this.googleContactGroups = [];

                // Auto-load folders for Google Drive
                if (
                    this.form.source_type === "mcp:gdrive" &&
                    this.form.google_account_id
                ) {
                    await this.loadGdriveFolders();
                }

                // Auto-load labels for Gmail
                if (
                    this.form.source_type === "mcp:gmail" &&
                    this.form.google_account_id
                ) {
                    await this.loadGmailLabels();
                }

                // Auto-load calendars for Google Calendar
                if (
                    this.form.source_type === "mcp:gcalendar" &&
                    this.form.google_account_id
                ) {
                    await this.loadGoogleCalendars();
                }

                // Auto-load task lists for Google Tasks
                if (
                    this.form.source_type === "mcp:gtasks" &&
                    this.form.google_account_id
                ) {
                    await this.loadGoogleTaskLists();
                }

                // Auto-load contact groups for Google Contacts
                if (
                    this.form.source_type === "mcp:gcontacts" &&
                    this.form.google_account_id
                ) {
                    await this.loadGoogleContactGroups();
                }
            },

            async loadGdriveFolders(parentId = "") {
                if (!this.form.google_account_id) return;

                this.loadingFolders = true;
                this.currentFolderId = parentId;
                try {
                    let url = `/api/oauth/google/${this.form.google_account_id}/folders`;
                    if (parentId) {
                        url += `?parent=${encodeURIComponent(parentId)}`;
                    }
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        this.gdriveFolders = data.folders || [];
                    } else {
                        const error = await response.json();
                        console.error("Failed to load folders:", error);
                    }
                } catch (error) {
                    console.error("Failed to load folders:", error);
                } finally {
                    this.loadingFolders = false;
                }
            },

            navigateToFolder(folderId, folderName) {
                // If going to root, clear breadcrumbs
                if (!folderId) {
                    this.folderBreadcrumbs = [];
                } else {
                    // Add to breadcrumbs
                    this.folderBreadcrumbs.push({
                        id: folderId,
                        name: folderName,
                    });
                }
                // Load subfolders
                this.loadGdriveFolders(folderId);
            },

            navigateToBreadcrumb(index) {
                // Navigate to a specific breadcrumb level
                const crumb = this.folderBreadcrumbs[index];
                // Truncate breadcrumbs to this level
                this.folderBreadcrumbs = this.folderBreadcrumbs.slice(
                    0,
                    index + 1,
                );
                // Load that folder's contents
                this.loadGdriveFolders(crumb.id);
            },

            selectFolder(folderId, folderName) {
                this.form.gdrive_folder_id = folderId;
                this.form.gdrive_folder_name = folderName;
            },

            selectCurrentFolder() {
                // Select the current folder we're browsing (last breadcrumb)
                if (this.folderBreadcrumbs.length > 0) {
                    const current =
                        this.folderBreadcrumbs[
                            this.folderBreadcrumbs.length - 1
                        ];
                    this.form.gdrive_folder_id = current.id;
                    this.form.gdrive_folder_name = current.name;
                }
            },

            clearFolderSelection() {
                this.form.gdrive_folder_id = "";
                this.form.gdrive_folder_name = "";
            },

            // Local folder browser functions
            toggleLocalFolderBrowser() {
                this.showLocalFolderBrowser = !this.showLocalFolderBrowser;
                if (this.showLocalFolderBrowser) {
                    this.loadLocalFolders("/");
                }
            },

            async loadLocalFolders(path) {
                this.loadingLocalFolders = true;
                try {
                    const response = await fetch(
                        `/api/local-folders?path=${encodeURIComponent(path)}`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.localFolders = data.folders || [];
                        this.localFolderBreadcrumbs = data.breadcrumbs || [];
                        this.currentLocalPath = data.current_path || "/data";
                    } else {
                        const error = await response.json();
                        console.error("Failed to load folders:", error.error);
                    }
                } catch (error) {
                    console.error("Failed to load local folders:", error);
                } finally {
                    this.loadingLocalFolders = false;
                }
            },

            navigateLocalFolder(path) {
                this.loadLocalFolders(path);
            },

            selectLocalFolder(path) {
                this.form.source_path = path;
                this.showLocalFolderBrowser = false;
            },

            // Nextcloud folder browser functions
            toggleNextcloudFolderBrowser() {
                this.showNextcloudFolderBrowser =
                    !this.showNextcloudFolderBrowser;
                if (this.showNextcloudFolderBrowser) {
                    this.loadNextcloudFolders("/");
                }
            },

            async loadNextcloudFolders(path) {
                this.loadingNextcloudFolders = true;
                try {
                    const response = await fetch(
                        `/api/nextcloud-folders?path=${encodeURIComponent(path)}`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.nextcloudFolders = data.folders || [];
                        this.nextcloudFolderBreadcrumbs =
                            data.breadcrumbs || [];
                        this.currentNextcloudPath = data.current_path || "/";
                    } else {
                        const error = await response.json();
                        console.error(
                            "Failed to load Nextcloud folders:",
                            error.error,
                        );
                    }
                } catch (error) {
                    console.error("Failed to load Nextcloud folders:", error);
                } finally {
                    this.loadingNextcloudFolders = false;
                }
            },

            navigateNextcloudFolder(path) {
                this.loadNextcloudFolders(path);
            },

            selectNextcloudFolder(path) {
                this.form.nextcloud_folder = path === "/" ? "" : path;
                this.showNextcloudFolderBrowser = false;
            },

            // Paperless tag functions
            async loadPaperlessTags() {
                this.loadingPaperlessTags = true;
                try {
                    const response = await fetch("/api/paperless-tags");
                    if (response.ok) {
                        const data = await response.json();
                        this.paperlessTags = data.tags || [];
                    } else {
                        const error = await response.json();
                        console.error(
                            "Failed to load Paperless tags:",
                            error.error,
                        );
                    }
                } catch (error) {
                    console.error("Failed to load Paperless tags:", error);
                } finally {
                    this.loadingPaperlessTags = false;
                }
            },

            onPaperlessTagChange() {
                // Update tag name when tag is selected
                const tag = this.paperlessTags.find(
                    (t) => t.id == this.form.paperless_tag_id,
                );
                this.form.paperless_tag_name = tag ? tag.name : "";
            },

            // Slack channel functions
            async loadSlackChannels() {
                if (this.loadingSlackChannels) return;
                this.loadingSlackChannels = true;
                try {
                    const response = await fetch("/api/slack/channels");
                    if (response.ok) {
                        const data = await response.json();
                        this.slackChannels = data.channels || [];
                    } else {
                        const error = await response.json();
                        console.error(
                            "Failed to load Slack channels:",
                            error.error,
                        );
                    }
                } catch (error) {
                    console.error("Failed to load Slack channels:", error);
                } finally {
                    this.loadingSlackChannels = false;
                }
            },

            toggleSlackChannelType(type) {
                const types = this.form.slack_channel_types
                    .split(",")
                    .filter((t) => t);
                const idx = types.indexOf(type);
                if (idx >= 0) {
                    // Remove if already present (but keep at least one)
                    if (types.length > 1) {
                        types.splice(idx, 1);
                    }
                } else {
                    // Add if not present
                    types.push(type);
                }
                this.form.slack_channel_types = types.join(",");
            },

            // Todoist functions
            async loadTodoistProjects() {
                if (this.loadingTodoistProjects) return;
                this.loadingTodoistProjects = true;
                try {
                    const response = await fetch("/api/todoist/projects");
                    if (response.ok) {
                        const data = await response.json();
                        this.todoistProjects = data.projects || [];

                        // Restore saved selection after loading options (Alpine.js fix)
                        const savedProjectId = this.form.todoist_project_id;
                        if (savedProjectId) {
                            setTimeout(() => {
                                const el = document.querySelector(
                                    'select[x-model="form.todoist_project_id"]',
                                );
                                if (el) {
                                    el.value = savedProjectId;
                                    el.dispatchEvent(new Event("change"));
                                }
                            }, 100);
                        }
                    } else {
                        const error = await response.json();
                        console.error(
                            "Failed to load Todoist projects:",
                            error.error,
                        );
                    }
                } catch (error) {
                    console.error("Failed to load Todoist projects:", error);
                } finally {
                    this.loadingTodoistProjects = false;
                }
            },

            onTodoistProjectChange() {
                // Update project name when project is selected
                const project = this.todoistProjects.find(
                    (p) => p.id === this.form.todoist_project_id,
                );
                this.form.todoist_project_name = project ? project.name : "";
            },

            onFolderChange() {
                // Update folder name when folder is selected
                const folder = this.gdriveFolders.find(
                    (f) => f.id === this.form.gdrive_folder_id,
                );
                this.form.gdrive_folder_name = folder ? folder.name : "";
            },

            async loadGmailLabels() {
                if (!this.form.google_account_id) return;

                this.loadingLabels = true;
                try {
                    const response = await fetch(
                        `/api/oauth/google/${this.form.google_account_id}/labels`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.gmailLabels = data.labels || [];
                    }
                } catch (error) {
                    console.error("Failed to load Gmail labels:", error);
                } finally {
                    this.loadingLabels = false;
                }
            },

            onLabelChange() {
                // Update label name when label is selected
                const label = this.gmailLabels.find(
                    (l) => l.id === this.form.gmail_label_id,
                );
                this.form.gmail_label_name = label ? label.name : "";
            },

            async loadGoogleCalendars() {
                if (!this.form.google_account_id) return;

                this.loadingCalendars = true;
                try {
                    const response = await fetch(
                        `/api/oauth/google/${this.form.google_account_id}/calendars`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.googleCalendars = data.calendars || [];
                    }
                } catch (error) {
                    console.error("Failed to load Google calendars:", error);
                } finally {
                    this.loadingCalendars = false;
                }
            },

            onCalendarChange() {
                // Update calendar name when calendar is selected
                const cal = this.googleCalendars.find(
                    (c) => c.id === this.form.gcalendar_calendar_id,
                );
                this.form.gcalendar_calendar_name = cal ? cal.name : "";
            },

            async loadGoogleTaskLists() {
                if (!this.form.google_account_id) return;

                this.loadingTaskLists = true;
                try {
                    const response = await fetch(
                        `/api/oauth/google/${this.form.google_account_id}/tasklists`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.googleTaskLists = data.tasklists || [];
                    }
                } catch (error) {
                    console.error("Failed to load Google task lists:", error);
                } finally {
                    this.loadingTaskLists = false;
                }
            },

            onTaskListChange() {
                // Update task list name when task list is selected
                const list = this.googleTaskLists.find(
                    (l) => l.id === this.form.gtasks_tasklist_id,
                );
                this.form.gtasks_tasklist_name = list ? list.name : "";
            },

            async loadGoogleContactGroups() {
                if (!this.form.google_account_id) return;

                this.loadingContactGroups = true;
                try {
                    const response = await fetch(
                        `/api/oauth/google/${this.form.google_account_id}/contactgroups`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.googleContactGroups = data.groups || [];
                    }
                } catch (error) {
                    console.error(
                        "Failed to load Google contact groups:",
                        error,
                    );
                } finally {
                    this.loadingContactGroups = false;
                }
            },

            onContactGroupChange() {
                // Update contact group name when group is selected
                const group = this.googleContactGroups.find(
                    (g) => g.id === this.form.gcontacts_group_id,
                );
                this.form.gcontacts_group_name = group ? group.name : "";
            },

            async loadNotionDatabases() {
                this.loadingNotionDatabases = true;
                this.notionError = null;
                try {
                    const response = await fetch("/api/notion/databases");
                    if (response.ok) {
                        const data = await response.json();
                        this.notionDatabases = data.databases || [];
                    } else {
                        const error = await response.json();
                        this.notionError =
                            error.error || "Failed to load databases";
                    }
                } catch (error) {
                    console.error("Failed to load Notion databases:", error);
                    this.notionError = "Failed to connect to Notion API";
                } finally {
                    this.loadingNotionDatabases = false;
                }
            },

            // Source display helpers for the table
            getSourceBadgeClass(store) {
                if (store.source_type === "local") return "badge-ghost";
                if (store.source_type === "website") return "badge-info";
                if (store.source_type === "paperless") return "badge-success";
                if (store.source_type === "nextcloud") return "badge-info";
                if (store.source_type === "notion") return "badge-warning";
                if (store.source_type === "mcp:gdrive") return "badge-primary";
                if (store.source_type === "mcp:gmail") return "badge-secondary";
                if (store.source_type === "mcp:gcalendar")
                    return "badge-accent";
                if (store.source_type === "mcp:gtasks") return "badge-info";
                if (store.source_type === "mcp:gcontacts")
                    return "badge-warning";
                if (store.source_type === "mcp:onedrive") return "badge-info";
                if (store.source_type === "mcp:outlook") return "badge-primary";
                if (store.source_type === "mcp:onenote")
                    return "badge-secondary";
                if (store.source_type === "mcp:notion") return "badge-warning";
                if (store.source_type === "mcp:github") return "badge-neutral";
                if (store.source_type === "slack") return "badge-warning";
                if (store.source_type === "todoist") return "badge-error";
                if (
                    store.source_type === "mcp" ||
                    store.source_type?.startsWith("mcp:")
                )
                    return "badge-info";
                return "badge-ghost";
            },

            getStoreDisplayName(store) {
                // Use display_name if set, otherwise convert slug to title case
                if (store.display_name) {
                    return store.display_name;
                }
                // Convert slug to title case: "my-gmail-store" -> "My Gmail Store"
                return store.name
                    .split("-")
                    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(" ");
            },

            getSourceIcon(store) {
                // Special case: Notion task databases get task icon
                if (
                    store.source_type === "notion" &&
                    store.notion_is_task_database
                ) {
                    return "âœ…";
                }
                const icons = {
                    local: "ðŸ“",
                    website: "ðŸŒ",
                    websearch: "ðŸ”",
                    paperless: "ðŸ“„",
                    nextcloud: "â˜ï¸",
                    notion: "ðŸ“",
                    "mcp:gdrive": "ðŸ“‚",
                    "mcp:gmail": "ðŸ“§",
                    "mcp:gcalendar": "ðŸ“…",
                    "mcp:gtasks": "âœ…",
                    "mcp:gcontacts": "ðŸ‘¥",
                    "mcp:gkeep": "ðŸ“",
                    "mcp:onedrive": "ðŸ“‚",
                    "mcp:outlook": "ðŸ“§",
                    "mcp:onenote": "ðŸ““",
                    "mcp:teams": "ðŸ’¬",
                    "mcp:notion": "ðŸ“",
                    "mcp:github": "ðŸ™",
                    slack: "ðŸ’¬",
                    todoist: "âœ…",
                };
                return icons[store.source_type] || "ðŸ“¦";
            },

            getSourceBadgeText(store) {
                if (store.source_type === "local") return "Local";
                if (store.source_type === "website") return "Website";
                if (store.source_type === "websearch") return "Web Search";
                if (store.source_type === "paperless") return "Paperless";
                if (store.source_type === "nextcloud") return "Nextcloud";
                if (store.source_type === "notion") return "Notion";
                if (store.source_type === "mcp:gdrive") return "Drive";
                if (store.source_type === "mcp:gmail") return "Gmail";
                if (store.source_type === "mcp:gcalendar") return "Calendar";
                if (store.source_type === "mcp:gtasks") return "Tasks";
                if (store.source_type === "mcp:gcontacts") return "Contacts";
                if (store.source_type === "mcp:gkeep") return "Keep";
                if (store.source_type === "mcp:onedrive") return "OneDrive";
                if (store.source_type === "mcp:outlook") return "Outlook";
                if (store.source_type === "mcp:onenote") return "OneNote";
                if (store.source_type === "mcp:teams") return "Teams";
                if (store.source_type === "mcp:notion") return "Notion";
                if (store.source_type === "mcp:github") return "GitHub";
                if (store.source_type === "slack") return "Slack";
                if (store.source_type === "todoist") return "Todoist";
                if (
                    store.source_type === "mcp" ||
                    store.source_type?.startsWith("mcp:")
                )
                    return "MCP";
                return "Local";
            },

            getSourceDetail(store) {
                if (store.source_type === "local")
                    return store.source_path || "";
                if (store.source_type === "website")
                    return store.website_url || "";
                if (store.source_type === "websearch")
                    return store.websearch_query || "";
                if (store.source_type === "paperless")
                    return store.paperless_url || "";
                if (store.source_type === "nextcloud")
                    return store.nextcloud_folder || "All files";
                if (store.source_type === "notion") {
                    if (store.notion_database_id)
                        return `Database: ${store.notion_database_id.substring(0, 8)}...`;
                    if (store.notion_page_id)
                        return `Page: ${store.notion_page_id.substring(0, 8)}...`;
                    return "All accessible pages";
                }
                if (store.source_type === "mcp:github") {
                    let detail = store.github_repo || "";
                    if (store.github_branch)
                        detail += `:${store.github_branch}`;
                    if (store.github_path) detail += ` (${store.github_path})`;
                    return detail;
                }
                const acct = store.google_account_email || "";
                if (store.source_type === "mcp:gdrive") {
                    const folder = store.gdrive_folder_name || "All files";
                    return acct ? `${acct}: ${folder}` : folder;
                }
                if (store.source_type === "mcp:gmail") {
                    const label = store.gmail_label_name || "All emails";
                    return acct ? `${acct}: ${label}` : label;
                }
                if (store.source_type === "mcp:gcalendar") {
                    const cal = store.gcalendar_calendar_name || "Primary";
                    return acct ? `${acct}: ${cal}` : cal;
                }
                if (store.source_type === "mcp:gtasks") {
                    const list = store.gtasks_tasklist_name || "All lists";
                    return acct ? `${acct}: ${list}` : list;
                }
                if (store.source_type === "mcp:gcontacts") {
                    const label = store.gcontacts_group_name || "All contacts";
                    return acct ? `${acct}: ${label}` : label;
                }
                if (store.source_type === "mcp:gkeep") {
                    return acct ? `${acct}: All notes` : "All notes";
                }
                // Microsoft sources
                const msAcct = store.microsoft_account_email || "";
                if (store.source_type === "mcp:onedrive") {
                    const folder = store.onedrive_folder_name || "All files";
                    return msAcct ? `${msAcct}: ${folder}` : folder;
                }
                if (store.source_type === "mcp:outlook") {
                    const folder = store.outlook_folder_name || "Inbox";
                    const days = store.outlook_days_back || 90;
                    const detail = `${folder} (${days}d)`;
                    return msAcct ? `${msAcct}: ${detail}` : detail;
                }
                if (store.source_type === "mcp:onenote") {
                    const notebook =
                        store.onenote_notebook_name || "All notebooks";
                    return msAcct ? `${msAcct}: ${notebook}` : notebook;
                }
                if (store.source_type === "mcp:teams") {
                    const days = store.teams_days_back || 90;
                    let detail = "";
                    if (store.teams_channel_name) {
                        detail = `${store.teams_team_name}/${store.teams_channel_name}`;
                    } else if (store.teams_team_name) {
                        detail = store.teams_team_name;
                    } else {
                        detail = "All teams";
                    }
                    detail += ` (${days}d)`;
                    return msAcct ? `${msAcct}: ${detail}` : detail;
                }
                if (store.source_type === "slack") {
                    const days = store.slack_days_back || 90;
                    if (store.slack_channel_id) {
                        return `Channel: ${store.slack_channel_id} (${days}d)`;
                    }
                    return `All channels (${days}d)`;
                }
                if (store.source_type === "todoist") {
                    let detail = store.todoist_project_name || "All projects";
                    if (store.todoist_filter) {
                        detail += ` (${store.todoist_filter})`;
                    }
                    if (store.todoist_include_completed) {
                        detail += " +completed";
                    }
                    return detail;
                }
                if (store.source_type === "mcp")
                    return store.mcp_server_config?.name || "Unknown";
                return "";
            },

            getSourceDetailShort(store) {
                // For local paths, show just the last 2 path segments
                if (store.source_type === "local" && store.source_path) {
                    const parts = store.source_path.split("/").filter((p) => p);
                    if (parts.length > 2) {
                        return ".../" + parts.slice(-2).join("/");
                    }
                    return store.source_path;
                }
                // For other sources, use the full detail (they're usually short)
                return this.getSourceDetail(store);
            },

            async loadMcpStatus() {
                try {
                    const response = await fetch(
                        "/api/mcp-integrations/status",
                    );
                    if (response.ok) {
                        this.mcpStatus = await response.json();
                    }
                } catch (error) {
                    console.error("Failed to load MCP status:", error);
                }
            },

            async loadDocumentSources() {
                try {
                    const response = await fetch("/api/feature-status");
                    if (response.ok) {
                        const data = await response.json();
                        this.documentSources =
                            data.dependencies?.document_sources || {};
                    }
                } catch (error) {
                    console.error("Failed to load document sources:", error);
                }
            },

            async loadStores() {
                try {
                    const response = await fetch("/api/document-stores");
                    if (response.ok) {
                        this.allStores = await response.json();
                        // Filtering is now handled by the filteredStores computed property
                    }
                } catch (error) {
                    console.error("Failed to load stores:", error);
                } finally {
                    this.loading = false;
                }
            },

            setFilter(mode) {
                this.filterMode = mode;
                // Update URL without reload
                const url = new URL(window.location);
                if (mode === "all") {
                    url.searchParams.delete("filter");
                } else {
                    url.searchParams.set("filter", mode);
                }
                window.history.replaceState({}, "", url);
            },

            toggleExpand(id) {
                const idx = this.expandedRows.indexOf(id);
                if (idx >= 0) {
                    this.expandedRows.splice(idx, 1);
                } else {
                    this.expandedRows.push(id);
                }
            },

            getMcpPresetKey() {
                if (!this.form.source_type.startsWith("mcp:")) return null;
                const key = this.form.source_type.replace("mcp:", "");
                return key !== "custom" && this.mcpPresets[key] ? key : null;
            },

            onSourceTypeChange() {
                const presetKey = this.getMcpPresetKey();
                if (presetKey && this.mcpPresets[presetKey]) {
                    const preset = this.mcpPresets[presetKey];
                    this.form.mcp_name = preset.name;
                    this.form.mcp_transport = preset.transport;
                    this.form.mcp_command = preset.command;
                    this.form.mcp_args = preset.args;
                } else if (this.form.source_type === "mcp:custom") {
                    this.form.mcp_name = "";
                    this.form.mcp_transport = "stdio";
                    this.form.mcp_command = "";
                    this.form.mcp_args = "";
                }
            },

            openAddModal() {
                this.editingStore = null;
                this.gdriveFolders = [];
                this.folderBreadcrumbs = [];
                this.currentFolderId = "";
                this.gmailLabels = [];
                this.googleCalendars = [];
                this.slackChannels = [];
                this.todoistProjects = [];
                this.onedriveFolders = [];
                this.onedriveFolderBreadcrumbs = [];
                this.currentOneDriveFolderId = "";
                this.outlookFolders = [];
                this.onenoteNotebooks = [];
                this.form = {
                    name: "",
                    display_name: "",
                    source_type:
                        this.filterMode === "website" ? "website" : "local",
                    source_path: "",
                    paperless_url: "",
                    paperless_token: "",
                    github_repo: "",
                    github_branch: "",
                    github_path: "",
                    slack_channel_id: "",
                    slack_channel_types: "public_channel",
                    slack_days_back: 90,
                    todoist_project_id: "",
                    todoist_project_name: "",
                    todoist_filter: "",
                    todoist_include_completed: false,
                    websearch_query: "",
                    websearch_max_results: 10,
                    websearch_pages_to_scrape: 5,
                    websearch_time_range: "",
                    websearch_category: "",
                    mcp_name: "",
                    mcp_transport: "stdio",
                    mcp_command: "",
                    mcp_args: "",
                    mcp_url: "",
                    mcp_uri_patterns: "",
                    google_account_id: "",
                    gdrive_folder_id: "",
                    gdrive_folder_name: "",
                    gmail_label_id: "",
                    gmail_label_name: "",
                    gcalendar_calendar_id: "",
                    gcalendar_calendar_name: "",
                    gtasks_tasklist_id: "",
                    gtasks_tasklist_name: "",
                    gcontacts_group_id: "",
                    gcontacts_group_name: "",
                    microsoft_account_id: "",
                    onedrive_folder_id: "",
                    onedrive_folder_name: "",
                    outlook_folder_id: "",
                    outlook_folder_name: "",
                    outlook_days_back: 90,
                    onenote_notebook_id: "",
                    onenote_notebook_name: "",
                    teams_team_id: "",
                    teams_team_name: "",
                    teams_channel_id: "",
                    teams_channel_name: "",
                    teams_days_back: 90,
                    index_schedule: "",
                    custom_schedule: "",
                    chunk_size: 512,
                    chunk_overlap: 50,
                    max_documents: null,
                    description: "",
                    enabled: true,
                };
                this.formErrors = {};
                this.showModal = true;
            },

            async openEditModal(store) {
                this.editingStore = store;
                this.gdriveFolders = [];
                this.folderBreadcrumbs = [];
                this.currentFolderId = "";
                this.gmailLabels = [];
                this.googleCalendars = [];
                this.slackChannels = [];
                this.todoistProjects = [];
                this.onedriveFolders = [];
                this.onedriveFolderBreadcrumbs = [];
                this.currentOneDriveFolderId = "";
                this.teamsTeams = [];
                this.teamsChannels = [];
                this.outlookFolders = [];
                this.onenoteNotebooks = [];

                // Determine source type
                let sourceType = store.source_type;
                if (sourceType === "mcp" && store.mcp_server_config) {
                    const mcpName = store.mcp_server_config.name;
                    // Check if it matches a preset
                    for (const [key, preset] of Object.entries(
                        this.mcpPresets,
                    )) {
                        if (preset.name === mcpName) {
                            sourceType = `mcp:${key}`;
                            break;
                        }
                    }
                    if (sourceType === "mcp") {
                        sourceType = "mcp:custom";
                    }
                }

                this.form = {
                    name: store.name,
                    display_name: store.display_name || "",
                    source_type: sourceType,
                    source_path: store.source_path || "",
                    paperless_url: store.paperless_url || "",
                    paperless_token: store.paperless_token || "",
                    paperless_tag_id: store.paperless_tag_id || "",
                    paperless_tag_name: store.paperless_tag_name || "",
                    github_repo: store.github_repo || "",
                    github_branch: store.github_branch || "",
                    github_path: store.github_path || "",
                    notion_database_id: store.notion_database_id || "",
                    notion_page_id: store.notion_page_id || "",
                    notion_is_task_database:
                        store.notion_is_task_database || false,
                    nextcloud_folder: store.nextcloud_folder || "",
                    website_url: store.website_url || "",
                    website_crawl_depth: store.website_crawl_depth || 1,
                    website_max_pages: store.website_max_pages || 50,
                    website_include_pattern:
                        store.website_include_pattern || "",
                    website_exclude_pattern:
                        store.website_exclude_pattern || "",
                    website_crawler_override:
                        store.website_crawler_override || "",
                    slack_channel_id: store.slack_channel_id || "",
                    slack_channel_types:
                        store.slack_channel_types || "public_channel",
                    slack_days_back: store.slack_days_back || 90,
                    todoist_project_id: store.todoist_project_id || "",
                    todoist_project_name: store.todoist_project_name || "",
                    todoist_filter: store.todoist_filter || "",
                    todoist_include_completed:
                        store.todoist_include_completed || false,
                    mcp_name: store.mcp_server_config?.name || "",
                    mcp_transport:
                        store.mcp_server_config?.transport || "stdio",
                    mcp_command: store.mcp_server_config?.command || "",
                    mcp_args: (store.mcp_server_config?.args || []).join(" "),
                    mcp_url: store.mcp_server_config?.url || "",
                    mcp_uri_patterns: (
                        store.mcp_server_config?.uri_patterns || []
                    ).join(", "),
                    google_account_id: store.google_account_id || "",
                    gdrive_folder_id: store.gdrive_folder_id || "",
                    gdrive_folder_name: store.gdrive_folder_name || "",
                    gmail_label_id: store.gmail_label_id || "",
                    gmail_label_name: store.gmail_label_name || "",
                    gcalendar_calendar_id: store.gcalendar_calendar_id || "",
                    gcalendar_calendar_name:
                        store.gcalendar_calendar_name || "",
                    gtasks_tasklist_id: store.gtasks_tasklist_id || "",
                    gtasks_tasklist_name: store.gtasks_tasklist_name || "",
                    gcontacts_group_id: store.gcontacts_group_id || "",
                    gcontacts_group_name: store.gcontacts_group_name || "",
                    microsoft_account_id: store.microsoft_account_id || "",
                    onedrive_folder_id: store.onedrive_folder_id || "",
                    onedrive_folder_name: store.onedrive_folder_name || "",
                    outlook_folder_id: store.outlook_folder_id || "",
                    outlook_folder_name: store.outlook_folder_name || "",
                    outlook_days_back: store.outlook_days_back || 90,
                    onenote_notebook_id: store.onenote_notebook_id || "",
                    onenote_notebook_name: store.onenote_notebook_name || "",
                    teams_team_id: store.teams_team_id || "",
                    teams_team_name: store.teams_team_name || "",
                    teams_channel_id: store.teams_channel_id || "",
                    teams_channel_name: store.teams_channel_name || "",
                    teams_days_back: store.teams_days_back || 90,
                    websearch_query: store.websearch_query || "",
                    websearch_max_results: store.websearch_max_results || 10,
                    websearch_pages_to_scrape:
                        store.websearch_pages_to_scrape || 5,
                    websearch_time_range: store.websearch_time_range || "",
                    websearch_category: store.websearch_category || "",
                    index_schedule: store.index_schedule || "",
                    custom_schedule: "",
                    chunk_size: store.chunk_size || 512,
                    chunk_overlap: store.chunk_overlap || 50,
                    max_documents: store.max_documents || null,
                    description: store.description || "",
                    enabled: store.enabled,
                };

                // Load folders/labels/calendars if editing a Google source with an account
                // Save the selected values before loading options (async load can reset them)
                const savedLabelId = this.form.gmail_label_id;
                const savedCalendarId = this.form.gcalendar_calendar_id;
                const savedFolderId = this.form.gdrive_folder_id;
                const savedTaskListId = this.form.gtasks_tasklist_id;
                const savedContactGroupId = this.form.gcontacts_group_id;

                if (sourceType === "mcp:gdrive" && store.google_account_id) {
                    await this.loadGdriveFolders();
                }
                if (sourceType === "mcp:gmail" && store.google_account_id) {
                    await this.loadGmailLabels();
                }
                if (sourceType === "mcp:gcalendar" && store.google_account_id) {
                    await this.loadGoogleCalendars();
                }
                if (sourceType === "mcp:gtasks" && store.google_account_id) {
                    await this.loadGoogleTaskLists();
                }
                if (sourceType === "mcp:gcontacts" && store.google_account_id) {
                    await this.loadGoogleContactGroups();
                }

                // Load Microsoft folders/notebooks/teams if editing a Microsoft source
                const savedOneDriveFolderId = this.form.onedrive_folder_id;
                const savedOutlookFolderId = this.form.outlook_folder_id;
                const savedOneNoteNotebookId = this.form.onenote_notebook_id;
                const savedTeamsTeamId = this.form.teams_team_id;
                const savedTeamsChannelId = this.form.teams_channel_id;

                if (
                    sourceType === "mcp:onedrive" &&
                    store.microsoft_account_id
                ) {
                    await this.loadOneDriveFolders();
                }
                if (
                    sourceType === "mcp:outlook" &&
                    store.microsoft_account_id
                ) {
                    await this.loadOutlookFolders();
                }
                if (
                    sourceType === "mcp:onenote" &&
                    store.microsoft_account_id
                ) {
                    await this.loadOneNoteNotebooks();
                }
                if (sourceType === "mcp:teams" && store.microsoft_account_id) {
                    await this.loadTeams();
                    // If a team was selected, also load its channels
                    if (savedTeamsTeamId) {
                        await this.loadTeamsChannels();
                    }
                }

                // Restore selections after options are rendered
                // Use setTimeout to ensure x-for templates have fully rendered
                // Then set via DOM and dispatch input event to sync with Alpine
                setTimeout(() => {
                    if (savedFolderId) {
                        const el = document.querySelector(
                            'select[x-model="form.gdrive_folder_id"]',
                        );
                        if (el) {
                            el.value = savedFolderId;
                            el.dispatchEvent(new Event("change"));
                        }
                    }
                    if (savedLabelId) {
                        const el = document.querySelector(
                            'select[x-model="form.gmail_label_id"]',
                        );
                        if (el) {
                            el.value = savedLabelId;
                            el.dispatchEvent(new Event("change"));
                        }
                    }
                    if (savedCalendarId) {
                        const el = document.querySelector(
                            'select[x-model="form.gcalendar_calendar_id"]',
                        );
                        if (el) {
                            el.value = savedCalendarId;
                            el.dispatchEvent(new Event("change"));
                        }
                    }
                    if (savedTaskListId) {
                        const el = document.querySelector(
                            'select[x-model="form.gtasks_tasklist_id"]',
                        );
                        if (el) {
                            el.value = savedTaskListId;
                            el.dispatchEvent(new Event("change"));
                        }
                    }
                    if (savedContactGroupId) {
                        const el = document.querySelector(
                            'select[x-model="form.gcontacts_group_id"]',
                        );
                        if (el) {
                            el.value = savedContactGroupId;
                            el.dispatchEvent(new Event("change"));
                        }
                    }
                    if (savedOneDriveFolderId) {
                        const el = document.querySelector(
                            'select[x-model="form.onedrive_folder_id"]',
                        );
                        if (el) {
                            el.value = savedOneDriveFolderId;
                            el.dispatchEvent(new Event("change"));
                        }
                    }
                    if (savedOutlookFolderId) {
                        const el = document.querySelector(
                            'select[x-model="form.outlook_folder_id"]',
                        );
                        if (el) {
                            el.value = savedOutlookFolderId;
                            el.dispatchEvent(new Event("change"));
                        }
                    }
                    if (savedOneNoteNotebookId) {
                        const el = document.querySelector(
                            'select[x-model="form.onenote_notebook_id"]',
                        );
                        if (el) {
                            el.value = savedOneNoteNotebookId;
                            el.dispatchEvent(new Event("change"));
                        }
                    }
                    if (savedTeamsTeamId) {
                        const el = document.querySelector(
                            'select[x-model="form.teams_team_id"]',
                        );
                        if (el) {
                            el.value = savedTeamsTeamId;
                            el.dispatchEvent(new Event("change"));
                        }
                    }
                    if (savedTeamsChannelId) {
                        const el = document.querySelector(
                            'select[x-model="form.teams_channel_id"]',
                        );
                        if (el) {
                            el.value = savedTeamsChannelId;
                            el.dispatchEvent(new Event("change"));
                        }
                    }
                }, 100);

                this.formErrors = {};
                this.showModal = true;
            },

            closeModal() {
                this.showModal = false;
                this.editingStore = null;
            },

            async saveStore() {
                this.formErrors = {};
                this.saving = true;

                try {
                    // Build request body
                    const body = {
                        name: this.form.name,
                        display_name: this.form.display_name || null,
                        enabled: this.form.enabled,
                        chunk_size: parseInt(this.form.chunk_size),
                        chunk_overlap: parseInt(this.form.chunk_overlap),
                        max_documents: this.form.max_documents
                            ? parseInt(this.form.max_documents)
                            : null,
                        description: this.form.description || null,
                        index_schedule:
                            this.form.index_schedule === "custom"
                                ? this.form.custom_schedule
                                : this.form.index_schedule || null,
                    };

                    if (this.form.source_type === "local") {
                        body.source_type = "local";
                        body.source_path = this.form.source_path;
                    } else if (this.form.source_type === "paperless") {
                        body.source_type = "paperless";
                        body.paperless_tag_id = this.form.paperless_tag_id
                            ? parseInt(this.form.paperless_tag_id)
                            : null;
                        body.paperless_tag_name =
                            this.form.paperless_tag_name || null;
                        // Credentials come from PAPERLESS_URL and PAPERLESS_TOKEN env vars
                    } else if (this.form.source_type === "nextcloud") {
                        body.source_type = "nextcloud";
                        body.nextcloud_folder =
                            this.form.nextcloud_folder || null;
                        // Credentials come from NEXTCLOUD_URL, NEXTCLOUD_USER, NEXTCLOUD_PASSWORD env vars
                    } else if (this.form.source_type === "notion") {
                        body.source_type = "notion";
                        body.notion_database_id =
                            this.form.notion_database_id || null;
                        body.notion_page_id = this.form.notion_page_id || null;
                        body.notion_is_task_database =
                            this.form.notion_is_task_database || false;
                    } else if (this.form.source_type === "mcp:github") {
                        body.source_type = "mcp:github";
                        body.github_repo = this.form.github_repo;
                        body.github_branch = this.form.github_branch || null;
                        body.github_path = this.form.github_path || null;
                    } else if (this.form.source_type === "website") {
                        body.source_type = "website";
                        body.website_url = this.form.website_url;
                        body.website_crawl_depth =
                            parseInt(this.form.website_crawl_depth) || 1;
                        body.website_max_pages =
                            parseInt(this.form.website_max_pages) || 50;
                        body.website_include_pattern =
                            this.form.website_include_pattern || null;
                        body.website_exclude_pattern =
                            this.form.website_exclude_pattern || null;
                        body.website_crawler_override =
                            this.form.website_crawler_override || null;
                    } else if (this.form.source_type === "slack") {
                        body.source_type = "slack";
                        body.slack_channel_id =
                            this.form.slack_channel_id || null;
                        body.slack_channel_types =
                            this.form.slack_channel_types || "public_channel";
                        body.slack_days_back =
                            parseInt(this.form.slack_days_back) || 90;
                    } else if (this.form.source_type === "todoist") {
                        body.source_type = "todoist";
                        body.todoist_project_id =
                            this.form.todoist_project_id || null;
                        body.todoist_project_name =
                            this.form.todoist_project_name || null;
                        body.todoist_filter = this.form.todoist_filter || null;
                        body.todoist_include_completed =
                            this.form.todoist_include_completed || false;
                    } else if (
                        [
                            "mcp:gdrive",
                            "mcp:gmail",
                            "mcp:gcalendar",
                            "mcp:gtasks",
                            "mcp:gcontacts",
                            "mcp:gkeep",
                        ].includes(this.form.source_type)
                    ) {
                        // Google sources - use specific source type and OAuth account
                        body.source_type = this.form.source_type;
                        body.google_account_id = this.form.google_account_id
                            ? parseInt(this.form.google_account_id)
                            : null;
                        // Include folder filter for Google Drive
                        if (this.form.source_type === "mcp:gdrive") {
                            body.gdrive_folder_id =
                                this.form.gdrive_folder_id || null;
                            body.gdrive_folder_name =
                                this.form.gdrive_folder_name || null;
                        }
                        // Include label filter for Gmail
                        if (this.form.source_type === "mcp:gmail") {
                            body.gmail_label_id =
                                this.form.gmail_label_id || null;
                            body.gmail_label_name =
                                this.form.gmail_label_name || null;
                        }
                        // Include calendar filter for Google Calendar
                        if (this.form.source_type === "mcp:gcalendar") {
                            body.gcalendar_calendar_id =
                                this.form.gcalendar_calendar_id || null;
                            body.gcalendar_calendar_name =
                                this.form.gcalendar_calendar_name || null;
                        }
                        // Include task list filter for Google Tasks
                        if (this.form.source_type === "mcp:gtasks") {
                            body.gtasks_tasklist_id =
                                this.form.gtasks_tasklist_id || null;
                            body.gtasks_tasklist_name =
                                this.form.gtasks_tasklist_name || null;
                        }
                        // Include contact group filter for Google Contacts
                        if (this.form.source_type === "mcp:gcontacts") {
                            body.gcontacts_group_id =
                                this.form.gcontacts_group_id || null;
                            body.gcontacts_group_name =
                                this.form.gcontacts_group_name || null;
                        }
                    } else if (
                        ["mcp:onedrive", "mcp:outlook", "mcp:onenote"].includes(
                            this.form.source_type,
                        )
                    ) {
                        // Microsoft sources - use specific source type and OAuth account
                        body.source_type = this.form.source_type;
                        body.microsoft_account_id = this.form
                            .microsoft_account_id
                            ? parseInt(this.form.microsoft_account_id)
                            : null;
                        // Include folder filter for OneDrive
                        if (this.form.source_type === "mcp:onedrive") {
                            body.onedrive_folder_id =
                                this.form.onedrive_folder_id || null;
                            body.onedrive_folder_name =
                                this.form.onedrive_folder_name || null;
                        }
                        // Include folder filter and days back for Outlook
                        if (this.form.source_type === "mcp:outlook") {
                            body.outlook_folder_id =
                                this.form.outlook_folder_id || null;
                            body.outlook_folder_name =
                                this.form.outlook_folder_name || null;
                            body.outlook_days_back =
                                parseInt(this.form.outlook_days_back) || 90;
                        }
                        // Include notebook filter for OneNote
                        if (this.form.source_type === "mcp:onenote") {
                            body.onenote_notebook_id =
                                this.form.onenote_notebook_id || null;
                            body.onenote_notebook_name =
                                this.form.onenote_notebook_name || null;
                        }
                        // Include team/channel filter for Teams
                        if (this.form.source_type === "mcp:teams") {
                            body.teams_team_id =
                                this.form.teams_team_id || null;
                            body.teams_team_name =
                                this.form.teams_team_name || null;
                            body.teams_channel_id =
                                this.form.teams_channel_id || null;
                            body.teams_channel_name =
                                this.form.teams_channel_name || null;
                            body.teams_days_back =
                                parseInt(this.form.teams_days_back) || 90;
                        }
                    } else if (this.form.source_type === "websearch") {
                        body.source_type = "websearch";
                        body.websearch_query = this.form.websearch_query;
                        body.websearch_max_results =
                            parseInt(this.form.websearch_max_results) || 10;
                        body.websearch_pages_to_scrape =
                            parseInt(this.form.websearch_pages_to_scrape) || 5;
                        body.websearch_time_range =
                            this.form.websearch_time_range || null;
                        body.websearch_category =
                            this.form.websearch_category || null;
                    } else if (this.form.source_type.startsWith("mcp:")) {
                        // Other MCP sources - use generic mcp type with config
                        body.source_type = "mcp";
                        body.mcp_server_config = {
                            name: this.form.mcp_name,
                            transport: this.form.mcp_transport,
                        };
                        if (this.form.mcp_transport === "stdio") {
                            body.mcp_server_config.command =
                                this.form.mcp_command;
                            body.mcp_server_config.args = this.form.mcp_args
                                .split(/\s+/)
                                .filter(Boolean);
                        } else {
                            body.mcp_server_config.url = this.form.mcp_url;
                        }
                        if (this.form.mcp_uri_patterns) {
                            body.mcp_server_config.uri_patterns =
                                this.form.mcp_uri_patterns
                                    .split(",")
                                    .map((p) => p.trim())
                                    .filter(Boolean);
                        }
                        // Add discovery tool config from preset if available
                        const presetKey = this.getMcpPresetKey();
                        if (presetKey && this.mcpPresets[presetKey]) {
                            const preset = this.mcpPresets[presetKey];
                            if (preset.discovery_tool) {
                                body.mcp_server_config.discovery_tool =
                                    preset.discovery_tool;
                                body.mcp_server_config.discovery_args =
                                    preset.discovery_args || null;
                                body.mcp_server_config.content_tool =
                                    preset.content_tool || null;
                                body.mcp_server_config.content_id_field =
                                    preset.content_id_field || null;
                            }
                        }
                    }

                    const url = this.editingStore
                        ? `/api/document-stores/${this.editingStore.id}`
                        : "/api/document-stores";
                    const method = this.editingStore ? "PUT" : "POST";

                    const response = await fetch(url, {
                        method,
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        this.formErrors.general =
                            result.error || "Failed to save";
                        return;
                    }

                    this.closeModal();
                    await this.loadStores();
                } catch (error) {
                    console.error("Save error:", error);
                    this.formErrors.general = "Failed to save document store";
                } finally {
                    this.saving = false;
                }
            },

            confirmDelete(store) {
                if (store.rag_count > 0) {
                    alert(
                        `Cannot delete "${store.name}" - it is used by ${store.rag_count} RAG(s)`,
                    );
                    return;
                }
                this.deleteTarget = store;
                this.showDeleteModal = true;
            },

            async deleteStore() {
                if (!this.deleteTarget) return;
                this.deleting = true;

                try {
                    const response = await fetch(
                        `/api/document-stores/${this.deleteTarget.id}`,
                        { method: "DELETE" },
                    );

                    if (response.ok) {
                        this.showDeleteModal = false;
                        this.deleteTarget = null;
                        await this.loadStores();
                    } else {
                        const result = await response.json();
                        alert(result.error || "Failed to delete store");
                    }
                } catch (error) {
                    console.error("Delete error:", error);
                    alert("Failed to delete store");
                } finally {
                    this.deleting = false;
                }
            },

            async indexNow(store) {
                this.indexingStores.push(store.id);

                try {
                    const response = await fetch(
                        `/api/document-stores/${store.id}/index`,
                        { method: "POST" },
                    );

                    if (!response.ok) {
                        const result = await response.json();
                        alert(result.error || "Failed to start indexing");
                    }

                    await this.loadStores();
                } catch (error) {
                    console.error("Index error:", error);
                    alert("Failed to start indexing");
                } finally {
                    this.indexingStores = this.indexingStores.filter(
                        (id) => id !== store.id,
                    );
                }
            },

            async cancelIndex(store) {
                this.cancellingStores.push(store.id);

                try {
                    const response = await fetch(
                        `/api/document-stores/${store.id}/cancel-index`,
                        { method: "POST" },
                    );

                    if (!response.ok) {
                        const result = await response.json();
                        alert(result.error || "Failed to cancel indexing");
                    }

                    await this.loadStores();
                } catch (error) {
                    console.error("Cancel error:", error);
                    alert("Failed to cancel indexing");
                } finally {
                    this.cancellingStores = this.cancellingStores.filter(
                        (id) => id !== store.id,
                    );
                }
            },

            async openPreviewModal(store) {
                this.previewStore = store;
                this.previewData = null;
                this.previewError = null;
                this.previewLoading = true;
                this.showPreviewModal = true;

                try {
                    const response = await fetch(
                        `/api/document-stores/${store.id}/preview?limit=20`,
                    );

                    if (!response.ok) {
                        const result = await response.json();
                        this.previewError =
                            result.error || "Failed to load preview";
                        return;
                    }

                    this.previewData = await response.json();
                } catch (error) {
                    console.error("Preview error:", error);
                    this.previewError = "Failed to load preview";
                } finally {
                    this.previewLoading = false;
                }
            },

            async loadMorePreview() {
                if (!this.previewStore || !this.previewData) return;

                this.previewLoadingMore = true;

                try {
                    const offset = this.previewData.documents.length;
                    const response = await fetch(
                        `/api/document-stores/${this.previewStore.id}/preview?limit=20&offset=${offset}`,
                    );

                    if (!response.ok) {
                        const result = await response.json();
                        alert(result.error || "Failed to load more");
                        return;
                    }

                    const moreData = await response.json();
                    this.previewData.documents.push(...moreData.documents);
                    this.previewData.showing =
                        this.previewData.documents.length;
                } catch (error) {
                    console.error("Load more error:", error);
                    alert("Failed to load more");
                } finally {
                    this.previewLoadingMore = false;
                }
            },

            async clearContents(store) {
                if (
                    !confirm(
                        `Clear all indexed content from "${store.name}"? This cannot be undone.`,
                    )
                ) {
                    return;
                }

                this.clearingStores.push(store.id);

                try {
                    const response = await fetch(
                        `/api/document-stores/${store.id}/clear`,
                        { method: "POST" },
                    );

                    if (!response.ok) {
                        const result = await response.json();
                        alert(result.error || "Failed to clear contents");
                    }

                    await this.loadStores();
                } catch (error) {
                    console.error("Clear error:", error);
                    alert("Failed to clear contents");
                } finally {
                    this.clearingStores = this.clearingStores.filter(
                        (id) => id !== store.id,
                    );
                }
            },

            async testUnified(store) {
                if (!store.unified_source) {
                    alert("This store does not have a unified source");
                    return;
                }

                this.testingUnifiedStores.push(store.id);

                try {
                    const response = await fetch(
                        `/api/document-stores/${store.id}/test-unified`,
                        { method: "POST" },
                    );

                    const result = await response.json();

                    if (result.success) {
                        const caps = result.capabilities;
                        const capList = [];
                        if (caps.rag) capList.push("RAG");
                        if (caps.live) capList.push("Live");
                        if (caps.actions) capList.push("Actions");
                        alert(
                            `Unified source test passed!\n\nCapabilities: ${capList.join(", ")}\n\n${result.message}`,
                        );
                    } else {
                        alert(
                            `Unified source test failed:\n\n${result.error || result.message}`,
                        );
                    }
                } catch (error) {
                    console.error("Test unified error:", error);
                    alert("Failed to test unified source");
                } finally {
                    this.testingUnifiedStores =
                        this.testingUnifiedStores.filter(
                            (id) => id !== store.id,
                        );
                }
            },

            async refreshIntelligence(store) {
                this.refreshingIntelligence = store.id;

                try {
                    const response = await fetch(
                        `/api/document-stores/${store.id}/refresh-intelligence`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                        },
                    );

                    if (!response.ok) {
                        const result = await response.json();
                        alert(
                            result.error || "Failed to generate intelligence",
                        );
                    }

                    await this.loadStores();
                } catch (error) {
                    console.error("Intelligence refresh error:", error);
                    alert("Failed to generate intelligence");
                } finally {
                    this.refreshingIntelligence = null;
                }
            },
        };
    }
</script>
{% endblock %}
