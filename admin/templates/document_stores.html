{% extends "base.html" %} {% block title %}Document Stores{% endblock %} {%
block content %}
<div x-data="documentStoresPage()" x-init="init()">
    <!-- Header -->
    <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6"
    >
        <div>
            <h1
                class="text-2xl font-bold"
                x-text="filterMode === 'website' ? 'Websites' : 'Document Stores'"
            >
                Document Stores
            </h1>
            <p
                class="text-base-content/60"
                x-text="filterMode === 'website' ? 'Crawled and indexed websites for Smart RAGs' : 'Configure and index document sources for Smart RAGs'"
            >
                Configure and index document sources for Smart RAGs
            </p>
        </div>
        <button @click="openAddModal()" class="btn btn-primary btn-sm">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 mr-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                />
            </svg>
            <span
                x-text="filterMode === 'website' ? 'Add Website' : 'Add Store'"
                >Add Store</span
            >
        </button>
    </div>

    <!-- Loading State -->
    <template x-if="loading">
        <div class="flex justify-center py-12">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    </template>

    <!-- No Stores Configured -->
    <template x-if="!loading && stores.length === 0">
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center py-12">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-16 w-16 mx-auto text-base-content/30"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"
                    />
                </svg>
                <h3
                    class="mt-4 text-lg font-medium"
                    x-text="filterMode === 'website' ? 'No Websites Configured' : 'No Document Stores Configured'"
                >
                    No Document Stores Configured
                </h3>
                <p
                    class="mt-2 text-base-content/60 max-w-md mx-auto"
                    x-text="filterMode === 'website' ? 'Websites are crawled and indexed for semantic search. Add a website to enable RAG-based Q&A over web content.' : 'Document stores index documents from local folders or MCP sources. They can be shared across multiple Smart RAGs for multi-source search.'"
                >
                    Document stores index documents from local folders or MCP
                    sources. They can be shared across multiple Smart RAGs for
                    multi-source search.
                </p>
                <button @click="openAddModal()" class="btn btn-primary mt-4">
                    <span
                        x-text="filterMode === 'website' ? 'Add Your First Website' : 'Create Your First Store'"
                        >Create Your First Store</span
                    >
                </button>
            </div>
        </div>
    </template>

    <!-- Store Table -->
    <template x-if="!loading && stores.length > 0">
        <div class="card bg-base-100 shadow-lg">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="w-8"></th>
                            <th>Name</th>
                            <th>Source</th>
                            <th>Index</th>
                            <th
                                class="text-right"
                                x-text="filterMode === 'website' ? 'Pages' : 'Docs'"
                            >
                                Docs
                            </th>
                            <th class="text-right">Chunks</th>
                            <th>Status</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <template x-for="store in stores" :key="store.id">
                        <tbody>
                            <!-- Main Row -->
                            <tr
                                @click="toggleExpand(store.id)"
                                class="cursor-pointer hover:bg-base-200"
                            >
                                <td class="w-8">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 transition-transform"
                                        :class="{'rotate-90': expandedRows.includes(store.id)}"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 5l7 7-7 7"
                                        />
                                    </svg>
                                </td>
                                <td>
                                    <div
                                        class="font-mono font-medium"
                                        x-text="store.name"
                                    ></div>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="badge badge-sm"
                                            :class="getSourceBadgeClass(store)"
                                            x-text="getSourceBadgeText(store)"
                                        ></span>
                                        <span
                                            class="font-mono text-sm text-base-content/70 truncate max-w-[200px]"
                                            x-text="getSourceDetailShort(store)"
                                            :title="getSourceDetail(store)"
                                        ></span>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="badge badge-sm"
                                            :class="{
                                                'badge-success': store.index_status === 'ready',
                                                'badge-warning': store.index_status === 'indexing',
                                                'badge-error': store.index_status === 'error',
                                                'badge-ghost': store.index_status === 'pending'
                                            }"
                                            x-text="store.index_status"
                                        ></span>
                                        <span
                                            x-show="store.index_status === 'indexing'"
                                            class="loading loading-spinner loading-xs"
                                        ></span>
                                    </div>
                                </td>
                                <td class="text-right">
                                    <span
                                        class="font-mono text-sm"
                                        x-text="store.document_count || 0"
                                    ></span>
                                </td>
                                <td class="text-right">
                                    <span
                                        class="font-mono text-sm"
                                        x-text="store.chunk_count || 0"
                                    ></span>
                                </td>
                                <td>
                                    <span
                                        class="badge badge-sm"
                                        :class="store.enabled ? 'badge-success' : 'badge-ghost'"
                                        x-text="store.enabled ? 'Enabled' : 'Disabled'"
                                    ></span>
                                </td>
                                <td class="text-right" @click.stop>
                                    <div class="flex justify-end gap-1">
                                        <!-- Index Now button (hidden when indexing) -->
                                        <button
                                            x-show="store.index_status !== 'indexing'"
                                            @click="indexNow(store)"
                                            class="btn btn-ghost btn-sm"
                                            :class="{ 'loading': indexingStores.includes(store.id) }"
                                            :disabled="indexingStores.includes(store.id)"
                                            title="Index now"
                                        >
                                            <svg
                                                x-show="!indexingStores.includes(store.id)"
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                                />
                                            </svg>
                                        </button>
                                        <!-- Cancel Index button (shown when indexing) -->
                                        <button
                                            x-show="store.index_status === 'indexing'"
                                            @click="cancelIndex(store)"
                                            class="btn btn-ghost btn-sm text-warning"
                                            :class="{ 'loading': cancellingStores.includes(store.id) }"
                                            :disabled="cancellingStores.includes(store.id)"
                                            title="Cancel indexing"
                                        >
                                            <svg
                                                x-show="!cancellingStores.includes(store.id)"
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M6 18L18 6M6 6l12 12"
                                                />
                                            </svg>
                                        </button>
                                        <!-- Clear Contents button (shown when has content) -->
                                        <button
                                            x-show="store.chunk_count > 0 && store.index_status !== 'indexing'"
                                            @click="clearContents(store)"
                                            class="btn btn-ghost btn-sm text-warning"
                                            :class="{ 'loading': clearingStores.includes(store.id) }"
                                            :disabled="clearingStores.includes(store.id)"
                                            title="Clear indexed content"
                                        >
                                            <svg
                                                x-show="!clearingStores.includes(store.id)"
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                />
                                            </svg>
                                        </button>
                                        <button
                                            @click="openEditModal(store)"
                                            class="btn btn-ghost btn-sm"
                                            title="Edit store"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                                />
                                            </svg>
                                        </button>
                                        <button
                                            @click="confirmDelete(store)"
                                            class="btn btn-ghost btn-sm text-error"
                                            :disabled="store.rag_count > 0"
                                            :title="store.rag_count > 0 ? 'Cannot delete - used by RAGs' : 'Delete store'"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Expanded Details Row -->
                            <tr
                                x-show="expandedRows.includes(store.id)"
                                x-transition
                            >
                                <td colspan="9" class="bg-base-200 p-0">
                                    <div
                                        class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"
                                    >
                                        <!-- Description -->
                                        <div
                                            x-show="store.description"
                                            class="md:col-span-2"
                                        >
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Description
                                            </div>
                                            <div
                                                class="text-sm"
                                                x-text="store.description"
                                            ></div>
                                        </div>
                                        <!-- Source Path (full) -->
                                        <div
                                            x-show="getSourceDetail(store)"
                                            class="md:col-span-2"
                                        >
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Source Path
                                            </div>
                                            <div
                                                class="font-mono text-xs break-all"
                                                x-text="getSourceDetail(store)"
                                            ></div>
                                        </div>
                                        <!-- Embedding Provider -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Embedding
                                            </div>
                                            <div class="font-mono text-xs">
                                                <span
                                                    x-text="store.embedding_provider"
                                                ></span>
                                                <span
                                                    x-show="store.embedding_model"
                                                    x-text="' / ' + store.embedding_model"
                                                ></span>
                                            </div>
                                        </div>
                                        <!-- Vision Provider -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Vision
                                            </div>
                                            <div class="font-mono text-xs">
                                                <span
                                                    x-text="store.vision_provider"
                                                ></span>
                                                <span
                                                    x-show="store.vision_model"
                                                    x-text="' / ' + store.vision_model"
                                                ></span>
                                            </div>
                                        </div>
                                        <!-- Index Schedule -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Schedule
                                            </div>
                                            <div
                                                class="text-xs"
                                                x-text="store.index_schedule || 'Manual only'"
                                            ></div>
                                        </div>
                                        <!-- Last Indexed -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Last Indexed
                                            </div>
                                            <div
                                                class="text-xs"
                                                x-text="store.last_indexed ? new Date(store.last_indexed).toLocaleString() : 'Never'"
                                            ></div>
                                        </div>
                                        <!-- Chunking -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Chunking
                                            </div>
                                            <div class="text-xs">
                                                Size:
                                                <span
                                                    class="font-mono"
                                                    x-text="store.chunk_size"
                                                ></span
                                                >, Overlap:
                                                <span
                                                    class="font-mono"
                                                    x-text="store.chunk_overlap"
                                                ></span>
                                            </div>
                                        </div>
                                        <!-- Collection Name -->
                                        <div>
                                            <div
                                                class="text-xs text-base-content/50 uppercase mb-1"
                                            >
                                                Collection
                                            </div>
                                            <div
                                                class="font-mono text-xs"
                                                x-text="store.collection_name || 'Not created'"
                                            ></div>
                                        </div>
                                        <!-- Error (if any) -->
                                        <div
                                            x-show="store.index_error"
                                            class="md:col-span-2"
                                        >
                                            <div
                                                class="text-xs text-error uppercase mb-1"
                                            >
                                                Index Error
                                            </div>
                                            <div
                                                class="text-xs text-error"
                                                x-text="store.index_error"
                                            ></div>
                                        </div>
                                    </div>

                                    <!-- Intelligence Section -->
                                    <div
                                        x-show="store.themes?.length || store.best_for || store.content_summary"
                                        class="border-t border-base-300 p-4"
                                    >
                                        <div
                                            class="flex items-center justify-between mb-3"
                                        >
                                            <div
                                                class="text-xs text-base-content/50 uppercase font-medium"
                                            >
                                                Document Intelligence
                                            </div>
                                            <div
                                                class="flex items-center gap-2"
                                            >
                                                <span
                                                    x-show="store.intelligence_updated_at"
                                                    class="text-xs text-base-content/40"
                                                    x-text="'Updated: ' + new Date(store.intelligence_updated_at).toLocaleDateString()"
                                                ></span>
                                                <button
                                                    @click="refreshIntelligence(store)"
                                                    class="btn btn-ghost btn-xs"
                                                    :class="{ 'loading': refreshingIntelligence === store.id }"
                                                    :disabled="refreshingIntelligence === store.id"
                                                    title="Regenerate intelligence"
                                                >
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        class="h-3 w-3"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <div
                                            class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm"
                                        >
                                            <!-- Themes -->
                                            <div x-show="store.themes?.length">
                                                <div
                                                    class="text-xs text-base-content/50 mb-1"
                                                >
                                                    Themes
                                                </div>
                                                <div
                                                    class="flex flex-wrap gap-1"
                                                >
                                                    <template
                                                        x-for="theme in store.themes"
                                                        :key="theme"
                                                    >
                                                        <span
                                                            class="badge badge-sm badge-outline"
                                                            x-text="theme"
                                                        ></span>
                                                    </template>
                                                </div>
                                            </div>
                                            <!-- Best For -->
                                            <div x-show="store.best_for">
                                                <div
                                                    class="text-xs text-base-content/50 mb-1"
                                                >
                                                    Best For
                                                </div>
                                                <div
                                                    class="text-xs"
                                                    x-text="store.best_for"
                                                ></div>
                                            </div>
                                            <!-- Summary -->
                                            <div x-show="store.content_summary">
                                                <div
                                                    class="text-xs text-base-content/50 mb-1"
                                                >
                                                    Summary
                                                </div>
                                                <div
                                                    class="text-xs"
                                                    x-text="store.content_summary"
                                                ></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- No Intelligence - offer to generate -->
                                    <div
                                        x-show="!store.themes?.length && !store.best_for && !store.content_summary && store.index_status === 'ready' && store.chunk_count > 0"
                                        class="border-t border-base-300 p-4"
                                    >
                                        <div
                                            class="flex items-center justify-between"
                                        >
                                            <span
                                                class="text-xs text-base-content/50"
                                                >No intelligence generated</span
                                            >
                                            <button
                                                @click="refreshIntelligence(store)"
                                                class="btn btn-ghost btn-xs"
                                                :class="{ 'loading': refreshingIntelligence === store.id }"
                                                :disabled="refreshingIntelligence === store.id"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-3 w-3 mr-1"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M13 10V3L4 14h7v7l9-11h-7z"
                                                    />
                                                </svg>
                                                Generate Intelligence
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </template>
                </table>
            </div>
        </div>
    </template>

    <!-- Add/Edit Modal -->
    <div class="modal" :class="{ 'modal-open': showModal }">
        <div class="modal-box max-w-2xl">
            <h3
                class="font-bold text-lg"
                x-text="editingStore ? 'Edit Document Store' : 'Add Document Store'"
            ></h3>
            <form @submit.prevent="saveStore()">
                <!-- Name -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Store Name</span>
                    </label>
                    <input
                        type="text"
                        x-model="form.name"
                        class="input input-bordered font-mono"
                        :class="{ 'input-error': formErrors.name }"
                        placeholder="e.g., my-drive-docs, company-wiki"
                        required
                        :disabled="editingStore"
                    />
                    <label class="label" x-show="formErrors.name">
                        <span
                            class="label-text-alt text-error"
                            x-text="formErrors.name"
                        ></span>
                    </label>
                </div>

                <!-- Source Type -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Document Source</span>
                    </label>
                    <select
                        x-model="form.source_type"
                        @change="onSourceTypeChange()"
                        class="select select-bordered"
                    >
                        <option value="local">Local Filesystem</option>
                        <optgroup label="Google">
                            <option value="mcp:gdrive">Google Drive</option>
                            <option value="mcp:gmail">Gmail</option>
                            <option value="mcp:gcalendar">
                                Google Calendar
                            </option>
                        </optgroup>
                        <optgroup label="Document Management">
                            <option
                                value="paperless"
                                x-show="documentSources.paperless?.configured"
                            >
                                Paperless-ngx
                            </option>
                            <option
                                value="notion"
                                x-show="documentSources.notion?.configured"
                            >
                                Notion
                            </option>
                            <option
                                value="nextcloud"
                                x-show="documentSources.nextcloud?.configured"
                            >
                                Nextcloud
                            </option>
                        </optgroup>
                        <optgroup label="Web">
                            <option value="website">Website (crawled)</option>
                        </optgroup>
                        <optgroup label="Other Integrations">
                            <option
                                value="mcp:github"
                                x-show="documentSources.github?.configured"
                            >
                                GitHub
                            </option>
                            <option
                                value="mcp:slack"
                                x-show="mcpStatus.slack?.available"
                            >
                                Slack
                            </option>
                        </optgroup>
                    </select>
                    <label
                        class="label"
                        x-show="!mcpStatus.google?.available && !mcpStatus.notion?.available && !mcpStatus.github?.available && !mcpStatus.slack?.available"
                    >
                        <span class="label-text-alt text-base-content/60">
                            Set environment variables to enable MCP integrations
                            (e.g., NOTION_API_KEY, GITHUB_TOKEN)
                        </span>
                    </label>
                </div>

                <!-- Source Path (for local source) -->
                <div
                    class="form-control mt-4"
                    x-show="form.source_type === 'local'"
                >
                    <label class="label">
                        <span class="label-text">Source Path</span>
                    </label>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            x-model="form.source_path"
                            class="input input-bordered font-mono flex-1"
                            :class="{ 'input-error': formErrors.source_path }"
                            placeholder="e.g., /data/documents"
                            :required="form.source_type === 'local'"
                        />
                        <button
                            type="button"
                            @click="toggleLocalFolderBrowser()"
                            class="btn btn-outline btn-square"
                            title="Browse folders"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                />
                            </svg>
                        </button>
                    </div>

                    <!-- Local folder browser -->
                    <div
                        x-show="showLocalFolderBrowser"
                        x-transition
                        class="mt-2 border rounded-lg p-3 bg-base-200"
                    >
                        <!-- Breadcrumb navigation -->
                        <div
                            class="text-sm flex items-center gap-1 mb-2 flex-wrap"
                        >
                            <a
                                href="#"
                                @click.prevent="navigateLocalFolder('/')"
                                class="link link-hover"
                            >
                                /
                            </a>
                            <template
                                x-for="(crumb, index) in localFolderBreadcrumbs"
                                :key="crumb.path"
                            >
                                <span class="flex items-center gap-1">
                                    <span class="text-base-content/50"
                                        >&gt;</span
                                    >
                                    <a
                                        href="#"
                                        @click.prevent="navigateLocalFolder(crumb.path)"
                                        class="link link-hover"
                                        x-text="crumb.name"
                                    ></a>
                                </span>
                            </template>
                        </div>

                        <!-- Folder list -->
                        <div
                            class="border rounded-lg max-h-48 overflow-y-auto bg-base-100"
                        >
                            <div
                                x-show="loadingLocalFolders"
                                class="flex justify-center py-4"
                            >
                                <span
                                    class="loading loading-spinner loading-sm"
                                ></span>
                            </div>
                            <ul
                                x-show="!loadingLocalFolders"
                                class="menu menu-sm p-1"
                            >
                                <!-- "Select this folder" option -->
                                <li>
                                    <a
                                        href="#"
                                        @click.prevent="selectLocalFolder(currentLocalPath)"
                                        class="text-primary font-medium"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M5 13l4 4L19 7"
                                            />
                                        </svg>
                                        Select this folder
                                    </a>
                                </li>
                                <!-- Subfolders -->
                                <template
                                    x-for="folder in localFolders"
                                    :key="folder.path"
                                >
                                    <li>
                                        <a
                                            href="#"
                                            @click.prevent="navigateLocalFolder(folder.path)"
                                            class="font-mono text-sm"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                                />
                                            </svg>
                                            <span x-text="folder.name"></span>
                                        </a>
                                    </li>
                                </template>
                                <!-- No subfolders message -->
                                <li
                                    x-show="localFolders.length === 0 && !loadingLocalFolders"
                                >
                                    <span class="text-base-content/50 italic"
                                        >No subfolders</span
                                    >
                                </li>
                            </ul>
                        </div>
                    </div>

                    <label class="label">
                        <span class="label-text-alt"
                            >Docker-mounted folder containing documents to
                            index</span
                        >
                    </label>
                </div>

                <!-- Paperless Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'paperless'"
                    x-effect="if (form.source_type === 'paperless' && paperlessTags.length === 0 && !loadingPaperlessTags) loadPaperlessTags()"
                >
                    <!-- Tag Filter -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Filter by Tag (optional)</span
                            >
                        </label>
                        <select
                            x-model="form.paperless_tag_id"
                            @change="onPaperlessTagChange()"
                            class="select select-bordered w-full"
                        >
                            <option value="">
                                <span x-show="loadingPaperlessTags"
                                    >Loading tags...</span
                                >
                                <span x-show="!loadingPaperlessTags"
                                    >All documents (no filter)</span
                                >
                            </option>
                            <template
                                x-for="(tag, index) in paperlessTags"
                                :key="index"
                            >
                                <option :value="tag.id">
                                    <span
                                        x-text="tag.name + (tag.document_count ? ' (' + tag.document_count + ')' : '')"
                                    ></span>
                                </option>
                            </template>
                        </select>
                        <label class="label">
                            <span class="label-text-alt">
                                Only index documents with a specific tag, or
                                leave empty for all documents
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Nextcloud Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'nextcloud'"
                >
                    <!-- Folder Path with Browser -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Folder Path (optional)</span
                            >
                        </label>
                        <div class="join w-full">
                            <input
                                type="text"
                                x-model="form.nextcloud_folder"
                                class="input input-bordered join-item flex-1 font-mono"
                                placeholder="/ (all files)"
                            />
                            <button
                                type="button"
                                @click="toggleNextcloudFolderBrowser()"
                                class="btn btn-outline btn-square join-item"
                                title="Browse folders"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                    />
                                </svg>
                            </button>
                        </div>

                        <!-- Nextcloud folder browser -->
                        <div
                            x-show="showNextcloudFolderBrowser"
                            x-transition
                            class="mt-2 border rounded-lg p-3 bg-base-200"
                        >
                            <!-- Breadcrumb navigation -->
                            <div
                                class="text-sm flex items-center gap-1 mb-2 flex-wrap"
                            >
                                <a
                                    href="#"
                                    @click.prevent="navigateNextcloudFolder('/')"
                                    class="link link-hover"
                                >
                                    /
                                </a>
                                <template
                                    x-for="(crumb, index) in nextcloudFolderBreadcrumbs"
                                    :key="crumb.path"
                                >
                                    <span class="flex items-center gap-1">
                                        <span class="text-base-content/50"
                                            >&gt;</span
                                        >
                                        <a
                                            href="#"
                                            @click.prevent="navigateNextcloudFolder(crumb.path)"
                                            class="link link-hover"
                                            x-text="crumb.name"
                                        ></a>
                                    </span>
                                </template>
                            </div>

                            <!-- Folder list -->
                            <div
                                class="border rounded-lg max-h-48 overflow-y-auto bg-base-100"
                            >
                                <div
                                    x-show="loadingNextcloudFolders"
                                    class="flex justify-center py-4"
                                >
                                    <span
                                        class="loading loading-spinner loading-sm"
                                    ></span>
                                </div>
                                <ul
                                    x-show="!loadingNextcloudFolders"
                                    class="menu menu-sm p-1"
                                >
                                    <!-- "Select this folder" option -->
                                    <li>
                                        <a
                                            href="#"
                                            @click.prevent="selectNextcloudFolder(currentNextcloudPath)"
                                            class="text-primary font-medium"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M5 13l4 4L19 7"
                                                />
                                            </svg>
                                            Select this folder
                                        </a>
                                    </li>
                                    <!-- Subfolders -->
                                    <template
                                        x-for="folder in nextcloudFolders"
                                        :key="folder.path"
                                    >
                                        <li>
                                            <a
                                                href="#"
                                                @click.prevent="navigateNextcloudFolder(folder.path)"
                                                class="font-mono text-sm"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-4 w-4"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                                    />
                                                </svg>
                                                <span
                                                    x-text="folder.name"
                                                ></span>
                                            </a>
                                        </li>
                                    </template>
                                    <!-- Empty state -->
                                    <li
                                        x-show="nextcloudFolders.length === 0 && !loadingNextcloudFolders"
                                    >
                                        <span
                                            class="text-base-content/50 italic"
                                            >No subfolders</span
                                        >
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <label class="label">
                            <span class="label-text-alt">
                                Leave empty to index all files, or select a
                                folder to restrict indexing
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Notion Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'notion'"
                    x-effect="if (form.source_type === 'notion' && notionDatabases.length === 0 && !loadingNotionDatabases) loadNotionDatabases()"
                >
                    <!-- Database Selection -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Database (optional)</span>
                        </label>
                        <div class="flex gap-2">
                            <select
                                x-model="form.notion_database_id"
                                class="select select-bordered flex-1"
                                :disabled="loadingNotionDatabases"
                            >
                                <option value="">
                                    All accessible pages (no filter)
                                </option>
                                <template
                                    x-for="db in notionDatabases"
                                    :key="db.id"
                                >
                                    <option
                                        :value="db.id"
                                        x-text="db.title"
                                    ></option>
                                </template>
                            </select>
                            <button
                                type="button"
                                @click="loadNotionDatabases()"
                                class="btn btn-ghost btn-sm"
                                :class="{ 'loading': loadingNotionDatabases }"
                                :disabled="loadingNotionDatabases"
                                title="Refresh databases"
                            >
                                <svg
                                    x-show="!loadingNotionDatabases"
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                    />
                                </svg>
                            </button>
                        </div>
                        <label class="label" x-show="notionError">
                            <span
                                class="label-text-alt text-error"
                                x-text="notionError"
                            ></span>
                        </label>
                        <label class="label" x-show="!notionError">
                            <span class="label-text-alt"
                                >Index all pages from a specific Notion
                                database</span
                            >
                        </label>
                    </div>

                    <!-- Manual Page ID (alternative to database) -->
                    <div class="form-control" x-show="!form.notion_database_id">
                        <label class="label">
                            <span class="label-text"
                                >Or enter Page ID manually (optional)</span
                            >
                        </label>
                        <input
                            type="text"
                            x-model="form.notion_page_id"
                            class="input input-bordered font-mono"
                            placeholder="e.g., 1234abcd-5678-efgh-ijkl-9012mnop3456"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Index a specific page and its children (find ID
                                in Notion URL)</span
                            >
                        </label>
                    </div>

                    <div
                        class="text-sm text-base-content/60"
                        x-show="!form.notion_database_id && !form.notion_page_id"
                    >
                        Leave both empty to search all accessible pages.
                    </div>
                </div>

                <!-- GitHub Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'mcp:github'"
                >
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Repository</span>
                        </label>
                        <input
                            type="text"
                            x-model="form.github_repo"
                            class="input input-bordered font-mono"
                            placeholder="owner/repo (e.g., anthropics/claude-code)"
                            :required="form.source_type === 'mcp:github'"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Format: owner/repository-name</span
                            >
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Branch (optional)</span>
                        </label>
                        <input
                            type="text"
                            x-model="form.github_branch"
                            class="input input-bordered font-mono"
                            placeholder="main (defaults to repository default branch)"
                        />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Path Filter (optional)</span
                            >
                        </label>
                        <input
                            type="text"
                            x-model="form.github_path"
                            class="input input-bordered font-mono"
                            placeholder="e.g., docs/ or src/**/*.md"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Only index files matching this path
                                pattern</span
                            >
                        </label>
                    </div>
                    <div class="alert alert-info">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="stroke-current shrink-0 h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        <div class="text-sm">
                            Authentication via
                            <code class="font-mono">GITHUB_TOKEN</code>
                            environment variable.
                        </div>
                    </div>
                </div>

                <!-- Website Configuration -->
                <div
                    class="mt-4 space-y-4"
                    x-show="form.source_type === 'website'"
                >
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Website URL</span>
                        </label>
                        <input
                            type="url"
                            x-model="form.website_url"
                            class="input input-bordered font-mono"
                            placeholder="https://docs.example.com"
                            :required="form.source_type === 'website'"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Starting URL for the crawler</span
                            >
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Crawl Depth</span>
                            </label>
                            <input
                                type="number"
                                x-model.number="form.website_crawl_depth"
                                class="input input-bordered"
                                min="0"
                                max="5"
                            />
                            <label class="label">
                                <span class="label-text-alt"
                                    >0 = start page only, 1 = follow links
                                    once</span
                                >
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Max Pages</span>
                            </label>
                            <input
                                type="number"
                                x-model.number="form.website_max_pages"
                                class="input input-bordered"
                                min="1"
                                max="500"
                            />
                            <label class="label">
                                <span class="label-text-alt"
                                    >Maximum pages to crawl</span
                                >
                            </label>
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Include Pattern (optional)</span
                            >
                        </label>
                        <input
                            type="text"
                            x-model="form.website_include_pattern"
                            class="input input-bordered font-mono"
                            placeholder="e.g., /docs/.*"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Regex pattern - only crawl URLs matching
                                this</span
                            >
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >Exclude Pattern (optional)</span
                            >
                        </label>
                        <input
                            type="text"
                            x-model="form.website_exclude_pattern"
                            class="input input-bordered font-mono"
                            placeholder="e.g., /blog/.*|/archive/.*"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Regex pattern - skip URLs matching this</span
                            >
                        </label>
                    </div>
                    <div class="alert alert-info">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="stroke-current shrink-0 h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        <div class="text-sm">
                            Crawls the website using trafilatura for content
                            extraction. Only follows links within the same
                            domain.
                        </div>
                    </div>
                </div>

                <!-- Google OAuth Configuration (for mcp:gdrive, mcp:gmail, mcp:gcalendar) -->
                <div
                    x-show="['mcp:gdrive', 'mcp:gmail', 'mcp:gcalendar'].includes(form.source_type)"
                    class="mt-4"
                >
                    <!-- No OAuth configured -->
                    <template x-if="!googleOAuth.configured">
                        <div class="alert alert-warning">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="stroke-current shrink-0 h-6 w-6"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                                />
                            </svg>
                            <div>
                                <h3 class="font-bold">
                                    Google OAuth Not Configured
                                </h3>
                                <div class="text-sm">
                                    Set GOOGLE_CLIENT_ID and
                                    GOOGLE_CLIENT_SECRET environment variables.
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- OAuth configured but no accounts connected -->
                    <template
                        x-if="googleOAuth.configured && googleOAuth.accounts.length === 0"
                    >
                        <div class="alert alert-info">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="stroke-current shrink-0 h-6 w-6"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                />
                            </svg>
                            <div>
                                <h3 class="font-bold">
                                    Connect Google Account
                                </h3>
                                <div class="text-sm">
                                    Authorize access to Google Drive to index
                                    documents.
                                </div>
                            </div>
                            <button
                                type="button"
                                @click="startGoogleOAuth()"
                                class="btn btn-sm btn-primary"
                            >
                                Connect Google Account
                            </button>
                        </div>
                    </template>

                    <!-- OAuth configured with accounts - show selector -->
                    <template
                        x-if="googleOAuth.configured && googleOAuth.accounts.length > 0"
                    >
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Google Account</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.google_account_id"
                                        @change="onGoogleAccountChange()"
                                        class="select select-bordered flex-1"
                                        :required="['mcp:gdrive', 'mcp:gmail', 'mcp:gcalendar'].includes(form.source_type)"
                                    >
                                        <option value="">
                                            Select an account...
                                        </option>
                                        <template
                                            x-for="account in googleOAuth.accounts"
                                            :key="account.id"
                                        >
                                            <option
                                                :value="account.id"
                                                x-text="account.account_email + (account.account_name ? ' (' + account.account_name + ')' : '')"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="startGoogleOAuth()"
                                        class="btn btn-ghost btn-sm"
                                        title="Connect another account"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M12 4v16m8-8H4"
                                            />
                                        </svg>
                                    </button>
                                    <button
                                        type="button"
                                        @click="deleteGoogleAccount()"
                                        class="btn btn-ghost btn-sm text-error"
                                        title="Delete selected account"
                                        :disabled="!form.google_account_id"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                            />
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Folder Selection (Google Drive only) -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:gdrive' && form.google_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Folder (optional)</span
                                    >
                                </label>

                                <!-- Selected folder display -->
                                <div
                                    class="flex items-center gap-2 mb-2"
                                    x-show="form.gdrive_folder_id"
                                >
                                    <span class="badge badge-primary gap-1">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                            />
                                        </svg>
                                        <span
                                            x-text="form.gdrive_folder_name || 'Selected folder'"
                                        ></span>
                                    </span>
                                    <button
                                        type="button"
                                        @click="clearFolderSelection()"
                                        class="btn btn-ghost btn-xs"
                                        title="Clear selection"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12"
                                            />
                                        </svg>
                                    </button>
                                </div>

                                <!-- Breadcrumb navigation -->
                                <div
                                    class="text-sm flex items-center gap-1 mb-2 flex-wrap"
                                    x-show="folderBreadcrumbs.length > 0"
                                >
                                    <a
                                        href="#"
                                        @click.prevent="navigateToFolder('', 'My Drive')"
                                        class="link link-hover"
                                    >
                                        My Drive
                                    </a>
                                    <template
                                        x-for="(crumb, index) in folderBreadcrumbs"
                                        :key="crumb.id"
                                    >
                                        <span class="flex items-center gap-1">
                                            <span class="text-base-content/50"
                                                >&gt;</span
                                            >
                                            <a
                                                href="#"
                                                @click.prevent="navigateToBreadcrumb(index)"
                                                class="link link-hover"
                                                x-text="crumb.name"
                                            ></a>
                                        </span>
                                    </template>
                                </div>

                                <!-- Folder list -->
                                <div
                                    class="border rounded-lg max-h-48 overflow-y-auto bg-base-200"
                                >
                                    <div
                                        x-show="loadingFolders"
                                        class="flex justify-center py-4"
                                    >
                                        <span
                                            class="loading loading-spinner loading-sm"
                                        ></span>
                                    </div>
                                    <ul
                                        x-show="!loadingFolders"
                                        class="menu menu-sm p-1"
                                    >
                                        <!-- "Select this folder" option when inside a subfolder -->
                                        <li
                                            x-show="folderBreadcrumbs.length > 0"
                                        >
                                            <a
                                                href="#"
                                                @click.prevent="selectCurrentFolder()"
                                                class="text-primary font-medium"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-4 w-4"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M5 13l4 4L19 7"
                                                    />
                                                </svg>
                                                Select this folder
                                            </a>
                                        </li>
                                        <!-- "All files" option at root level -->
                                        <li
                                            x-show="folderBreadcrumbs.length === 0"
                                        >
                                            <a
                                                href="#"
                                                @click.prevent="selectFolder('', 'All files (no filter)')"
                                                class="text-base-content/70"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-4 w-4"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 6h16M4 10h16M4 14h16M4 18h16"
                                                    />
                                                </svg>
                                                All files (no folder filter)
                                            </a>
                                        </li>
                                        <!-- Folder items -->
                                        <template
                                            x-for="folder in gdriveFolders"
                                            :key="folder.id"
                                        >
                                            <li>
                                                <a
                                                    href="#"
                                                    @click.prevent="navigateToFolder(folder.id, folder.name)"
                                                    class="flex justify-between"
                                                >
                                                    <span
                                                        class="flex items-center gap-2"
                                                    >
                                                        <svg
                                                            xmlns="http://www.w3.org/2000/svg"
                                                            class="h-4 w-4 text-warning"
                                                            fill="none"
                                                            viewBox="0 0 24 24"
                                                            stroke="currentColor"
                                                        >
                                                            <path
                                                                stroke-linecap="round"
                                                                stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                                                            />
                                                        </svg>
                                                        <span
                                                            x-text="folder.name"
                                                        ></span>
                                                    </span>
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        class="h-4 w-4 text-base-content/50"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M9 5l7 7-7 7"
                                                        />
                                                    </svg>
                                                </a>
                                            </li>
                                        </template>
                                        <!-- No folders message -->
                                        <li
                                            x-show="gdriveFolders.length === 0 && !loadingFolders"
                                        >
                                            <span
                                                class="text-base-content/50 italic"
                                                >No subfolders</span
                                            >
                                        </li>
                                    </ul>
                                </div>

                                <label class="label">
                                    <span class="label-text-alt"
                                        >Navigate to select a folder, or leave
                                        empty for all files</span
                                    >
                                </label>
                            </div>

                            <!-- Gmail Label Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:gmail' && form.google_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Label (optional)</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.gmail_label_id"
                                        @change="onLabelChange()"
                                        class="select select-bordered flex-1"
                                        :disabled="loadingLabels"
                                    >
                                        <option value="">
                                            All emails (no label filter)
                                        </option>
                                        <template
                                            x-for="label in gmailLabels"
                                            :key="label.id"
                                        >
                                            <option
                                                :value="label.id"
                                                x-text="label.name"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="loadGmailLabels()"
                                        class="btn btn-ghost btn-sm"
                                        :class="{ 'loading': loadingLabels }"
                                        :disabled="loadingLabels || !form.google_account_id"
                                        title="Refresh labels"
                                    >
                                        <svg
                                            x-show="!loadingLabels"
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Limit indexing to emails with this
                                        label (e.g., INBOX, SENT, or custom
                                        labels)</span
                                    >
                                </label>
                            </div>

                            <!-- Google Calendar Selection -->
                            <div
                                class="form-control"
                                x-show="form.source_type === 'mcp:gcalendar' && form.google_account_id"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Calendar (optional)</span
                                    >
                                </label>
                                <div class="flex gap-2">
                                    <select
                                        x-model="form.gcalendar_calendar_id"
                                        @change="onCalendarChange()"
                                        class="select select-bordered flex-1"
                                        :disabled="loadingCalendars"
                                    >
                                        <option value="">
                                            Primary calendar only
                                        </option>
                                        <template
                                            x-for="cal in googleCalendars"
                                            :key="cal.id"
                                        >
                                            <option
                                                :value="cal.id"
                                                x-text="cal.name"
                                            ></option>
                                        </template>
                                    </select>
                                    <button
                                        type="button"
                                        @click="loadGoogleCalendars()"
                                        class="btn btn-ghost btn-sm"
                                        :class="{ 'loading': loadingCalendars }"
                                        :disabled="loadingCalendars || !form.google_account_id"
                                        title="Refresh calendars"
                                    >
                                        <svg
                                            x-show="!loadingCalendars"
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                            />
                                        </svg>
                                    </button>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Select a specific calendar to index, or
                                        leave empty for primary calendar</span
                                    >
                                </label>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- MCP Server Configuration (for mcp sources) -->
                <div
                    x-show="form.source_type.startsWith('mcp:') && !['mcp:gdrive', 'mcp:gmail', 'mcp:gcalendar'].includes(form.source_type)"
                    class="mt-4 space-y-4"
                >
                    <!-- Custom MCP Server fields (only shown for mcp:custom) -->
                    <template x-if="form.source_type === 'mcp:custom'">
                        <div class="space-y-4">
                            <!-- MCP Server Name -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Server Name</span>
                                </label>
                                <input
                                    type="text"
                                    x-model="form.mcp_name"
                                    class="input input-bordered"
                                    placeholder="e.g., my-mcp-server"
                                    required
                                />
                            </div>

                            <!-- MCP Transport Type -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Transport</span>
                                </label>
                                <select
                                    x-model="form.mcp_transport"
                                    class="select select-bordered"
                                >
                                    <option value="stdio">
                                        Stdio (subprocess)
                                    </option>
                                    <option value="http">HTTP</option>
                                </select>
                            </div>

                            <!-- Stdio Configuration -->
                            <template x-if="form.mcp_transport === 'stdio'">
                                <div class="space-y-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text"
                                                >Command</span
                                            >
                                        </label>
                                        <input
                                            type="text"
                                            x-model="form.mcp_command"
                                            class="input input-bordered font-mono"
                                            placeholder="e.g., npx, uvx, python"
                                        />
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text"
                                                >Arguments</span
                                            >
                                        </label>
                                        <input
                                            type="text"
                                            x-model="form.mcp_args"
                                            class="input input-bordered font-mono"
                                            placeholder="e.g., -y @modelcontextprotocol/server-gdrive"
                                        />
                                        <label class="label">
                                            <span class="label-text-alt"
                                                >Space-separated arguments</span
                                            >
                                        </label>
                                    </div>
                                </div>
                            </template>

                            <!-- HTTP Configuration -->
                            <template x-if="form.mcp_transport === 'http'">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text"
                                            >MCP Server URL</span
                                        >
                                    </label>
                                    <input
                                        type="text"
                                        x-model="form.mcp_url"
                                        class="input input-bordered font-mono"
                                        placeholder="e.g., http://localhost:8000/mcp"
                                    />
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- URI Patterns (optional - shown for all MCP sources) -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text"
                                >URI Patterns (optional)</span
                            >
                        </label>
                        <input
                            type="text"
                            x-model="form.mcp_uri_patterns"
                            class="input input-bordered font-mono"
                            placeholder="e.g., file://**/*.pdf, gdrive://**/*"
                        />
                        <label class="label">
                            <span class="label-text-alt"
                                >Comma-separated glob patterns to filter
                                resources</span
                            >
                        </label>
                    </div>
                </div>

                <!-- Embedding & Vision Settings Note -->
                <div
                    class="mt-4 text-sm text-base-content/60 bg-base-200 rounded-lg p-3"
                >
                    <span class="font-medium">Embedding & Vision Models:</span>
                    Embedding provider and vision model for document parsing are
                    configured in
                    <a href="/settings" class="link link-primary"
                        >Global Settings</a
                    >.
                </div>

                <!-- Index Schedule -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Index Schedule</span>
                    </label>
                    <select
                        x-model="form.index_schedule"
                        class="select select-bordered"
                    >
                        <option value="">Manual only</option>
                        <option value="0 * * * *">Every hour</option>
                        <option value="0 */6 * * *">Every 6 hours</option>
                        <option value="0 2 * * *">Daily at 2 AM</option>
                        <option value="0 2 * * 0">
                            Weekly on Sunday at 2 AM
                        </option>
                        <option value="custom">Custom cron...</option>
                    </select>
                </div>
                <div
                    class="form-control mt-2"
                    x-show="form.index_schedule === 'custom'"
                >
                    <input
                        type="text"
                        x-model="form.custom_schedule"
                        class="input input-bordered font-mono"
                        placeholder="0 2 * * * (minute hour day month day_of_week)"
                    />
                </div>

                <!-- Description -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Description</span>
                    </label>
                    <textarea
                        x-model="form.description"
                        class="textarea textarea-bordered"
                        rows="2"
                        placeholder="Optional description of this document store"
                    ></textarea>
                </div>

                <!-- Advanced Settings (collapsed) -->
                <div class="collapse collapse-arrow bg-base-200 mt-4">
                    <input type="checkbox" />
                    <div class="collapse-title text-sm font-medium">
                        Advanced Settings
                    </div>
                    <div class="collapse-content">
                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Chunk Size</span>
                                </label>
                                <input
                                    type="number"
                                    x-model="form.chunk_size"
                                    class="input input-bordered input-sm"
                                    min="100"
                                    max="2000"
                                />
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Tokens per chunk (default: 512)</span
                                    >
                                </label>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Chunk Overlap</span
                                    >
                                </label>
                                <input
                                    type="number"
                                    x-model="form.chunk_overlap"
                                    class="input input-bordered input-sm"
                                    min="0"
                                    max="500"
                                />
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Overlap between chunks (default:
                                        50)</span
                                    >
                                </label>
                            </div>
                            <!-- Max Documents (hidden for website sources - use max_pages instead) -->
                            <div
                                class="form-control"
                                x-show="form.source_type !== 'website'"
                            >
                                <label class="label">
                                    <span class="label-text"
                                        >Max Documents</span
                                    >
                                </label>
                                <input
                                    type="number"
                                    x-model="form.max_documents"
                                    class="input input-bordered input-sm"
                                    min="0"
                                    placeholder="No limit"
                                />
                                <label class="label">
                                    <span class="label-text-alt"
                                        >Maximum documents to index (0 or empty
                                        = no limit)</span
                                    >
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enabled Toggle -->
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input
                            type="checkbox"
                            x-model="form.enabled"
                            class="toggle toggle-primary"
                        />
                        <span class="label-text">Enabled</span>
                    </label>
                </div>

                <!-- Form Actions -->
                <div class="modal-action">
                    <button
                        type="button"
                        @click="closeModal()"
                        class="btn btn-ghost"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        class="btn btn-primary"
                        :class="{ 'loading': saving }"
                        :disabled="saving"
                    >
                        <span
                            x-text="editingStore ? 'Save Changes' : 'Create Store'"
                        ></span>
                    </button>
                </div>
            </form>
        </div>
        <div class="modal-backdrop" @click="closeModal()"></div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" :class="{ 'modal-open': showDeleteModal }">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Delete Document Store</h3>
            <p class="py-4">
                Are you sure you want to delete
                <span
                    class="font-mono font-bold"
                    x-text="deleteTarget?.name"
                ></span
                >? This will also delete the ChromaDB collection with all
                indexed chunks.
            </p>
            <div class="modal-action">
                <button @click="showDeleteModal = false" class="btn btn-ghost">
                    Cancel
                </button>
                <button
                    @click="deleteStore()"
                    class="btn btn-error"
                    :class="{ 'loading': deleting }"
                    :disabled="deleting"
                >
                    Delete
                </button>
            </div>
        </div>
        <div class="modal-backdrop" @click="showDeleteModal = false"></div>
    </div>
</div>

<script>
    function documentStoresPage() {
        return {
            loading: true,
            stores: [],
            allStores: [], // Unfiltered stores
            filterMode:
                new URLSearchParams(window.location.search).get("filter") ||
                null,
            expandedRows: [],
            showModal: false,
            showDeleteModal: false,
            editingStore: null,
            deleteTarget: null,
            saving: false,
            deleting: false,
            indexingStores: [],
            cancellingStores: [],
            clearingStores: [],
            refreshingIntelligence: null,
            formErrors: {},

            // MCP integration availability status
            documentSources: {},
            mcpStatus: {
                google: { available: false },
                notion: { available: false },
                github: { available: false },
                slack: { available: false },
                postgres: { available: true },
                custom: { available: true },
            },

            // Google OAuth status
            googleOAuth: {
                configured: false,
                accounts: [],
            },

            // Google Drive folders
            gdriveFolders: [],
            loadingFolders: false,
            folderBreadcrumbs: [], // [{id, name}, ...] for navigation path
            currentFolderId: "", // Current folder being browsed

            // Gmail labels
            gmailLabels: [],
            loadingLabels: false,

            // Google calendars
            googleCalendars: [],
            loadingCalendars: false,

            // Notion databases
            notionDatabases: [],
            loadingNotionDatabases: false,
            notionError: null,

            // Local folder browser
            showLocalFolderBrowser: false,
            localFolders: [],
            loadingLocalFolders: false,
            localFolderBreadcrumbs: [],
            currentLocalPath: "/",

            // Nextcloud folder browser
            showNextcloudFolderBrowser: false,
            nextcloudFolders: [],
            loadingNextcloudFolders: false,
            nextcloudFolderBreadcrumbs: [],
            currentNextcloudPath: "/",

            // Paperless tags
            paperlessTags: [],
            loadingPaperlessTags: false,

            form: {
                name: "",
                source_type: "local",
                source_path: "",
                paperless_url: "",
                paperless_token: "",
                paperless_tag_id: "",
                paperless_tag_name: "",
                github_repo: "",
                github_branch: "",
                github_path: "",
                notion_database_id: "",
                notion_page_id: "",
                nextcloud_folder: "",
                website_url: "",
                website_crawl_depth: 1,
                website_max_pages: 50,
                website_include_pattern: "",
                website_exclude_pattern: "",
                mcp_name: "",
                mcp_transport: "stdio",
                mcp_command: "",
                mcp_args: "",
                mcp_url: "",
                mcp_uri_patterns: "",
                google_account_id: "",
                gdrive_folder_id: "",
                gdrive_folder_name: "",
                gmail_label_id: "",
                gmail_label_name: "",
                gcalendar_calendar_id: "",
                gcalendar_calendar_name: "",
                index_schedule: "",
                custom_schedule: "",
                chunk_size: 512,
                chunk_overlap: 50,
                max_documents: null,
                description: "",
                enabled: true,
            },

            // MCP presets
            mcpPresets: {
                gdrive: {
                    name: "gdrive",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-gdrive",
                },
                gmail: {
                    name: "gmail",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-gsuite",
                },
                gcalendar: {
                    name: "gcalendar",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-gsuite",
                },
                notion: {
                    name: "notion",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @notionhq/notion-mcp-server",
                    discovery_tool: "API-post-search",
                    discovery_args: {
                        filter: { property: "object", value: "page" },
                    },
                    content_tool: "API-get-block-children",
                    content_id_field: "block_id",
                },
                github: {
                    name: "github",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-github",
                },
                slack: {
                    name: "slack",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-slack",
                },
                postgres: {
                    name: "postgres",
                    transport: "stdio",
                    command: "npx",
                    args: "-y @anthropic/mcp-postgres",
                },
            },

            async init() {
                await Promise.all([
                    this.loadStores(),
                    this.loadMcpStatus(),
                    this.loadGoogleOAuthStatus(),
                    this.loadDocumentSources(),
                ]);
                // Poll for status updates
                setInterval(() => this.loadStores(), 5000);
            },

            async loadGoogleOAuthStatus() {
                try {
                    const response = await fetch("/api/oauth/google/status");
                    if (response.ok) {
                        this.googleOAuth = await response.json();
                    }
                } catch (error) {
                    console.error("Failed to load Google OAuth status:", error);
                }
            },

            async startGoogleOAuth() {
                try {
                    // Map source type to OAuth scope
                    const scopeMap = {
                        "mcp:gdrive": "drive",
                        "mcp:gmail": "gmail",
                        "mcp:gcalendar": "calendar",
                    };
                    const scope = scopeMap[this.form.source_type] || "drive";
                    const response = await fetch(
                        `/api/oauth/google/start?scope=${scope}&redirect_uri=/document-stores`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        window.location.href = data.auth_url;
                    } else {
                        const error = await response.json();
                        alert(error.error || "Failed to start OAuth");
                    }
                } catch (error) {
                    console.error("Failed to start Google OAuth:", error);
                    alert("Failed to start Google OAuth");
                }
            },

            async deleteGoogleAccount() {
                if (!this.form.google_account_id) return;

                const account = this.googleOAuth.accounts.find(
                    (a) => a.id == this.form.google_account_id,
                );
                const accountName = account
                    ? account.account_email
                    : "this account";

                if (
                    !confirm(
                        `Are you sure you want to delete ${accountName}? Any document stores using this account will need to be reconfigured.`,
                    )
                ) {
                    return;
                }

                try {
                    const response = await fetch(
                        `/api/oauth/accounts/${this.form.google_account_id}`,
                        { method: "DELETE" },
                    );
                    if (response.ok) {
                        // Refresh accounts list
                        await this.loadGoogleOAuthStatus();
                        this.form.google_account_id = "";
                        this.gdriveFolders = [];
                        this.form.gdrive_folder_id = "";
                        this.form.gdrive_folder_name = "";
                    } else {
                        const error = await response.json();
                        alert(error.error || "Failed to delete account");
                    }
                } catch (error) {
                    console.error("Failed to delete account:", error);
                    alert("Failed to delete account");
                }
            },

            async onGoogleAccountChange() {
                // Clear folder/label selection when account changes
                this.form.gdrive_folder_id = "";
                this.form.gdrive_folder_name = "";
                this.gdriveFolders = [];
                this.folderBreadcrumbs = [];
                this.currentFolderId = "";
                this.form.gmail_label_id = "";
                this.form.gmail_label_name = "";
                this.gmailLabels = [];
                this.form.gcalendar_calendar_id = "";
                this.form.gcalendar_calendar_name = "";
                this.googleCalendars = [];

                // Auto-load folders for Google Drive
                if (
                    this.form.source_type === "mcp:gdrive" &&
                    this.form.google_account_id
                ) {
                    await this.loadGdriveFolders();
                }

                // Auto-load labels for Gmail
                if (
                    this.form.source_type === "mcp:gmail" &&
                    this.form.google_account_id
                ) {
                    await this.loadGmailLabels();
                }

                // Auto-load calendars for Google Calendar
                if (
                    this.form.source_type === "mcp:gcalendar" &&
                    this.form.google_account_id
                ) {
                    await this.loadGoogleCalendars();
                }
            },

            async loadGdriveFolders(parentId = "") {
                if (!this.form.google_account_id) return;

                this.loadingFolders = true;
                this.currentFolderId = parentId;
                try {
                    let url = `/api/oauth/google/${this.form.google_account_id}/folders`;
                    if (parentId) {
                        url += `?parent=${encodeURIComponent(parentId)}`;
                    }
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        this.gdriveFolders = data.folders || [];
                    } else {
                        const error = await response.json();
                        console.error("Failed to load folders:", error);
                    }
                } catch (error) {
                    console.error("Failed to load folders:", error);
                } finally {
                    this.loadingFolders = false;
                }
            },

            navigateToFolder(folderId, folderName) {
                // If going to root, clear breadcrumbs
                if (!folderId) {
                    this.folderBreadcrumbs = [];
                } else {
                    // Add to breadcrumbs
                    this.folderBreadcrumbs.push({
                        id: folderId,
                        name: folderName,
                    });
                }
                // Load subfolders
                this.loadGdriveFolders(folderId);
            },

            navigateToBreadcrumb(index) {
                // Navigate to a specific breadcrumb level
                const crumb = this.folderBreadcrumbs[index];
                // Truncate breadcrumbs to this level
                this.folderBreadcrumbs = this.folderBreadcrumbs.slice(
                    0,
                    index + 1,
                );
                // Load that folder's contents
                this.loadGdriveFolders(crumb.id);
            },

            selectFolder(folderId, folderName) {
                this.form.gdrive_folder_id = folderId;
                this.form.gdrive_folder_name = folderName;
            },

            selectCurrentFolder() {
                // Select the current folder we're browsing (last breadcrumb)
                if (this.folderBreadcrumbs.length > 0) {
                    const current =
                        this.folderBreadcrumbs[
                            this.folderBreadcrumbs.length - 1
                        ];
                    this.form.gdrive_folder_id = current.id;
                    this.form.gdrive_folder_name = current.name;
                }
            },

            clearFolderSelection() {
                this.form.gdrive_folder_id = "";
                this.form.gdrive_folder_name = "";
            },

            // Local folder browser functions
            toggleLocalFolderBrowser() {
                this.showLocalFolderBrowser = !this.showLocalFolderBrowser;
                if (this.showLocalFolderBrowser) {
                    this.loadLocalFolders("/");
                }
            },

            async loadLocalFolders(path) {
                this.loadingLocalFolders = true;
                try {
                    const response = await fetch(
                        `/api/local-folders?path=${encodeURIComponent(path)}`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.localFolders = data.folders || [];
                        this.localFolderBreadcrumbs = data.breadcrumbs || [];
                        this.currentLocalPath = data.current_path || "/data";
                    } else {
                        const error = await response.json();
                        console.error("Failed to load folders:", error.error);
                    }
                } catch (error) {
                    console.error("Failed to load local folders:", error);
                } finally {
                    this.loadingLocalFolders = false;
                }
            },

            navigateLocalFolder(path) {
                this.loadLocalFolders(path);
            },

            selectLocalFolder(path) {
                this.form.source_path = path;
                this.showLocalFolderBrowser = false;
            },

            // Nextcloud folder browser functions
            toggleNextcloudFolderBrowser() {
                this.showNextcloudFolderBrowser =
                    !this.showNextcloudFolderBrowser;
                if (this.showNextcloudFolderBrowser) {
                    this.loadNextcloudFolders("/");
                }
            },

            async loadNextcloudFolders(path) {
                this.loadingNextcloudFolders = true;
                try {
                    const response = await fetch(
                        `/api/nextcloud-folders?path=${encodeURIComponent(path)}`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.nextcloudFolders = data.folders || [];
                        this.nextcloudFolderBreadcrumbs =
                            data.breadcrumbs || [];
                        this.currentNextcloudPath = data.current_path || "/";
                    } else {
                        const error = await response.json();
                        console.error(
                            "Failed to load Nextcloud folders:",
                            error.error,
                        );
                    }
                } catch (error) {
                    console.error("Failed to load Nextcloud folders:", error);
                } finally {
                    this.loadingNextcloudFolders = false;
                }
            },

            navigateNextcloudFolder(path) {
                this.loadNextcloudFolders(path);
            },

            selectNextcloudFolder(path) {
                this.form.nextcloud_folder = path === "/" ? "" : path;
                this.showNextcloudFolderBrowser = false;
            },

            // Paperless tag functions
            async loadPaperlessTags() {
                this.loadingPaperlessTags = true;
                try {
                    const response = await fetch("/api/paperless-tags");
                    if (response.ok) {
                        const data = await response.json();
                        this.paperlessTags = data.tags || [];
                    } else {
                        const error = await response.json();
                        console.error(
                            "Failed to load Paperless tags:",
                            error.error,
                        );
                    }
                } catch (error) {
                    console.error("Failed to load Paperless tags:", error);
                } finally {
                    this.loadingPaperlessTags = false;
                }
            },

            onPaperlessTagChange() {
                // Update tag name when tag is selected
                const tag = this.paperlessTags.find(
                    (t) => t.id == this.form.paperless_tag_id,
                );
                this.form.paperless_tag_name = tag ? tag.name : "";
            },

            onFolderChange() {
                // Update folder name when folder is selected
                const folder = this.gdriveFolders.find(
                    (f) => f.id === this.form.gdrive_folder_id,
                );
                this.form.gdrive_folder_name = folder ? folder.name : "";
            },

            async loadGmailLabels() {
                if (!this.form.google_account_id) return;

                this.loadingLabels = true;
                try {
                    const response = await fetch(
                        `/api/oauth/google/${this.form.google_account_id}/labels`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.gmailLabels = data.labels || [];
                    }
                } catch (error) {
                    console.error("Failed to load Gmail labels:", error);
                } finally {
                    this.loadingLabels = false;
                }
            },

            onLabelChange() {
                // Update label name when label is selected
                const label = this.gmailLabels.find(
                    (l) => l.id === this.form.gmail_label_id,
                );
                this.form.gmail_label_name = label ? label.name : "";
            },

            async loadGoogleCalendars() {
                if (!this.form.google_account_id) return;

                this.loadingCalendars = true;
                try {
                    const response = await fetch(
                        `/api/oauth/google/${this.form.google_account_id}/calendars`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.googleCalendars = data.calendars || [];
                    }
                } catch (error) {
                    console.error("Failed to load Google calendars:", error);
                } finally {
                    this.loadingCalendars = false;
                }
            },

            onCalendarChange() {
                // Update calendar name when calendar is selected
                const cal = this.googleCalendars.find(
                    (c) => c.id === this.form.gcalendar_calendar_id,
                );
                this.form.gcalendar_calendar_name = cal ? cal.name : "";
            },

            async loadNotionDatabases() {
                this.loadingNotionDatabases = true;
                this.notionError = null;
                try {
                    const response = await fetch("/api/notion/databases");
                    if (response.ok) {
                        const data = await response.json();
                        this.notionDatabases = data.databases || [];
                    } else {
                        const error = await response.json();
                        this.notionError =
                            error.error || "Failed to load databases";
                    }
                } catch (error) {
                    console.error("Failed to load Notion databases:", error);
                    this.notionError = "Failed to connect to Notion API";
                } finally {
                    this.loadingNotionDatabases = false;
                }
            },

            // Source display helpers for the table
            getSourceBadgeClass(store) {
                if (store.source_type === "local") return "badge-ghost";
                if (store.source_type === "website") return "badge-info";
                if (store.source_type === "paperless") return "badge-success";
                if (store.source_type === "nextcloud") return "badge-info";
                if (store.source_type === "notion") return "badge-warning";
                if (store.source_type === "mcp:gdrive") return "badge-primary";
                if (store.source_type === "mcp:gmail") return "badge-secondary";
                if (store.source_type === "mcp:gcalendar")
                    return "badge-accent";
                if (store.source_type === "mcp:notion") return "badge-warning";
                if (store.source_type === "mcp:github") return "badge-neutral";
                if (store.source_type === "mcp:slack") return "badge-error";
                if (
                    store.source_type === "mcp" ||
                    store.source_type?.startsWith("mcp:")
                )
                    return "badge-info";
                return "badge-ghost";
            },

            getSourceBadgeText(store) {
                if (store.source_type === "local") return "Local";
                if (store.source_type === "website") return "Website";
                if (store.source_type === "paperless") return "Paperless";
                if (store.source_type === "nextcloud") return "Nextcloud";
                if (store.source_type === "notion") return "Notion";
                if (store.source_type === "mcp:gdrive") return "Drive";
                if (store.source_type === "mcp:gmail") return "Gmail";
                if (store.source_type === "mcp:gcalendar") return "Calendar";
                if (store.source_type === "mcp:notion") return "Notion";
                if (store.source_type === "mcp:github") return "GitHub";
                if (store.source_type === "mcp:slack") return "Slack";
                if (
                    store.source_type === "mcp" ||
                    store.source_type?.startsWith("mcp:")
                )
                    return "MCP";
                return "Local";
            },

            getSourceDetail(store) {
                if (store.source_type === "local")
                    return store.source_path || "";
                if (store.source_type === "website")
                    return store.website_url || "";
                if (store.source_type === "paperless")
                    return store.paperless_url || "";
                if (store.source_type === "nextcloud")
                    return store.nextcloud_folder || "All files";
                if (store.source_type === "notion") {
                    if (store.notion_database_id)
                        return `Database: ${store.notion_database_id.substring(0, 8)}...`;
                    if (store.notion_page_id)
                        return `Page: ${store.notion_page_id.substring(0, 8)}...`;
                    return "All accessible pages";
                }
                if (store.source_type === "mcp:github") {
                    let detail = store.github_repo || "";
                    if (store.github_branch)
                        detail += `:${store.github_branch}`;
                    if (store.github_path) detail += ` (${store.github_path})`;
                    return detail;
                }
                const acct = store.google_account_email || "";
                if (store.source_type === "mcp:gdrive") {
                    const folder = store.gdrive_folder_name || "All files";
                    return acct ? `${acct}: ${folder}` : folder;
                }
                if (store.source_type === "mcp:gmail") {
                    const label = store.gmail_label_name || "All emails";
                    return acct ? `${acct}: ${label}` : label;
                }
                if (store.source_type === "mcp:gcalendar") {
                    const cal = store.gcalendar_calendar_name || "Primary";
                    return acct ? `${acct}: ${cal}` : cal;
                }
                if (store.source_type === "mcp")
                    return store.mcp_server_config?.name || "Unknown";
                return "";
            },

            getSourceDetailShort(store) {
                // For local paths, show just the last 2 path segments
                if (store.source_type === "local" && store.source_path) {
                    const parts = store.source_path.split("/").filter((p) => p);
                    if (parts.length > 2) {
                        return ".../" + parts.slice(-2).join("/");
                    }
                    return store.source_path;
                }
                // For other sources, use the full detail (they're usually short)
                return this.getSourceDetail(store);
            },

            async loadMcpStatus() {
                try {
                    const response = await fetch(
                        "/api/mcp-integrations/status",
                    );
                    if (response.ok) {
                        this.mcpStatus = await response.json();
                    }
                } catch (error) {
                    console.error("Failed to load MCP status:", error);
                }
            },

            async loadDocumentSources() {
                try {
                    const response = await fetch("/api/feature-status");
                    if (response.ok) {
                        const data = await response.json();
                        this.documentSources =
                            data.dependencies?.document_sources || {};
                    }
                } catch (error) {
                    console.error("Failed to load document sources:", error);
                }
            },

            async loadStores() {
                try {
                    const response = await fetch("/api/document-stores");
                    if (response.ok) {
                        this.allStores = await response.json();
                        // Apply filter based on mode
                        if (this.filterMode === "website") {
                            // Websites page: show only websites
                            this.stores = this.allStores.filter(
                                (s) => s.source_type === "website",
                            );
                        } else {
                            // Document Stores page: exclude websites (they have their own nav item)
                            this.stores = this.allStores.filter(
                                (s) => s.source_type !== "website",
                            );
                        }
                    }
                } catch (error) {
                    console.error("Failed to load stores:", error);
                } finally {
                    this.loading = false;
                }
            },

            toggleExpand(id) {
                const idx = this.expandedRows.indexOf(id);
                if (idx >= 0) {
                    this.expandedRows.splice(idx, 1);
                } else {
                    this.expandedRows.push(id);
                }
            },

            getMcpPresetKey() {
                if (!this.form.source_type.startsWith("mcp:")) return null;
                const key = this.form.source_type.replace("mcp:", "");
                return key !== "custom" && this.mcpPresets[key] ? key : null;
            },

            onSourceTypeChange() {
                const presetKey = this.getMcpPresetKey();
                if (presetKey && this.mcpPresets[presetKey]) {
                    const preset = this.mcpPresets[presetKey];
                    this.form.mcp_name = preset.name;
                    this.form.mcp_transport = preset.transport;
                    this.form.mcp_command = preset.command;
                    this.form.mcp_args = preset.args;
                } else if (this.form.source_type === "mcp:custom") {
                    this.form.mcp_name = "";
                    this.form.mcp_transport = "stdio";
                    this.form.mcp_command = "";
                    this.form.mcp_args = "";
                }
            },

            openAddModal() {
                this.editingStore = null;
                this.gdriveFolders = [];
                this.folderBreadcrumbs = [];
                this.currentFolderId = "";
                this.gmailLabels = [];
                this.googleCalendars = [];
                this.form = {
                    name: "",
                    source_type:
                        this.filterMode === "website" ? "website" : "local",
                    source_path: "",
                    paperless_url: "",
                    paperless_token: "",
                    github_repo: "",
                    github_branch: "",
                    github_path: "",
                    mcp_name: "",
                    mcp_transport: "stdio",
                    mcp_command: "",
                    mcp_args: "",
                    mcp_url: "",
                    mcp_uri_patterns: "",
                    google_account_id: "",
                    gdrive_folder_id: "",
                    gdrive_folder_name: "",
                    gmail_label_id: "",
                    gmail_label_name: "",
                    gcalendar_calendar_id: "",
                    gcalendar_calendar_name: "",
                    index_schedule: "",
                    custom_schedule: "",
                    chunk_size: 512,
                    chunk_overlap: 50,
                    max_documents: null,
                    description: "",
                    enabled: true,
                };
                this.formErrors = {};
                this.showModal = true;
            },

            async openEditModal(store) {
                this.editingStore = store;
                this.gdriveFolders = [];
                this.folderBreadcrumbs = [];
                this.currentFolderId = "";
                this.gmailLabels = [];
                this.googleCalendars = [];

                // Determine source type
                let sourceType = store.source_type;
                if (sourceType === "mcp" && store.mcp_server_config) {
                    const mcpName = store.mcp_server_config.name;
                    // Check if it matches a preset
                    for (const [key, preset] of Object.entries(
                        this.mcpPresets,
                    )) {
                        if (preset.name === mcpName) {
                            sourceType = `mcp:${key}`;
                            break;
                        }
                    }
                    if (sourceType === "mcp") {
                        sourceType = "mcp:custom";
                    }
                }

                this.form = {
                    name: store.name,
                    source_type: sourceType,
                    source_path: store.source_path || "",
                    paperless_url: store.paperless_url || "",
                    paperless_token: store.paperless_token || "",
                    paperless_tag_id: store.paperless_tag_id || "",
                    paperless_tag_name: store.paperless_tag_name || "",
                    github_repo: store.github_repo || "",
                    github_branch: store.github_branch || "",
                    github_path: store.github_path || "",
                    notion_database_id: store.notion_database_id || "",
                    notion_page_id: store.notion_page_id || "",
                    nextcloud_folder: store.nextcloud_folder || "",
                    website_url: store.website_url || "",
                    website_crawl_depth: store.website_crawl_depth || 1,
                    website_max_pages: store.website_max_pages || 50,
                    website_include_pattern:
                        store.website_include_pattern || "",
                    website_exclude_pattern:
                        store.website_exclude_pattern || "",
                    mcp_name: store.mcp_server_config?.name || "",
                    mcp_transport:
                        store.mcp_server_config?.transport || "stdio",
                    mcp_command: store.mcp_server_config?.command || "",
                    mcp_args: (store.mcp_server_config?.args || []).join(" "),
                    mcp_url: store.mcp_server_config?.url || "",
                    mcp_uri_patterns: (
                        store.mcp_server_config?.uri_patterns || []
                    ).join(", "),
                    google_account_id: store.google_account_id || "",
                    gdrive_folder_id: store.gdrive_folder_id || "",
                    gdrive_folder_name: store.gdrive_folder_name || "",
                    gmail_label_id: store.gmail_label_id || "",
                    gmail_label_name: store.gmail_label_name || "",
                    gcalendar_calendar_id: store.gcalendar_calendar_id || "",
                    gcalendar_calendar_name:
                        store.gcalendar_calendar_name || "",
                    index_schedule: store.index_schedule || "",
                    custom_schedule: "",
                    chunk_size: store.chunk_size || 512,
                    chunk_overlap: store.chunk_overlap || 50,
                    max_documents: store.max_documents || null,
                    description: store.description || "",
                    enabled: store.enabled,
                };

                // Load folders/labels/calendars if editing a Google source with an account
                // Save the selected values before loading options (async load can reset them)
                const savedLabelId = this.form.gmail_label_id;
                const savedCalendarId = this.form.gcalendar_calendar_id;
                const savedFolderId = this.form.gdrive_folder_id;

                if (sourceType === "mcp:gdrive" && store.google_account_id) {
                    await this.loadGdriveFolders();
                }
                if (sourceType === "mcp:gmail" && store.google_account_id) {
                    await this.loadGmailLabels();
                }
                if (sourceType === "mcp:gcalendar" && store.google_account_id) {
                    await this.loadGoogleCalendars();
                }

                // Restore selections after a tick to ensure options are rendered
                this.$nextTick(() => {
                    this.form.gdrive_folder_id = savedFolderId;
                    this.form.gmail_label_id = savedLabelId;
                    this.form.gcalendar_calendar_id = savedCalendarId;
                });

                this.formErrors = {};
                this.showModal = true;
            },

            closeModal() {
                this.showModal = false;
                this.editingStore = null;
            },

            async saveStore() {
                this.formErrors = {};
                this.saving = true;

                try {
                    // Build request body
                    const body = {
                        name: this.form.name,
                        enabled: this.form.enabled,
                        chunk_size: parseInt(this.form.chunk_size),
                        chunk_overlap: parseInt(this.form.chunk_overlap),
                        max_documents: this.form.max_documents
                            ? parseInt(this.form.max_documents)
                            : null,
                        description: this.form.description || null,
                        index_schedule:
                            this.form.index_schedule === "custom"
                                ? this.form.custom_schedule
                                : this.form.index_schedule || null,
                    };

                    if (this.form.source_type === "local") {
                        body.source_type = "local";
                        body.source_path = this.form.source_path;
                    } else if (this.form.source_type === "paperless") {
                        body.source_type = "paperless";
                        body.paperless_tag_id = this.form.paperless_tag_id
                            ? parseInt(this.form.paperless_tag_id)
                            : null;
                        body.paperless_tag_name =
                            this.form.paperless_tag_name || null;
                        // Credentials come from PAPERLESS_URL and PAPERLESS_TOKEN env vars
                    } else if (this.form.source_type === "nextcloud") {
                        body.source_type = "nextcloud";
                        body.nextcloud_folder =
                            this.form.nextcloud_folder || null;
                        // Credentials come from NEXTCLOUD_URL, NEXTCLOUD_USER, NEXTCLOUD_PASSWORD env vars
                    } else if (this.form.source_type === "notion") {
                        body.source_type = "notion";
                        body.notion_database_id =
                            this.form.notion_database_id || null;
                        body.notion_page_id = this.form.notion_page_id || null;
                    } else if (this.form.source_type === "mcp:github") {
                        body.source_type = "mcp:github";
                        body.github_repo = this.form.github_repo;
                        body.github_branch = this.form.github_branch || null;
                        body.github_path = this.form.github_path || null;
                    } else if (this.form.source_type === "website") {
                        body.source_type = "website";
                        body.website_url = this.form.website_url;
                        body.website_crawl_depth =
                            parseInt(this.form.website_crawl_depth) || 1;
                        body.website_max_pages =
                            parseInt(this.form.website_max_pages) || 50;
                        body.website_include_pattern =
                            this.form.website_include_pattern || null;
                        body.website_exclude_pattern =
                            this.form.website_exclude_pattern || null;
                    } else if (
                        ["mcp:gdrive", "mcp:gmail", "mcp:gcalendar"].includes(
                            this.form.source_type,
                        )
                    ) {
                        // Google sources - use specific source type and OAuth account
                        body.source_type = this.form.source_type;
                        body.google_account_id = this.form.google_account_id
                            ? parseInt(this.form.google_account_id)
                            : null;
                        // Include folder filter for Google Drive
                        if (this.form.source_type === "mcp:gdrive") {
                            body.gdrive_folder_id =
                                this.form.gdrive_folder_id || null;
                            body.gdrive_folder_name =
                                this.form.gdrive_folder_name || null;
                        }
                        // Include label filter for Gmail
                        if (this.form.source_type === "mcp:gmail") {
                            body.gmail_label_id =
                                this.form.gmail_label_id || null;
                            body.gmail_label_name =
                                this.form.gmail_label_name || null;
                        }
                        // Include calendar filter for Google Calendar
                        if (this.form.source_type === "mcp:gcalendar") {
                            body.gcalendar_calendar_id =
                                this.form.gcalendar_calendar_id || null;
                            body.gcalendar_calendar_name =
                                this.form.gcalendar_calendar_name || null;
                        }
                    } else if (this.form.source_type.startsWith("mcp:")) {
                        // Other MCP sources - use generic mcp type with config
                        body.source_type = "mcp";
                        body.mcp_server_config = {
                            name: this.form.mcp_name,
                            transport: this.form.mcp_transport,
                        };
                        if (this.form.mcp_transport === "stdio") {
                            body.mcp_server_config.command =
                                this.form.mcp_command;
                            body.mcp_server_config.args = this.form.mcp_args
                                .split(/\s+/)
                                .filter(Boolean);
                        } else {
                            body.mcp_server_config.url = this.form.mcp_url;
                        }
                        if (this.form.mcp_uri_patterns) {
                            body.mcp_server_config.uri_patterns =
                                this.form.mcp_uri_patterns
                                    .split(",")
                                    .map((p) => p.trim())
                                    .filter(Boolean);
                        }
                        // Add discovery tool config from preset if available
                        const presetKey = this.getMcpPresetKey();
                        if (presetKey && this.mcpPresets[presetKey]) {
                            const preset = this.mcpPresets[presetKey];
                            if (preset.discovery_tool) {
                                body.mcp_server_config.discovery_tool =
                                    preset.discovery_tool;
                                body.mcp_server_config.discovery_args =
                                    preset.discovery_args || null;
                                body.mcp_server_config.content_tool =
                                    preset.content_tool || null;
                                body.mcp_server_config.content_id_field =
                                    preset.content_id_field || null;
                            }
                        }
                    }

                    const url = this.editingStore
                        ? `/api/document-stores/${this.editingStore.id}`
                        : "/api/document-stores";
                    const method = this.editingStore ? "PUT" : "POST";

                    const response = await fetch(url, {
                        method,
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        this.formErrors.general =
                            result.error || "Failed to save";
                        return;
                    }

                    this.closeModal();
                    await this.loadStores();
                } catch (error) {
                    console.error("Save error:", error);
                    this.formErrors.general = "Failed to save document store";
                } finally {
                    this.saving = false;
                }
            },

            confirmDelete(store) {
                if (store.rag_count > 0) {
                    alert(
                        `Cannot delete "${store.name}" - it is used by ${store.rag_count} RAG(s)`,
                    );
                    return;
                }
                this.deleteTarget = store;
                this.showDeleteModal = true;
            },

            async deleteStore() {
                if (!this.deleteTarget) return;
                this.deleting = true;

                try {
                    const response = await fetch(
                        `/api/document-stores/${this.deleteTarget.id}`,
                        { method: "DELETE" },
                    );

                    if (response.ok) {
                        this.showDeleteModal = false;
                        this.deleteTarget = null;
                        await this.loadStores();
                    } else {
                        const result = await response.json();
                        alert(result.error || "Failed to delete store");
                    }
                } catch (error) {
                    console.error("Delete error:", error);
                    alert("Failed to delete store");
                } finally {
                    this.deleting = false;
                }
            },

            async indexNow(store) {
                this.indexingStores.push(store.id);

                try {
                    const response = await fetch(
                        `/api/document-stores/${store.id}/index`,
                        { method: "POST" },
                    );

                    if (!response.ok) {
                        const result = await response.json();
                        alert(result.error || "Failed to start indexing");
                    }

                    await this.loadStores();
                } catch (error) {
                    console.error("Index error:", error);
                    alert("Failed to start indexing");
                } finally {
                    this.indexingStores = this.indexingStores.filter(
                        (id) => id !== store.id,
                    );
                }
            },

            async cancelIndex(store) {
                this.cancellingStores.push(store.id);

                try {
                    const response = await fetch(
                        `/api/document-stores/${store.id}/cancel-index`,
                        { method: "POST" },
                    );

                    if (!response.ok) {
                        const result = await response.json();
                        alert(result.error || "Failed to cancel indexing");
                    }

                    await this.loadStores();
                } catch (error) {
                    console.error("Cancel error:", error);
                    alert("Failed to cancel indexing");
                } finally {
                    this.cancellingStores = this.cancellingStores.filter(
                        (id) => id !== store.id,
                    );
                }
            },

            async clearContents(store) {
                if (
                    !confirm(
                        `Clear all indexed content from "${store.name}"? This cannot be undone.`,
                    )
                ) {
                    return;
                }

                this.clearingStores.push(store.id);

                try {
                    const response = await fetch(
                        `/api/document-stores/${store.id}/clear`,
                        { method: "POST" },
                    );

                    if (!response.ok) {
                        const result = await response.json();
                        alert(result.error || "Failed to clear contents");
                    }

                    await this.loadStores();
                } catch (error) {
                    console.error("Clear error:", error);
                    alert("Failed to clear contents");
                } finally {
                    this.clearingStores = this.clearingStores.filter(
                        (id) => id !== store.id,
                    );
                }
            },

            async refreshIntelligence(store) {
                this.refreshingIntelligence = store.id;

                try {
                    const response = await fetch(
                        `/api/document-stores/${store.id}/refresh-intelligence`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                        },
                    );

                    if (!response.ok) {
                        const result = await response.json();
                        alert(
                            result.error || "Failed to generate intelligence",
                        );
                    }

                    await this.loadStores();
                } catch (error) {
                    console.error("Intelligence refresh error:", error);
                    alert("Failed to generate intelligence");
                } finally {
                    this.refreshingIntelligence = null;
                }
            },
        };
    }
</script>
{% endblock %}
