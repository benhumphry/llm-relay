{% extends "base.html" %} {% block title %}Smart Caches{% endblock %} {% block
content %}
<div x-data="cachesPage()" x-init="init()">
    <!-- Header -->
    <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6"
    >
        <div>
            <h1 class="text-2xl font-bold">Smart Caches</h1>
            <p class="text-base-content/60">
                Cache LLM responses and return cached answers for semantically similar queries
            </p>
        </div>
        <button @click="openAddModal()" class="btn btn-primary btn-sm" :disabled="!chromaAvailable">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 mr-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                />
            </svg>
            Add Cache
        </button>
    </div>

    <!-- ChromaDB Status Alert -->
    <template x-if="!chromaAvailable && !loading">
        <div class="alert alert-warning mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
                <h3 class="font-bold">ChromaDB Not Available</h3>
                <div class="text-sm">
                    Smart Caches require ChromaDB for semantic similarity matching.
                    <template x-if="!chromaConfigured">
                        <span>Set the <code class="font-mono">CHROMA_URL</code> environment variable to enable.</span>
                    </template>
                    <template x-if="chromaConfigured && !chromaAvailable">
                        <span>ChromaDB is configured but not reachable at <code class="font-mono" x-text="chromaUrl"></code>.</span>
                    </template>
                </div>
            </div>
        </div>
    </template>

    <!-- Loading State -->
    <template x-if="loading">
        <div class="flex justify-center py-12">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    </template>

    <!-- No Caches Configured -->
    <template x-if="!loading && caches.length === 0 && chromaAvailable">
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center py-12">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-16 w-16 mx-auto text-base-content/30"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"
                    />
                </svg>
                <h3 class="mt-4 text-lg font-medium">
                    No Smart Caches Configured
                </h3>
                <p class="mt-2 text-base-content/60 max-w-md mx-auto">
                    Smart caches use ChromaDB to find semantically similar past queries
                    and return cached responses, reducing token usage and costs.
                </p>
                <button @click="openAddModal()" class="btn btn-primary mt-4">
                    Create Your First Cache
                </button>
            </div>
        </div>
    </template>

    <!-- Cache Table -->
    <template x-if="!loading && caches.length > 0">
        <div class="card bg-base-100 shadow-lg">
            <div class="overflow-x-auto">
                <table class="table table-fixed">
                    <thead>
                        <tr>
                            <th class="w-8"></th>
                            <th class="w-1/6">Name</th>
                            <th class="w-1/5">Target</th>
                            <th class="w-1/6">Tags</th>
                            <th class="w-20 text-right">Requests</th>
                            <th class="w-24 text-right">Hits</th>
                            <th class="w-20">Status</th>
                            <th class="w-28 text-right">Actions</th>
                        </tr>
                    </thead>
                    <template x-for="cache in caches" :key="cache.id">
                        <tbody>
                            <!-- Main Row -->
                            <tr
                                @click="toggleExpand(cache.id)"
                                class="cursor-pointer hover:bg-base-200"
                            >
                                <td class="w-8">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 transition-transform"
                                        :class="{'rotate-90': expandedRows.includes(cache.id)}"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 5l7 7-7 7"
                                        />
                                    </svg>
                                </td>
                                <td>
                                    <div class="font-mono font-medium" x-text="cache.name"></div>
                                </td>
                                <td>
                                    <div class="font-mono text-sm text-base-content/70" x-text="cache.target_model"></div>
                                </td>
                                <td>
                                    <template x-for="tag in (cache.tags || []).slice(0, 2)" :key="tag">
                                        <span class="badge badge-outline badge-xs mr-1" x-text="tag"></span>
                                    </template>
                                    <span
                                        x-show="(cache.tags || []).length > 2"
                                        class="text-xs text-base-content/50"
                                        x-text="'+' + ((cache.tags || []).length - 2)"
                                    ></span>
                                    <span
                                        x-show="!cache.tags || cache.tags.length === 0"
                                        class="text-base-content/40 text-sm"
                                    >-</span>
                                </td>
                                <td class="text-right">
                                    <span class="font-mono text-sm" x-text="cache.total_requests || 0"></span>
                                </td>
                                <td class="text-right">
                                    <span class="font-mono text-sm" x-text="cache.cache_hits || 0"></span>
                                    <span class="text-xs text-base-content/50" x-text="'(' + (cache.hit_rate || 0).toFixed(0) + '%)'"></span>
                                </td>
                                <td>
                                    <span
                                        class="badge badge-sm"
                                        :class="cache.enabled ? 'badge-success' : 'badge-ghost'"
                                        x-text="cache.enabled ? 'Enabled' : 'Disabled'"
                                    ></span>
                                </td>
                                <td class="text-right" @click.stop>
                                    <div class="flex justify-end gap-1">
                                        <button
                                            @click="openEditModal(cache)"
                                            class="btn btn-ghost btn-sm"
                                            title="Edit cache"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                                />
                                            </svg>
                                        </button>
                                        <button
                                            @click="confirmClear(cache)"
                                            class="btn btn-ghost btn-sm text-warning"
                                            title="Clear cache"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                                />
                                            </svg>
                                        </button>
                                        <button
                                            @click="confirmDelete(cache)"
                                            class="btn btn-ghost btn-sm text-error"
                                            title="Delete cache"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Expanded Details Row -->
                            <tr x-show="expandedRows.includes(cache.id)" x-transition>
                                <td colspan="8" class="bg-base-200 p-0">
                                    <div class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                        <!-- Description -->
                                        <div x-show="cache.description">
                                            <div class="text-xs text-base-content/50 uppercase mb-1">Description</div>
                                            <div class="text-sm" x-text="cache.description"></div>
                                        </div>
                                        <!-- Target Model -->
                                        <div>
                                            <div class="text-xs text-base-content/50 uppercase mb-1">Target Model</div>
                                            <div class="font-mono text-xs" x-text="cache.target_model"></div>
                                        </div>
                                        <!-- Similarity Threshold -->
                                        <div>
                                            <div class="text-xs text-base-content/50 uppercase mb-1">Similarity</div>
                                            <div class="text-sm" x-text="(cache.similarity_threshold * 100).toFixed(0) + '%'"></div>
                                        </div>
                                        <!-- TTL -->
                                        <div>
                                            <div class="text-xs text-base-content/50 uppercase mb-1">TTL</div>
                                            <div class="text-sm" x-text="cache.cache_ttl_hours + ' hours'"></div>
                                        </div>
                                        <!-- Token Limits -->
                                        <div>
                                            <div class="text-xs text-base-content/50 uppercase mb-1">Token Limits</div>
                                            <div class="text-xs">
                                                Min: <span class="font-mono" x-text="cache.min_cached_tokens"></span>,
                                                Max: <span class="font-mono" x-text="cache.max_cached_tokens"></span>
                                            </div>
                                        </div>
                                        <!-- Match Options -->
                                        <div>
                                            <div class="text-xs text-base-content/50 uppercase mb-1">Match Options</div>
                                            <div class="flex flex-wrap gap-1">
                                                <span x-show="cache.match_last_message_only" class="badge badge-ghost badge-xs">Last msg only</span>
                                                <span x-show="cache.match_system_prompt" class="badge badge-ghost badge-xs">Include system</span>
                                                <span x-show="!cache.match_last_message_only && !cache.match_system_prompt" class="text-base-content/40">Default</span>
                                            </div>
                                        </div>
                                        <!-- All Tags -->
                                        <div x-show="cache.tags && cache.tags.length > 0">
                                            <div class="text-xs text-base-content/50 uppercase mb-1">All Tags</div>
                                            <div class="flex flex-wrap gap-1">
                                                <template x-for="tag in cache.tags" :key="tag">
                                                    <span class="badge badge-primary badge-sm" x-text="tag"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <!-- Stats -->
                                        <div>
                                            <div class="text-xs text-base-content/50 uppercase mb-1">Statistics</div>
                                            <div class="text-xs space-y-1">
                                                <div>Tokens saved: <span class="font-mono" x-text="(cache.tokens_saved || 0).toLocaleString()"></span></div>
                                                <div>Cost saved: <span class="font-mono" x-text="'$' + (cache.cost_saved || 0).toFixed(4)"></span></div>
                                                <div>Entries: <span class="font-mono" x-text="cache.entry_count || 0"></span></div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </template>
                </table>
            </div>
        </div>
    </template>

    <!-- Add/Edit Modal -->
    <div class="modal" :class="{ 'modal-open': showModal }">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg" x-text="editingCache ? 'Edit Cache' : 'Add Cache'"></h3>
            <form @submit.prevent="saveCache()">
                <!-- Name -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Cache Name</span>
                    </label>
                    <input
                        type="text"
                        x-model="form.name"
                        class="input input-bordered font-mono"
                        :class="{ 'input-error': formErrors.name }"
                        placeholder="e.g., cache-gpt4, fast-cache"
                        required
                        :disabled="editingCache"
                    />
                    <label class="label" x-show="formErrors.name">
                        <span class="label-text-alt text-error" x-text="formErrors.name"></span>
                    </label>
                </div>

                <!-- Target Model -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Target Model</span>
                    </label>
                    <select
                        x-model="form.target_model"
                        class="select select-bordered"
                        required
                    >
                        <option value="">Select a model...</option>
                        <template x-for="model in availableModels" :key="model.id">
                            <option :value="model.id" x-text="`${model.id} (${model.family})`"></option>
                        </template>
                    </select>
                    <label class="label">
                        <span class="label-text-alt">Model to use for cache misses</span>
                    </label>
                </div>

                <!-- Similarity Threshold -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Similarity Threshold</span>
                        <span class="label-text-alt" x-text="(form.similarity_threshold * 100).toFixed(0) + '%'"></span>
                    </label>
                    <input
                        type="range"
                        x-model="form.similarity_threshold"
                        min="0.5"
                        max="1.0"
                        step="0.01"
                        class="range range-primary"
                    />
                    <label class="label">
                        <span class="label-text-alt">Higher = stricter matching (0.95 recommended)</span>
                    </label>
                </div>

                <!-- Cache TTL -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Cache TTL (hours)</span>
                    </label>
                    <input
                        type="number"
                        x-model="form.cache_ttl_hours"
                        class="input input-bordered"
                        min="1"
                        max="8760"
                    />
                </div>

                <!-- Token Limits -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Min Tokens</span>
                        </label>
                        <input
                            type="number"
                            x-model="form.min_cached_tokens"
                            class="input input-bordered"
                            min="0"
                        />
                        <label class="label">
                            <span class="label-text-alt">Skip short responses</span>
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Max Tokens</span>
                        </label>
                        <input
                            type="number"
                            x-model="form.max_cached_tokens"
                            class="input input-bordered"
                            min="0"
                        />
                        <label class="label">
                            <span class="label-text-alt">Skip very long responses</span>
                        </label>
                    </div>
                </div>

                <!-- Match Options -->
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input
                            type="checkbox"
                            x-model="form.match_last_message_only"
                            class="toggle toggle-sm"
                        />
                        <div>
                            <span class="label-text">Match last message only</span>
                            <div class="text-xs text-base-content/50">Useful for OpenWebUI where context varies</div>
                        </div>
                    </label>
                </div>

                <div class="form-control mt-2">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input
                            type="checkbox"
                            x-model="form.match_system_prompt"
                            class="toggle toggle-sm"
                        />
                        <div>
                            <span class="label-text">Include system prompt in match</span>
                            <div class="text-xs text-base-content/50">Different system prompts = different cache entries</div>
                        </div>
                    </label>
                </div>

                <!-- Tags -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Tags (optional)</span>
                    </label>
                    <input
                        type="text"
                        x-model="form.tagsInput"
                        class="input input-bordered"
                        placeholder="e.g., production, team-a"
                    />
                    <label class="label">
                        <span class="label-text-alt">Comma-separated tags for usage tracking</span>
                    </label>
                </div>

                <!-- Description -->
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Description (optional)</span>
                    </label>
                    <textarea
                        x-model="form.description"
                        class="textarea textarea-bordered"
                        placeholder="What is this cache for?"
                        rows="2"
                    ></textarea>
                </div>

                <!-- Enabled -->
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input
                            type="checkbox"
                            x-model="form.enabled"
                            class="toggle toggle-primary"
                        />
                        <span class="label-text">Enabled</span>
                    </label>
                </div>

                <div class="modal-action">
                    <button type="button" @click="closeModal()" class="btn btn-ghost">
                        Cancel
                    </button>
                    <button
                        type="submit"
                        class="btn btn-primary"
                        :class="{ 'loading': saving }"
                        :disabled="saving"
                    >
                        <span x-text="editingCache ? 'Save Changes' : 'Create Cache'"></span>
                    </button>
                </div>
            </form>
        </div>
        <div class="modal-backdrop" @click="closeModal()"></div>
    </div>

    <!-- Clear Cache Confirmation Modal -->
    <div class="modal" :class="{ 'modal-open': showClearModal }">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Clear Cache</h3>
            <p class="py-4">
                Are you sure you want to clear all entries from
                <span class="font-mono font-bold" x-text="clearingCache?.name"></span>?
                This will reset hit statistics but keep the cache configuration.
            </p>
            <div class="modal-action">
                <button @click="showClearModal = false" class="btn btn-ghost">
                    Cancel
                </button>
                <button
                    @click="clearCache()"
                    class="btn btn-warning"
                    :class="{ 'loading': clearing }"
                    :disabled="clearing"
                >
                    Clear Cache
                </button>
            </div>
        </div>
        <div class="modal-backdrop" @click="showClearModal = false"></div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" :class="{ 'modal-open': showDeleteModal }">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Delete Cache</h3>
            <p class="py-4">
                Are you sure you want to delete the cache
                <span class="font-mono font-bold" x-text="deletingCache?.name"></span>?
                This will remove all cached entries and cannot be undone.
            </p>
            <div class="modal-action">
                <button @click="showDeleteModal = false" class="btn btn-ghost">
                    Cancel
                </button>
                <button
                    @click="deleteCache()"
                    class="btn btn-error"
                    :class="{ 'loading': deleting }"
                    :disabled="deleting"
                >
                    Delete
                </button>
            </div>
        </div>
        <div class="modal-backdrop" @click="showDeleteModal = false"></div>
    </div>
</div>

<script>
    function cachesPage() {
        return {
            loading: true,
            caches: [],
            availableModels: [],
            expandedRows: [],
            chromaAvailable: false,
            chromaConfigured: false,
            chromaUrl: '',
            showModal: false,
            showClearModal: false,
            showDeleteModal: false,
            editingCache: null,
            clearingCache: null,
            deletingCache: null,
            saving: false,
            clearing: false,
            deleting: false,
            form: {
                name: '',
                target_model: '',
                similarity_threshold: 0.95,
                cache_ttl_hours: 168,
                min_cached_tokens: 100,
                max_cached_tokens: 10000,
                match_last_message_only: false,
                match_system_prompt: false,
                tagsInput: '',
                description: '',
                enabled: true,
            },
            formErrors: {},

            async init() {
                await Promise.all([
                    this.checkChromaStatus(),
                    this.loadCaches(),
                    this.loadAvailableModels(),
                ]);
                this.loading = false;
            },

            async checkChromaStatus() {
                try {
                    const response = await fetch('/api/caches/chroma-status');
                    if (response.ok) {
                        const data = await response.json();
                        this.chromaAvailable = data.available;
                        this.chromaConfigured = data.configured;
                        this.chromaUrl = data.url || '';
                    }
                } catch (error) {
                    console.error('Failed to check ChromaDB status:', error);
                }
            },

            async loadCaches() {
                try {
                    const response = await fetch('/api/caches');
                    if (response.ok) {
                        this.caches = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to load caches:', error);
                }
            },

            async loadAvailableModels() {
                try {
                    const response = await fetch('/api/caches/models');
                    if (response.ok) {
                        this.availableModels = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to load available models:', error);
                }
            },

            toggleExpand(id) {
                const idx = this.expandedRows.indexOf(id);
                if (idx >= 0) {
                    this.expandedRows.splice(idx, 1);
                } else {
                    this.expandedRows.push(id);
                }
            },

            openAddModal() {
                this.editingCache = null;
                this.form = {
                    name: '',
                    target_model: '',
                    similarity_threshold: 0.95,
                    cache_ttl_hours: 168,
                    min_cached_tokens: 100,
                    max_cached_tokens: 10000,
                    match_last_message_only: false,
                    match_system_prompt: false,
                    tagsInput: '',
                    description: '',
                    enabled: true,
                };
                this.formErrors = {};
                this.showModal = true;
            },

            openEditModal(cache) {
                this.editingCache = cache;
                this.form = {
                    name: cache.name,
                    target_model: cache.target_model,
                    similarity_threshold: cache.similarity_threshold,
                    cache_ttl_hours: cache.cache_ttl_hours,
                    min_cached_tokens: cache.min_cached_tokens,
                    max_cached_tokens: cache.max_cached_tokens,
                    match_last_message_only: cache.match_last_message_only,
                    match_system_prompt: cache.match_system_prompt,
                    tagsInput: (cache.tags || []).join(', '),
                    description: cache.description || '',
                    enabled: cache.enabled,
                };
                this.formErrors = {};
                this.showModal = true;
            },

            closeModal() {
                this.showModal = false;
                this.editingCache = null;
                this.formErrors = {};
            },

            async saveCache() {
                this.formErrors = {};
                this.saving = true;

                const tags = this.form.tagsInput
                    .split(',')
                    .map(t => t.trim().toLowerCase())
                    .filter(t => t.length > 0);

                const payload = {
                    name: this.form.name.toLowerCase().trim(),
                    target_model: this.form.target_model,
                    similarity_threshold: parseFloat(this.form.similarity_threshold),
                    cache_ttl_hours: parseInt(this.form.cache_ttl_hours),
                    min_cached_tokens: parseInt(this.form.min_cached_tokens),
                    max_cached_tokens: parseInt(this.form.max_cached_tokens),
                    match_last_message_only: this.form.match_last_message_only,
                    match_system_prompt: this.form.match_system_prompt,
                    tags: tags,
                    description: this.form.description || null,
                    enabled: this.form.enabled,
                };

                try {
                    const url = this.editingCache
                        ? `/api/caches/${this.editingCache.id}`
                        : '/api/caches';
                    const method = this.editingCache ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        if (data.error && data.error.includes('name')) {
                            this.formErrors.name = data.error;
                        } else {
                            alert(data.error || 'Failed to save cache');
                        }
                        return;
                    }

                    await this.loadCaches();
                    this.closeModal();
                } catch (error) {
                    console.error('Failed to save cache:', error);
                    alert('Failed to save cache');
                } finally {
                    this.saving = false;
                }
            },

            confirmClear(cache) {
                this.clearingCache = cache;
                this.showClearModal = true;
            },

            async clearCache() {
                if (!this.clearingCache) return;

                this.clearing = true;
                try {
                    const response = await fetch(`/api/caches/${this.clearingCache.id}/clear`, {
                        method: 'POST',
                    });

                    if (response.ok) {
                        await this.loadCaches();
                        this.showClearModal = false;
                        this.clearingCache = null;
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to clear cache');
                    }
                } catch (error) {
                    console.error('Failed to clear cache:', error);
                    alert('Failed to clear cache');
                } finally {
                    this.clearing = false;
                }
            },

            confirmDelete(cache) {
                this.deletingCache = cache;
                this.showDeleteModal = true;
            },

            async deleteCache() {
                if (!this.deletingCache) return;

                this.deleting = true;
                try {
                    const response = await fetch(`/api/caches/${this.deletingCache.id}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        await this.loadCaches();
                        this.showDeleteModal = false;
                        this.deletingCache = null;
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to delete cache');
                    }
                } catch (error) {
                    console.error('Failed to delete cache:', error);
                    alert('Failed to delete cache');
                } finally {
                    this.deleting = false;
                }
            },
        };
    }
</script>
{% endblock %}
