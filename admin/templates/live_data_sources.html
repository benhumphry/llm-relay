{% extends "base.html" %} {% block title %}Live Data Sources{% endblock %} {%
block content %}
<div x-data="liveDataSourcesPage()" x-init="init()">
    <!-- Header -->
    <div class="flex justify-between items-start mb-6">
        <div>
            <h1 class="text-2xl font-bold">Live Data Sources</h1>
            <p class="text-base-content/60">
                Real-time API data sources for Smart Alias enrichment. Add
                custom APIs or use built-in integrations.
            </p>
        </div>
        <button @click="openCreateModal()" class="btn btn-primary btn-sm">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 mr-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                />
            </svg>
            Add Source
        </button>
    </div>

    <!-- Loading State -->
    <template x-if="loading">
        <div class="flex justify-center py-12">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    </template>

    <!-- No Sources Configured -->
    <template x-if="!loading && sources.length === 0">
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center py-12">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-16 w-16 mx-auto text-base-content/30"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"
                    />
                </svg>
                <h3 class="mt-4 text-lg font-medium">No Live Data Sources</h3>
                <p class="mt-2 text-base-content/60 max-w-lg mx-auto">
                    Add custom API sources or configure built-in integrations
                    via environment variables.
                </p>
                <div class="mt-6 text-left max-w-md mx-auto">
                    <h4 class="font-medium mb-2">
                        Built-in integrations (auto-configured):
                    </h4>
                    <ul class="text-sm text-base-content/70 space-y-2">
                        <li class="flex items-center gap-2">
                            <span class="badge badge-sm badge-outline"
                                >Stocks (US)</span
                            >
                            <code class="text-xs bg-base-200 px-1 rounded"
                                >FINNHUB_API_KEY</code
                            >
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="badge badge-sm badge-outline"
                                >Stocks (UK/Intl)</span
                            >
                            <code class="text-xs bg-base-200 px-1 rounded"
                                >ALPHA_VANTAGE_API_KEY</code
                            >
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="badge badge-sm badge-outline"
                                >Weather</span
                            >
                            <code class="text-xs bg-base-200 px-1 rounded"
                                >ACCUWEATHER_API_KEY</code
                            >
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="badge badge-sm badge-outline"
                                >Transport</span
                            >
                            <code class="text-xs bg-base-200 px-1 rounded"
                                >TRANSPORTAPI_APP_ID</code
                            >
                            +
                            <code class="text-xs bg-base-200 px-1 rounded"
                                >TRANSPORTAPI_APP_KEY</code
                            >
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="badge badge-sm badge-outline"
                                >Google Maps</span
                            >
                            <code class="text-xs bg-base-200 px-1 rounded"
                                >GOOGLE_MAPS_API_KEY</code
                            >
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="badge badge-sm badge-outline"
                                >RapidAPI (1000s)</span
                            >
                            <code class="text-xs bg-base-200 px-1 rounded"
                                >RAPIDAPI_KEY</code
                            >
                        </li>
                    </ul>
                </div>
                <button @click="openCreateModal()" class="btn btn-primary mt-6">
                    Add Live Data Source
                </button>
            </div>
        </div>
    </template>

    <!-- Sources Table -->
    <template x-if="!loading && sources.length > 0">
        <div class="card bg-base-100 shadow-lg">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="w-8"></th>
                            <th>Source</th>
                            <th>Data Type</th>
                            <th>API Calls</th>
                            <th>Status</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <template x-for="source in sources" :key="source.id">
                        <tbody>
                            <!-- Main Row -->
                            <tr
                                @click="toggleExpand(source.id)"
                                class="cursor-pointer hover:bg-base-200 transition-colors"
                                :data-source-id="source.id"
                            >
                                <td class="w-8">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 transition-transform"
                                        :class="{'rotate-90': expandedRows.includes(source.id)}"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 5l7 7-7 7"
                                        />
                                    </svg>
                                </td>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <span
                                            class="text-xl"
                                            x-text="getPluginIcon(source.source_type)"
                                        ></span>
                                        <div>
                                            <div
                                                class="font-medium"
                                                x-text="getDisplayName(source)"
                                            ></div>
                                            <div
                                                class="text-xs text-base-content/50"
                                                x-text="source.description || getTypeLabel(source.source_type)"
                                            ></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span
                                        class="text-sm"
                                        x-text="source.data_type || '-'"
                                    ></span>
                                </td>
                                <td>
                                    <template x-if="source.total_calls > 0">
                                        <div class="text-sm">
                                            <span
                                                x-text="source.total_calls.toLocaleString()"
                                            ></span>
                                            <span
                                                class="text-xs text-base-content/50"
                                                x-text="'(' + Math.round(source.successful_calls / source.total_calls * 100) + '%)'"
                                            ></span>
                                        </div>
                                    </template>
                                    <template
                                        x-if="!source.total_calls || source.total_calls === 0"
                                    >
                                        <span
                                            class="text-xs text-base-content/40"
                                            >-</span
                                        >
                                    </template>
                                </td>
                                <td>
                                    <template x-if="source.last_success">
                                        <div class="flex items-center gap-1">
                                            <div
                                                class="w-2 h-2 rounded-full bg-success"
                                            ></div>
                                            <span
                                                class="text-xs text-base-content/60"
                                                x-text="source.tool_count ? source.tool_count + ' tools' : 'OK'"
                                            ></span>
                                        </div>
                                    </template>
                                    <template
                                        x-if="source.error_count > 0 && !source.last_success"
                                    >
                                        <div class="flex items-center gap-1">
                                            <div
                                                class="w-2 h-2 rounded-full bg-error"
                                            ></div>
                                            <span
                                                class="text-xs text-error"
                                                x-text="source.error_count + ' errors'"
                                            ></span>
                                        </div>
                                    </template>
                                    <template
                                        x-if="!source.last_success && source.error_count === 0"
                                    >
                                        <span
                                            class="text-xs text-base-content/40"
                                            >Not tested</span
                                        >
                                    </template>
                                </td>
                                <td class="text-right" @click.stop>
                                    <div class="flex justify-end gap-1">
                                        <button
                                            @click="testSource(source)"
                                            class="btn btn-ghost btn-xs"
                                            :class="{ 'loading': testingId === source.id }"
                                            :disabled="testingId === source.id"
                                            title="Test"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                                x-show="testingId !== source.id"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M13 10V3L4 14h7v7l9-11h-7z"
                                                />
                                            </svg>
                                        </button>
                                        <button
                                            @click="openEditModal(source)"
                                            class="btn btn-ghost btn-xs"
                                            title="Edit"
                                            x-show="!source.source_type.startsWith('builtin_')"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                                />
                                            </svg>
                                        </button>
                                        <button
                                            @click="deleteSource(source)"
                                            class="btn btn-ghost btn-xs text-error"
                                            title="Delete"
                                            x-show="!source.source_type.startsWith('builtin_')"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Expanded Details Row -->
                            <tr
                                x-show="expandedRows.includes(source.id)"
                                x-transition
                            >
                                <td colspan="7" class="bg-base-200 p-0">
                                    <div class="p-4">
                                        <!-- Description and Best For -->
                                        <div
                                            class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"
                                            x-show="source.description || source.best_for"
                                        >
                                            <div x-show="source.description">
                                                <div
                                                    class="text-xs text-base-content/50 uppercase mb-1"
                                                >
                                                    Description
                                                </div>
                                                <div
                                                    class="text-sm"
                                                    x-text="source.description"
                                                ></div>
                                            </div>
                                            <div x-show="source.best_for">
                                                <div
                                                    class="text-xs text-base-content/50 uppercase mb-1"
                                                >
                                                    Best For
                                                </div>
                                                <div
                                                    class="text-sm"
                                                    x-text="source.best_for"
                                                ></div>
                                            </div>
                                        </div>

                                        <!-- Endpoint/Tool Stats -->
                                        <template x-if="source.total_calls > 0">
                                            <div class="mt-4">
                                                <div
                                                    class="text-xs text-base-content/50 uppercase mb-2"
                                                >
                                                    Endpoint Statistics
                                                </div>
                                                <template
                                                    x-if="loadingEndpointStats[source.id]"
                                                >
                                                    <div
                                                        class="flex items-center gap-2 text-sm text-base-content/60"
                                                    >
                                                        <span
                                                            class="loading loading-spinner loading-xs"
                                                        ></span>
                                                        Loading stats...
                                                    </div>
                                                </template>
                                                <template
                                                    x-if="!loadingEndpointStats[source.id] && endpointStats[source.id] && endpointStats[source.id].length > 0"
                                                >
                                                    <div
                                                        class="overflow-x-auto"
                                                    >
                                                        <table
                                                            class="table table-xs"
                                                        >
                                                            <thead>
                                                                <tr
                                                                    class="text-xs"
                                                                >
                                                                    <th>
                                                                        Endpoint/Tool
                                                                    </th>
                                                                    <th
                                                                        class="text-right"
                                                                    >
                                                                        Calls
                                                                    </th>
                                                                    <th
                                                                        class="text-right"
                                                                    >
                                                                        Success
                                                                    </th>
                                                                    <th
                                                                        class="text-right"
                                                                    >
                                                                        Avg
                                                                        Latency
                                                                    </th>
                                                                    <th>
                                                                        Last
                                                                        Called
                                                                    </th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <template
                                                                    x-for="stat in endpointStats[source.id]"
                                                                    :key="stat.endpoint_name"
                                                                >
                                                                    <tr>
                                                                        <td
                                                                            class="font-mono text-xs"
                                                                            x-text="stat.endpoint_name"
                                                                        ></td>
                                                                        <td
                                                                            class="text-right"
                                                                            x-text="stat.total_calls"
                                                                        ></td>
                                                                        <td
                                                                            class="text-right"
                                                                        >
                                                                            <span
                                                                                :class="stat.total_calls > 0 && stat.successful_calls / stat.total_calls >= 0.9 ? 'text-success' : (stat.total_calls > 0 && stat.successful_calls / stat.total_calls < 0.5 ? 'text-error' : '')"
                                                                                x-text="stat.total_calls > 0 ? Math.round(stat.successful_calls / stat.total_calls * 100) + '%' : '-'"
                                                                            ></span>
                                                                        </td>
                                                                        <td
                                                                            class="text-right"
                                                                            x-text="stat.avg_latency_ms + 'ms'"
                                                                        ></td>
                                                                        <td
                                                                            class="text-xs text-base-content/60"
                                                                            x-text="stat.last_called ? new Date(stat.last_called).toLocaleString() : '-'"
                                                                        ></td>
                                                                    </tr>
                                                                </template>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </template>
                                                <template
                                                    x-if="!loadingEndpointStats[source.id] && (!endpointStats[source.id] || endpointStats[source.id].length === 0)"
                                                >
                                                    <div
                                                        class="text-sm text-base-content/50"
                                                    >
                                                        No endpoint statistics
                                                        recorded yet.
                                                    </div>
                                                </template>
                                            </div>
                                        </template>

                                        <!-- Last Success/Error Info -->
                                        <div
                                            class="flex gap-4 mt-4 pt-4 border-t border-base-300 text-xs text-base-content/50"
                                        >
                                            <div x-show="source.last_success">
                                                Last tested:
                                                <span
                                                    x-text="new Date(source.last_success).toLocaleString()"
                                                ></span>
                                            </div>
                                            <div
                                                x-show="source.last_error"
                                                class="text-error"
                                            >
                                                Last error:
                                                <span
                                                    x-text="source.last_error"
                                                ></span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </template>
                </table>
            </div>
        </div>
    </template>

    <!-- Create/Edit Modal -->
    <dialog
        id="editModal"
        class="modal"
        :class="{ 'modal-open': showEditModal }"
    >
        <div class="modal-box max-w-3xl">
            <h3
                class="font-bold text-lg mb-4"
                x-text="editingSource ? 'Edit Live Data Source' : 'Add Live Data Source'"
            ></h3>

            <form @submit.prevent="saveSource()">
                <!-- Source Type Selection - FIRST (Dynamic from plugins) -->
                <div class="form-control mb-4">
                    <label class="label"
                        ><span class="label-text">Source Type</span></label
                    >
                    <select
                        x-model="form.source_type"
                        class="select select-bordered"
                        @change="onSourceTypeChange()"
                    >
                        <!-- Dynamic plugin options grouped by category -->
                        <template
                            x-for="[category, categoryPlugins] in Object.entries(getPluginCategories())"
                            :key="category"
                        >
                            <optgroup :label="getCategoryLabel(category)">
                                <template
                                    x-for="plugin in categoryPlugins"
                                    :key="plugin.source_type"
                                >
                                    <option :value="plugin.source_type">
                                        <span x-text="plugin.icon"></span>
                                        <span
                                            x-text="plugin.display_name"
                                        ></span>
                                    </option>
                                </template>
                            </optgroup>
                        </template>
                    </select>
                    <label class="label"
                        ><span
                            class="label-text-alt"
                            x-text="getCurrentPlugin()?.description || 'Select a source type'"
                        ></span
                    ></label>
                </div>

                <!-- Dynamic Plugin Configuration -->
                <template
                    x-if="getCurrentPlugin() && getCurrentPlugin().fields && getCurrentPlugin().fields.length > 0"
                >
                    <div class="bg-base-200 rounded-lg p-4 mb-4">
                        <div
                            class="divider mt-0"
                            x-text="getCurrentPlugin().display_name + ' Configuration'"
                        ></div>

                        <!-- Plugin description -->
                        <template x-if="getCurrentPlugin().description">
                            <div class="alert alert-info mb-4">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                    />
                                </svg>
                                <span
                                    class="text-sm"
                                    x-text="getCurrentPlugin().description"
                                ></span>
                            </div>
                        </template>

                        <!-- Dynamic fields -->
                        <template
                            x-for="field in getCurrentPlugin().fields"
                            :key="field.name"
                        >
                            <div
                                class="form-control mb-4"
                                x-show="isFieldVisible(field)"
                            >
                                <!-- OAuth Account Field -->
                                <template
                                    x-if="field.field_type === 'oauth_account'"
                                >
                                    <div>
                                        <label class="label">
                                            <span
                                                class="label-text"
                                                x-text="field.label + (field.required ? ' *' : '')"
                                            ></span>
                                        </label>

                                        <!-- OAuth not configured -->
                                        <template
                                            x-if="!isOAuthConfigured(field.picker_options?.provider)"
                                        >
                                            <div
                                                class="alert alert-warning text-sm py-2"
                                            >
                                                <span
                                                    x-text="getOAuthNotConfiguredMessage(field.picker_options?.provider)"
                                                ></span>
                                            </div>
                                        </template>

                                        <!-- No accounts connected -->
                                        <template
                                            x-if="isOAuthConfigured(field.picker_options?.provider) && getOAuthAccounts(field.picker_options?.provider).length === 0"
                                        >
                                            <div>
                                                <div
                                                    class="alert alert-info mb-2 text-sm py-2"
                                                >
                                                    <span
                                                        x-text="'No ' + (field.picker_options?.provider || 'OAuth') + ' accounts connected yet.'"
                                                    ></span>
                                                </div>
                                                <button
                                                    type="button"
                                                    @click="connectOAuthProvider(field.picker_options?.provider)"
                                                    class="btn btn-sm btn-outline"
                                                    :disabled="oauthConnecting[field.picker_options?.provider]"
                                                >
                                                    <template
                                                        x-if="oauthConnecting[field.picker_options?.provider]"
                                                    >
                                                        <span
                                                            class="loading loading-spinner loading-sm"
                                                        ></span>
                                                    </template>
                                                    <span
                                                        x-text="'Connect ' + capitalizeFirst(field.picker_options?.provider || 'Account')"
                                                    ></span>
                                                </button>
                                            </div>
                                        </template>

                                        <!-- Account dropdown -->
                                        <template
                                            x-if="isOAuthConfigured(field.picker_options?.provider) && getOAuthAccounts(field.picker_options?.provider).length > 0"
                                        >
                                            <div>
                                                <select
                                                    x-model="pluginConfig[field.name]"
                                                    class="select select-bordered w-full"
                                                    :class="{'select-sm': !field.required}"
                                                    :required="field.required"
                                                >
                                                    <option value="">
                                                        <span
                                                            x-text="field.required ? 'Select an account...' : 'None (skip)'"
                                                        ></span>
                                                    </option>
                                                    <template
                                                        x-for="account in getOAuthAccounts(field.picker_options?.provider)"
                                                        :key="account.id"
                                                    >
                                                        <option
                                                            :value="account.id"
                                                            x-text="account.account_email + (account.account_name ? ' (' + account.account_name + ')' : '')"
                                                        ></option>
                                                    </template>
                                                </select>
                                                <label class="label py-1">
                                                    <span
                                                        class="label-text-alt"
                                                        x-text="field.help_text"
                                                    ></span>
                                                    <button
                                                        type="button"
                                                        @click="connectOAuthProvider(field.picker_options?.provider)"
                                                        class="link link-primary text-xs"
                                                    >
                                                        Connect another
                                                    </button>
                                                </label>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Text Field -->
                                <template x-if="field.field_type === 'text'">
                                    <div>
                                        <label class="label">
                                            <span
                                                class="label-text"
                                                x-text="field.label + (field.required ? ' *' : '')"
                                            ></span>
                                        </label>
                                        <input
                                            type="text"
                                            x-model="pluginConfig[field.name]"
                                            class="input input-bordered w-full"
                                            :placeholder="field.placeholder"
                                            :required="field.required"
                                        />
                                        <label
                                            class="label"
                                            x-show="field.help_text"
                                        >
                                            <span
                                                class="label-text-alt"
                                                x-text="field.help_text"
                                            ></span>
                                        </label>
                                    </div>
                                </template>

                                <!-- Password Field -->
                                <template
                                    x-if="field.field_type === 'password'"
                                >
                                    <div>
                                        <label class="label">
                                            <span
                                                class="label-text"
                                                x-text="field.label + (field.required ? ' *' : '')"
                                            ></span>
                                        </label>
                                        <input
                                            type="password"
                                            x-model="pluginConfig[field.name]"
                                            class="input input-bordered w-full"
                                            :placeholder="field.placeholder"
                                            :required="field.required"
                                        />
                                        <label
                                            class="label"
                                            x-show="field.help_text"
                                        >
                                            <span
                                                class="label-text-alt"
                                                x-text="field.help_text"
                                            ></span>
                                        </label>
                                    </div>
                                </template>

                                <!-- Integer Field -->
                                <template x-if="field.field_type === 'integer'">
                                    <div>
                                        <label class="label">
                                            <span
                                                class="label-text"
                                                x-text="field.label + (field.required ? ' *' : '')"
                                            ></span>
                                        </label>
                                        <input
                                            type="number"
                                            x-model.number="pluginConfig[field.name]"
                                            class="input input-bordered w-full"
                                            :placeholder="field.placeholder"
                                            :required="field.required"
                                            :min="field.min_value"
                                            :max="field.max_value"
                                        />
                                        <label
                                            class="label"
                                            x-show="field.help_text"
                                        >
                                            <span
                                                class="label-text-alt"
                                                x-text="field.help_text"
                                            ></span>
                                        </label>
                                    </div>
                                </template>

                                <!-- Number Field -->
                                <template x-if="field.field_type === 'number'">
                                    <div>
                                        <label class="label">
                                            <span
                                                class="label-text"
                                                x-text="field.label + (field.required ? ' *' : '')"
                                            ></span>
                                        </label>
                                        <input
                                            type="number"
                                            step="any"
                                            x-model.number="pluginConfig[field.name]"
                                            class="input input-bordered w-full"
                                            :placeholder="field.placeholder"
                                            :required="field.required"
                                            :min="field.min_value"
                                            :max="field.max_value"
                                        />
                                        <label
                                            class="label"
                                            x-show="field.help_text"
                                        >
                                            <span
                                                class="label-text-alt"
                                                x-text="field.help_text"
                                            ></span>
                                        </label>
                                    </div>
                                </template>

                                <!-- Boolean Field -->
                                <template x-if="field.field_type === 'boolean'">
                                    <div>
                                        <label
                                            class="label cursor-pointer justify-start gap-3"
                                        >
                                            <input
                                                type="checkbox"
                                                x-model="pluginConfig[field.name]"
                                                class="toggle toggle-primary"
                                            />
                                            <span
                                                class="label-text"
                                                x-text="field.label"
                                            ></span>
                                        </label>
                                        <label
                                            class="label py-0"
                                            x-show="field.help_text"
                                        >
                                            <span
                                                class="label-text-alt"
                                                x-text="field.help_text"
                                            ></span>
                                        </label>
                                    </div>
                                </template>

                                <!-- Select Field -->
                                <template x-if="field.field_type === 'select'">
                                    <div>
                                        <label class="label">
                                            <span
                                                class="label-text"
                                                x-text="field.label + (field.required ? ' *' : '')"
                                            ></span>
                                        </label>
                                        <select
                                            x-model="pluginConfig[field.name]"
                                            class="select select-bordered w-full"
                                            :required="field.required"
                                        >
                                            <option value="">Select...</option>
                                            <template
                                                x-for="opt in field.options"
                                                :key="opt.value"
                                            >
                                                <option
                                                    :value="opt.value"
                                                    x-text="opt.label"
                                                ></option>
                                            </template>
                                        </select>
                                        <label
                                            class="label"
                                            x-show="field.help_text"
                                        >
                                            <span
                                                class="label-text-alt"
                                                x-text="field.help_text"
                                            ></span>
                                        </label>
                                    </div>
                                </template>

                                <!-- Textarea Field -->
                                <template
                                    x-if="field.field_type === 'textarea'"
                                >
                                    <div>
                                        <label class="label">
                                            <span
                                                class="label-text"
                                                x-text="field.label + (field.required ? ' *' : '')"
                                            ></span>
                                        </label>
                                        <textarea
                                            x-model="pluginConfig[field.name]"
                                            class="textarea textarea-bordered w-full"
                                            :placeholder="field.placeholder"
                                            :required="field.required"
                                            rows="3"
                                        ></textarea>
                                        <label
                                            class="label"
                                            x-show="field.help_text"
                                        >
                                            <span
                                                class="label-text-alt"
                                                x-text="field.help_text"
                                            ></span>
                                        </label>
                                    </div>
                                </template>

                                <!-- JSON Field -->
                                <template x-if="field.field_type === 'json'">
                                    <div>
                                        <label class="label">
                                            <span
                                                class="label-text"
                                                x-text="field.label + (field.required ? ' *' : '')"
                                            ></span>
                                        </label>
                                        <textarea
                                            x-model="pluginConfig[field.name]"
                                            class="textarea textarea-bordered w-full font-mono text-sm"
                                            :placeholder="field.placeholder || '{}'"
                                            :required="field.required"
                                            rows="4"
                                        ></textarea>
                                        <label
                                            class="label"
                                            x-show="field.help_text"
                                        >
                                            <span
                                                class="label-text-alt"
                                                x-text="field.help_text"
                                            ></span>
                                        </label>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>

                <div class="modal-action">
                    <button
                        type="button"
                        @click="showEditModal = false"
                        class="btn btn-ghost"
                    >
                        Cancel
                    </button>
                    <button
                        type="button"
                        @click="testCurrentConfig()"
                        class="btn btn-outline"
                        :class="{ 'loading': testing }"
                        :disabled="testing"
                    >
                        Test
                    </button>
                    <button
                        type="submit"
                        class="btn btn-primary"
                        :disabled="saving"
                    >
                        <span
                            x-show="saving"
                            class="loading loading-spinner loading-sm"
                        ></span>
                        <span
                            x-text="editingSource ? 'Save Changes' : 'Create Source'"
                        ></span>
                    </button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button @click="showEditModal = false">close</button>
        </form>
    </dialog>

    <!-- Details Modal (read-only for built-in) -->
    <dialog
        id="detailsModal"
        class="modal"
        :class="{ 'modal-open': showDetailsModal }"
    >
        <div class="modal-box max-w-xl">
            <h3
                class="font-bold text-lg mb-4"
                x-text="selectedSource?.name + ' Details'"
            ></h3>

            <template x-if="selectedSource">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-base-content/50 uppercase">
                                Source Type
                            </div>
                            <div
                                class="font-medium"
                                x-text="getTypeLabel(selectedSource.source_type)"
                            ></div>
                        </div>
                        <div>
                            <div class="text-xs text-base-content/50 uppercase">
                                Data Type
                            </div>
                            <div
                                class="font-medium"
                                x-text="selectedSource.data_type || '-'"
                            ></div>
                        </div>
                    </div>

                    <div>
                        <div class="text-xs text-base-content/50 uppercase">
                            Description
                        </div>
                        <div
                            x-text="selectedSource.description || 'No description'"
                        ></div>
                    </div>

                    <div>
                        <div class="text-xs text-base-content/50 uppercase">
                            Best For
                        </div>
                        <div
                            x-text="selectedSource.best_for || 'Not specified'"
                        ></div>
                    </div>

                    <template x-if="selectedSource.endpoint_url">
                        <div>
                            <div class="text-xs text-base-content/50 uppercase">
                                Endpoint
                            </div>
                            <div
                                class="font-mono text-sm break-all"
                                x-text="selectedSource.endpoint_url"
                            ></div>
                        </div>
                    </template>

                    <div class="divider text-xs text-base-content/50">
                        Settings
                    </div>
                    <div class="grid grid-cols-4 gap-4 text-sm">
                        <div>
                            <div class="text-xs text-base-content/50">
                                Cache TTL
                            </div>
                            <div
                                x-text="selectedSource.cache_ttl_seconds + 's'"
                            ></div>
                        </div>
                        <div>
                            <div class="text-xs text-base-content/50">
                                Timeout
                            </div>
                            <div
                                x-text="selectedSource.timeout_seconds + 's'"
                            ></div>
                        </div>
                        <div>
                            <div class="text-xs text-base-content/50">
                                Retries
                            </div>
                            <div x-text="selectedSource.retry_count"></div>
                        </div>
                        <div>
                            <div class="text-xs text-base-content/50">
                                Rate Limit
                            </div>
                            <div
                                x-text="selectedSource.rate_limit_rpm + '/min'"
                            ></div>
                        </div>
                    </div>

                    <div class="divider text-xs text-base-content/50">
                        Status
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <div class="text-xs text-base-content/50">
                                Last Success
                            </div>
                            <div
                                x-text="selectedSource.last_success ? new Date(selectedSource.last_success).toLocaleString() : 'Never'"
                            ></div>
                        </div>
                        <div>
                            <div class="text-xs text-base-content/50">
                                Error Count
                            </div>
                            <div x-text="selectedSource.error_count || 0"></div>
                        </div>
                    </div>
                    <template x-if="selectedSource.last_error">
                        <div>
                            <div class="text-xs text-base-content/50">
                                Last Error
                            </div>
                            <div
                                class="text-error text-sm"
                                x-text="selectedSource.last_error"
                            ></div>
                        </div>
                    </template>
                </div>
            </template>

            <div class="modal-action">
                <button @click="showDetailsModal = false" class="btn btn-ghost">
                    Close
                </button>
                <button
                    @click="testSource(selectedSource); showDetailsModal = false;"
                    class="btn btn-primary btn-sm"
                >
                    Test Connection
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button @click="showDetailsModal = false">close</button>
        </form>
    </dialog>

    <!-- Test Result Toast -->
    <div x-show="testResult" x-transition class="toast toast-end">
        <div
            class="alert"
            :class="testResult?.success ? 'alert-success' : 'alert-error'"
        >
            <span x-text="testResult?.message"></span>
        </div>
    </div>
</div>

<script>
    function liveDataSourcesPage() {
        return {
            loading: true,
            sources: [],
            showEditModal: false,
            showDetailsModal: false,
            selectedSource: null,
            editingSource: null,
            testingId: null,
            testResult: null,
            testing: false,
            saving: false,
            expandedRows: [],
            endpointStats: {},
            loadingEndpointStats: {},
            configuredEnvVars: {}, // Which env vars are set (for hiding fields)
            form: {
                name: "",
                description: "",
                source_type: "",
                data_type: "general",
                best_for: "",
            },

            // Plugin system
            plugins: [],
            pluginsByType: {},
            oauthAccounts: {}, // Keyed by provider: {google: [], oura: [], withings: [], ...}
            oauthStatus: {}, // Keyed by provider: {google: {configured: true}, ...}
            oauthConnecting: {}, // Keyed by provider
            pluginConfig: {}, // Dynamic plugin field values

            async init() {
                await this.loadPlugins();
                await this.loadSources();
                await this.loadEnvVarStatus();
                await this.loadAllOAuthAccounts();
            },

            async loadPlugins() {
                try {
                    const response = await fetch("/api/plugins/live-sources");
                    if (response.ok) {
                        this.plugins = await response.json();
                        // Index by source_type for quick lookup
                        this.pluginsByType = {};
                        for (const plugin of this.plugins) {
                            this.pluginsByType[plugin.source_type] = plugin;
                        }
                        console.log(
                            `Loaded ${this.plugins.length} live source plugins`,
                        );
                    }
                } catch (error) {
                    console.error("Failed to load plugins:", error);
                }
            },

            async loadAllOAuthAccounts() {
                // Get unique OAuth providers from plugin fields
                const providers = new Set();
                for (const plugin of this.plugins) {
                    for (const field of plugin.fields || []) {
                        if (
                            field.field_type === "oauth_account" &&
                            field.picker_options?.provider
                        ) {
                            providers.add(field.picker_options.provider);
                        }
                    }
                }
                // Always include google for legacy sources
                providers.add("google");

                // Load accounts for each provider
                for (const provider of providers) {
                    await this.loadOAuthAccountsForProvider(provider);
                }
            },

            async loadOAuthAccountsForProvider(provider) {
                try {
                    const response = await fetch(
                        `/api/oauth/${provider}/status`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.oauthAccounts[provider] = data.accounts || [];
                        this.oauthStatus[provider] = {
                            configured: data.configured,
                        };
                    }
                } catch (error) {
                    console.error(
                        `Failed to load ${provider} accounts:`,
                        error,
                    );
                    this.oauthAccounts[provider] = [];
                    this.oauthStatus[provider] = { configured: false };
                }
            },

            async connectOAuthProvider(provider) {
                this.oauthConnecting[provider] = true;
                try {
                    const response = await fetch(
                        `/api/oauth/${provider}/start?redirect_uri=/live-data-sources`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        if (data.auth_url) {
                            window.location.href = data.auth_url;
                        }
                    } else {
                        const error = await response.json();
                        alert(
                            error.error || `Failed to start ${provider} OAuth`,
                        );
                    }
                } catch (error) {
                    console.error(`Failed to connect ${provider}:`, error);
                    alert(`Failed to connect ${provider}: ` + error.message);
                } finally {
                    this.oauthConnecting[provider] = false;
                }
            },

            getPluginCategories() {
                // Group plugins by category for dropdown
                const categories = {};
                for (const plugin of this.plugins) {
                    const cat = plugin.category || "other";
                    if (!categories[cat]) {
                        categories[cat] = [];
                    }
                    categories[cat].push(plugin);
                }
                return categories;
            },

            getCategoryLabel(category) {
                const labels = {
                    smart: "Smart Providers",
                    google: "Google (OAuth)",
                    health: "Health & Fitness",
                    weather: "Weather",
                    finance: "Finance",
                    transport: "Transport",
                    other: "Other Integrations",
                };
                return (
                    labels[category] ||
                    category.charAt(0).toUpperCase() + category.slice(1)
                );
            },

            getCurrentPlugin() {
                return this.pluginsByType[this.form.source_type] || null;
            },

            // Helper methods for dynamic plugin form
            isOAuthConfigured(provider) {
                if (!provider) return false;
                return this.oauthStatus[provider]?.configured === true;
            },

            getOAuthAccounts(provider) {
                if (!provider) return [];
                return this.oauthAccounts[provider] || [];
            },

            getOAuthNotConfiguredMessage(provider) {
                const envVars = {
                    google: "GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET",
                    oura: "OURA_CLIENT_ID and OURA_CLIENT_SECRET",
                    withings: "WITHINGS_CLIENT_ID and WITHINGS_CLIENT_SECRET",
                };
                const vars =
                    envVars[provider] ||
                    `${provider?.toUpperCase()}_CLIENT_ID and ${provider?.toUpperCase()}_CLIENT_SECRET`;
                return `${this.capitalizeFirst(provider || "OAuth")} not configured. Set ${vars} environment variables.`;
            },

            capitalizeFirst(str) {
                if (!str) return "";
                return str.charAt(0).toUpperCase() + str.slice(1);
            },

            isFieldVisible(field) {
                // Hide field if env var is configured
                if (this.isFieldHiddenByEnvVar(field)) {
                    return false;
                }
                // Check depends_on conditions
                if (
                    !field.depends_on ||
                    Object.keys(field.depends_on).length === 0
                ) {
                    return true;
                }
                for (const [fieldName, expectedValue] of Object.entries(
                    field.depends_on,
                )) {
                    if (this.pluginConfig[fieldName] !== expectedValue) {
                        return false;
                    }
                }
                return true;
            },

            onSourceTypeChange() {
                const plugin = this.getCurrentPlugin();
                if (plugin) {
                    // Initialize pluginConfig with defaults from plugin fields
                    this.pluginConfig = {};
                    for (const field of plugin.fields || []) {
                        if (
                            field.default !== undefined &&
                            field.default !== null
                        ) {
                            this.pluginConfig[field.name] = field.default;
                        } else {
                            this.pluginConfig[field.name] = "";
                        }
                    }
                    // Set data_type and best_for from plugin metadata
                    this.form.data_type = plugin.data_type || "";
                    this.form.best_for = plugin.best_for || "";
                } else {
                    // Fallback defaults for non-plugin source types
                    this.pluginConfig = {};
                }
            },

            async loadGoogleAccounts() {
                try {
                    const response = await fetch("/api/oauth/google/status");
                    if (response.ok) {
                        const data = await response.json();
                        this.googleAccounts = data.accounts || [];
                    }
                } catch (error) {
                    console.error("Failed to load Google accounts:", error);
                }
            },

            getGoogleSourceDescription(sourceType) {
                const descriptions = {
                    google_calendar_live:
                        "Real-time calendar queries: today's schedule, next meeting, upcoming events",
                    google_tasks_live:
                        "Real-time task queries: pending tasks, due today, overdue items",
                    google_gmail_live:
                        "Real-time email queries: unread messages, today's emails, search",
                };
                return (
                    descriptions[sourceType] || "Real-time Google data access"
                );
            },

            async loadOuraAccounts() {
                try {
                    const response = await fetch("/api/oauth/oura/status");
                    if (response.ok) {
                        const data = await response.json();
                        this.ouraConfigured = data.configured;
                        this.ouraAccounts = data.accounts || [];
                    }
                } catch (error) {
                    console.error("Failed to load Oura accounts:", error);
                }
            },

            async connectOura() {
                this.ouraConnecting = true;
                try {
                    const response = await fetch(
                        "/api/oauth/oura/start?redirect_uri=/live-data-sources",
                    );
                    if (response.ok) {
                        const data = await response.json();
                        if (data.auth_url) {
                            window.location.href = data.auth_url;
                        }
                    } else {
                        const error = await response.json();
                        alert(error.error || "Failed to start Oura OAuth");
                    }
                } catch (error) {
                    console.error("Failed to connect Oura:", error);
                    alert("Failed to connect Oura: " + error.message);
                } finally {
                    this.ouraConnecting = false;
                }
            },

            async loadWithingsAccounts() {
                try {
                    const response = await fetch("/api/oauth/withings/status");
                    if (response.ok) {
                        const data = await response.json();
                        this.withingsConfigured = data.configured;
                        this.withingsAccounts = data.accounts || [];
                    }
                } catch (error) {
                    console.error("Failed to load Withings accounts:", error);
                }
            },

            async connectWithings() {
                this.withingsConnecting = true;
                try {
                    const response = await fetch(
                        "/api/oauth/withings/start?redirect_uri=/live-data-sources",
                    );
                    if (response.ok) {
                        const data = await response.json();
                        if (data.auth_url) {
                            window.location.href = data.auth_url;
                        }
                    } else {
                        const error = await response.json();
                        alert(error.error || "Failed to start Withings OAuth");
                    }
                } catch (error) {
                    console.error("Failed to connect Withings:", error);
                    alert("Failed to connect Withings: " + error.message);
                } finally {
                    this.withingsConnecting = false;
                }
            },

            async loadSources() {
                this.loading = true;
                try {
                    const response = await fetch("/api/live-data-sources");
                    if (response.ok) {
                        this.sources = await response.json();
                    }
                } catch (error) {
                    console.error("Failed to load live data sources:", error);
                } finally {
                    this.loading = false;
                }
            },

            async loadEnvVarStatus() {
                try {
                    const response = await fetch(
                        "/api/live-data-sources/env-var-status",
                    );
                    if (response.ok) {
                        this.configuredEnvVars = await response.json();
                    }
                } catch (error) {
                    console.error("Failed to load env var status:", error);
                }
            },

            isFieldHiddenByEnvVar(field) {
                // Hide field if it has an env_var and that env var is configured
                return field.env_var && this.configuredEnvVars[field.env_var];
            },

            getDisplayName(source) {
                // Get friendly display name from plugin config
                if (source.config?.name) {
                    return source.config.name;
                }
                // Fallback: convert slug to title case
                return source.name
                    .split("-")
                    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(" ");
            },

            getTypeLabel(type) {
                const plugin = this.pluginsByType[type];
                if (plugin && plugin.display_name) {
                    return plugin.display_name;
                }
                return type;
            },

            getTypeBadgeClass(type) {
                const plugin = this.pluginsByType[type];
                if (plugin) {
                    const categoryClasses = {
                        health: "badge-success",
                        productivity: "badge-info",
                        finance: "badge-warning",
                        location: "badge-primary",
                        other: "badge-ghost",
                    };
                    return categoryClasses[plugin.category] || "badge-ghost";
                }
                return "badge-ghost";
            },

            getPluginIcon(type) {
                const plugin = this.pluginsByType[type];
                return plugin?.icon || "";
            },

            resetForm() {
                this.form = {
                    name: "",
                    description: "",
                    source_type: "",
                    data_type: "general",
                    best_for: "",
                    // Behavior
                    cache_ttl_seconds: 60,
                    timeout_seconds: 30,
                    retry_count: 1,
                    rate_limit_rpm: 60,
                    test_params_json: "",
                };
            },

            openCreateModal() {
                this.editingSource = null;
                this.resetForm();
                this.showEditModal = true;
            },

            openEditModal(source) {
                this.editingSource = source;

                this.form = {
                    name: source.name,
                    description: source.description || "",
                    source_type: source.source_type,
                    data_type: source.data_type || "general",
                    best_for: source.best_for || "",
                };

                // Populate pluginConfig from config (preferred) or auth_config (legacy fallback)
                const plugin = this.pluginsByType[source.source_type];
                const selectFieldsToRestore = [];
                const pluginConfigSource =
                    source.config && Object.keys(source.config).length > 0
                        ? source.config
                        : source.auth_config || {};

                if (plugin && plugin.fields) {
                    this.pluginConfig = {};
                    for (const field of plugin.fields) {
                        let value = pluginConfigSource[field.name];
                        if (value === undefined || value === null) {
                            value =
                                field.default !== undefined
                                    ? field.default
                                    : "";
                        }
                        // Convert to string for form binding (except booleans)
                        if (
                            field.field_type === "oauth_account" ||
                            field.field_type === "integer"
                        ) {
                            this.pluginConfig[field.name] = value
                                ? String(value)
                                : "";
                            if (field.field_type === "oauth_account" && value) {
                                selectFieldsToRestore.push({
                                    name: field.name,
                                    value: String(value),
                                });
                            }
                        } else {
                            this.pluginConfig[field.name] = value;
                            if (field.field_type === "select" && value) {
                                selectFieldsToRestore.push({
                                    name: field.name,
                                    value: String(value),
                                });
                            }
                        }
                    }
                } else {
                    this.pluginConfig = {};
                }

                this.showEditModal = true;

                // Fix Alpine.js select dropdown restoration
                if (selectFieldsToRestore.length > 0) {
                    setTimeout(() => {
                        for (const { name, value } of selectFieldsToRestore) {
                            const selects =
                                document.querySelectorAll("#editModal select");
                            for (const sel of selects) {
                                const option = sel.querySelector(
                                    `option[value="${value}"]`,
                                );
                                if (option && sel.value !== value) {
                                    sel.value = value;
                                    sel.dispatchEvent(new Event("change"));
                                }
                            }
                        }
                    }, 100);
                }
            },

            openDetailsModal(source) {
                this.selectedSource = source;
                this.showDetailsModal = true;
            },

            async saveSource() {
                this.saving = true;
                try {
                    const plugin = this.getCurrentPlugin();
                    if (!plugin) {
                        this.testResult = {
                            success: false,
                            message: "Please select a source type",
                        };
                        this.saving = false;
                        setTimeout(() => (this.testResult = null), 3000);
                        return;
                    }

                    // Build config from pluginConfig
                    let pluginConfigData = {};
                    if (this.pluginConfig.name) {
                        pluginConfigData.name = this.pluginConfig.name;
                    }

                    for (const field of plugin.fields) {
                        if (field.name === "name") continue;

                        const value = this.pluginConfig[field.name];

                        // Validate required OAuth account fields
                        if (
                            field.required &&
                            field.field_type === "oauth_account" &&
                            !value
                        ) {
                            this.testResult = {
                                success: false,
                                message: `Please fill in required field: ${field.label}`,
                            };
                            this.saving = false;
                            setTimeout(() => (this.testResult = null), 3000);
                            return;
                        }

                        // Convert values to appropriate types
                        if (field.field_type === "oauth_account" && value) {
                            pluginConfigData[field.name] = parseInt(value);
                        } else if (field.field_type === "integer" && value) {
                            pluginConfigData[field.name] = parseInt(value);
                        } else if (field.field_type === "number" && value) {
                            pluginConfigData[field.name] = parseFloat(value);
                        } else if (field.field_type === "boolean") {
                            pluginConfigData[field.name] = !!value;
                        } else if (value !== undefined && value !== "") {
                            pluginConfigData[field.name] = value;
                        }
                    }

                    // Get source name from pluginConfig
                    const sourceName = this.pluginConfig.name
                        ? this.pluginConfig.name
                              .toLowerCase()
                              .replace(/\s+/g, "-")
                        : "";

                    if (!sourceName) {
                        this.testResult = {
                            success: false,
                            message: "Please provide a Source Name",
                        };
                        this.saving = false;
                        setTimeout(() => (this.testResult = null), 3000);
                        return;
                    }

                    const payload = {
                        name: sourceName,
                        source_type: this.form.source_type,
                        description: plugin.description || "",
                        data_type: plugin.data_type || "general",
                        best_for: plugin.best_for || "",
                        config_json: JSON.stringify(pluginConfigData),
                        cache_ttl_seconds: 300,
                        timeout_seconds: 30,
                        retry_count: 1,
                        rate_limit_rpm: 60,
                        enabled: true,
                    };

                    const url = this.editingSource
                        ? `/api/live-data-sources/${this.editingSource.id}`
                        : "/api/live-data-sources";
                    const method = this.editingSource ? "PUT" : "POST";

                    const response = await fetch(url, {
                        method,
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });

                    if (response.ok) {
                        this.showEditModal = false;
                        await this.loadSources();
                        this.testResult = {
                            success: true,
                            message: "Source saved successfully",
                        };
                    } else {
                        const error = await response.json();
                        this.testResult = {
                            success: false,
                            message: error.error || "Failed to save",
                        };
                    }
                } catch (error) {
                    this.testResult = {
                        success: false,
                        message: "Failed to save: " + error.message,
                    };
                } finally {
                    this.saving = false;
                    setTimeout(() => (this.testResult = null), 3000);
                }
            },

            async toggleEnabled(source) {
                try {
                    await fetch(`/api/live-data-sources/${source.id}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ enabled: !source.enabled }),
                    });
                    await this.loadSources();
                } catch (error) {
                    console.error("Failed to toggle:", error);
                }
            },

            toggleExpand(id) {
                const idx = this.expandedRows.indexOf(id);
                if (idx >= 0) {
                    this.expandedRows.splice(idx, 1);
                } else {
                    this.expandedRows.push(id);
                    const source = this.sources.find((s) => s.id === id);
                    // Load endpoint stats if source has calls
                    if (
                        source &&
                        source.total_calls > 0 &&
                        !this.endpointStats[id]
                    ) {
                        this.loadEndpointStats(source);
                    }
                }
            },

            async loadEndpointStats(source) {
                this.loadingEndpointStats[source.id] = true;
                try {
                    const response = await fetch(
                        `/api/live-data-sources/${source.id}/endpoint-stats`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        this.endpointStats[source.id] = data.stats || [];
                    } else {
                        this.endpointStats[source.id] = [];
                    }
                } catch (error) {
                    console.error("Failed to load endpoint stats:", error);
                    this.endpointStats[source.id] = [];
                } finally {
                    this.loadingEndpointStats[source.id] = false;
                }
            },

            async testSource(source) {
                this.testingId = source.id;
                this.testResult = null;
                try {
                    const response = await fetch(
                        `/api/live-data-sources/${source.id}/test`,
                        { method: "POST" },
                    );
                    const result = await response.json();
                    this.testResult = result;

                    // Tool count is now stored in database and returned via loadSources()

                    setTimeout(() => (this.testResult = null), 3000);
                    await this.loadSources();
                } catch (error) {
                    this.testResult = {
                        success: false,
                        message: "Test failed: " + error.message,
                    };
                    setTimeout(() => (this.testResult = null), 3000);
                } finally {
                    this.testingId = null;
                }
            },

            async deleteSource(source) {
                if (!confirm(`Delete "${source.name}"? This cannot be undone.`))
                    return;
                try {
                    const response = await fetch(
                        `/api/live-data-sources/${source.id}`,
                        { method: "DELETE" },
                    );
                    if (response.ok) {
                        await this.loadSources();
                        this.testResult = {
                            success: true,
                            message: "Source deleted",
                        };
                    } else {
                        const error = await response.json();
                        this.testResult = {
                            success: false,
                            message: error.error || "Failed to delete",
                        };
                    }
                } catch (error) {
                    this.testResult = {
                        success: false,
                        message: "Failed to delete: " + error.message,
                    };
                }
                setTimeout(() => (this.testResult = null), 3000);
            },
        };
    }
</script>
{% endblock %}
