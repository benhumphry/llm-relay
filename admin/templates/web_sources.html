{% extends "base.html" %} {% block title %}Web Sources{% endblock %} {% block
content %}
<div x-data="webSourcesPage()" x-init="loadSettings()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold">Web Sources</h1>
        <p class="text-base-content/60">
            Configure web search and scraping for Smart Enrichers
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Search Provider -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Web Search</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Search provider for realtime web access in Smart Enrichers
                </p>

                <div class="space-y-4">
                    <!-- Search Provider Selection -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Search Provider</span>
                        </label>
                        <select
                            x-model="settings.search_provider"
                            class="select select-bordered"
                            :disabled="!hasAnySearchProvider"
                        >
                            <option value="">Select provider...</option>
                            <template
                                x-for="provider in availableSearchProviders"
                                :key="provider.name"
                            >
                                <option
                                    :value="provider.name"
                                    x-text="provider.name.charAt(0).toUpperCase() + provider.name.slice(1)"
                                ></option>
                            </template>
                        </select>
                        <template x-if="!hasAnySearchProvider">
                            <label class="label">
                                <span class="label-text-alt text-warning">
                                    No search providers configured. Set
                                    SEARXNG_URL or PERPLEXITY_API_KEY.
                                </span>
                            </label>
                        </template>
                    </div>

                    <!-- Provider Status -->
                    <div class="bg-base-200 rounded-lg p-3">
                        <div class="text-sm font-medium mb-2">
                            Available Providers
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <template
                                x-for="provider in availableSearchProviders"
                                :key="provider.name"
                            >
                                <span class="badge badge-success gap-1">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-3 w-3"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M5 13l4 4L19 7"
                                        />
                                    </svg>
                                    <span x-text="provider.name"></span>
                                </span>
                            </template>
                            <span
                                x-show="availableSearchProviders.length === 0"
                                class="text-base-content/50 text-sm"
                            >
                                None configured
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Web Scraper -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Web Scraper</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Extract content from web pages for context injection
                </p>

                <div class="space-y-4">
                    <!-- Scraper Provider -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Scraper Provider</span>
                        </label>
                        <select
                            x-model="settings.scraper_provider"
                            class="select select-bordered"
                        >
                            <option value="builtin">
                                Built-in (httpx + trafilatura)
                            </option>
                            <option value="jina">
                                Jina Reader (handles JS-heavy sites)
                            </option>
                        </select>
                        <label class="label">
                            <span class="label-text-alt">
                                Used by Smart Enrichers to extract content from
                                web pages
                            </span>
                        </label>
                    </div>

                    <!-- Jina API Key Status -->
                    <template x-if="settings.scraper_provider === 'jina'">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Jina API Key</span>
                            </label>
                            <div
                                class="flex items-center gap-2 h-12 px-4 bg-base-200 rounded-lg"
                            >
                                <template x-if="settings.jina_api_configured">
                                    <span
                                        class="text-success flex items-center gap-2"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M5 13l4 4L19 7"
                                            />
                                        </svg>
                                        Configured via JINA_API_KEY
                                    </span>
                                </template>
                                <template x-if="!settings.jina_api_configured">
                                    <span class="text-base-content/50">
                                        Optional - set JINA_API_KEY env var for
                                        higher rate limits
                                    </span>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Built-in Scraper Info -->
                    <template x-if="settings.scraper_provider === 'builtin'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Uses httpx for fetching and trafilatura for content
                            extraction. Works well for most static websites.
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Embedding Settings -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Embeddings</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Vector embeddings for document stores and semantic search
                </p>

                <div class="space-y-4">
                    <!-- Embedding Provider -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Embedding Provider</span>
                            <template
                                x-if="settings.embedding_provider === 'local'"
                            >
                                <span
                                    class="badge badge-sm"
                                    :class="settings.gpu_available ? 'badge-success' : 'badge-warning'"
                                    x-text="settings.gpu_available ? 'GPU: ' + settings.gpu_name : 'CPU'"
                                ></span>
                            </template>
                        </label>
                        <select
                            x-model="settings.embedding_provider"
                            @change="onEmbeddingProviderChange()"
                            class="select select-bordered"
                        >
                            <option value="local">
                                Local (BAAI/bge-small-en-v1.5)
                            </option>
                            <option
                                x-show="embeddingModels.ollama?.available"
                                value="ollama"
                            >
                                Ollama
                            </option>
                            <template
                                x-for="provider in embeddingModels.providers || []"
                                :key="provider.name"
                            >
                                <option
                                    :value="provider.name"
                                    x-text="provider.name"
                                ></option>
                            </template>
                        </select>
                    </div>

                    <!-- Ollama Instance & Model -->
                    <template
                        x-if="settings.embedding_provider === 'ollama' && embeddingModels.ollama?.available"
                    >
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Ollama Instance</span
                                    >
                                </label>
                                <select
                                    x-model="settings.embedding_ollama_instance"
                                    @change="onEmbeddingOllamaInstanceChange()"
                                    class="select select-bordered"
                                >
                                    <template
                                        x-for="instance in embeddingModels.ollama.instances"
                                        :key="instance.name"
                                    >
                                        <option
                                            :value="instance.name"
                                            x-text="instance.name + ' (' + instance.url + ')'"
                                        ></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Embedding Model</span
                                    >
                                </label>
                                <select
                                    x-model="settings.embedding_model"
                                    class="select select-bordered"
                                >
                                    <template
                                        x-for="model in currentOllamaEmbeddingModels"
                                        :key="model"
                                    >
                                        <option
                                            :value="model"
                                            x-text="model"
                                        ></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                    </template>

                    <!-- Provider Embedding Model -->
                    <template
                        x-if="settings.embedding_provider !== 'local' && settings.embedding_provider !== 'ollama'"
                    >
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Embedding Model</span>
                            </label>
                            <select
                                x-model="settings.embedding_model"
                                class="select select-bordered"
                            >
                                <template
                                    x-for="model in currentProviderEmbeddingModels"
                                    :key="model"
                                >
                                    <option
                                        :value="model"
                                        x-text="model"
                                    ></option>
                                </template>
                            </select>
                        </div>
                    </template>

                    <!-- Local Embedding Info -->
                    <template x-if="settings.embedding_provider === 'local'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Uses bundled BAAI/bge-small-en-v1.5 model (~130MB).
                            No external dependencies required.
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Reranking Settings -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Reranking</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Rerank retrieved documents for better relevance
                </p>

                <div class="space-y-4">
                    <!-- Rerank Provider -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Rerank Provider</span>
                            <template
                                x-if="settings.rerank_provider === 'local'"
                            >
                                <span
                                    class="badge badge-sm"
                                    :class="settings.gpu_available ? 'badge-success' : 'badge-warning'"
                                    x-text="settings.gpu_available ? 'GPU: ' + settings.gpu_name : 'CPU'"
                                ></span>
                            </template>
                        </label>
                        <select
                            x-model="settings.rerank_provider"
                            class="select select-bordered"
                        >
                            <option value="local">Local (cross-encoder)</option>
                            <option value="jina">
                                Jina Reranker (requires API key)
                            </option>
                        </select>
                    </div>

                    <!-- Jina Warning -->
                    <template
                        x-if="settings.rerank_provider === 'jina' && !settings.jina_api_configured"
                    >
                        <div class="alert alert-warning py-2">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                                />
                            </svg>
                            <span class="text-sm"
                                >Jina reranker requires JINA_API_KEY to be
                                set</span
                            >
                        </div>
                    </template>

                    <!-- Local Rerank Model -->
                    <template x-if="settings.rerank_provider === 'local'">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Rerank Model</span>
                            </label>
                            <select
                                x-model="settings.rerank_model"
                                class="select select-bordered"
                            >
                                <option
                                    value="cross-encoder/ms-marco-MiniLM-L-6-v2"
                                >
                                    ms-marco-MiniLM-L-6-v2 (fast)
                                </option>
                                <option
                                    value="cross-encoder/ms-marco-TinyBERT-L-2-v2"
                                >
                                    ms-marco-TinyBERT-L-2-v2 (fastest)
                                </option>
                                <option value="BAAI/bge-reranker-base">
                                    bge-reranker-base (accurate)
                                </option>
                            </select>
                        </div>
                    </template>

                    <!-- Local Rerank Info -->
                    <template x-if="settings.rerank_provider === 'local'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Cross-encoder models run locally. GPU recommended
                            for large document sets.
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Vision Settings -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Document Vision</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Vision provider for parsing PDFs and images in documents
                </p>

                <div class="space-y-4">
                    <!-- Vision Provider -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Vision Provider</span>
                            <template
                                x-if="settings.vision_provider === 'local'"
                            >
                                <span
                                    class="badge badge-sm"
                                    :class="settings.gpu_available ? 'badge-success' : 'badge-warning'"
                                    x-text="settings.gpu_available ? 'GPU: ' + settings.gpu_name : 'CPU'"
                                ></span>
                            </template>
                        </label>
                        <select
                            x-model="settings.vision_provider"
                            @change="onVisionProviderChange()"
                            class="select select-bordered"
                        >
                            <option value="local">
                                Local (Docling default)
                            </option>
                            <option
                                x-show="visionModels.ollama?.available"
                                value="ollama"
                            >
                                Ollama
                            </option>
                            <template
                                x-for="provider in visionModels.providers || []"
                                :key="provider.name"
                            >
                                <option
                                    :value="provider.name"
                                    x-text="provider.name"
                                ></option>
                            </template>
                        </select>
                    </div>

                    <!-- Ollama Vision Instance & Model -->
                    <template
                        x-if="settings.vision_provider === 'ollama' && visionModels.ollama?.available"
                    >
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text"
                                        >Ollama Instance</span
                                    >
                                </label>
                                <select
                                    x-model="settings.vision_ollama_instance"
                                    @change="onVisionOllamaInstanceChange()"
                                    class="select select-bordered"
                                >
                                    <template
                                        x-for="instance in visionModels.ollama.instances"
                                        :key="instance.name"
                                    >
                                        <option
                                            :value="instance.name"
                                            x-text="instance.name + ' (' + instance.url + ')'"
                                        ></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Vision Model</span>
                                </label>
                                <select
                                    x-model="settings.vision_model"
                                    class="select select-bordered"
                                >
                                    <template
                                        x-for="model in currentOllamaVisionModels"
                                        :key="model"
                                    >
                                        <option
                                            :value="model"
                                            x-text="model"
                                        ></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                    </template>

                    <!-- Provider Vision Model -->
                    <template
                        x-if="settings.vision_provider !== 'local' && settings.vision_provider !== 'ollama'"
                    >
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Vision Model</span>
                            </label>
                            <select
                                x-model="settings.vision_model"
                                class="select select-bordered"
                            >
                                <template
                                    x-for="model in currentProviderVisionModels"
                                    :key="model"
                                >
                                    <option
                                        :value="model"
                                        x-text="model"
                                    ></option>
                                </template>
                            </select>
                        </div>
                    </template>

                    <!-- Local Vision Info -->
                    <template x-if="settings.vision_provider === 'local'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Uses bundled Docling models for document parsing.
                            Runs on CPU/GPU.
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="mt-6">
        <button
            @click="saveSettings()"
            class="btn btn-primary"
            :class="{ 'loading': saving }"
            :disabled="saving"
        >
            Save All Settings
        </button>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-transition class="toast toast-end" x-cloak>
        <div :class="'alert alert-' + toast.type">
            <span x-text="toast.message"></span>
        </div>
    </div>
</div>

<script>
    function webSourcesPage() {
        return {
            settings: {
                search_provider: "",
                scraper_provider: "builtin",
                jina_api_configured: false,
                gpu_available: false,
                gpu_name: "",
                embedding_provider: "local",
                embedding_model: "",
                embedding_ollama_instance: "",
                rerank_provider: "local",
                rerank_model: "cross-encoder/ms-marco-MiniLM-L-6-v2",
                vision_provider: "local",
                vision_model: "",
                vision_ollama_instance: "",
            },
            availableSearchProviders: [],
            hasAnySearchProvider: false,
            embeddingModels: {},
            visionModels: {},
            currentOllamaEmbeddingModels: [],
            currentProviderEmbeddingModels: [],
            currentOllamaVisionModels: [],
            currentProviderVisionModels: [],
            saving: false,
            toast: { show: false, message: "", type: "info" },

            async loadSettings() {
                try {
                    // Load feature status for search providers
                    const featureRes = await fetch("/api/feature-status");
                    if (featureRes.ok) {
                        const featureData = await featureRes.json();
                        this.availableSearchProviders =
                            featureData.dependencies?.search_providers || [];
                        this.hasAnySearchProvider =
                            this.availableSearchProviders.length > 0;
                    }

                    // Load web settings
                    const webRes = await fetch("/api/settings/web");
                    if (webRes.ok) {
                        const webData = await webRes.json();
                        this.settings.search_provider =
                            webData.search_provider || "";
                        this.settings.scraper_provider =
                            webData.scraper_provider || "builtin";
                        this.settings.jina_api_configured =
                            webData.jina_api_configured || false;
                        this.settings.gpu_available =
                            webData.gpu_available || false;
                        this.settings.gpu_name = webData.gpu_name || "";
                        this.settings.embedding_provider =
                            webData.embedding_provider || "local";
                        this.settings.embedding_model =
                            webData.embedding_model || "";
                        this.settings.embedding_ollama_instance =
                            webData.embedding_ollama_instance || "";
                        this.settings.rerank_provider =
                            webData.rerank_provider || "local";
                        this.settings.rerank_model =
                            webData.rerank_model ||
                            "cross-encoder/ms-marco-MiniLM-L-6-v2";
                        this.settings.vision_provider =
                            webData.vision_provider || "local";
                        this.settings.vision_model = webData.vision_model || "";
                        this.settings.vision_ollama_instance =
                            webData.vision_ollama_instance || "";
                    }

                    // Load embedding models
                    const embedRes = await fetch(
                        "/api/settings/embedding-models",
                    );
                    if (embedRes.ok) {
                        this.embeddingModels = await embedRes.json();
                        this.updateEmbeddingModelLists();
                    }

                    // Load vision models
                    const visionRes = await fetch(
                        "/api/settings/vision-models",
                    );
                    if (visionRes.ok) {
                        this.visionModels = await visionRes.json();
                        this.updateVisionModelLists();
                    }
                } catch (error) {
                    console.error("Error loading settings:", error);
                    this.showToast("Failed to load settings", "error");
                }
            },

            updateEmbeddingModelLists() {
                // Update Ollama embedding models
                if (
                    this.embeddingModels.ollama?.available &&
                    this.settings.embedding_ollama_instance
                ) {
                    const instance = this.embeddingModels.ollama.instances.find(
                        (i) =>
                            i.name === this.settings.embedding_ollama_instance,
                    );
                    this.currentOllamaEmbeddingModels =
                        instance?.embedding_models || [];
                }
                // Update provider embedding models
                if (
                    this.settings.embedding_provider &&
                    this.settings.embedding_provider !== "local" &&
                    this.settings.embedding_provider !== "ollama"
                ) {
                    const provider = this.embeddingModels.providers?.find(
                        (p) => p.name === this.settings.embedding_provider,
                    );
                    this.currentProviderEmbeddingModels =
                        provider?.models || [];
                }
            },

            updateVisionModelLists() {
                // Update Ollama vision models
                if (
                    this.visionModels.ollama?.available &&
                    this.settings.vision_ollama_instance
                ) {
                    const instance = this.visionModels.ollama.instances.find(
                        (i) => i.name === this.settings.vision_ollama_instance,
                    );
                    this.currentOllamaVisionModels =
                        instance?.vision_models || [];
                }
                // Update provider vision models
                if (
                    this.settings.vision_provider &&
                    this.settings.vision_provider !== "local" &&
                    this.settings.vision_provider !== "ollama"
                ) {
                    const provider = this.visionModels.providers?.find(
                        (p) => p.name === this.settings.vision_provider,
                    );
                    this.currentProviderVisionModels = provider?.models || [];
                }
            },

            onEmbeddingProviderChange() {
                this.settings.embedding_model = "";
                this.settings.embedding_ollama_instance = "";
                if (
                    this.settings.embedding_provider === "ollama" &&
                    this.embeddingModels.ollama?.instances?.length > 0
                ) {
                    this.settings.embedding_ollama_instance =
                        this.embeddingModels.ollama.instances[0].name;
                    this.onEmbeddingOllamaInstanceChange();
                }
                this.updateEmbeddingModelLists();
            },

            onEmbeddingOllamaInstanceChange() {
                this.updateEmbeddingModelLists();
                if (this.currentOllamaEmbeddingModels.length > 0) {
                    this.settings.embedding_model =
                        this.currentOllamaEmbeddingModels[0];
                }
            },

            onVisionProviderChange() {
                this.settings.vision_model = "";
                this.settings.vision_ollama_instance = "";
                if (
                    this.settings.vision_provider === "ollama" &&
                    this.visionModels.ollama?.instances?.length > 0
                ) {
                    this.settings.vision_ollama_instance =
                        this.visionModels.ollama.instances[0].name;
                    this.onVisionOllamaInstanceChange();
                }
                this.updateVisionModelLists();
            },

            onVisionOllamaInstanceChange() {
                this.updateVisionModelLists();
                if (this.currentOllamaVisionModels.length > 0) {
                    this.settings.vision_model =
                        this.currentOllamaVisionModels[0];
                }
            },

            async saveSettings() {
                this.saving = true;
                try {
                    const response = await fetch("/api/settings/web", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            search_provider: this.settings.search_provider,
                            scraper_provider: this.settings.scraper_provider,
                            embedding_provider:
                                this.settings.embedding_provider,
                            embedding_model: this.settings.embedding_model,
                            embedding_ollama_instance:
                                this.settings.embedding_ollama_instance,
                            rerank_provider: this.settings.rerank_provider,
                            rerank_model: this.settings.rerank_model,
                            vision_provider: this.settings.vision_provider,
                            vision_model: this.settings.vision_model,
                            vision_ollama_instance:
                                this.settings.vision_ollama_instance,
                        }),
                    });

                    if (response.ok) {
                        this.showToast(
                            "Settings saved successfully",
                            "success",
                        );
                    } else {
                        const data = await response.json();
                        this.showToast(
                            data.error || "Failed to save settings",
                            "error",
                        );
                    }
                } catch (error) {
                    console.error("Error saving settings:", error);
                    this.showToast("Failed to save settings", "error");
                }
                this.saving = false;
            },

            showToast(message, type = "info") {
                this.toast = { show: true, message, type };
                setTimeout(() => {
                    this.toast.show = false;
                }, 3000);
            },
        };
    }
</script>
{% endblock %}
