{% extends "base.html" %} {% block title %}Web Configuration{% endblock %} {%
block content %}
<div x-data="webConfigPage()" x-init="loadSettings()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold">Web Configuration</h1>
        <p class="text-base-content/60">
            Configure web search and scraping for Smart Aliases
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Search Provider -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Web Search</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Search provider for realtime web access
                </p>

                <div class="space-y-4">
                    <!-- Search Provider Selection -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Search Provider</span>
                        </label>
                        <select
                            x-model="settings.search_provider"
                            class="select select-bordered"
                            :disabled="!hasAnySearchProvider"
                        >
                            <option value="">Select provider...</option>
                            <template
                                x-for="provider in availableSearchProviders"
                                :key="provider.name"
                            >
                                <option
                                    :value="provider.name"
                                    x-text="getProviderDisplayName(provider.name)"
                                ></option>
                            </template>
                        </select>
                        <template x-if="!hasAnySearchProvider">
                            <label class="label">
                                <span class="label-text-alt text-warning">
                                    No search providers configured. Set
                                    SEARXNG_URL or PERPLEXITY_API_KEY.
                                </span>
                            </label>
                        </template>
                    </div>

                    <!-- Provider Status -->
                    <div class="bg-base-200 rounded-lg p-3">
                        <div class="text-sm font-medium mb-2">
                            Available Providers
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <template
                                x-for="provider in availableSearchProviders"
                                :key="provider.name"
                            >
                                <span class="badge badge-success gap-1">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-3 w-3"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M5 13l4 4L19 7"
                                        />
                                    </svg>
                                    <span
                                        x-text="getProviderDisplayName(provider.name)"
                                    ></span>
                                </span>
                            </template>
                            <span
                                x-show="availableSearchProviders.length === 0"
                                class="text-base-content/50 text-sm"
                            >
                                None configured
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Web Scraper -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Web Scraper</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Extract content from web pages for context injection
                </p>

                <div class="space-y-4">
                    <!-- Scraper Provider -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Scraper Provider</span>
                        </label>
                        <select
                            x-model="settings.scraper_provider"
                            class="select select-bordered"
                        >
                            <option value="builtin">
                                Built-in (httpx + trafilatura)
                            </option>
                            <option value="jina">Jina Reader (Free)</option>
                            <option
                                value="jina-api"
                                x-show="settings.jina_api_configured"
                            >
                                Jina Reader (API)
                            </option>
                        </select>
                        <label class="label">
                            <span class="label-text-alt">
                                Used by Smart Aliases to extract content from
                                web pages
                            </span>
                        </label>
                    </div>

                    <!-- Provider Info -->
                    <template x-if="settings.scraper_provider === 'builtin'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Uses httpx for fetching and trafilatura for content
                            extraction. Works well for most static websites.
                        </div>
                    </template>
                    <template x-if="settings.scraper_provider === 'jina'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Handles JavaScript-heavy sites. Free tier with rate
                            limits.
                        </div>
                    </template>
                    <template x-if="settings.scraper_provider === 'jina-api'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Handles JavaScript-heavy sites. Uses your API key
                            for higher rate limits.
                        </div>
                    </template>

                    <!-- PDF Parser -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Web PDF Parser</span>
                        </label>
                        <select
                            x-model="settings.pdf_parser"
                            class="select select-bordered"
                        >
                            <option value="docling">
                                Docling (with Vision model)
                            </option>
                            <option value="pypdf">
                                PyPDF (fast, text-only)
                            </option>
                            <option
                                value="jina"
                                x-show="settings.jina_api_configured"
                            >
                                Jina Reader (API)
                            </option>
                        </select>
                        <label class="label">
                            <span class="label-text-alt text-base-content/60">
                                <template
                                    x-if="settings.pdf_parser === 'docling'"
                                >
                                    <span
                                        >Uses configured Vision model. Best
                                        quality but slower.</span
                                    >
                                </template>
                                <template
                                    x-if="settings.pdf_parser === 'pypdf'"
                                >
                                    <span
                                        >Fast text extraction. Won't work on
                                        scanned documents.</span
                                    >
                                </template>
                                <template x-if="settings.pdf_parser === 'jina'">
                                    <span
                                        >Fast cloud parsing via Jina. Handles
                                        scanned docs. Requires API key.</span
                                    >
                                </template>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Website Crawler -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Website Crawler</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Crawl and index websites for Document Stores
                </p>

                <div class="space-y-4">
                    <!-- Crawler Provider -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Crawler Provider</span>
                        </label>
                        <select
                            x-model="settings.crawl_provider"
                            class="select select-bordered"
                        >
                            <option value="builtin">
                                Built-in (trafilatura)
                            </option>
                            <option value="jina">Jina Reader (Free)</option>
                            <option
                                value="jina-api"
                                x-show="settings.jina_api_configured"
                            >
                                Jina Reader (API)
                            </option>
                        </select>
                        <label class="label">
                            <span class="label-text-alt">
                                Used when indexing website document sources
                            </span>
                        </label>
                    </div>

                    <!-- Provider Info -->
                    <template x-if="settings.crawl_provider === 'builtin'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Free, runs locally. Uses browser-like headers and
                            random delays. May be blocked by aggressive bot
                            protection (Cloudflare, MalCare, etc.).
                        </div>
                    </template>
                    <template x-if="settings.crawl_provider === 'jina'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Requests from Jina's servers (different IP). Handles
                            JS and bypasses most bot protection. Free tier with
                            rate limits.
                        </div>
                    </template>
                    <template x-if="settings.crawl_provider === 'jina-api'">
                        <div
                            class="bg-base-200 rounded-lg p-3 text-sm text-base-content/70"
                        >
                            Requests from Jina's servers (different IP). Handles
                            JS and bypasses most bot protection. Uses your API
                            key for higher rate limits.
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Reranking Info Card -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="card-title text-lg">Content Reranking</h2>
                        <p class="text-sm text-base-content/60">
                            Web search results are reranked for relevance before
                            injection
                        </p>
                    </div>
                    <a
                        href="{{ url_for('admin.rag_config_page') }}"
                        class="btn btn-outline btn-sm"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-4 w-4 mr-1"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                            />
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                            />
                        </svg>
                        Configure in RAG Settings
                    </a>
                </div>
                <div class="mt-3 flex items-center gap-4">
                    <div class="bg-base-200 rounded-lg px-4 py-2">
                        <span class="text-xs text-base-content/60"
                            >Provider</span
                        >
                        <div
                            class="font-medium"
                            x-text="settings.rerank_provider === 'local' ? 'Local (cross-encoder)' : 'Jina Reranker'"
                        ></div>
                    </div>
                    <template x-if="settings.rerank_provider === 'local'">
                        <div class="bg-base-200 rounded-lg px-4 py-2">
                            <span class="text-xs text-base-content/60"
                                >Model</span
                            >
                            <div
                                class="font-medium text-sm"
                                x-text="settings.rerank_model.split('/').pop()"
                            ></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="mt-6">
        <button
            @click="saveSettings()"
            class="btn btn-primary"
            :class="{ 'loading': saving }"
            :disabled="saving"
        >
            Save Settings
        </button>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-transition class="toast toast-end" x-cloak>
        <div :class="'alert alert-' + toast.type">
            <span x-text="toast.message"></span>
        </div>
    </div>
</div>

<script>
    function webConfigPage() {
        return {
            settings: {
                search_provider: "",
                scraper_provider: "builtin",
                crawl_provider: "builtin",
                pdf_parser: "pypdf",
                jina_api_configured: false,
                rerank_provider: "local",
                rerank_model: "cross-encoder/ms-marco-MiniLM-L-6-v2",
            },
            availableSearchProviders: [],
            hasAnySearchProvider: false,
            saving: false,
            toast: { show: false, message: "", type: "info" },

            getProviderDisplayName(name) {
                const displayNames = {
                    searxng: "SearXNG",
                    perplexity: "Perplexity",
                    jina: "Jina (Free)",
                    "jina-api": "Jina (API)",
                };
                return (
                    displayNames[name] ||
                    name.charAt(0).toUpperCase() + name.slice(1)
                );
            },

            async loadSettings() {
                try {
                    // Load both in parallel
                    const [featureRes, webRes] = await Promise.all([
                        fetch("/api/feature-status"),
                        fetch("/api/settings/web"),
                    ]);

                    // Store settings values temporarily
                    let savedSearchProvider = "";
                    let savedScraperProvider = "builtin";
                    let savedCrawlProvider = "builtin";
                    let savedPdfParser = "pypdf";

                    // Load web settings first to capture saved values
                    if (webRes.ok) {
                        const webData = await webRes.json();
                        savedSearchProvider = webData.search_provider || "";
                        savedScraperProvider =
                            webData.scraper_provider || "builtin";
                        savedCrawlProvider =
                            webData.crawl_provider || "builtin";
                        savedPdfParser = webData.pdf_parser || "pypdf";
                        this.settings.jina_api_configured =
                            webData.jina_api_configured || false;
                        this.settings.rerank_provider =
                            webData.rerank_provider || "local";
                        this.settings.rerank_model =
                            webData.rerank_model ||
                            "cross-encoder/ms-marco-MiniLM-L-6-v2";
                    }

                    // Load feature status for search providers
                    if (featureRes.ok) {
                        const featureData = await featureRes.json();
                        this.availableSearchProviders =
                            featureData.dependencies?.search_providers || [];
                        this.hasAnySearchProvider =
                            this.availableSearchProviders.length > 0;
                    }

                    // Restore saved values after Alpine renders template options
                    // Must set via DOM and dispatch change event for x-model to sync
                    this.$nextTick(() => {
                        const setSelect = (selector, value) => {
                            if (!value) return;
                            const select = document.querySelector(selector);
                            if (select) {
                                select.value = value;
                                select.dispatchEvent(new Event("change"));
                            }
                        };
                        setSelect(
                            'select[x-model="settings.search_provider"]',
                            savedSearchProvider,
                        );
                        setSelect(
                            'select[x-model="settings.scraper_provider"]',
                            savedScraperProvider,
                        );
                        setSelect(
                            'select[x-model="settings.crawl_provider"]',
                            savedCrawlProvider,
                        );
                        setSelect(
                            'select[x-model="settings.pdf_parser"]',
                            savedPdfParser,
                        );
                    });
                } catch (error) {
                    console.error("Error loading settings:", error);
                    this.showToast("Failed to load settings", "error");
                }
            },

            async saveSettings() {
                this.saving = true;
                try {
                    const response = await fetch("/api/settings/web", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            search_provider: this.settings.search_provider,
                            scraper_provider: this.settings.scraper_provider,
                            crawl_provider: this.settings.crawl_provider,
                            pdf_parser: this.settings.pdf_parser,
                        }),
                    });

                    if (response.ok) {
                        this.showToast(
                            "Settings saved successfully",
                            "success",
                        );
                    } else {
                        const data = await response.json();
                        this.showToast(
                            data.error || "Failed to save settings",
                            "error",
                        );
                    }
                } catch (error) {
                    console.error("Error saving settings:", error);
                    this.showToast("Failed to save settings", "error");
                }
                this.saving = false;
            },

            showToast(message, type = "info") {
                this.toast = { show: true, message, type };
                setTimeout(() => {
                    this.toast.show = false;
                }, 3000);
            },
        };
    }
</script>
{% endblock %}
