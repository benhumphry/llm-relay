# LLM Relay - Development/Testing Configuration
#
# This file is for local development and testing. It builds from source
# and includes all optional services (PostgreSQL, ChromaDB, SearXNG).
#
# Usage:
#   # Start all services
#   docker compose -f docker-compose.dev.yml up -d
#
#   # Rebuild after code changes
#   docker compose -f docker-compose.dev.yml up -d --build
#
#   # View logs
#   docker compose -f docker-compose.dev.yml logs -f llm-relay
#
#   # Stop all services
#   docker compose -f docker-compose.dev.yml down
#
#   # Stop and remove volumes (fresh start)
#   docker compose -f docker-compose.dev.yml down -v

services:
    # ===========================================================================
    # LLM RELAY (builds from local source)
    # ===========================================================================
    llm-relay:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: llm-relay-dev
        ports:
            - "21434:11434" # API server (Ollama/OpenAI compatible)
            - "28080:8080" # Admin UI
        volumes:
            - llm-relay-data:/data
        env_file:
            - .env
        environment:
            # Server configuration
            - PORT=11434
            - HOST=0.0.0.0
            - ADMIN_PORT=8080
            - ADMIN_HOST=0.0.0.0
            # PostgreSQL connection
            - DATABASE_URL=postgresql://llmrelay:llmrelay@postgres-dev:5432/llmrelay
            # ChromaDB connection
            - CHROMA_URL=http://chroma-dev:8000
            # SearXNG connection (for Smart Augmentor)
            - SEARXNG_URL=http://searxng-dev:8080
        depends_on:
            postgres-dev:
                condition: service_healthy
            chroma-dev:
                condition: service_healthy
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "python",
                    "-c",
                    "import urllib.request; urllib.request.urlopen('http://localhost:11434/')",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s
        networks:
            - llm-relay-dev-net

    # ===========================================================================
    # POSTGRESQL
    # ===========================================================================
    postgres-dev:
        image: postgres:16-alpine
        container_name: llm-relay-postgres-dev
        environment:
            - POSTGRES_USER=llmrelay
            - POSTGRES_PASSWORD=llmrelay
            - POSTGRES_DB=llmrelay
        volumes:
            - postgres-data:/var/lib/postgresql/data
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U llmrelay -d llmrelay"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        networks:
            - llm-relay-dev-net

    # ===========================================================================
    # CHROMADB
    # ===========================================================================
    chroma-dev:
        image: chromadb/chroma:latest
        container_name: llm-relay-chroma-dev
        volumes:
            - chroma-data:/chroma/chroma
        environment:
            - ANONYMIZED_TELEMETRY=false
        restart: unless-stopped
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:8000/api/v2/heartbeat"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s
        networks:
            - llm-relay-dev-net

    # ===========================================================================
    # SEARXNG (for Smart Augmentor web search)
    # ===========================================================================
    searxng-dev:
        image: searxng/searxng:latest
        container_name: llm-relay-searxng-dev
        volumes:
            - searxng-data:/etc/searxng
        environment:
            - SEARXNG_BASE_URL=http://localhost:8888
            - SEARXNG_SECRET_KEY=dev-secret-key-change-in-production
        # No ports exposed - only accessed internally by llm-relay-dev
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "-q",
                    "--spider",
                    "http://localhost:8080/healthz",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
        networks:
            - llm-relay-dev-net

volumes:
    llm-relay-data:
    postgres-data:
    chroma-data:
    searxng-data:

networks:
    llm-relay-dev-net:
        driver: bridge
